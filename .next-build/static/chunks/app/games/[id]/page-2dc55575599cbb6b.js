(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[238],{1743:function(e,t,a){Promise.resolve().then(a.bind(a,1801))},1801:function(e,t,a){"use strict";a.d(t,{GameView:function(){return d}});var s=a(3890),n=a(8496),l=a(7994),r=a(3376),i=a(9297);let c={p:"♟",r:"♜",n:"♞",b:"♝",q:"♛",k:"♚"};function o(e){let{pieces:t,selectedSquare:a,onSquareClick:l,interactive:r,orientation:i="white"}=e,o=(0,n.useMemo)(()=>{let e=new Map;for(let a of t)e.set(a.square,a);return e},[t]),u="white"===i?["a","b","c","d","e","f","g","h"]:["h","g","f","e","d","c","b","a"];return(0,s.jsx)("div",{className:"board",children:("white"===i?[8,7,6,5,4,3,2,1]:[1,2,3,4,5,6,7,8]).map((e,t)=>u.map((t,n)=>{let i="".concat(t).concat(e),u=o.get(i),d=(t.charCodeAt(0)-97+e)%2==0;return(0,s.jsx)("button",{type:"button",disabled:!r,onClick:()=>l(i),className:"square ".concat(d?"light":"dark"," ").concat(a===i?"selected":""),title:i,children:u?(0,s.jsx)("span",{className:"piece piece-".concat(u.color),children:c[u.type]}):""},i)}))})}function u(e){let{messages:t,canSend:a,onSend:l}=e,[r,i]=(0,n.useState)(""),[c,o]=(0,n.useState)(!1);async function u(){if(r.trim()){o(!0);try{await l(r.trim()),i("")}finally{o(!1)}}}return(0,s.jsxs)("section",{className:"panel stack",children:[(0,s.jsx)("h3",{style:{margin:0},children:"Game Chat"}),(0,s.jsx)("div",{className:"chat-box",children:0===t.length?(0,s.jsx)("p",{className:"muted",children:"No chat messages yet."}):t.map(e=>{var t;return(0,s.jsxs)("div",{className:"chat-msg",children:[(0,s.jsx)("strong",{children:null!==(t=e.user.email)&&void 0!==t?t:e.user.id}),(0,s.jsx)("p",{style:{margin:"0.2rem 0"},children:e.body}),(0,s.jsx)("p",{className:"muted",children:new Date(e.createdAt).toLocaleString()})]},e.id)})}),a?(0,s.jsxs)("div",{className:"row",children:[(0,s.jsx)("input",{value:r,onChange:e=>i(e.target.value),placeholder:"Type a message",style:{flex:1}}),(0,s.jsx)("button",{type:"button",className:"primary",disabled:c||!r.trim(),onClick:()=>void u(),children:"Send"})]}):(0,s.jsx)("p",{className:"muted",children:"Only authenticated players can post to chat."})]})}function d(e){var t,a;let{gameId:c,currentUserId:d}=e,[m,h]=(0,n.useState)(null),[v,p]=(0,n.useState)(null),[g,f]=(0,n.useState)([]),[y,b]=(0,n.useState)([]),[j,x]=(0,n.useState)(null),[w,N]=(0,n.useState)(null),[k,S]=(0,n.useState)(null),[C,_]=(0,n.useState)(!0),[M,E]=(0,n.useState)([]),[q,T]=(0,n.useState)("board"),[U,D]=(0,n.useState)(0),I=(0,n.useRef)(0),O=(0,n.useRef)("board"),G=(0,n.useCallback)(async()=>{_(!0),S(null);try{let[e,t,a,s]=await Promise.all([(0,i._)("get_game",{gameId:c}),(0,i._)("status",{gameId:c}),(0,i._)("history",{gameId:c}),(0,i._)("get_chat_messages",{gameId:c,limit:80})]);h(e.game),p(t),f(a.moves),b(s.messages),D(0)}catch(e){S(e instanceof Error?e.message:"Failed to load game")}finally{_(!1)}},[c]);(0,n.useEffect)(()=>{G()},[G]),(0,n.useEffect)(()=>{O.current=q,"chat"===q&&D(0)},[q]);let P=(0,n.useCallback)(async()=>{b((await (0,i._)("get_chat_messages",{gameId:c,limit:80})).messages)},[c]);(0,n.useEffect)(()=>{let e=new r.Realtime({authUrl:"/api/ably/token",autoConnect:!0,closeOnUnload:!0}),t=e.channels.get("game:".concat(c)),a=e=>{if("chat.created"===e.name){"chat"===O.current?P():"object"==typeof e.data&&null!==e.data&&"userId"in e.data&&e.data.userId===d||D(e=>e+1);return}("move.created"===e.name||"game.finished"===e.name||"game.created"===e.name)&&G()};return t.subscribe(a),()=>{t.unsubscribe(a),e.close()}},[c,d,G,P]);let A=(0,n.useMemo)(()=>{var e;let t=new Map;for(let a of null!==(e=null==v?void 0:v.pieces)&&void 0!==e?e:[])t.set(a.square,a);return t},[null==v?void 0:v.pieces]),B=(0,n.useMemo)(()=>m&&d?m.white.id===d?"w":m.black.id===d?"b":null:null,[m,d]),F=(null==v?void 0:v.gameStatus)==="ACTIVE",L=!!((null==m?void 0:m.canMove)&&B&&F),R=!!(L&&(null==v?void 0:v.turn)===B),W=(0,n.useMemo)(()=>{if(!v||F)return null;if(v.isCheckmate){var e,t;let a="w"===v.turn?null==m?void 0:m.black:null==m?void 0:m.white;return"Checkmate. Winner: ".concat(null!==(t=null!==(e=null==a?void 0:a.email)&&void 0!==e?e:null==a?void 0:a.id)&&void 0!==t?t:"Unknown player",".")}return v.isDraw||v.isStalemate?"Game over: Draw.":"Game finished."},[v,F,m]);function H(e,t){let a=I.current+1;I.current=a,E(s=>[...s,{id:a,level:e,message:t}]),setTimeout(()=>{E(e=>e.filter(e=>e.id!==a))},3200)}async function J(e){if(!v||!(null==m?void 0:m.canMove)||!B)return;if(v.turn!==B){H("warning","Not your turn.");return}if(!j){let t=A.get(e);if(!t||t.color!==B){H("warning","Select one of your pieces first.");return}x(e);return}if(j===e){x(null);return}let t=A.get(e);if((null==t?void 0:t.color)===B){x(e);return}if(!new l.qQ(v.fen).moves({square:j,verbose:!0}).map(e=>e.to).includes(e)){H("warning","That destination is not legal for the selected piece.");return}S(null);try{await (0,i._)("move_piece",{gameId:c,from:j,to:e,promotion:"q"}),x(null),await G()}catch(t){let e=t instanceof Error?t.message:"Move failed";S(e),e.includes("Illegal move")?H("error","Illegal move. This move would break chess rules (for example, exposing your king)."):e.includes("not your turn")&&H("warning","Not your turn."),x(null)}}async function V(e){await (0,i._)("post_chat_message",{gameId:c,body:e}),b((await (0,i._)("get_chat_messages",{gameId:c,limit:80})).messages),D(0)}async function Y(){S(null);try{let e=await (0,i._)("snapshot",{gameId:c,size:560});N(e.dataUrl)}catch(e){S(e instanceof Error?e.message:"Snapshot failed")}}return((0,n.useEffect)(()=>{R&&"board"===q||x(null)},[R,q]),C)?(0,s.jsx)("p",{className:"muted",children:"Loading game..."}):m&&v?(0,s.jsxs)("div",{className:"stack",style:{marginTop:"1rem"},children:[(0,s.jsx)("div",{className:"toast-stack","aria-live":"polite",children:M.map(e=>(0,s.jsx)("div",{className:"toast ".concat("error"===e.level?"toast-error":"toast-warning"),children:e.message},e.id))}),(0,s.jsxs)("section",{className:"panel stack",children:[(0,s.jsxs)("div",{className:"row",style:{justifyContent:"space-between"},children:[(0,s.jsxs)("h2",{style:{margin:0},children:[null!==(t=m.white.email)&&void 0!==t?t:m.white.id," vs ",null!==(a=m.black.email)&&void 0!==a?a:m.black.id]}),(0,s.jsx)("strong",{children:v.gameStatus})]}),(0,s.jsxs)("p",{className:"muted",children:["Turn: ","w"===v.turn?"White":"Black"," • Moves: ",m.moveCount]}),W&&(0,s.jsx)("div",{className:"game-result-banner",children:W}),(0,s.jsxs)("div",{className:"tabs",children:[(0,s.jsx)("button",{className:"tab ".concat("board"===q?"active":""),type:"button",onClick:()=>T("board"),children:"Board"}),(0,s.jsx)("button",{className:"tab ".concat("history"===q?"active":""),type:"button",onClick:()=>T("history"),children:"Move History"}),(0,s.jsxs)("button",{className:"tab ".concat("chat"===q?"active":""),type:"button",onClick:()=>T("chat"),children:["Chat",U>0&&(0,s.jsx)("span",{className:"tab-badge",children:U})]})]}),"board"===q&&(0,s.jsxs)(s.Fragment,{children:[L?R?(0,s.jsx)("div",{className:"turn-banner my-turn",children:"Your turn to move"}):(0,s.jsx)("div",{className:"turn-banner waiting-turn",children:"Not your turn. Waiting for opponent."}):(0,s.jsx)("div",{className:"turn-banner spectator-turn",children:"You can view this game, but only the two players can move."}),(0,s.jsxs)("div",{className:"row",children:[v.isCheck&&(0,s.jsx)("span",{children:"Check"}),v.isCheckmate&&(0,s.jsx)("span",{children:"Checkmate"}),v.isStalemate&&(0,s.jsx)("span",{children:"Stalemate"}),v.isDraw&&(0,s.jsx)("span",{children:"Draw"})]}),(0,s.jsx)(o,{pieces:v.pieces,selectedSquare:j,onSquareClick:e=>void J(e),interactive:R,orientation:"b"===B?"black":"white"}),(0,s.jsx)("p",{className:"muted",children:R?"Select one of your pieces, then a destination square.":"Board is locked until your turn."})]}),"history"===q&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"row",style:{justifyContent:"space-between"},children:[(0,s.jsx)("h3",{style:{margin:0},children:"History"}),(0,s.jsx)("button",{type:"button",className:"primary",onClick:()=>void Y(),children:"Snapshot"})]}),0===g.length?(0,s.jsx)("p",{className:"muted",children:"No moves yet."}):(0,s.jsx)("ul",{className:"game-list",children:g.map(e=>{var t;return(0,s.jsxs)("li",{children:[(0,s.jsxs)("strong",{children:[e.ply,". ",e.san]}),(0,s.jsxs)("p",{className:"muted",children:[null!==(t=e.byUser.email)&&void 0!==t?t:e.byUser.id," • ",new Date(e.createdAt).toLocaleString()]})]},e.id)})}),w&&(0,s.jsx)("img",{src:w,alt:"Chess board snapshot",className:"snapshot"})]}),"chat"===q&&(0,s.jsx)(u,{messages:y,canSend:!!(m.canMove&&d),onSend:V})]}),k&&(0,s.jsx)("p",{className:"error",children:k})]}):(0,s.jsx)("p",{className:"error",children:"Game unavailable."})}},9297:function(e,t,a){"use strict";async function s(e){var t,a,s,n,l;let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=await fetch("/api/mcp",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({jsonrpc:"2.0",id:crypto.randomUUID(),method:"tools/call",params:{name:e,arguments:r}}),credentials:"same-origin"}),c=await i.json();if(c.error)throw Error(null!==(l=c.error.message)&&void 0!==l?l:"MCP call failed");let o=null==c?void 0:null===(t=c.result)||void 0===t?void 0:t.structuredContent;if(void 0!==o)return o;let u=null==c?void 0:null===(n=c.result)||void 0===n?void 0:null===(s=n.content)||void 0===s?void 0:null===(a=s[0])||void 0===a?void 0:a.text;if("string"==typeof u)return JSON.parse(u);throw Error("Invalid MCP response")}a.d(t,{_:function(){return s}})}},function(e){e.O(0,[329,994,649,945,744],function(){return e(e.s=1743)}),_N_E=e.O()}]);