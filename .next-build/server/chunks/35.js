exports.id=35,exports.ids=[35],exports.modules={88089:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});let s=["Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"],r=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Blob","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","FormData","URLSearchParams","HTMLElement",...s],n=["null","undefined","string","number","bigint","boolean","symbol"];function i(e){return t=>typeof t===e}let{toString:o}=Object.prototype,a=e=>{let t=o.call(e).slice(8,-1);return/HTML\w+Element/.test(t)&&c.domElement(e)?"HTMLElement":r.includes(t)?t:void 0},l=e=>t=>a(t)===e;function c(e){if(null===e)return"null";switch(typeof e){case"undefined":return"undefined";case"string":return"string";case"number":return"number";case"boolean":return"boolean";case"function":return"Function";case"bigint":return"bigint";case"symbol":return"symbol"}if(c.observable(e))return"Observable";if(c.array(e))return"Array";if(c.buffer(e))return"Buffer";let t=a(e);if(t)return t;if(e instanceof String||e instanceof Boolean||e instanceof Number)throw TypeError("Please don't use object wrappers for primitive types");return"Object"}c.undefined=i("undefined"),c.string=i("string");let h=i("number");c.number=e=>h(e)&&!c.nan(e),c.bigint=i("bigint"),c.function_=i("function"),c.null_=e=>null===e,c.class_=e=>c.function_(e)&&e.toString().startsWith("class "),c.boolean=e=>!0===e||!1===e,c.symbol=i("symbol"),c.numericString=e=>c.string(e)&&!c.emptyStringOrWhitespace(e)&&!Number.isNaN(Number(e)),c.array=(e,t)=>!!Array.isArray(e)&&(!c.function_(t)||e.every(t)),c.buffer=e=>{var t,s,r;return null!==(r=null===(s=null===(t=null==e?void 0:e.constructor)||void 0===t?void 0:t.isBuffer)||void 0===s?void 0:s.call(t,e))&&void 0!==r&&r},c.blob=e=>l("Blob")(e),c.nullOrUndefined=e=>c.null_(e)||c.undefined(e),c.object=e=>!c.null_(e)&&("object"==typeof e||c.function_(e)),c.iterable=e=>c.function_(null==e?void 0:e[Symbol.iterator]),c.asyncIterable=e=>c.function_(null==e?void 0:e[Symbol.asyncIterator]),c.generator=e=>c.iterable(e)&&c.function_(null==e?void 0:e.next)&&c.function_(null==e?void 0:e.throw),c.asyncGenerator=e=>c.asyncIterable(e)&&c.function_(e.next)&&c.function_(e.throw),c.nativePromise=e=>l("Promise")(e);let u=e=>c.function_(null==e?void 0:e.then)&&c.function_(null==e?void 0:e.catch);c.promise=e=>c.nativePromise(e)||u(e),c.generatorFunction=l("GeneratorFunction"),c.asyncGeneratorFunction=e=>"AsyncGeneratorFunction"===a(e),c.asyncFunction=e=>"AsyncFunction"===a(e),c.boundFunction=e=>c.function_(e)&&!e.hasOwnProperty("prototype"),c.regExp=l("RegExp"),c.date=l("Date"),c.error=l("Error"),c.map=e=>l("Map")(e),c.set=e=>l("Set")(e),c.weakMap=e=>l("WeakMap")(e),c.weakSet=e=>l("WeakSet")(e),c.int8Array=l("Int8Array"),c.uint8Array=l("Uint8Array"),c.uint8ClampedArray=l("Uint8ClampedArray"),c.int16Array=l("Int16Array"),c.uint16Array=l("Uint16Array"),c.int32Array=l("Int32Array"),c.uint32Array=l("Uint32Array"),c.float32Array=l("Float32Array"),c.float64Array=l("Float64Array"),c.bigInt64Array=l("BigInt64Array"),c.bigUint64Array=l("BigUint64Array"),c.arrayBuffer=l("ArrayBuffer"),c.sharedArrayBuffer=l("SharedArrayBuffer"),c.dataView=l("DataView"),c.enumCase=(e,t)=>Object.values(t).includes(e),c.directInstanceOf=(e,t)=>Object.getPrototypeOf(e)===t.prototype,c.urlInstance=e=>l("URL")(e),c.urlString=e=>{if(!c.string(e))return!1;try{return new URL(e),!0}catch(e){return!1}},c.truthy=e=>!!e,c.falsy=e=>!e,c.nan=e=>Number.isNaN(e),c.primitive=e=>{var t;return c.null_(e)||(t=typeof e,n.includes(t))},c.integer=e=>Number.isInteger(e),c.safeInteger=e=>Number.isSafeInteger(e),c.plainObject=e=>{if("[object Object]"!==o.call(e))return!1;let t=Object.getPrototypeOf(e);return null===t||t===Object.getPrototypeOf({})},c.typedArray=e=>{var t;return t=a(e),s.includes(t)};let d=e=>c.safeInteger(e)&&e>=0;c.arrayLike=e=>!c.nullOrUndefined(e)&&!c.function_(e)&&d(e.length),c.inRange=(e,t)=>{if(c.number(t))return e>=Math.min(0,t)&&e<=Math.max(t,0);if(c.array(t)&&2===t.length)return e>=Math.min(...t)&&e<=Math.max(...t);throw TypeError(`Invalid range: ${JSON.stringify(t)}`)};let f=["innerHTML","ownerDocument","style","attributes","nodeValue"];c.domElement=e=>c.object(e)&&1===e.nodeType&&c.string(e.nodeName)&&!c.plainObject(e)&&f.every(t=>t in e),c.observable=e=>{var t,s;return!!e&&(e===(null===(t=e[Symbol.observable])||void 0===t?void 0:t.call(e))||e===(null===(s=e["@@observable"])||void 0===s?void 0:s.call(e)))},c.nodeStream=e=>c.object(e)&&c.function_(e.pipe)&&!c.observable(e),c.infinite=e=>e===1/0||e===-1/0;let p=e=>t=>c.integer(t)&&Math.abs(t%2)===e;c.evenInteger=p(0),c.oddInteger=p(1),c.emptyArray=e=>c.array(e)&&0===e.length,c.nonEmptyArray=e=>c.array(e)&&e.length>0,c.emptyString=e=>c.string(e)&&0===e.length;let g=e=>c.string(e)&&!/\S/.test(e);c.emptyStringOrWhitespace=e=>c.emptyString(e)||g(e),c.nonEmptyString=e=>c.string(e)&&e.length>0,c.nonEmptyStringAndNotWhitespace=e=>c.string(e)&&!c.emptyStringOrWhitespace(e),c.emptyObject=e=>c.object(e)&&!c.map(e)&&!c.set(e)&&0===Object.keys(e).length,c.nonEmptyObject=e=>c.object(e)&&!c.map(e)&&!c.set(e)&&Object.keys(e).length>0,c.emptySet=e=>c.set(e)&&0===e.size,c.nonEmptySet=e=>c.set(e)&&e.size>0,c.emptyMap=e=>c.map(e)&&0===e.size,c.nonEmptyMap=e=>c.map(e)&&e.size>0,c.propertyKey=e=>c.any([c.string,c.number,c.symbol],e),c.formData=e=>l("FormData")(e),c.urlSearchParams=e=>l("URLSearchParams")(e);let m=(e,t,s)=>{if(!c.function_(t))throw TypeError(`Invalid predicate: ${JSON.stringify(t)}`);if(0===s.length)throw TypeError("Invalid number of values");return e.call(s,t)};c.any=(e,...t)=>(c.array(e)?e:[e]).some(e=>m(Array.prototype.some,e,t)),c.all=(e,...t)=>m(Array.prototype.every,e,t);let y=(e,t,s,r={})=>{if(!e){let{multipleValues:e}=r,n=e?`received values of types ${[...new Set(s.map(e=>`\`${c(e)}\``))].join(", ")}`:`received value of type \`${c(s)}\``;throw TypeError(`Expected value which is \`${t}\`, ${n}.`)}};t.assert={undefined:e=>y(c.undefined(e),"undefined",e),string:e=>y(c.string(e),"string",e),number:e=>y(c.number(e),"number",e),bigint:e=>y(c.bigint(e),"bigint",e),function_:e=>y(c.function_(e),"Function",e),null_:e=>y(c.null_(e),"null",e),class_:e=>y(c.class_(e),"Class",e),boolean:e=>y(c.boolean(e),"boolean",e),symbol:e=>y(c.symbol(e),"symbol",e),numericString:e=>y(c.numericString(e),"string with a number",e),array:(e,t)=>{y(c.array(e),"Array",e),t&&e.forEach(t)},buffer:e=>y(c.buffer(e),"Buffer",e),blob:e=>y(c.blob(e),"Blob",e),nullOrUndefined:e=>y(c.nullOrUndefined(e),"null or undefined",e),object:e=>y(c.object(e),"Object",e),iterable:e=>y(c.iterable(e),"Iterable",e),asyncIterable:e=>y(c.asyncIterable(e),"AsyncIterable",e),generator:e=>y(c.generator(e),"Generator",e),asyncGenerator:e=>y(c.asyncGenerator(e),"AsyncGenerator",e),nativePromise:e=>y(c.nativePromise(e),"native Promise",e),promise:e=>y(c.promise(e),"Promise",e),generatorFunction:e=>y(c.generatorFunction(e),"GeneratorFunction",e),asyncGeneratorFunction:e=>y(c.asyncGeneratorFunction(e),"AsyncGeneratorFunction",e),asyncFunction:e=>y(c.asyncFunction(e),"AsyncFunction",e),boundFunction:e=>y(c.boundFunction(e),"Function",e),regExp:e=>y(c.regExp(e),"RegExp",e),date:e=>y(c.date(e),"Date",e),error:e=>y(c.error(e),"Error",e),map:e=>y(c.map(e),"Map",e),set:e=>y(c.set(e),"Set",e),weakMap:e=>y(c.weakMap(e),"WeakMap",e),weakSet:e=>y(c.weakSet(e),"WeakSet",e),int8Array:e=>y(c.int8Array(e),"Int8Array",e),uint8Array:e=>y(c.uint8Array(e),"Uint8Array",e),uint8ClampedArray:e=>y(c.uint8ClampedArray(e),"Uint8ClampedArray",e),int16Array:e=>y(c.int16Array(e),"Int16Array",e),uint16Array:e=>y(c.uint16Array(e),"Uint16Array",e),int32Array:e=>y(c.int32Array(e),"Int32Array",e),uint32Array:e=>y(c.uint32Array(e),"Uint32Array",e),float32Array:e=>y(c.float32Array(e),"Float32Array",e),float64Array:e=>y(c.float64Array(e),"Float64Array",e),bigInt64Array:e=>y(c.bigInt64Array(e),"BigInt64Array",e),bigUint64Array:e=>y(c.bigUint64Array(e),"BigUint64Array",e),arrayBuffer:e=>y(c.arrayBuffer(e),"ArrayBuffer",e),sharedArrayBuffer:e=>y(c.sharedArrayBuffer(e),"SharedArrayBuffer",e),dataView:e=>y(c.dataView(e),"DataView",e),enumCase:(e,t)=>y(c.enumCase(e,t),"EnumCase",e),urlInstance:e=>y(c.urlInstance(e),"URL",e),urlString:e=>y(c.urlString(e),"string with a URL",e),truthy:e=>y(c.truthy(e),"truthy",e),falsy:e=>y(c.falsy(e),"falsy",e),nan:e=>y(c.nan(e),"NaN",e),primitive:e=>y(c.primitive(e),"primitive",e),integer:e=>y(c.integer(e),"integer",e),safeInteger:e=>y(c.safeInteger(e),"integer",e),plainObject:e=>y(c.plainObject(e),"plain object",e),typedArray:e=>y(c.typedArray(e),"TypedArray",e),arrayLike:e=>y(c.arrayLike(e),"array-like",e),domElement:e=>y(c.domElement(e),"HTMLElement",e),observable:e=>y(c.observable(e),"Observable",e),nodeStream:e=>y(c.nodeStream(e),"Node.js Stream",e),infinite:e=>y(c.infinite(e),"infinite number",e),emptyArray:e=>y(c.emptyArray(e),"empty array",e),nonEmptyArray:e=>y(c.nonEmptyArray(e),"non-empty array",e),emptyString:e=>y(c.emptyString(e),"empty string",e),emptyStringOrWhitespace:e=>y(c.emptyStringOrWhitespace(e),"empty string or whitespace",e),nonEmptyString:e=>y(c.nonEmptyString(e),"non-empty string",e),nonEmptyStringAndNotWhitespace:e=>y(c.nonEmptyStringAndNotWhitespace(e),"non-empty string and not whitespace",e),emptyObject:e=>y(c.emptyObject(e),"empty object",e),nonEmptyObject:e=>y(c.nonEmptyObject(e),"non-empty object",e),emptySet:e=>y(c.emptySet(e),"empty set",e),nonEmptySet:e=>y(c.nonEmptySet(e),"non-empty set",e),emptyMap:e=>y(c.emptyMap(e),"empty map",e),nonEmptyMap:e=>y(c.nonEmptyMap(e),"non-empty map",e),propertyKey:e=>y(c.propertyKey(e),"PropertyKey",e),formData:e=>y(c.formData(e),"FormData",e),urlSearchParams:e=>y(c.urlSearchParams(e),"URLSearchParams",e),evenInteger:e=>y(c.evenInteger(e),"even integer",e),oddInteger:e=>y(c.oddInteger(e),"odd integer",e),directInstanceOf:(e,t)=>y(c.directInstanceOf(e,t),"T",e),inRange:(e,t)=>y(c.inRange(e,t),"in range",e),any:(e,...t)=>y(c.any(e,...t),"predicate returns truthy for any value",t,{multipleValues:!0}),all:(e,...t)=>y(c.all(e,...t),"predicate returns truthy for all values",t,{multipleValues:!0})},Object.defineProperties(c,{class:{value:c.class_},function:{value:c.function_},null:{value:c.null_}}),Object.defineProperties(t.assert,{class:{value:t.assert.class_},function:{value:t.assert.function_},null:{value:t.assert.null_}}),t.default=c,e.exports=c,e.exports.default=c,e.exports.assert=t.assert},56991:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});let r=s(6152),n=s(21764),i=Number(process.versions.node.split(".")[0]),o=e=>{if(e.timings)return e.timings;let t={start:Date.now(),socket:void 0,lookup:void 0,connect:void 0,secureConnect:void 0,upload:void 0,response:void 0,end:void 0,error:void 0,abort:void 0,phases:{wait:void 0,dns:void 0,tcp:void 0,tls:void 0,request:void 0,firstByte:void 0,download:void 0,total:void 0}};e.timings=t;let s=e=>{let s=e.emit.bind(e);e.emit=(r,...n)=>("error"===r&&(t.error=Date.now(),t.phases.total=t.error-t.start,e.emit=s),s(r,...n))};s(e);let o=()=>{t.abort=Date.now(),(!t.response||i>=13)&&(t.phases.total=Date.now()-t.start)};e.prependOnceListener("abort",o);let a=e=>{if(t.socket=Date.now(),t.phases.wait=t.socket-t.start,n.types.isProxy(e))return;let s=()=>{t.lookup=Date.now(),t.phases.dns=t.lookup-t.socket};e.prependOnceListener("lookup",s),r.default(e,{connect:()=>{t.connect=Date.now(),void 0===t.lookup&&(e.removeListener("lookup",s),t.lookup=t.connect,t.phases.dns=t.lookup-t.socket),t.phases.tcp=t.connect-t.lookup},secureConnect:()=>{t.secureConnect=Date.now(),t.phases.tls=t.secureConnect-t.connect}})};e.socket?a(e.socket):e.prependOnceListener("socket",a);let l=()=>{var e;t.upload=Date.now(),t.phases.request=t.upload-(null!==(e=t.secureConnect)&&void 0!==e?e:t.connect)};return("boolean"==typeof e.writableFinished?e.writableFinished:e.finished&&0===e.outputSize&&(!e.socket||0===e.socket.writableLength))?l():e.prependOnceListener("finish",l),e.prependOnceListener("response",e=>{t.response=Date.now(),t.phases.firstByte=t.response-t.upload,e.timings=t,s(e),e.prependOnceListener("end",()=>{t.end=Date.now(),t.phases.download=t.end-t.response,t.phases.total=t.end-t.start}),e.prependOnceListener("aborted",o)}),t};t.default=o,e.exports=o,e.exports.default=o},2589:function(e,t,s){var r;r=(e,t)=>{"use strict";var r,n,i,o,a,l,c,h={},u={exports:h},d=Object.create,f=Object.defineProperty,p=Object.defineProperties,g=Object.getOwnPropertyDescriptor,m=Object.getOwnPropertyDescriptors,y=Object.getOwnPropertyNames,b=Object.getOwnPropertySymbols,_=Object.getPrototypeOf,v=Object.prototype.hasOwnProperty,w=Object.prototype.propertyIsEnumerable,S=(e,t,s)=>t in e?f(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,O=(e,t)=>{for(var s in t||(t={}))v.call(t,s)&&S(e,s,t[s]);if(b)for(var s of b(t))w.call(t,s)&&S(e,s,t[s]);return e},E=(e,t)=>p(e,m(t)),k=(e,t)=>{var s={};for(var r in e)v.call(e,r)&&0>t.indexOf(r)&&(s[r]=e[r]);if(null!=e&&b)for(var r of b(e))0>t.indexOf(r)&&w.call(e,r)&&(s[r]=e[r]);return s},C=(e,t)=>function(){return t||(0,e[y(e)[0]])((t={exports:{}}).exports,t),t.exports},R=(e,t,s,r)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let n of y(t))v.call(e,n)||n===s||f(e,n,{get:()=>t[n],enumerable:!(r=g(t,n))||r.enumerable});return e},T=(e,t,s)=>(s=null!=e?d(_(e)):{},R(!t&&e&&e.__esModule?s:f(s,"default",{value:e,enumerable:!0}),e)),A=function(e,t){this[0]=e,this[1]=t},P=(e,t,s)=>{var r=(e,t,n,i)=>{try{var o=s[e](t),a=(t=o.value)instanceof A,l=o.done;Promise.resolve(a?t[0]:t).then(s=>a?r("return"===e?e:"next",t[1]?{done:s.done,value:s.value}:s,n,i):n({value:s,done:l})).catch(e=>r("throw",e,n,i))}catch(e){i(e)}},n=e=>i[e]=t=>new Promise((s,n)=>r(e,t,s,n)),i={};return s=s.apply(e,t),i[Symbol.asyncIterator]=()=>i,n("next"),n("throw"),n("return"),i},M=C({"node_modules/bops/from.js"(e,t){var r=s(78893).Buffer,n=((process||{}).version||"v0.0.0").slice(1).split(".")[0];t.exports=6>Number(n)?function(e,t){return new r(e,t)}:function(e,t){return r.from(e,t)}}}),I=C({"node_modules/bops/to.js"(e,t){t.exports=function(e,t){return e.toString(t)}}}),x=C({"node_modules/bops/is.js"(e,t){var r=s(78893).Buffer;t.exports=function(e){return r.isBuffer(e)}}}),L=C({"node_modules/bops/subarray.js"(e,t){t.exports=function(e,t,s){return 2==arguments.length?e.slice(t):e.slice(t,s)}}}),N=C({"node_modules/bops/join.js"(e,t){var r=s(78893).Buffer;t.exports=function(e,t){return void 0!==t?r.concat(e,t):r.concat(e)}}}),U=C({"node_modules/bops/copy.js"(e,t){t.exports=function(e,t,s,r,n){return e.copy(t,s,r,n)}}}),j=C({"node_modules/bops/create.js"(e,t){var r=s(78893).Buffer,n=((process||{}).version||"v0.0.0").slice(1).split(".")[0];t.exports=6>Number(n)?function(e){return new r(e)}:function(e){return r.alloc(e)}}}),B=C({"node_modules/bops/read.js"(e,t){var s,r,n={},i=/read.+/;for(r in s=function(e){return Function(["buf","a","b","c"],"return buf."+e+"(a,b,c)")},t.exports=n,Buffer.prototype)i.test(r)&&(n[r]=s(r))}}),q=C({"node_modules/bops/write.js"(e,t){var r,n,i=s(78893).Buffer,o={},a=/write.+/;for(n in r=function(e){return Function(["buf","a","b","c"],"return buf."+e+"(a,b,c)")},t.exports=o,i.prototype)a.test(n)&&(o[n]=r(n))}}),D=C({"node_modules/bops/index.js"(e,t){var s={};function r(e,t){for(var s in e)t[s]=e[s]}t.exports=s,s.from=M(),s.to=I(),s.is=x(),s.subarray=L(),s.join=N(),s.copy=U(),s.create=j(),r(B(),s),r(q(),s)}}),G=C({"node_modules/@ably/msgpack-js/msgpack.js"(e){var t=D();e.encode=function(e,r){var i=function e(s,r,i){var o,a,l=typeof s;if("string"===l){if((o=t.from(s).length)<32)return 1+o;if(o<256)return 2+o;if(o<65536)return 3+o;if(o<4294967296)return 5+o}if(t.is(s)){if((o=s.length)<256)return 2+o;if(o<65536)return 3+o;if(o<4294967296)return 5+o}if("number"===l){if(Math.floor(s)!==s)return 9;if(s>=0){if(s<128)return 1;if(s<256)return 2;if(s<65536)return 3;if(s<4294967296)return 5;if(s<18446744073709552e3)return 9;throw Error("Number too big 0x"+s.toString(16))}if(s>=-32)return 1;if(s>=-128)return 2;if(s>=-32768)return 3;if(s>=-2147483648)return 5;if(s>=-0x8000000000000000)return 9;throw Error("Number too small -0x"+s.toString(16).substr(1))}if("boolean"===l)return 1;if(null===s)return r&&i?0:1;if(void 0===s)return r&&i?0:3;if("function"==typeof s.toJSON)return e(s.toJSON(),r);if("object"===l){if(a=0,Array.isArray(s)){o=s.length;for(var c=0;c<o;c++)a+=e(s[c],r)}else{var h=n(s,r);o=h.length;for(var c=0;c<o;c++){var u=h[c];a+=e(u)+e(s[u],r,!0)}}if(o<16)return 1+a;if(o<65536)return 3+a;if(o<4294967296)return 5+a;throw Error("Array or object too long 0x"+o.toString(16))}if("function"===l)return 0;throw Error("Unknown type "+l)}(e,r);if(0!=i){var o=t.create(i);return function e(r,i,o,a,l){var c,h,u,d,f,p,g=typeof r;if("string"===g){if((f=(r=t.from(r)).length)<32)return i[o]=160|f,t.copy(r,i,o+1),1+f;if(f<256)return i[o]=217,t.writeUInt8(i,f,o+1),t.copy(r,i,o+2),2+f;if(f<65536)return i[o]=218,t.writeUInt16BE(i,f,o+1),t.copy(r,i,o+3),3+f;if(f<4294967296)return i[o]=219,t.writeUInt32BE(i,f,o+1),t.copy(r,i,o+5),5+f}if(t.is(r)){if((f=r.length)<256)return i[o]=196,t.writeUInt8(i,f,o+1),t.copy(r,i,o+2),2+f;if(f<65536)return i[o]=197,t.writeUInt16BE(i,f,o+1),t.copy(r,i,o+3),3+f;if(f<4294967296)return i[o]=198,t.writeUInt32BE(i,f,o+1),t.copy(r,i,o+5),5+f}if("number"===g){if(Math.floor(r)!==r)return i[o]=203,t.writeDoubleBE(i,r,o+1),9;if(r>=0){if(r<128)return i[o]=r,1;if(r<256)return i[o]=204,i[o+1]=r,2;if(r<65536)return i[o]=205,t.writeUInt16BE(i,r,o+1),3;if(r<4294967296)return i[o]=206,t.writeUInt32BE(i,r,o+1),5;if(r<18446744073709552e3)return i[o]=207,c=r,h=o+1,c<18446744073709552e3?(i.writeUInt32BE(Math.floor(c*s),h),i.writeInt32BE(-1&c,h+4)):(i.writeUInt32BE(4294967295,h),i.writeUInt32BE(4294967295,h+4)),9;throw Error("Number too big 0x"+r.toString(16))}if(r>=-32)return t.writeInt8(i,r,o),1;if(r>=-128)return i[o]=208,t.writeInt8(i,r,o+1),2;if(r>=-32768)return i[o]=209,t.writeInt16BE(i,r,o+1),3;if(r>=-2147483648)return i[o]=210,t.writeInt32BE(i,r,o+1),5;if(r>=-0x8000000000000000)return i[o]=211,u=r,d=o+1,u<0x7fffffffffffffff?(i.writeInt32BE(Math.floor(u*s),d),i.writeInt32BE(-1&u,d+4)):(i.writeUInt32BE(2147483647,d),i.writeUInt32BE(4294967295,d+4)),9;throw Error("Number too small -0x"+r.toString(16).substr(1))}if("undefined"===g)return a&&l?0:(i[o]=212,i[o+1]=0,i[o+2]=0,3);if(null===r)return a&&l?0:(i[o]=192,1);if("boolean"===g)return i[o]=r?195:194,1;if("function"==typeof r.toJSON)return e(r.toJSON(),i,o,a);if("object"===g){p=0;var m=Array.isArray(r);if(m)f=r.length;else{var y=n(r,a);f=y.length}if(f<16?(i[o]=f|(m?144:128),p=1):f<65536?(i[o]=m?220:222,t.writeUInt16BE(i,f,o+1),p=3):f<4294967296&&(i[o]=m?221:223,t.writeUInt32BE(i,f,o+1),p=5),m)for(var b=0;b<f;b++)p+=e(r[b],i,o+p,a);else for(var b=0;b<f;b++){var _=y[b];p+=e(_,i,o+p),p+=e(r[_],i,o+p,a,!0)}return p}if("function"!==g)throw Error("Unknown type "+g)}(e,o,0,r),o}},e.decode=function(e){var t=new r(e),s=t.parse();if(t.offset!==e.length)throw Error(e.length-t.offset+" trailing bytes");return s};var s=23283064365386963e-26;function r(e,t){this.offset=t||0,this.buffer=e,this.bufferLength=e.length}function n(e,t){return Object.keys(e).filter(function(s){var r=e[s];return(!t||null!=r)&&("function"!=typeof r||!!r.toJSON)})}r.prototype.map=function(e){if(2*e>this.bufferLength)throw Error(`malformed messagepack detected: buffer size was ${this.bufferLength}, but referenced a map of length ${e})`);for(var t={},s=0;s<e;s++)t[this.parse()]=this.parse();return t},r.prototype.bin=r.prototype.buf=function(e){if(e>this.bufferLength)throw Error(`malformed messagepack detected: buffer size was ${this.bufferLength}, but referenced a binary of length ${e})`);var s=t.subarray(this.buffer,this.offset,this.offset+e);return this.offset+=e,s},r.prototype.str=function(e){if(e>this.bufferLength)throw Error(`malformed messagepack detected: buffer size was ${this.bufferLength}, but referenced a string of length ${e})`);var s=t.to(t.subarray(this.buffer,this.offset,this.offset+e));return this.offset+=e,s},r.prototype.array=function(e){if(e>this.bufferLength)throw Error(`malformed messagepack detected: buffer size was ${this.bufferLength}, but referenced an array of length ${e})`);for(var t=Array(e),s=0;s<e;s++)t[s]=this.parse();return t},r.prototype.parse=function(){var e,s,r,n,i,o,a,l=this.buffer[this.offset];if(void 0===l)throw Error("malformed messagepack (referenced offset is outside buffer)");if((128&l)==0)return this.offset++,l;if((240&l)==128)return o=15&l,this.offset++,this.map(o);if((240&l)==144)return o=15&l,this.offset++,this.array(o);if((224&l)==160)return o=31&l,this.offset++,this.str(o);if((224&l)==224)return i=t.readInt8(this.buffer,this.offset),this.offset++,i;switch(l){case 192:return this.offset++,null;case 194:return this.offset++,!1;case 195:return this.offset++,!0;case 196:return o=t.readUInt8(this.buffer,this.offset+1),this.offset+=2,this.bin(o);case 197:return o=t.readUInt16BE(this.buffer,this.offset+1),this.offset+=3,this.bin(o);case 198:return o=t.readUInt32BE(this.buffer,this.offset+1),this.offset+=5,this.bin(o);case 199:return o=t.readUInt8(this.buffer,this.offset+1),a=t.readUInt8(this.buffer,this.offset+2),this.offset+=3,[a,this.bin(o)];case 200:return o=t.readUInt16BE(this.buffer,this.offset+1),a=t.readUInt8(this.buffer,this.offset+3),this.offset+=4,[a,this.bin(o)];case 201:return o=t.readUInt32BE(this.buffer,this.offset+1),a=t.readUInt8(this.buffer,this.offset+5),this.offset+=6,[a,this.bin(o)];case 202:return i=t.readFloatBE(this.buffer,this.offset+1),this.offset+=5,i;case 203:return i=t.readDoubleBE(this.buffer,this.offset+1),this.offset+=9,i;case 204:return i=this.buffer[this.offset+1],this.offset+=2,i;case 205:return i=t.readUInt16BE(this.buffer,this.offset+1),this.offset+=3,i;case 206:return i=t.readUInt32BE(this.buffer,this.offset+1),this.offset+=5,i;case 207:return e=this.buffer,s=(s=this.offset+1)||0,i=4294967296*e.readUInt32BE(s+0)+e.readUInt32BE(s+4),this.offset+=9,i;case 208:return i=t.readInt8(this.buffer,this.offset+1),this.offset+=2,i;case 209:return i=t.readInt16BE(this.buffer,this.offset+1),this.offset+=3,i;case 210:return i=t.readInt32BE(this.buffer,this.offset+1),this.offset+=5,i;case 211:return r=this.buffer,n=(n=this.offset+1)||0,i=4294967296*r.readInt32BE(n+0)+r.readUInt32BE(n+4),this.offset+=9,i;case 212:return a=t.readUInt8(this.buffer,this.offset+1),i=t.readUInt8(this.buffer,this.offset+2),this.offset+=3,0===a&&0===i?void 0:[a,i];case 213:return a=t.readUInt8(this.buffer,this.offset+1),this.offset+=2,[a,this.bin(2)];case 214:return a=t.readUInt8(this.buffer,this.offset+1),this.offset+=2,[a,this.bin(4)];case 215:return a=t.readUInt8(this.buffer,this.offset+1),this.offset+=2,[a,this.bin(8)];case 216:return a=t.readUInt8(this.buffer,this.offset+1),this.offset+=2,[a,this.bin(16)];case 217:return o=t.readUInt8(this.buffer,this.offset+1),this.offset+=2,this.str(o);case 218:return o=t.readUInt16BE(this.buffer,this.offset+1),this.offset+=3,this.str(o);case 219:return o=t.readUInt32BE(this.buffer,this.offset+1),this.offset+=5,this.str(o);case 220:return o=t.readUInt16BE(this.buffer,this.offset+1),this.offset+=3,this.array(o);case 221:return o=t.readUInt32BE(this.buffer,this.offset+1),this.offset+=5,this.array(o);case 222:return o=t.readUInt16BE(this.buffer,this.offset+1),this.offset+=3,this.map(o);case 223:return o=t.readUInt32BE(this.buffer,this.offset+1),this.offset+=5,this.map(o)}throw Error("Unknown type 0x"+l.toString(16))}}}),H=class{},W="undefined"!=typeof global?global:"undefined"!=typeof window?window:self;function F(e,t){return`${e}`.padStart(t?3:2,"0")}function V(e){return H.Config.logTimestamps?function(t){let s=new Date;e(F(s.getHours())+":"+F(s.getMinutes())+":"+F(s.getSeconds())+"."+F(s.getMilliseconds(),1)+" "+t)}:function(t){e(t)}}var $=()=>{var e;let t,s;return"function"==typeof(null==(e=null==W?void 0:W.console)?void 0:e.log)?(t=function(...e){console.log.apply(console,e)},s=console.warn?function(...e){console.warn.apply(console,e)}:t):t=s=function(){},[t,s].map(V)},z=class e{constructor(){this.deprecated=(e,t)=>{this.deprecationWarning(`${e} is deprecated and will be removed in a future version. ${t}`)},this.shouldLog=e=>e<=this.logLevel,this.setLog=(e,t)=>{void 0!==e&&(this.logLevel=e),void 0!==t&&(this.logHandler=this.logErrorHandler=t)},this.logLevel=e.defaultLogLevel,this.logHandler=e.defaultLogHandler,this.logErrorHandler=e.defaultLogErrorHandler}static initLogHandlers(){let[t,s]=$();this.defaultLogHandler=t,this.defaultLogErrorHandler=s,this.defaultLogger=new e}static logActionNoStrip(e,t,s,r){e.logAction(t,s,r)}logAction(e,t,s){this.shouldLog(e)&&(1===e?this.logErrorHandler:this.logHandler)("Ably: "+t+": "+s,e)}renamedClientOption(e,t){this.deprecationWarning(`The \`${e}\` client option has been renamed to \`${t}\`. Please update your code to use \`${t}\` instead. \`${e}\` will be removed in a future version.`)}renamedMethod(e,t,s){this.deprecationWarning(`\`${e}\`\u2019s \`${t}\` method has been renamed to \`${s}\`. Please update your code to use \`${s}\` instead. \`${t}\` will be removed in a future version.`)}deprecationWarning(e){this.shouldLog(1)&&this.logErrorHandler(`Ably: Deprecation warning - ${e}`,1)}};z.defaultLogLevel=1,z.LOG_NONE=0,z.LOG_ERROR=1,z.LOG_MAJOR=2,z.LOG_MINOR=3,z.LOG_MICRO=4,z.logAction=(e,t,s,r)=>{z.logActionNoStrip(e,t,s,r)};var J={};function K(e){let t="["+e.constructor.name;return e.message&&(t+=": "+e.message),e.statusCode&&(t+="; statusCode="+e.statusCode),e.code&&(t+="; code="+e.code),e.cause&&(t+="; cause="+eO(e.cause)),e.href&&!(e.message&&e.message.indexOf("help.ably.io")>-1)&&(t+="; see "+e.href+" "),t+="]"}((e,t)=>{for(var s in t)f(e,s,{get:t[s],enumerable:!0})})(J,{Format:()=>ey,allSame:()=>em,allToLowerCase:()=>eI,allToUpperCase:()=>ex,arrChooseN:()=>eT,arrDeleteValue:()=>eu,arrEquals:()=>eG,arrIntersect:()=>ec,arrIntersectOb:()=>eh,arrPopRandomElement:()=>eb,arrWithoutValue:()=>ed,cheapRandStr:()=>eC,containsValue:()=>ea,copy:()=>Z,createMissingPluginError:()=>eH,dataSizeBytes:()=>ek,decodeBody:()=>eP,encodeBody:()=>eM,ensureArray:()=>ee,forInOwnNonNullProperties:()=>eg,getBackoffCoefficient:()=>eL,getGlobalObject:()=>ej,getJitterCoefficient:()=>eN,getRetryTime:()=>eU,inherits:()=>eo,inspectBody:()=>eE,inspectError:()=>eO,intersect:()=>el,isEmpty:()=>es,isErrorInfoOrPartialErrorInfo:()=>eS,isNil:()=>er,isObject:()=>et,keysArray:()=>ef,listenerToAsyncIterator:()=>eV,matchDerivedChannel:()=>eq,mixin:()=>Y,parseQueryString:()=>ew,prototypicalClone:()=>ei,randomString:()=>eR,shallowClone:()=>en,shallowEquals:()=>eB,stringifyValues:()=>ev,throwMissingPluginError:()=>eW,toBase64:()=>eD,toQueryString:()=>e_,valuesArray:()=>ep,whenPromiseSettles:()=>eA,withTimeoutAsync:()=>eF});var Q=class e extends Error{constructor(t,s,r,n){super(t),void 0!==Object.setPrototypeOf&&Object.setPrototypeOf(this,e.prototype),this.code=s,this.statusCode=r,this.cause=n}toString(){return K(this)}static fromValues(t){let{message:s,code:r,statusCode:n}=t;if("string"!=typeof s||"number"!=typeof r||"number"!=typeof n)throw Error("ErrorInfo.fromValues(): invalid values: "+H.Config.inspect(t));let i=Object.assign(new e(s,r,n),t);return i.code&&!i.href&&(i.href="https://help.ably.io/error/"+i.code),i}},X=class e extends Error{constructor(t,s,r,n){super(t),void 0!==Object.setPrototypeOf&&Object.setPrototypeOf(this,e.prototype),this.code=s,this.statusCode=r,this.cause=n}toString(){return K(this)}static fromValues(t){let{message:s,code:r,statusCode:n}=t;if("string"!=typeof s||!er(r)&&"number"!=typeof r||!er(n)&&"number"!=typeof n)throw Error("PartialErrorInfo.fromValues(): invalid values: "+H.Config.inspect(t));let i=Object.assign(new e(s,r,n),t);return i.code&&!i.href&&(i.href="https://help.ably.io/error/"+i.code),i}};function Y(e,...t){for(let s=0;s<t.length;s++){let r=t[s];if(!r)break;for(let t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=r[t])}return e}function Z(e){return Y({},e)}function ee(e){return er(e)?[]:Array.isArray(e)?e:[e]}function et(e){return"[object Object]"==Object.prototype.toString.call(e)}function es(e){for(let t in e)return!1;return!0}function er(e){return null==e}function en(e){let t={};for(let s in e)t[s]=e[s];return t}function ei(e,t){class s{}s.prototype=e;let r=new s;return t&&Y(r,t),r}var eo=function(e,t){if(H.Config.inherits){H.Config.inherits(e,t);return}e.super_=t,e.prototype=ei(t.prototype,{constructor:e})};function ea(e,t){for(let s in e)if(e[s]==t)return!0;return!1}function el(e,t){return Array.isArray(t)?ec(e,t):eh(e,t)}function ec(e,t){let s=[];for(let r=0;r<e.length;r++){let n=e[r];-1!=t.indexOf(n)&&s.push(n)}return s}function eh(e,t){let s=[];for(let r=0;r<e.length;r++){let n=e[r];n in t&&s.push(n)}return s}function eu(e,t){let s=e.indexOf(t),r=-1!=s;return r&&e.splice(s,1),r}function ed(e,t){let s=e.slice();return eu(s,t),s}function ef(e,t){let s=[];for(let r in e)(!t||Object.prototype.hasOwnProperty.call(e,r))&&s.push(r);return s}function ep(e,t){let s=[];for(let r in e)(!t||Object.prototype.hasOwnProperty.call(e,r))&&s.push(e[r]);return s}function eg(e,t){for(let s in e)Object.prototype.hasOwnProperty.call(e,s)&&e[s]&&t(s)}function em(e,t){if(0===e.length)return!0;let s=e[0][t];return e.every(function(e){return e[t]===s})}var ey=((r=ey||{}).msgpack="msgpack",r.json="json",r);function eb(e){return e.splice(Math.floor(Math.random()*e.length),1)[0]}function e_(e){let t=[];if(e)for(let s in e)t.push(encodeURIComponent(s)+"="+encodeURIComponent(e[s]));return t.length?"?"+t.join("&"):""}function ev(e){return Object.fromEntries(Object.entries(e).map(([e,t])=>[e,String(t)]))}function ew(e){let t;let s=/([^?&=]+)=?([^&]*)/g,r={};for(;t=s.exec(e);)r[decodeURIComponent(t[1])]=decodeURIComponent(t[2]);return r}function eS(e){return"object"==typeof e&&null!==e&&(e instanceof Q||e instanceof X)}function eO(e){var t,s;return e instanceof Error||(null==(t=null==e?void 0:e.constructor)?void 0:t.name)==="ErrorInfo"||(null==(s=null==e?void 0:e.constructor)?void 0:s.name)==="PartialErrorInfo"?e.toString():H.Config.inspect(e)}function eE(e){return H.BufferUtils.isBuffer(e)?e.toString():"string"==typeof e?e:H.Config.inspect(e)}function ek(e){if(H.BufferUtils.isBuffer(e))return H.BufferUtils.byteLength(e);if("string"==typeof e)return H.Config.stringByteSize(e);if("number"==typeof e)return 8;if("boolean"==typeof e)return 1;throw Error(`Expected input of Utils.dataSizeBytes to be a string, a number, a boolean or a buffer, but was: ${typeof e}`)}function eC(){return String(Math.random()).substr(2)}var eR=async e=>{let t=await H.Config.getRandomArrayBuffer(e);return H.BufferUtils.base64Encode(t)};function eT(e,t){let s=Math.min(t,e.length),r=e.slice(),n=[];for(let e=0;e<s;e++)n.push(eb(r));return n}function eA(e,t){e.then(e=>{null==t||t(null,e)}).catch(e=>{null==t||t(e)})}function eP(e,t,s){return"msgpack"==s?(t||eW("MsgPack"),t.decode(e)):JSON.parse(String(e))}function eM(e,t,s){return"msgpack"==s?(t||eW("MsgPack"),t.encode(e,!0)):JSON.stringify(e)}function eI(e){return e.map(function(e){return e&&e.toLowerCase()})}function ex(e){return e.map(function(e){return e&&e.toUpperCase()})}function eL(e){return Math.min((e+2)/3,2)}function eN(){return 1-.2*Math.random()}function eU(e,t){return e*eL(t)*eN()}function ej(){return"undefined"!=typeof global?global:"undefined"!=typeof window?window:self}function eB(e,t){return Object.keys(e).every(s=>e[s]===t[s])&&Object.keys(t).every(s=>t[s]===e[s])}function eq(e){let t=e.match(/^(\[([^?]*)(?:(.*))\])?(.+)$/);if(!t||!t.length||t.length<5)throw new Q("regex match failed",400,40010);if(t[2])throw new Q(`cannot use a derived option with a ${t[2]} channel`,400,40010);return{qualifierParam:t[3]||"",channelName:t[4]}}function eD(e){let t=H.BufferUtils,s=t.utf8Encode(e);return t.base64Encode(s)}function eG(e,t){return e.length===t.length&&e.every(function(e,s){return e===t[s]})}function eH(e){return new Q(`${e} plugin not provided`,40019,400)}function eW(e){throw eH(e)}async function eF(e,t=5e3,s="Timeout expired"){let r=new Q(s,5e4,500);return Promise.race([e,new Promise((e,s)=>setTimeout(()=>s(r),t))])}function eV(e){return P(this,null,function*(){let t=[],s=null,r=e(e=>{if(s){let t=s;s=null,t(e)}else t.push(e)});try{for(;;)if(t.length>0)yield t.shift();else{if(s)throw new Q("Concurrent next() calls are not supported",4e4,400);let e=yield new A(new Promise(e=>{s=e}));yield e}}finally{r()}})}var e$="2.17.1",ez={ENDPOINT:"main",ENVIRONMENT:"",REST_HOST:"rest.ably.io",REALTIME_HOST:"realtime.ably.io",FALLBACK_HOSTS:["main.a.fallback.ably-realtime.com","main.b.fallback.ably-realtime.com","main.c.fallback.ably-realtime.com","main.d.fallback.ably-realtime.com","main.e.fallback.ably-realtime.com"],PORT:80,TLS_PORT:443,TIMEOUTS:{disconnectedRetryTimeout:15e3,suspendedRetryTimeout:3e4,httpRequestTimeout:1e4,httpMaxRetryDuration:15e3,channelRetryTimeout:15e3,fallbackRetryTimeout:6e5,connectionStateTtl:12e4,realtimeRequestTimeout:1e4,recvTimeout:9e4,webSocketConnectTimeout:1e4,webSocketSlowTimeout:4e3},httpMaxRetryCount:3,maxMessageSize:65536,version:e$,protocolVersion:5,agent:"ably-js/"+e$,getPort:function(e,t){return t||e.tls?e.tlsPort:e.port},getHttpScheme:function(e){return e.tls?"https://":"http://"},getPrimaryDomainFromEndpoint:eK,getEndpointFallbackHosts:eQ,getFallbackHosts:eY,getHosts:function(e){return[e.primaryDomain].concat(eY(e))},checkHost:eZ,objectifyOptions:function(e,t,s,r,n){let i;if(void 0===e){let e=t?`${s} must be initialized with either a client options object, an Ably API key, or an Ably Token`:`${s} must be initialized with a client options object`;throw z.logAction(r,z.LOG_ERROR,`${s}()`,e),Error(e)}if("string"==typeof e){if(-1==e.indexOf(":")){if(!t){let e=`${s} cannot be initialized with just an Ably Token; you must provide a client options object with a \`plugins\` property. (Set this Ably Token as the object\u2019s \`token\` property.)`;throw z.logAction(r,z.LOG_ERROR,`${s}()`,e),Error(e)}i={token:e}}else{if(!t){let e=`${s} cannot be initialized with just an Ably API key; you must provide a client options object with a \`plugins\` property. (Set this Ably API key as the object\u2019s \`key\` property.)`;throw z.logAction(r,z.LOG_ERROR,`${s}()`,e),Error(e)}i={key:e}}}else i=e;return n&&(i=E(O({},i),{plugins:O(O({},n),i.plugins)})),i},normaliseOptions:function(e,t,s){let r=null!=s?s:z.defaultLogger;e.environment&&r.deprecated("The `environment` client option","Use the `endpoint` client option instead."),e.restHost&&r.deprecated("The `restHost` client option","Use the `endpoint` client option instead."),e.realtimeHost&&r.deprecated("The `realtimeHost` client option","Use the `endpoint` client option instead."),function(e){if(e.endpoint&&(e.environment||e.restHost||e.realtimeHost))throw new Q("The `endpoint` option cannot be used in conjunction with the `environment`, `restHost`, or `realtimeHost` options.",40106,400);if(e.environment&&(e.restHost||e.realtimeHost))throw new Q("The `environment` option cannot be used in conjunction with the `restHost`, or `realtimeHost` options.",40106,400)}(e),"function"==typeof e.recover&&!0===e.closeOnUnload&&(z.logAction(r,z.LOG_ERROR,"Defaults.normaliseOptions","closeOnUnload was true and a session recovery function was set - these are mutually exclusive, so unsetting the latter"),e.recover=void 0),"closeOnUnload"in e||(e.closeOnUnload=!e.recover),"queueMessages"in e||(e.queueMessages=!0);let n=e.endpoint||ez.ENDPOINT;e.fallbackHosts||e.restHost||e.realtimeHost||e.port||e.tlsPort||(e.fallbackHosts=eQ(e.environment||n));let i=e.environment&&`${e.environment}.realtime.ably.net`,o=e.restHost||e.realtimeHost||i||eK(n);(e.fallbackHosts||[]).concat(o).forEach(eZ),e.port=e.port||ez.PORT,e.tlsPort=e.tlsPort||ez.TLS_PORT,"tls"in e||(e.tls=!0);let a=function(e){let t={};for(let s in ez.TIMEOUTS)t[s]=e[s]||ez.TIMEOUTS[s];return t}(e);t?"useBinaryProtocol"in e?e.useBinaryProtocol=H.Config.supportsBinary&&e.useBinaryProtocol:e.useBinaryProtocol=H.Config.preferBinary:e.useBinaryProtocol=!1;let l={};e.clientId&&(l["X-Ably-ClientId"]=H.BufferUtils.base64Encode(H.BufferUtils.utf8Encode(e.clientId))),"idempotentRestPublishing"in e||(e.idempotentRestPublishing=!0);let c=null,h=e.connectivityCheckUrl;if(e.connectivityCheckUrl){let[t,s]=e.connectivityCheckUrl.split("?");c=s?ew(s):{},-1===t.indexOf("://")&&(t="https://"+t),h=t}let u=e.wsConnectivityCheckUrl;return u&&-1===u.indexOf("://")&&(u="wss://"+u),E(O({},e),{primaryDomain:o,maxMessageSize:e.maxMessageSize||ez.maxMessageSize,timeouts:a,connectivityCheckParams:c,connectivityCheckUrl:h,wsConnectivityCheckUrl:u,headers:l})},defaultGetHeaders:function(e,{format:t,protocolVersion:s=e2.protocolVersion}={}){return{accept:e4[null!=t?t:e.useBinaryProtocol?"msgpack":"json"],"X-Ably-Version":s.toString(),"Ably-Agent":e0(e)}},defaultPostHeaders:function(e,{format:t,protocolVersion:s=e2.protocolVersion}={}){let r=e4[null!=t?t:e.useBinaryProtocol?"msgpack":"json"];return{accept:r,"content-type":r,"X-Ably-Version":s.toString(),"Ably-Agent":e0(e)}}};function eJ(e){return e.includes(".")||e.includes("::")||"localhost"===e}function eK(e){if(eJ(e))return e;if(e.startsWith("nonprod:")){let t=e.replace("nonprod:","");return`${t}.realtime.ably-nonprod.net`}return`${e}.realtime.ably.net`}function eQ(e){return eJ(e)?[]:e.startsWith("nonprod:")?eX(e.replace("nonprod:",""),"ably-realtime-nonprod.com"):eX(e,"ably-realtime.com")}function eX(e,t){return["a","b","c","d","e"].map(s=>`${e}.${s}.fallback.${t}`)}function eY(e){let t=e.fallbackHosts,s=void 0!==e.httpMaxRetryCount?e.httpMaxRetryCount:ez.httpMaxRetryCount;return t?eT(t,s):[]}function eZ(e){if("string"!=typeof e)throw new Q("host must be a string; was a "+typeof e,4e4,400);if(!e.length)throw new Q("host must not be zero-length",4e4,400)}function e0(e){let t=ez.agent;if(e.agents)for(var s in e.agents)t+=" "+s+"/"+e.agents[s];return t}function e1(e,t,s){let r=s||{};if(r.cipher){e||eW("Crypto");let s=e.getCipher(r.cipher,t);r.cipher=s.cipherParams,r.channelCipher=s.cipher}else"cipher"in r&&(r.cipher=void 0,r.channelCipher=null);return r}var e4={json:"application/json",xml:"application/xml",html:"text/html",msgpack:"application/x-msgpack",text:"text/plain"},e2={format:"json",protocolVersion:ez.protocolVersion},e6=class e{constructor(e,t){this.logger=e,this.members=t||[]}call(e,t){for(let s of this.members)if(s)try{s(e,t)}catch(e){z.logAction(this.logger,z.LOG_ERROR,"Multicaster multiple callback handler","Unexpected exception: "+e+"; stack = "+e.stack)}}push(...e){this.members.push(...e)}createPromise(){return new Promise((e,t)=>{this.push((s,r)=>{s?t(s):e(r)})})}resolveAll(e){this.call(null,e)}rejectAll(e){this.call(e)}static create(t,s){let r=new e(t,s);return Object.assign((e,t)=>r.call(e,t),{push:e=>r.push(e),createPromise:()=>r.createPromise(),resolveAll:e=>r.resolveAll(e),rejectAll:e=>r.rejectAll(e)})}},e3=((n=e3||{}).Get="get",n.Delete="delete",n.Post="post",n.Put="put",n.Patch="patch",n),e8=((i=e8||{})[i.Success=200]="Success",i[i.NoContent=204]="NoContent",i[i.BadRequest=400]="BadRequest",i[i.Unauthorized=401]="Unauthorized",i[i.Forbidden=403]="Forbidden",i[i.RequestTimeout=408]="RequestTimeout",i[i.InternalServerError=500]="InternalServerError",i);function e5(e){return eS(e)?(e.code||(403===e.statusCode?e.code=40300:(e.code=40170,e.statusCode=401)),e):new Q(eO(e),e.code||40170,e.statusCode||401)}var e9=(e,t)=>{let s=H.BufferUtils,r=s.utf8Encode(e),n=s.utf8Encode(t),i=s.hmacSha256(r,n);return s.base64Encode(i)};function e7(e){if(!e)return"";"string"==typeof e&&(e=JSON.parse(e));let t=Object.create(null),s=ef(e,!0);if(!s)return"";s.sort();for(let r=0;r<s.length;r++)t[s[r]]=e[s[r]].sort();return JSON.stringify(t)}function te(e,t){if(e.authCallback)z.logAction(t,z.LOG_MINOR,"Auth()","using token auth with authCallback");else if(e.authUrl)z.logAction(t,z.LOG_MINOR,"Auth()","using token auth with authUrl");else if(e.key)z.logAction(t,z.LOG_MINOR,"Auth()","using token auth with client-side signing");else if(e.tokenDetails)z.logAction(t,z.LOG_MINOR,"Auth()","using token auth with supplied token only");else{let e="authOptions must include valid authentication parameters";throw z.logAction(t,z.LOG_ERROR,"Auth()",e),Error(e)}}function tt(e){return e.useTokenAuth||!("useTokenAuth"in e&&!e.useTokenAuth)&&(e.authCallback||e.authUrl||e.token||e.tokenDetails)}var ts=0,tr=class{constructor(e,t){if(this.authOptions={},this.client=e,this.tokenParams=t.defaultTokenParams||{},this.currentTokenRequestId=null,this.waitingForTokenRequest=null,tt(t))t.key||t.authCallback||t.authUrl||z.logAction(this.logger,z.LOG_ERROR,"Auth()","Warning: library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help"),this._saveTokenOptions(t.defaultTokenParams,t),te(this.authOptions,this.logger);else{if(!t.key){let e="No authentication options provided; need one of: key, authUrl, or authCallback (or for testing only, token or tokenDetails)";throw z.logAction(this.logger,z.LOG_ERROR,"Auth()",e),new Q(e,40160,401)}z.logAction(this.logger,z.LOG_MINOR,"Auth()","anonymous, using basic auth"),this._saveBasicOptions(t)}}get logger(){return this.client.logger}async authorize(e,t){if(t&&t.key&&this.authOptions.key!==t.key)throw new Q("Unable to update auth options with incompatible key",40102,401);try{let s=await this._forceNewToken(null!=e?e:null,null!=t?t:null);if(this.client.connection)return new Promise((e,t)=>{this.client.connection.connectionManager.onAuthUpdated(s,(s,r)=>s?t(s):e(r))});return s}catch(e){throw this.client.connection&&e.statusCode===e8.Forbidden&&this.client.connection.connectionManager.actOnErrorFromAuthorize(e),e}}async _forceNewToken(e,t){this.tokenDetails=null,this._saveTokenOptions(e,t),te(this.authOptions,this.logger);try{return this._ensureValidAuthCredentials(!0)}finally{delete this.tokenParams.timestamp,delete this.authOptions.queryTime}}async requestToken(e,t){let s=t||this.authOptions,r=e||Z(this.tokenParams),n,i=this.client;if(s.authCallback)z.logAction(this.logger,z.LOG_MINOR,"Auth.requestToken()","using token auth with authCallback"),n=s.authCallback;else if(s.authUrl)z.logAction(this.logger,z.LOG_MINOR,"Auth.requestToken()","using token auth with authUrl"),n=(e,t)=>{let r;let n=Y({accept:"application/json, text/plain"},s.authHeaders),i=s.authMethod&&"post"===s.authMethod.toLowerCase(),o=s.authUrl.indexOf("?");o>-1&&(r=ew(s.authUrl.slice(o)),s.authUrl=s.authUrl.slice(0,o),i||(s.authParams=Y(r,s.authParams)));let a=Y({},s.authParams||{},e),l=e=>{var s,r;let n=null!=(s=e.body)?s:null,i=null;if(e.error)z.logAction(this.logger,z.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received Error: "+eO(e.error));else{let t=null!=(r=e.headers["content-type"])?r:null;i=Array.isArray(t)?t.join(", "):t,z.logAction(this.logger,z.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received; content-type: "+i+"; body: "+eE(n))}if(e.error){t(e.error,null);return}if(e.unpacked){t(null,n);return}if(H.BufferUtils.isBuffer(n)&&(n=n.toString()),!i){t(new Q("authUrl response is missing a content-type header",40170,401),null);return}let o=i.indexOf("application/json")>-1,a=i.indexOf("text/plain")>-1||i.indexOf("application/jwt")>-1;if(!o&&!a){t(new Q("authUrl responded with unacceptable content-type "+i+", should be either text/plain, application/jwt or application/json",40170,401),null);return}if(o){if(n.length>131072){t(new Q("authUrl response exceeded max permitted length",40170,401),null);return}try{n=JSON.parse(n)}catch(e){t(new Q("Unexpected error processing authURL response; err = "+e.message,40170,401),null);return}}t(null,n,i)};if(z.logAction(this.logger,z.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Requesting token from "+s.authUrl+"; Params: "+JSON.stringify(a)+"; method: "+(i?"POST":"GET")),i){let e=n||{};e["content-type"]="application/x-www-form-urlencoded";let t=e_(a).slice(1);eA(this.client.http.doUri(e3.Post,s.authUrl,e,t,r),(e,t)=>e?l(e):l(t))}else eA(this.client.http.doUri(e3.Get,s.authUrl,n||{},null,a),(e,t)=>e?l(e):l(t))};else if(s.key)z.logAction(this.logger,z.LOG_MINOR,"Auth.requestToken()","using token auth with client-side signing"),n=(e,t)=>{eA(this.createTokenRequest(e,s),(e,s)=>t(e,null!=s?s:null))};else throw z.logAction(this.logger,z.LOG_ERROR,"Auth()","library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help"),new Q("Need a new token, but authOptions does not include any way to request one (no authUrl, authCallback, or key)",40171,403);"capability"in r&&(r.capability=e7(r.capability));let o=(e,t)=>{let r="/keys/"+e.keyName+"/requestToken",n=ez.defaultPostHeaders(this.client.options,{format:"json"});s.requestHeaders&&Y(n,s.requestHeaders),z.logAction(this.logger,z.LOG_MICRO,"Auth.requestToken().requestToken","Sending POST to "+r+"; Token params: "+JSON.stringify(e)),eA(this.client.http.do(e3.Post,function(e){return i.baseUri(e)+r},n,JSON.stringify(e),null),(e,s)=>e?t(e):t(s.error,s.body,s.unpacked))};return new Promise((e,t)=>{let i=!1,a=this.client.options.timeouts.realtimeRequestTimeout,l=setTimeout(()=>{i=!0;let e="Token request callback timed out after "+a/1e3+" seconds";z.logAction(this.logger,z.LOG_ERROR,"Auth.requestToken()",e),t(new Q(e,40170,401))},a);n(r,(r,n,a)=>{if(i)return;if(clearTimeout(l),r){z.logAction(this.logger,z.LOG_ERROR,"Auth.requestToken()","token request signing call returned error; err = "+eO(r)),t(e5(r));return}if("string"==typeof n){0===n.length?t(new Q("Token string is empty",40170,401)):n.length>131072?t(new Q("Token string exceeded max permitted length (was "+n.length+" bytes)",40170,401)):"undefined"===n||"null"===n?t(new Q("Token string was literal null/undefined",40170,401)):"{"!==n[0]||a&&a.indexOf("application/jwt")>-1?e({token:n}):t(new Q("Token was double-encoded; make sure you're not JSON-encoding an already encoded token request or details",40170,401));return}if("object"!=typeof n||null===n){let e="Expected token request callback to call back with a token string or token request/details object, but got a "+typeof n;z.logAction(this.logger,z.LOG_ERROR,"Auth.requestToken()",e),t(new Q(e,40170,401));return}let c=JSON.stringify(n).length;if(c>131072&&!s.suppressMaxLengthCheck){t(new Q("Token request/details object exceeded max permitted stringified size (was "+c+" bytes)",40170,401));return}if("issued"in n){e(n);return}if(!("keyName"in n)){let e="Expected token request callback to call back with a token string, token request object, or token details object";z.logAction(this.logger,z.LOG_ERROR,"Auth.requestToken()",e),t(new Q(e,40170,401));return}o(n,(s,r,n)=>{if(s){z.logAction(this.logger,z.LOG_ERROR,"Auth.requestToken()","token request API call returned error; err = "+eO(s)),t(e5(s));return}n||(r=JSON.parse(r)),z.logAction(this.logger,z.LOG_MINOR,"Auth.getToken()","token received"),e(r)})})})}async createTokenRequest(e,t){t=t||this.authOptions,e=e||Z(this.tokenParams);let s=t.key;if(!s)throw new Q("No key specified",40101,403);let r=s.split(":"),n=r[0],i=r[1];if(!i)throw new Q("Invalid key specified",40101,403);if(""===e.clientId)throw new Q("clientId canâ€™t be an empty string",40012,400);"capability"in e&&(e.capability=e7(e.capability));let o=Y({keyName:n},e),a=e.clientId||"",l=e.ttl||"",c=e.capability||"";o.timestamp||(o.timestamp=await this._getTimestamp(t&&t.queryTime));let h=o.nonce||(o.nonce=("000000"+Math.floor(1e16*Math.random())).slice(-16)),u=o.timestamp,d=o.keyName+"\n"+l+"\n"+c+"\n"+a+"\n"+u+"\n"+h+"\n";return o.mac=o.mac||e9(d,i),z.logAction(this.logger,z.LOG_MINOR,"Auth.getTokenRequest()","generated signed request"),o}async getAuthParams(){if("basic"==this.method)return{key:this.key};{let e=await this._ensureValidAuthCredentials(!1);if(!e)throw Error("Auth.getAuthParams(): _ensureValidAuthCredentials returned no error or tokenDetails");return{access_token:e.token}}}async getAuthHeaders(){if("basic"==this.method)return{authorization:"Basic "+this.basicKey};{let e=await this._ensureValidAuthCredentials(!1);if(!e)throw Error("Auth.getAuthParams(): _ensureValidAuthCredentials returned no error or tokenDetails");return{authorization:"Bearer "+eD(e.token)}}}_saveBasicOptions(e){this.method="basic",this.key=e.key,this.basicKey=eD(e.key),this.authOptions=e||{},"clientId"in e&&this._userSetClientId(e.clientId)}_saveTokenOptions(e,t){this.method="token",e&&(this.tokenParams=e),t&&(t.token&&(t.tokenDetails="string"==typeof t.token?{token:t.token}:t.token),t.tokenDetails&&(this.tokenDetails=t.tokenDetails),"clientId"in t&&this._userSetClientId(t.clientId),this.authOptions=t)}async _ensureValidAuthCredentials(e){let t=this.tokenDetails;if(t){if(this._tokenClientIdMismatch(t.clientId))throw new Q("Mismatch between clientId in token ("+t.clientId+") and current clientId ("+this.clientId+")",40102,403);if(!this.client.isTimeOffsetSet()||!t.expires||t.expires>=this.client.getTimestampUsingOffset())return z.logAction(this.logger,z.LOG_MINOR,"Auth.getToken()","using cached token; expires = "+t.expires),t;z.logAction(this.logger,z.LOG_MINOR,"Auth.getToken()","deleting expired token"),this.tokenDetails=null}let s=(this.waitingForTokenRequest||(this.waitingForTokenRequest=e6.create(this.logger))).createPromise();if(null!==this.currentTokenRequestId&&!e)return s;let r=this.currentTokenRequestId=ts++,n,i=null;try{n=await this.requestToken(this.tokenParams,this.authOptions)}catch(e){i=e}if(this.currentTokenRequestId>r)return z.logAction(this.logger,z.LOG_MINOR,"Auth._ensureValidAuthCredentials()","Discarding token request response; overtaken by newer one"),s;this.currentTokenRequestId=null;let o=this.waitingForTokenRequest;return(this.waitingForTokenRequest=null,i)?null==o||o.rejectAll(i):null==o||o.resolveAll(this.tokenDetails=n),s}_userSetClientId(e){if("string"==typeof e||null===e){if("*"===e)throw new Q('Canâ€™t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, instantiate the library with {defaultTokenParams: {clientId: "*"}}), or if calling authorize(), pass it in as a tokenParam: authorize({clientId: "*"}, authOptions)',40012,400);{let t=this._uncheckedSetClientId(e);if(t)throw t}}else throw new Q("clientId must be either a string or null",40012,400)}_uncheckedSetClientId(e){if(!this._tokenClientIdMismatch(e))return this.clientId=this.tokenParams.clientId=e,null;{let t="Unexpected clientId mismatch: client has "+this.clientId+", requested "+e,s=new Q(t,40102,401);return z.logAction(this.logger,z.LOG_ERROR,"Auth._uncheckedSetClientId()",t),s}}_tokenClientIdMismatch(e){return!!(this.clientId&&"*"!==this.clientId&&e&&"*"!==e&&this.clientId!==e)}static isTokenErr(e){return e.code&&e.code>=40140&&e.code<40150}revokeTokens(e,t){return this.client.rest.revokeTokens(e,t)}async _getTimestamp(e){return this.client.getTimestamp(e||!!this.authOptions.queryTime)}};function tn(e){let t=[];if(e)for(let s in e)t.push(s+"="+e[s]);return t.join("&")}function ti(e,t){return e+(t?"?":"")+tn(t)}var to=class{constructor(e){this.client=e,this.platformHttp=new H.Http(e),this.checkConnectivity=this.platformHttp.checkConnectivity?()=>this.platformHttp.checkConnectivity():void 0}get logger(){var e,t;return null!=(t=null==(e=this.client)?void 0:e.logger)?t:z.defaultLogger}get supportsAuthHeaders(){return this.platformHttp.supportsAuthHeaders}get supportsLinkHeaders(){return this.platformHttp.supportsLinkHeaders}_getHosts(e){let t=e.connection,s=t&&t.connectionManager.host;return s?[s].concat(ez.getFallbackHosts(e.options)):ez.getHosts(e.options)}async do(e,t,s,r,n){try{let i=this.client;if(!i)return{error:new Q("http.do called without client",5e4,500)};let o="function"==typeof t?t:function(e){return i.baseUri(e)+t},a=i._currentFallback;if(a){if(a.validUntil>Date.now()){let l=await this.doUri(e,o(a.host),s,r,n);if(l.error&&this.platformHttp.shouldFallback(l.error))return i._currentFallback=null,this.do(e,t,s,r,n);return l}i._currentFallback=null}let l=this._getHosts(i);if(1===l.length)return this.doUri(e,o(l[0]),s,r,n);let c=null,h=async(t,a)=>{let l=t.shift();c=null!=c?c:new Date;let u=await this.doUri(e,o(l),s,r,n);return u.error&&this.platformHttp.shouldFallback(u.error)&&t.length?Date.now()-c.getTime()>i.options.timeouts.httpMaxRetryDuration?{error:new Q(`Timeout for trying fallback hosts retries. Total elapsed time exceeded the ${i.options.timeouts.httpMaxRetryDuration}ms limit`,50003,500)}:h(t,!0):(a&&(i._currentFallback={host:l,validUntil:Date.now()+i.options.timeouts.fallbackRetryTimeout}),u)};return h(l)}catch(e){return{error:new Q(`Unexpected error in Http.do: ${eO(e)}`,500,5e4)}}}async doUri(e,t,s,r,n){try{var i,o;(i=this.logger).shouldLog(z.LOG_MICRO)&&z.logActionNoStrip(i,z.LOG_MICRO,"Http."+e+"()","Sending; "+ti(t,n)+"; Body"+(H.BufferUtils.isBuffer(r)?" (Base64): "+H.BufferUtils.base64Encode(r):": "+r));let a=await this.platformHttp.doUri(e,t,s,r,n);return this.logger.shouldLog(z.LOG_MICRO)&&(o=this.logger,a.error?z.logActionNoStrip(o,z.LOG_MICRO,"Http."+e+"()","Received Error; "+ti(t,n)+"; Error: "+eO(a.error)):z.logActionNoStrip(o,z.LOG_MICRO,"Http."+e+"()","Received; "+ti(t,n)+"; Headers: "+tn(a.headers)+"; StatusCode: "+a.statusCode+"; Body"+(H.BufferUtils.isBuffer(a.body)?" (Base64): "+H.BufferUtils.base64Encode(a.body):": "+a.body))),a}catch(e){return{error:new Q(`Unexpected error in Http.doUri: ${eO(e)}`,500,5e4)}}}};function ta(e,t,s){let r,n,i;for(let o=0;o<e.length;o++)if(r=e[o],s&&(r=r[s]),Array.isArray(r)){for(;-1!==(n=r.indexOf(t));)r.splice(n,1);s&&0===r.length&&delete e[o][s]}else if(et(r))for(i in r)Object.prototype.hasOwnProperty.call(r,i)&&Array.isArray(r[i])&&ta([r],t,i)}var tl=class{constructor(e){this.logger=e,this.any=[],this.events=Object.create(null),this.anyOnce=[],this.eventsOnce=Object.create(null)}on(...e){if(1===e.length){let t=e[0];if("function"==typeof t)this.any.push(t);else throw Error("EventListener.on(): Invalid arguments: "+H.Config.inspect(e))}if(2===e.length){let[t,s]=e;if("function"!=typeof s)throw Error("EventListener.on(): Invalid arguments: "+H.Config.inspect(e));if(er(t))this.any.push(s);else if(Array.isArray(t))t.forEach(e=>{this.on(e,s)});else{if("string"!=typeof t)throw Error("EventListener.on(): Invalid arguments: "+H.Config.inspect(e));(this.events[t]||(this.events[t]=[])).push(s)}}}off(...e){if(0==e.length||er(e[0])&&er(e[1])){this.any=[],this.events=Object.create(null),this.anyOnce=[],this.eventsOnce=Object.create(null);return}let[t,s]=e,r=null,n=null;if(1!==e.length&&s){if("function"!=typeof s)throw Error("EventEmitter.off(): invalid arguments:"+H.Config.inspect(e));[n,r]=[t,s]}else"function"==typeof t?r=t:n=t;if(r&&er(n)){ta([this.any,this.events,this.anyOnce,this.eventsOnce],r);return}if(Array.isArray(n)){n.forEach(e=>{this.off(e,r)});return}if("string"!=typeof n)throw Error("EventEmitter.off(): invalid arguments:"+H.Config.inspect(e));r?ta([this.events,this.eventsOnce],r,n):(delete this.events[n],delete this.eventsOnce[n])}listeners(e){if(e){let t=this.events[e]||[];return this.eventsOnce[e]&&Array.prototype.push.apply(t,this.eventsOnce[e]),t.length?t:null}return this.any.length?this.any:null}emit(e,...t){let s={event:e},r=[];this.anyOnce.length&&(Array.prototype.push.apply(r,this.anyOnce),this.anyOnce=[]),this.any.length&&Array.prototype.push.apply(r,this.any);let n=this.eventsOnce[e];n&&(Array.prototype.push.apply(r,n),delete this.eventsOnce[e]);let i=this.events[e];i&&Array.prototype.push.apply(r,i),r.forEach(e=>{!function(e,t,s,r){try{s.apply(t,r)}catch(t){z.logAction(e,z.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+t+"; stack = "+(t&&t.stack))}}(this.logger,s,e,t)})}once(...e){let t=e.length;if(0===t||1===t&&"function"!=typeof e[0]){let t=e[0];return new Promise(e=>{this.once(t,e)})}let[s,r]=e;if(1===e.length&&"function"==typeof s)this.anyOnce.push(s);else if(er(s)){if("function"!=typeof r)throw Error("EventEmitter.once(): Invalid arguments:"+H.Config.inspect(e));this.anyOnce.push(r)}else if(Array.isArray(s)){let t=this,n=function(){let i=Array.prototype.slice.call(arguments);if(s.forEach(function(e){t.off(e,n)}),"function"!=typeof r)throw Error("EventEmitter.once(): Invalid arguments:"+H.Config.inspect(e));r.apply(this,i)};s.forEach(function(e){t.on(e,n)})}else{if("string"!=typeof s)throw Error("EventEmitter.once(): Invalid arguments:"+H.Config.inspect(e));let t=this.eventsOnce[s]||(this.eventsOnce[s]=[]);if(r){if("function"!=typeof r)throw Error("EventEmitter.once(): Invalid arguments:"+H.Config.inspect(e));t.push(r)}}}async whenState(e,t){if("string"!=typeof e||"string"!=typeof t)throw Error("whenState requires a valid state String argument");return e===t?null:this.once(e)}},tc={HEARTBEAT:0,ACK:1,NACK:2,CONNECT:3,CONNECTED:4,DISCONNECT:5,DISCONNECTED:6,CLOSE:7,CLOSED:8,ERROR:9,ATTACH:10,ATTACHED:11,DETACH:12,DETACHED:13,PRESENCE:14,MESSAGE:15,SYNC:16,AUTH:17,ACTIVATE:18,OBJECT:19,OBJECT_SYNC:20,ANNOTATION:21},th=[];Object.keys(tc).forEach(function(e){th[tc[e]]=e});var tu={HAS_PRESENCE:1,HAS_BACKLOG:2,RESUMED:4,TRANSIENT:16,ATTACH_RESUME:32,HAS_OBJECTS:128,PRESENCE:65536,PUBLISH:131072,SUBSCRIBE:262144,PRESENCE_SUBSCRIBE:524288,ANNOTATION_PUBLISH:2097152,ANNOTATION_SUBSCRIBE:4194304,OBJECT_SUBSCRIBE:16777216,OBJECT_PUBLISH:33554432},td=Object.keys(tu);tu.MODE_ALL=tu.PRESENCE|tu.PUBLISH|tu.SUBSCRIBE|tu.PRESENCE_SUBSCRIBE|tu.ANNOTATION_PUBLISH|tu.ANNOTATION_SUBSCRIBE|tu.OBJECT_SUBSCRIBE|tu.OBJECT_PUBLISH;var tf=["PRESENCE","PUBLISH","SUBSCRIBE","PRESENCE_SUBSCRIBE","ANNOTATION_PUBLISH","ANNOTATION_SUBSCRIBE","OBJECT_SUBSCRIBE","OBJECT_PUBLISH"];function tp(e,t,s){if(s&&s.cipher){e||eW("Crypto");let r=e.getCipher(s.cipher,t);return{cipher:r.cipherParams,channelCipher:r.cipher}}return null!=s?s:{}}async function tg(e,t){let{data:s,encoding:r}=await tm(e.data,e.encoding,t);return e.data=s,e.encoding=r,e}async function tm(e,t,s){let r=s.channelCipher,n=e,i=t?t+"/":"";return H.BufferUtils.isBuffer(n)||(n=H.BufferUtils.utf8Encode(String(n)),i+="utf-8/"),{data:await r.encrypt(n),encoding:i=i+"cipher+"+r.algorithm}}async function ty(e,t){let{data:s,encoding:r}=tb(e.data,e.encoding);return(e.data=s,e.encoding=r,null!=t&&t.cipher)?tg(e,t):e}function tb(e,t){if("string"==typeof e||H.BufferUtils.isBuffer(e)||null==e)return{data:e,encoding:t};if(et(e)||Array.isArray(e))return{data:JSON.stringify(e),encoding:t?t+"/json":"json"};throw new Q("Data type is unsupported",40013,400)}async function t_(e,t){let{data:s,encoding:r,error:n}=await tv(e.data,e.encoding,t);if(e.data=s,e.encoding=r,n)throw n}async function tv(e,t,s){let r;let n=s&&s.channelOptions?s:{channelOptions:s,plugins:{},baseEncodedPreviousPayload:void 0},i=e,o=e,a=t;if(t){let e;let s=t.split("/"),l=s.length,c="";try{for(;(e=l)>0;){let t=s[--l].match(/([-\w]+)(\+([\w-]+))?/);if(!t)break;switch(c=t[1]){case"base64":o=H.BufferUtils.base64Decode(String(o)),e==s.length&&(i=o);continue;case"utf-8":o=H.BufferUtils.utf8Decode(o);continue;case"json":o=JSON.parse(o);continue;case"cipher":if(null!=n.channelOptions&&n.channelOptions.cipher&&n.channelOptions.channelCipher){let e=t[3],s=n.channelOptions.channelCipher;if(e!=s.algorithm)throw Error("Unable to decrypt message with given cipher; incompatible cipher params");o=await s.decrypt(o);continue}throw Error("Unable to decrypt message; not an encrypted channel");case"vcdiff":if(!n.plugins||!n.plugins.vcdiff)throw new Q("Missing Vcdiff decoder (https://github.com/ably-forks/vcdiff-decoder)",40019,400);if("undefined"==typeof Uint8Array)throw new Q("Delta decoding not supported on this browser (need ArrayBuffer & Uint8Array)",40020,400);try{let e=n.baseEncodedPreviousPayload;"string"==typeof e&&(e=H.BufferUtils.utf8Encode(e));let t=H.BufferUtils.toBuffer(e);o=H.BufferUtils.toBuffer(o),i=o=H.BufferUtils.arrayBufferViewToBuffer(n.plugins.vcdiff.decode(o,t))}catch(e){throw new Q("Vcdiff delta decode failed with "+e,40018,400)}continue;default:throw Error("Unknown encoding")}}}catch(e){r=new Q(`Error processing the ${c} encoding, decoder returned \u2018${e.message}\u2019`,e.code||40013,400)}finally{a=e<=0?null:s.slice(0,e).join("/")}}return r?{error:r,data:o,encoding:a}:(n.baseEncodedPreviousPayload=i,{data:o,encoding:a})}function tw(...e){let t=e.length>0?"json":"msgpack",{data:s,encoding:r}=tS(this.data,this.encoding,t);return Object.assign({},this,{encoding:r,data:s})}function tS(e,t,s){return e&&H.BufferUtils.isBuffer(e)?"msgpack"===s?{data:H.BufferUtils.toBuffer(e),encoding:t}:{data:H.BufferUtils.base64Encode(e),encoding:t?t+"/base64":"base64"}:{data:e,encoding:t}}var tO={encryptData:tm,encodeData:tb,encodeDataForWire:tS,decodeData:tv};function tE(e){let t;let{id:s,connectionId:r,timestamp:n}=e;switch(e.action){case tc.MESSAGE:t=e.messages;break;case tc.PRESENCE:case tc.SYNC:t=e.presence;break;case tc.ANNOTATION:t=e.annotations;break;case tc.OBJECT:case tc.OBJECT_SYNC:t=e.state;break;default:throw new Q("Unexpected action "+e.action,4e4,400)}for(let e=0;e<t.length;e++){let i=t[e];i.connectionId||(i.connectionId=r),i.timestamp||(i.timestamp=n),s&&!i.id&&(i.id=s+":"+e)}}function tk(e,t){let s="["+t;for(let t in e)"data"===t?"string"==typeof e.data?s+="; data="+e.data:H.BufferUtils.isBuffer(e.data)?s+="; data (buffer)="+H.BufferUtils.base64Encode(e.data):void 0!==e.data&&(s+="; data (json)="+JSON.stringify(e.data)):t&&("extras"===t||"operation"===t)?s+="; "+t+"="+JSON.stringify(e[t]):"version"===t?s+="; version="+JSON.stringify(e[t]):"annotations"===t?s+="; annotations="+JSON.stringify(e[t]):void 0!==e[t]&&(s+="; "+t+"="+e[t]);return s+"]"}var tC=class{},tR=class{constructor(e){var t,s,r,n,i,o,a,l,c,h;this.Platform=H,this.ErrorInfo=Q,this.Logger=z,this.Defaults=ez,this.Utils=J,this.EventEmitter=tl,this.MessageEncoding=tO,this._additionalHTTPRequestImplementations=null!=(t=e.plugins)?t:null,this.logger=new z,this.logger.setLog(e.logLevel,e.logHandler),z.logAction(this.logger,z.LOG_MICRO,"BaseClient()","initialized with clientOptions "+H.Config.inspect(e)),this._MsgPack=null!=(r=null==(s=e.plugins)?void 0:s.MsgPack)?r:null;let u=this.options=ez.normaliseOptions(e,this._MsgPack,this.logger);if(u.key){let e=u.key.match(/^([^:\s]+):([^:.\s]+)$/);if(!e){let e="invalid key parameter";throw z.logAction(this.logger,z.LOG_ERROR,"BaseClient()",e),new Q(e,40400,404)}u.keyName=e[1],u.keySecret=e[2]}if("clientId"in u){if("string"==typeof u.clientId||null===u.clientId){if("*"===u.clientId)throw new Q('Canâ€™t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, use {defaultTokenParams: {clientId: "*"}})',40012,400)}else throw new Q("clientId must be either a string or null",40012,400)}z.logAction(this.logger,z.LOG_MINOR,"BaseClient()","started; version = "+ez.version),this._currentFallback=null,this.serverTimeOffset=null,this.http=new to(this),this.auth=new tr(this,u),this._rest=(null==(n=e.plugins)?void 0:n.Rest)?new e.plugins.Rest(this):null,this._Crypto=null!=(o=null==(i=e.plugins)?void 0:i.Crypto)?o:null,this.__FilteredSubscriptions=null!=(l=null==(a=e.plugins)?void 0:a.MessageInteractions)?l:null,this._Annotations=null!=(h=null==(c=e.plugins)?void 0:c.Annotations)?h:null}get rest(){return this._rest||eW("Rest"),this._rest}get _FilteredSubscriptions(){return this.__FilteredSubscriptions||eW("MessageInteractions"),this.__FilteredSubscriptions}get channels(){return this.rest.channels}get push(){return this.rest.push}device(){var e;return(null==(e=this.options.plugins)?void 0:e.Push)&&this.push.LocalDevice||eW("Push"),this._device||(this._device=this.push.LocalDevice.load(this)),this._device}baseUri(e){return ez.getHttpScheme(this.options)+e+":"+ez.getPort(this.options,!1)}async stats(e){return this.rest.stats(e)}async time(e){return this.rest.time(e)}async request(e,t,s,r,n,i){return this.rest.request(e,t,s,r,n,i)}batchPublish(e){return this.rest.batchPublish(e)}batchPresence(e){return this.rest.batchPresence(e)}setLog(e){this.logger.setLog(e.level,e.handler)}async getTimestamp(e){return!this.isTimeOffsetSet()&&e?this.time():this.getTimestampUsingOffset()}getTimestampUsingOffset(){return Date.now()+(this.serverTimeOffset||0)}isTimeOffsetSet(){return null!==this.serverTimeOffset}};tR.Platform=H;var tT=tR,tA=class e{toJSON(){var e,t,s;return{id:this.id,deviceSecret:this.deviceSecret,platform:this.platform,formFactor:this.formFactor,clientId:this.clientId,metadata:this.metadata,deviceIdentityToken:this.deviceIdentityToken,push:{recipient:null==(e=this.push)?void 0:e.recipient,state:null==(t=this.push)?void 0:t.state,error:null==(s=this.push)?void 0:s.error}}}toString(){var e,t,s,r;let n="[DeviceDetails";return this.id&&(n+="; id="+this.id),this.platform&&(n+="; platform="+this.platform),this.formFactor&&(n+="; formFactor="+this.formFactor),this.clientId&&(n+="; clientId="+this.clientId),this.metadata&&(n+="; metadata="+this.metadata),this.deviceIdentityToken&&(n+="; deviceIdentityToken="+JSON.stringify(this.deviceIdentityToken)),(null==(e=this.push)?void 0:e.recipient)&&(n+="; push.recipient="+JSON.stringify(this.push.recipient)),(null==(t=this.push)?void 0:t.state)&&(n+="; push.state="+this.push.state),(null==(s=this.push)?void 0:s.error)&&(n+="; push.error="+JSON.stringify(this.push.error)),(null==(r=this.push)?void 0:r.metadata)&&(n+="; push.metadata="+this.push.metadata),n+="]"}static toRequestBody(e,t,s){return eM(e,t,s)}static fromResponseBody(t,s,r){return(r&&(t=eP(t,s,r)),Array.isArray(t))?e.fromValuesArray(t):e.fromValues(t)}static fromValues(t){return t.error=t.error&&Q.fromValues(t.error),Object.assign(new e,t)}static fromLocalDevice(t){return Object.assign(new e,t)}static fromValuesArray(t){let s=t.length,r=Array(s);for(let n=0;n<s;n++)r[n]=e.fromValues(t[n]);return r}};async function tP(e,t,s,r){return e.http.supportsAuthHeaders?r(Y(await e.auth.getAuthHeaders(),t),s):r(t,Y(await e.auth.getAuthParams(),s))}var tM=class e{static async get(t,s,r,n,i,o){return e.do(e3.Get,t,s,null,r,n,i,null!=o&&o)}static async delete(t,s,r,n,i,o){return e.do(e3.Delete,t,s,null,r,n,i,o)}static async post(t,s,r,n,i,o,a){return e.do(e3.Post,t,s,r,n,i,o,a)}static async patch(t,s,r,n,i,o,a){return e.do(e3.Patch,t,s,r,n,i,o,a)}static async put(t,s,r,n,i,o,a){return e.do(e3.Put,t,s,r,n,i,o,a)}static async do(e,t,s,r,n,i,o,a){o&&((i=i||{}).envelope=o);let l=t.logger;async function c(n,i){var o;if(l.shouldLog(z.LOG_MICRO)){let a=r;if((null==(o=n["content-type"])?void 0:o.indexOf("msgpack"))>0)try{t._MsgPack||eW("MsgPack"),a=t._MsgPack.decode(r)}catch(t){z.logAction(l,z.LOG_MICRO,"Resource."+e+"()","Sending MsgPack Decoding Error: "+eO(t))}z.logAction(l,z.LOG_MICRO,"Resource."+e+"()","Sending; "+ti(s,i)+"; Body: "+a)}let a=await t.http.do(e,s,n,r,i);return a.error&&tr.isTokenErr(a.error)?(await t.auth.authorize(null,null),tP(t,n,i,c)):{err:a.error,body:a.body,headers:a.headers,unpacked:a.unpacked,statusCode:a.statusCode}}let h=await tP(t,n,i,c);if(o&&(h=function(e,t,s){if(e.err&&!e.body)return{err:e.err};if(e.statusCode===e8.NoContent)return E(O({},e),{body:[],unpacked:!0});let r=e.body;if(!e.unpacked)try{r=eP(r,t,s)}catch(e){if(eS(e))return{err:e};return{err:new X(eO(e),null)}}if(!r)return{err:new X("unenvelope(): Response body is missing",null)};let{statusCode:n,response:i,headers:o}=r;if(void 0===n)return E(O({},e),{body:r,unpacked:!0});if(n<200||n>=300){let t=i&&i.error||e.err;return t||((t=Error("Error in unenveloping "+r)).statusCode=n),{err:t,body:i,headers:o,unpacked:!0,statusCode:n}}return{err:e.err,body:i,headers:o,unpacked:!0,statusCode:n}}(h,t._MsgPack,o)),l.shouldLog(z.LOG_MICRO)){var u,d;u=h,d=i,u.err?z.logAction(l,z.LOG_MICRO,"Resource."+e+"()","Received Error; "+ti(s,d)+"; Error: "+eO(u.err)):z.logAction(l,z.LOG_MICRO,"Resource."+e+"()","Received; "+ti(s,d)+"; Headers: "+tn(u.headers)+"; StatusCode: "+u.statusCode+"; Body: "+(H.BufferUtils.isBuffer(u.body)?" (Base64): "+H.BufferUtils.base64Encode(u.body):": "+H.Config.inspect(u.body)))}if(a){if(h.err)throw h.err;{let e=O({},h);return delete e.err,e}}return h}},tI=class{constructor(e,t,s,r,n,i){this.client=e,this.path=t,this.headers=s,this.envelope=null!=r?r:null,this.bodyHandler=n,this.useHttpPaginatedResponse=i||!1}get logger(){return this.client.logger}async get(e){let t=await tM.get(this.client,this.path,this.headers,e,this.envelope,!1);return this.handlePage(t)}async delete(e){let t=await tM.delete(this.client,this.path,this.headers,e,this.envelope,!1);return this.handlePage(t)}async post(e,t){let s=await tM.post(this.client,this.path,t,this.headers,e,this.envelope,!1);return this.handlePage(s)}async put(e,t){let s=await tM.put(this.client,this.path,t,this.headers,e,this.envelope,!1);return this.handlePage(s)}async patch(e,t){let s=await tM.patch(this.client,this.path,t,this.headers,e,this.envelope,!1);return this.handlePage(s)}async handlePage(e){var t,s;let r,n,i;if(e.err&&(t=e.err,s=e.body,!(this.useHttpPaginatedResponse&&(s||"number"==typeof t.code))))throw z.logAction(this.logger,z.LOG_ERROR,"PaginatedResource.handlePage()","Unexpected error getting resource: err = "+eO(e.err)),e.err;try{r=e.statusCode==e8.NoContent?[]:await this.bodyHandler(e.body,e.headers||{},e.unpacked)}catch(t){throw e.err||t}return(e.headers&&(n=e.headers.Link||e.headers.link)&&(i=function(e){"string"==typeof e&&(e=e.split(","));let t={};for(let s=0;s<e.length;s++){let r=e[s].match(/^\s*<(.+)>;\s*rel="(\w+)"$/);if(r){let e=function(e){let t=e.match(/^\.\/(\w+)\?(.*)$/);return t&&t[2]&&ew(t[2])}(r[1]);e&&(t[r[2]]=e)}}return t}(n)),this.useHttpPaginatedResponse)?new tL(this,r,e.headers||{},e.statusCode,i,e.err):new tx(this,r,i)}},tx=class{constructor(e,t,s){this.resource=e,this.items=t,this._relParams=s}async first(){if(this.hasFirst())return this.get(this._relParams.first);throw new Q("No link to the first page of results",40400,404)}async current(){if(this.hasCurrent())return this.get(this._relParams.current);throw new Q("No link to the current page of results",40400,404)}async next(){return this.hasNext()?this.get(this._relParams.next):null}hasFirst(){return null!=this._relParams&&"first"in this._relParams}hasCurrent(){return null!=this._relParams&&"current"in this._relParams}hasNext(){return null!=this._relParams&&"next"in this._relParams}isLast(){return!this.hasNext()}async get(e){let t=this.resource,s=await tM.get(t.client,t.path,t.headers,e,t.envelope,!1);return t.handlePage(s)}},tL=class extends tx{constructor(e,t,s,r,n,i){super(e,t,n),this.statusCode=r,this.success=r<300&&r>=200,this.headers=s,this.errorCode=i&&i.code,this.errorMessage=i&&i.message}toJSON(){return{items:this.items,statusCode:this.statusCode,success:this.success,headers:this.headers,errorCode:this.errorCode,errorMessage:this.errorMessage}}},tN=class e{toJSON(){return{channel:this.channel,deviceId:this.deviceId,clientId:this.clientId}}toString(){let e="[PushChannelSubscription";return this.channel&&(e+="; channel="+this.channel),this.deviceId&&(e+="; deviceId="+this.deviceId),this.clientId&&(e+="; clientId="+this.clientId),e+="]"}static fromResponseBody(t,s,r){return(r&&(t=eP(t,s,r)),Array.isArray(t))?e.fromValuesArray(t):e.fromValues(t)}static fromValues(t){return Object.assign(new e,t)}static fromValuesArray(t){let s=t.length,r=Array(s);for(let n=0;n<s;n++)r[n]=e.fromValues(t[n]);return r}};tN.toRequestBody=eM;var tU=class{constructor(e){var t;this.client=e,this.admin=new tj(e),H.Config.push&&(null==(t=e.options.plugins)?void 0:t.Push)&&(this.stateMachine=new e.options.plugins.Push.ActivationStateMachine(e),this.LocalDevice=e.options.plugins.Push.localDeviceFactory(tA))}async activate(e,t){await new Promise((s,r)=>{var n;if(!(null==(n=this.client.options.plugins)?void 0:n.Push)){r(eH("Push"));return}if(!this.stateMachine){r(new Q("This platform is not supported as a target of push notifications",4e4,400));return}if(this.stateMachine.activatedCallback){r(new Q("Activation already in progress",4e4,400));return}this.stateMachine.activatedCallback=e=>{if(e){r(e);return}s()},this.stateMachine.updateFailedCallback=t,this.stateMachine.handleEvent(new this.client.options.plugins.Push.CalledActivate(this.stateMachine,e))})}async deactivate(e){await new Promise((t,s)=>{var r;if(!(null==(r=this.client.options.plugins)?void 0:r.Push)){s(eH("Push"));return}if(!this.stateMachine){s(new Q("This platform is not supported as a target of push notifications",4e4,400));return}if(this.stateMachine.deactivatedCallback){s(new Q("Deactivation already in progress",4e4,400));return}this.stateMachine.deactivatedCallback=e=>{if(e){s(e);return}t()},this.stateMachine.handleEvent(new this.client.options.plugins.Push.CalledDeactivate(this.stateMachine,e))})}},tj=class{constructor(e){this.client=e,this.deviceRegistrations=new tB(e),this.channelSubscriptions=new tq(e)}async publish(e,t){let s=this.client,r=s.options.useBinaryProtocol?"msgpack":"json",n=ez.defaultPostHeaders(s.options),i={},o=Y({recipient:e},t);Y(n,s.options.headers),s.options.pushFullWait&&Y(i,{fullWait:"true"});let a=eM(o,s._MsgPack,r);await tM.post(s,"/push/publish",a,n,i,null,!0)}},tB=class{constructor(e){this.client=e}async save(e){let t=this.client,s=tA.fromValues(e),r=t.options.useBinaryProtocol?"msgpack":"json",n=ez.defaultPostHeaders(t.options),i={};Y(n,t.options.headers),t.options.pushFullWait&&Y(i,{fullWait:"true"});let o=eM(s,t._MsgPack,r),a=await tM.put(t,"/push/deviceRegistrations/"+encodeURIComponent(e.id),o,n,i,null,!0);return tA.fromResponseBody(a.body,t._MsgPack,a.unpacked?void 0:r)}async get(e){let t=this.client,s=t.options.useBinaryProtocol?"msgpack":"json",r=ez.defaultGetHeaders(t.options),n=e.id||e;if("string"!=typeof n||!n.length)throw new Q("First argument to DeviceRegistrations#get must be a deviceId string or DeviceDetails",4e4,400);Y(r,t.options.headers);let i=await tM.get(t,"/push/deviceRegistrations/"+encodeURIComponent(n),r,{},null,!0);return tA.fromResponseBody(i.body,t._MsgPack,i.unpacked?void 0:s)}async list(e){let t=this.client,s=t.options.useBinaryProtocol?"msgpack":"json",r=this.client.http.supportsLinkHeaders?void 0:s,n=ez.defaultGetHeaders(t.options);return Y(n,t.options.headers),new tI(t,"/push/deviceRegistrations",n,r,async function(e,r,n){return tA.fromResponseBody(e,t._MsgPack,n?void 0:s)}).get(e)}async remove(e){let t=this.client,s=ez.defaultGetHeaders(t.options),r={},n=e.id||e;if("string"!=typeof n||!n.length)throw new Q("First argument to DeviceRegistrations#remove must be a deviceId string or DeviceDetails",4e4,400);Y(s,t.options.headers),t.options.pushFullWait&&Y(r,{fullWait:"true"}),await tM.delete(t,"/push/deviceRegistrations/"+encodeURIComponent(n),s,r,null,!0)}async removeWhere(e){let t=this.client,s=t.options.useBinaryProtocol?"msgpack":"json",r=ez.defaultGetHeaders(t.options,{format:s});Y(r,t.options.headers),t.options.pushFullWait&&Y(e,{fullWait:"true"}),await tM.delete(t,"/push/deviceRegistrations",r,e,null,!0)}},tq=class e{constructor(t){this.remove=e.prototype.removeWhere,this.client=t}async save(e){let t=this.client,s=tN.fromValues(e),r=t.options.useBinaryProtocol?"msgpack":"json",n=ez.defaultPostHeaders(t.options),i={};Y(n,t.options.headers),t.options.pushFullWait&&Y(i,{fullWait:"true"});let o=eM(s,t._MsgPack,r),a=await tM.post(t,"/push/channelSubscriptions",o,n,i,null,!0);return tN.fromResponseBody(a.body,t._MsgPack,a.unpacked?void 0:r)}async list(e){let t=this.client,s=t.options.useBinaryProtocol?"msgpack":"json",r=this.client.http.supportsLinkHeaders?void 0:s,n=ez.defaultGetHeaders(t.options);return Y(n,t.options.headers),new tI(t,"/push/channelSubscriptions",n,r,async function(e,r,n){return tN.fromResponseBody(e,t._MsgPack,n?void 0:s)}).get(e)}async removeWhere(e){let t=this.client,s=t.options.useBinaryProtocol?"msgpack":"json",r=ez.defaultGetHeaders(t.options,{format:s});Y(r,t.options.headers),t.options.pushFullWait&&Y(e,{fullWait:"true"}),await tM.delete(t,"/push/channelSubscriptions",r,e,null,!0)}async listChannels(e){let t=this.client,s=t.options.useBinaryProtocol?"msgpack":"json",r=this.client.http.supportsLinkHeaders?void 0:s,n=ez.defaultGetHeaders(t.options);return Y(n,t.options.headers),t.options.pushFullWait&&Y(e,{fullWait:"true"}),new tI(t,"/push/channels",n,r,async function(e,r,n){let i=!n&&s?eP(e,t._MsgPack,s):e;for(let e=0;e<i.length;e++)i[e]=String(i[e]);return i}).get(e)}},tD=["absent","present","enter","leave","update"];async function tG(e,t,s,r){let n=tp(t,e,null!=r?r:null);return t$.fromValues(s).decode(n,e)}async function tH(e,t,s,r){return Promise.all(s.map(function(s){return tG(e,t,s,r)}))}async function tW(e,t){return t$.fromValues(e).decode(t.channelOptions,t.logger)}async function tF(e,t){return Promise.all(e.map(function(e){return tW(e,t)}))}var tV=class e extends tC{isSynthesized(){return!this.id||!this.connectionId||this.id.substring(this.connectionId.length,0)!==this.connectionId}parseId(){if(!this.id)throw Error("parseId(): Presence message does not contain an id");let e=this.id.split(":");return{connectionId:e[0],msgSerial:parseInt(e[1],10),index:parseInt(e[2],10)}}async encode(e){return ty(Object.assign(new t$,this,{action:tD.indexOf(this.action||"present")}),e)}static fromValues(t){return Object.assign(new e,t)}static fromValuesArray(t){return t.map(t=>e.fromValues(t))}static fromData(t){return t instanceof e?t:e.fromValues({data:t})}toString(){return tk(this,"PresenceMessage")}},t$=class e extends tC{toJSON(...e){return tw.call(this,...e)}static fromValues(t){return Object.assign(new e,t)}static fromValuesArray(t){return t.map(t=>e.fromValues(t))}async decode(e,t){let s=Object.assign(new tV,E(O({},this),{action:tD[this.action]}));try{await t_(s,e)}catch(e){z.logAction(t,z.LOG_ERROR,"WirePresenceMessage.decode()",eO(e))}return s}toString(){return tk(this,"WirePresenceMessage")}},tz=tV,tJ=class{constructor(e){this.channel=e}get logger(){return this.channel.logger}async get(e){z.logAction(this.logger,z.LOG_MICRO,"RestPresence.get()","channel = "+this.channel.name);let t=this.channel.client,s=t.options.useBinaryProtocol?"msgpack":"json",r=this.channel.client.http.supportsLinkHeaders?void 0:s,n=ez.defaultGetHeaders(t.options);return Y(n,t.options.headers),new tI(t,this.channel.client.rest.presenceMixin.basePath(this),n,r,async(e,r,n)=>tF(n?e:eP(e,t._MsgPack,s),this.channel)).get(e)}async history(e){return z.logAction(this.logger,z.LOG_MICRO,"RestPresence.history()","channel = "+this.channel.name),this.channel.client.rest.presenceMixin.history(this,e)}},tK=["message.create","message.update","message.delete","meta","message.summary","message.append"];async function tQ(e,t,s,r){let n=tp(t,e,null!=r?r:null);return t6.fromValues(s).decode(n,e)}async function tX(e,t,s,r){return Promise.all(s.map(function(s){return tQ(e,t,s,r)}))}async function tY(e,t){return t6.fromValues(e).decode(t.channelOptions,t.logger)}async function tZ(e,t){return Promise.all(e.map(function(e){return tY(e,t)}))}async function t0(e,t){return Promise.all(e.map(e=>e.encode(t)))}var t1=eM;function t4(e){let t,s=0;for(let r=0;r<e.length;r++)s+=(t=e[r]).size||(t.size=function(e){let t=0;return e.name&&(t+=e.name.length),e.clientId&&(t+=e.clientId.length),e.extras&&(t+=JSON.stringify(e.extras).length),e.data&&(t+=ek(e.data)),t}(t));return s}var t2=class e extends tC{expandFields(){if(this.version||(this.version={}),!this.version.serial&&this.serial&&(this.version.serial=this.serial),!this.version.timestamp&&this.timestamp&&(this.version.timestamp=this.timestamp),this.annotations?this.annotations.summary||(this.annotations.summary={}):this.annotations={summary:{}},this.annotations&&this.annotations.summary)for(let[e,t]of Object.entries(this.annotations.summary))if(e.endsWith(":distinct.v1")||e.endsWith(":unique.v1")||e.endsWith(":multiple.v1"))for(let[,e]of Object.entries(t))e.clipped||(e.clipped=!1);else e.endsWith(":flag.v1")&&!t.clipped&&(t.clipped=!1)}async encode(e){return ty(Object.assign(new t6,this,{action:tK.indexOf(this.action||"message.create")}),e)}static fromValues(t){return Object.assign(new e,t)}static fromValuesArray(t){return t.map(t=>e.fromValues(t))}toString(){return tk(this,"Message")}},t6=class e extends tC{toJSON(...e){return tw.call(this,...e)}static fromValues(t){return Object.assign(new e,t)}static fromValuesArray(t){return t.map(t=>e.fromValues(t))}async decodeWithErr(e,t){let s;let r=Object.assign(new t2,E(O({},this),{action:tK[this.action||0]||"unknown"}));try{await t_(r,e)}catch(e){z.logAction(t,z.LOG_ERROR,"WireMessage.decode()",eO(e)),s=e}return r.expandFields(),{decoded:r,err:s}}async decode(e,t){let{decoded:s}=await this.decodeWithErr(e,t);return s}toString(){return tk(this,"WireMessage")}},t3=t2,t8=class{constructor(e,t,s){var r,n;this._annotations=null,z.logAction(e.logger,z.LOG_MINOR,"RestChannel()","started; name = "+t),this.name=t,this.client=e,this.presence=new tJ(this),this.channelOptions=e1(null!=(r=e._Crypto)?r:null,this.logger,s),(null==(n=e.options.plugins)?void 0:n.Push)&&(this._push=new e.options.plugins.Push.PushChannel(this)),e._Annotations&&(this._annotations=new e._Annotations.RestAnnotations(this))}get annotations(){return this._annotations||eW("Annotations"),this._annotations}get push(){return this._push||eW("Push"),this._push}get logger(){return this.client.logger}setOptions(e){var t;this.channelOptions=e1(null!=(t=this.client._Crypto)?t:null,this.logger,e)}async history(e){return z.logAction(this.logger,z.LOG_MICRO,"RestChannel.history()","channel = "+this.name),this.client.rest.channelMixin.history(this,e)}async publish(...e){let t,s;let r=e[0],n=e[1];if("string"==typeof r||null===r)t=[t3.fromValues({name:r,data:n})],s=e[2];else if(et(r))t=[t3.fromValues(r)],s=e[1];else if(Array.isArray(r))t=t3.fromValuesArray(r),s=e[1];else throw new Q("The single-argument form of publish() expects a message object or an array of message objects",40013,400);s||(s={});let i=this.client,o=i.options,a=o.useBinaryProtocol?"msgpack":"json",l=i.options.idempotentRestPublishing,c=ez.defaultPostHeaders(i.options);if(Y(c,o.headers),l&&t.every(function(e){return!e.id})){let e=await eR(9);t.forEach(function(t,s){t.id=e+":"+s.toString()})}let h=await t0(t,this.channelOptions),u=t4(h),d=o.maxMessageSize;if(u>d)throw new Q(`Maximum size of messages that can be published at once exceeded (was ${u} bytes; limit is ${d} bytes)`,40009,400);return this._publish(t1(h,i._MsgPack,a),c,s)}async _publish(e,t,s){let r=this.client,n=r.options.useBinaryProtocol?"msgpack":"json",{body:i,unpacked:o}=await tM.post(r,r.rest.channelMixin.basePath(this)+"/messages",e,t,s,null,!0),a=(o?i:eP(i,r._MsgPack,n))||{};return delete a.channel,delete a.messageId,a}async status(){return this.client.rest.channelMixin.status(this)}async getMessage(e){return z.logAction(this.logger,z.LOG_MICRO,"RestChannel.getMessage()","channel = "+this.name),this.client.rest.channelMixin.getMessage(this,e)}async updateMessage(e,t,s){return z.logAction(this.logger,z.LOG_MICRO,"RestChannel.updateMessage()","channel = "+this.name),this.client.rest.channelMixin.updateDeleteMessage(this,"message.update",e,t,s)}async deleteMessage(e,t,s){return z.logAction(this.logger,z.LOG_MICRO,"RestChannel.deleteMessage()","channel = "+this.name),this.client.rest.channelMixin.updateDeleteMessage(this,"message.delete",e,t,s)}async appendMessage(e,t,s){return z.logAction(this.logger,z.LOG_MICRO,"RestChannel.appendMessage()","channel = "+this.name),this.client.rest.channelMixin.updateDeleteMessage(this,"message.append",e,t,s)}async getMessageVersions(e,t){return z.logAction(this.logger,z.LOG_MICRO,"RestChannel.getMessageVersions()","channel = "+this.name),this.client.rest.channelMixin.getMessageVersions(this,e,t)}},t5=class e{constructor(e){this.entries=e&&e.entries||void 0,this.schema=e&&e.schema||void 0,this.appId=e&&e.appId||void 0,this.inProgress=e&&e.inProgress||void 0,this.unit=e&&e.unit||void 0,this.intervalId=e&&e.intervalId||void 0}static fromValues(t){return new e(t)}},t9=class{static basePath(e){return"/channels/"+encodeURIComponent(e.name)}static history(e,t){let s=e.client,r=s.options.useBinaryProtocol?"msgpack":"json",n=e.client.http.supportsLinkHeaders?void 0:r,i=ez.defaultGetHeaders(s.options);return Y(i,s.options.headers),new tI(s,this.basePath(e)+"/messages",i,n,async function(t,n,i){return tZ(i?t:eP(t,s._MsgPack,r),e)}).get(t)}static async status(e){let t=e.client.options.useBinaryProtocol?"msgpack":"json",s=ez.defaultPostHeaders(e.client.options);return(await tM.get(e.client,this.basePath(e),s,{},t,!0)).body}static async getMessage(e,t){let s="string"==typeof t?t:t.serial;if(!s)throw new Q('This message lacks a serial. Make sure you have enabled "Message annotations, updates, and deletes" in channel settings on your dashboard.',40003,400);let r=e.client,n=r.options.useBinaryProtocol?"msgpack":"json",i=ez.defaultGetHeaders(r.options);Y(i,r.options.headers);let{body:o,unpacked:a}=await tM.get(r,this.basePath(e)+"/messages/"+encodeURIComponent(s),i,{},null,!0);return tY(a?o:eP(o,r._MsgPack,n),e)}static async updateDeleteMessage(e,t,s,r,n){if(!s.serial)throw new Q('This message lacks a serial and cannot be updated. Make sure you have enabled "Message annotations, updates, and deletes" in channel settings on your dashboard.',40003,400);let i=e.client,o=i.options.useBinaryProtocol?"msgpack":"json",a=ez.defaultPostHeaders(i.options);Y(a,i.options.headers);let l=t3.fromValues(s);l.action=t,l.version=r;let c=t1(await l.encode(e.channelOptions),i._MsgPack,o),h=tM.patch,{body:u,unpacked:d}=await h(i,this.basePath(e)+"/messages/"+encodeURIComponent(s.serial),c,a,n||{},null,!0);return(d?u:eP(u,i._MsgPack,o))||{versionSerial:null}}static getMessageVersions(e,t,s){let r="string"==typeof t?t:t.serial;if(!r)throw new Q('This message lacks a serial. Make sure you have enabled "Message annotations, updates, and deletes" in channel settings on your dashboard.',40003,400);let n=e.client,i=n.options.useBinaryProtocol?"msgpack":"json",o=e.client.http.supportsLinkHeaders?void 0:i,a=ez.defaultGetHeaders(n.options);return Y(a,n.options.headers),new tI(n,this.basePath(e)+"/messages/"+encodeURIComponent(r)+"/versions",a,o,async(t,s,r)=>tZ(r?t:eP(t,n._MsgPack,i),e)).get(s||{})}},t7=class{static basePath(e){return t9.basePath(e.channel)+"/presence"}static async history(e,t){let s=e.channel.client,r=s.options.useBinaryProtocol?"msgpack":"json",n=e.channel.client.http.supportsLinkHeaders?void 0:r,i=ez.defaultGetHeaders(s.options);return Y(i,s.options.headers),new tI(s,this.basePath(e)+"/history",i,n,async(t,n,i)=>tF(i?t:eP(t,s._MsgPack,r),e.channel)).get(t)}},se=class{constructor(e){this.channelMixin=t9,this.presenceMixin=t7,this.Resource=tM,this.PaginatedResource=tI,this.DeviceDetails=tA,this.PushChannelSubscription=tN,this.client=e,this.channels=new st(this.client),this.push=new tU(this.client)}async stats(e){let t=ez.defaultGetHeaders(this.client.options),s=this.client.options.useBinaryProtocol?"msgpack":"json",r=this.client.http.supportsLinkHeaders?void 0:s;return Y(t,this.client.options.headers),new tI(this.client,"/stats",t,r,async(e,t,r)=>{let n=r?e:eP(e,this.client._MsgPack,s);for(let e=0;e<n.length;e++)n[e]=t5.fromValues(n[e]);return n}).get(e)}async time(e){let t=ez.defaultGetHeaders(this.client.options,{format:"json"});this.client.options.headers&&Y(t,this.client.options.headers);let{error:s,body:r,unpacked:n}=await this.client.http.do(e3.Get,e=>this.client.baseUri(e)+"/time",t,null,e);if(s)throw s;n||(r=JSON.parse(r));let i=r[0];if(!i)throw new Q("Internal error (unexpected result type from GET /time)",5e4,500);return this.client.serverTimeOffset=i-Date.now(),i}async request(e,t,s,r,n,i){var o;let[a,l,c]=this.client.options.useBinaryProtocol?(this.client._MsgPack||eW("MsgPack"),[this.client._MsgPack.encode,this.client._MsgPack.decode,"msgpack"]):[JSON.stringify,JSON.parse,"json"],h=this.client.http.supportsLinkHeaders?void 0:c;r=r||{};let u=e.toLowerCase(),d="get"==u?ez.defaultGetHeaders(this.client.options,{format:c,protocolVersion:s}):ez.defaultPostHeaders(this.client.options,{format:c,protocolVersion:s});"string"!=typeof n&&(n=null!=(o=a(n))?o:null),Y(d,this.client.options.headers),i&&Y(d,i);let f=new tI(this.client,t,d,h,async function(e,t,s){return ee(s?e:l(e))},!0);if(!H.Http.methods.includes(u))throw new Q("Unsupported method "+u,40500,405);return H.Http.methodsWithBody.includes(u)?f[u](r,n):f[u](r)}async batchPublish(e){let t,s;Array.isArray(e)?(t=e,s=!1):(t=[e],s=!0);let r=this.client.options.useBinaryProtocol?"msgpack":"json",n=ez.defaultPostHeaders(this.client.options);this.client.options.headers&&Y(n,this.client.options.headers);let i=eM(t,this.client._MsgPack,r),o=await tM.post(this.client,"/messages",i,n,{},null,!0),a=o.unpacked?o.body:eP(o.body,this.client._MsgPack,r);return s?a[0]:a}async batchPresence(e){let t=this.client.options.useBinaryProtocol?"msgpack":"json",s=ez.defaultGetHeaders(this.client.options);this.client.options.headers&&Y(s,this.client.options.headers);let r=e.join(","),n=await tM.get(this.client,"/presence",s,{channels:r},null,!0);return n.unpacked?n.body:eP(n.body,this.client._MsgPack,t)}async revokeTokens(e,t){if(tt(this.client.options))throw new Q("Cannot revoke tokens when using token auth",40162,401);let s=this.client.options.keyName,r=O({targets:e.map(e=>`${e.type}:${e.value}`)},null!=t?t:{}),n=this.client.options.useBinaryProtocol?"msgpack":"json",i=ez.defaultPostHeaders(this.client.options);this.client.options.headers&&Y(i,this.client.options.headers);let o=eM(r,this.client._MsgPack,n),a=await tM.post(this.client,`/keys/${s}/revokeTokens`,o,i,{},null,!0);return a.unpacked?a.body:eP(a.body,this.client._MsgPack,n)}},st=class{constructor(e){this.client=e,this.all=Object.create(null)}get(e,t){e=String(e);let s=this.all[e];return s?t&&s.setOptions(t):this.all[e]=s=new t8(this.client,e,t),s}release(e){delete this.all[String(e)]}},ss=class extends tT{constructor(e){super(ez.objectifyOptions(e,!1,"BaseRest",z.defaultLogger,{Rest:se}))}},sr={Rest:se},sn=class extends t3{static async fromEncoded(e,t){return tQ(z.defaultLogger,H.Crypto,e,t)}static async fromEncodedArray(e,t){return tX(z.defaultLogger,H.Crypto,e,t)}static fromValues(e){return t3.fromValues(e)}},si=class extends tz{static async fromEncoded(e,t){return tG(z.defaultLogger,H.Crypto,e,t)}static async fromEncodedArray(e,t){return tH(z.defaultLogger,H.Crypto,e,t)}static fromValues(e){return tz.fromValues(e)}},so=["annotation.create","annotation.delete"];async function sa(e,t,s){return sd.fromValues(t).decode(s||{},e)}async function sl(e,t,s){return Promise.all(t.map(function(t){return sa(e,t,s)}))}async function sc(e,t){return sd.fromValues(e).decode(t.channelOptions,t.logger)}async function sh(e,t){return Promise.all(e.map(function(e){return sc(e,t)}))}var su=class e extends tC{async encode(){return ty(Object.assign(new sd,this,{action:so.indexOf(this.action||"annotation.create")}),{})}static fromValues(t){return Object.assign(new e,t)}static fromValuesArray(t){return t.map(t=>e.fromValues(t))}toString(){return tk(this,"Annotation")}},sd=class e extends tC{toJSON(...e){return tw.call(this,...e)}static fromValues(t){return Object.assign(new e,t)}static fromValuesArray(t){return t.map(t=>e.fromValues(t))}async decode(e,t){let s=Object.assign(new su,E(O({},this),{action:so[this.action]}));try{await t_(s,e)}catch(e){z.logAction(t,z.LOG_ERROR,"WireAnnotation.decode()",eO(e))}return s}toString(){return tk(this,"WireAnnotation")}},sf=su,sp=class extends sf{static async fromEncoded(e,t){return sa(z.defaultLogger,e,t)}static async fromEncodedArray(e,t){return sl(z.defaultLogger,e,t)}static fromValues(e){return sf.fromValues(e)}};function sg(e){let t;switch(typeof e){case"string":t=e;break;case"object":t=e.serial}if(!t||"string"!=typeof t)throw new Q("First argument of annotations.publish() must be either a Message (or at least an object with a string `serial` property) or a message serial (string)",40003,400);return t}function sm(e,t){let s=sg(e);if(!t||"object"!=typeof t)throw new Q("Second argument of annotations.publish() must be an object (the intended annotation to publish)",40003,400);let r=sf.fromValues(t);return r.messageSerial=s,r.action||(r.action="annotation.create"),r}function sy(e,t){return e.client.rest.channelMixin.basePath(e)+"/messages/"+encodeURIComponent(t)+"/annotations"}var sb=class{constructor(e){this.channel=e}async publish(e,t){let s=sm(e,t),r=await s.encode(),n=this.channel.client,i=n.options.useBinaryProtocol?"msgpack":"json",o=ez.defaultPostHeaders(n.options);Y(o,n.options.headers);let a=eM([r],n._MsgPack,i);await tM.post(n,sy(this.channel,s.messageSerial),a,o,{},null,!0)}async delete(e,t){return t.action="annotation.delete",this.publish(e,t)}async get(e,t){let s=this.channel.client,r=sg(e),n=s.options.useBinaryProtocol?"msgpack":"json",i=s.http.supportsLinkHeaders?void 0:n,o=ez.defaultGetHeaders(s.options);return Y(o,s.options.headers),new tI(s,sy(this.channel,r),o,i,async(e,t,r)=>sh(r?e:eP(e,s._MsgPack,n),this.channel)).get(t)}};function s_(e){let t=[];if(e)for(let s=0;s<e.length;s++)t.push(e[s].toString());return"[ "+t.join(", ")+" ]"}function sv(e,t,s,r){let n,i,o,a,l;return e.error&&(n=Q.fromValues(e.error)),e.messages&&(i=t6.fromValuesArray(e.messages)),t&&e.presence&&(o=t.WirePresenceMessage.fromValuesArray(e.presence)),s&&e.annotations&&(a=s.WireAnnotation.fromValuesArray(e.annotations)),r&&e.state&&(l=r.WireObjectMessage.fromValuesArray(e.state,J,tO)),Object.assign(new sO,E(O({},e),{presence:o,messages:i,annotations:a,state:l,error:n}))}function sw(e){return Object.assign(new sO,e)}function sS(e,t,s,r){let n,i="[ProtocolMessage";void 0!==e.action&&(i+="; action="+th[e.action]);let o=["id","channel","channelSerial","connectionId","count","msgSerial","timestamp"];for(let t=0;t<o.length;t++)void 0!==e[n=o[t]]&&(i+="; "+n+"="+e[n]);if(e.messages&&(i+="; messages="+s_(t6.fromValuesArray(e.messages))),e.presence&&t&&(i+="; presence="+s_(t.WirePresenceMessage.fromValuesArray(e.presence))),e.annotations&&s&&(i+="; annotations="+s_(s.WireAnnotation.fromValuesArray(e.annotations))),e.state&&r&&(i+="; state="+s_(r.WireObjectMessage.fromValuesArray(e.state,J,tO))),e.error&&(i+="; error="+Q.fromValues(e.error).toString()),e.auth&&e.auth.accessToken&&(i+="; token="+e.auth.accessToken),e.flags&&(i+="; flags="+td.filter(e.hasFlag).join(",")),e.params){let t="";eg(e.params,function(s){t.length>0&&(t+="; "),t+=s+"="+e.params[s]}),t.length>0&&(i+="; params=["+t+"]")}return i+"]"}var sO=class{constructor(){this.hasFlag=e=>(this.flags&tu[e])>0}setFlag(e){return this.flags=this.flags|tu[e]}getMode(){return(this.flags||0)&tu.MODE_ALL}encodeModesToFlags(e){e.forEach(e=>this.setFlag(e))}decodeModesFromFlags(){let e=[];return tf.forEach(t=>{this.hasFlag(t)&&e.push(t)}),e.length>0?e:void 0}},sE=class{constructor(e,t,s,r,n){this.previous=e,this.current=t,"attached"===t&&(this.resumed=s,this.hasBacklog=r),n&&(this.reason=n)}},sk=function(){},sC=class e extends tl{constructor(e,t,s){var r,n,i;super(e.logger),this._annotations=null,this._mode=0,this.retryCount=0,this.history=async function(e){z.logAction(this.logger,z.LOG_MICRO,"RealtimeChannel.history()","channel = "+this.name);let t=this.client.rest.channelMixin;if(e&&e.untilAttach){if("attached"!==this.state)throw new Q("option untilAttach requires the channel to be attached",4e4,400);if(!this.properties.attachSerial)throw new Q("untilAttach was specified and channel is attached, but attachSerial is not defined",4e4,400);delete e.untilAttach,e.from_serial=this.properties.attachSerial}return t.history(this,e)},this.whenState=e=>tl.prototype.whenState.call(this,e,this.state),z.logAction(this.logger,z.LOG_MINOR,"RealtimeChannel()","started; name = "+t),this.name=t,this.channelOptions=e1(null!=(r=e._Crypto)?r:null,this.logger,s),this.client=e,this._presence=e._RealtimePresence?new e._RealtimePresence.RealtimePresence(this):null,e._Annotations&&(this._annotations=new e._Annotations.RealtimeAnnotations(this)),this.connectionManager=e.connection.connectionManager,this.state="initialized",this.subscriptions=new tl(this.logger),this.syncChannelSerial=void 0,this.properties={attachSerial:void 0,channelSerial:void 0},this.setOptions(s),this.errorReason=null,this._attachResume=!1,this._decodingContext={channelOptions:this.channelOptions,plugins:e.options.plugins||{},baseEncodedPreviousPayload:void 0},this._lastPayload={messageId:null,protocolMessageChannelSerial:null,decodeFailureRecoveryInProgress:null},this._allChannelChanges=new tl(this.logger),(null==(n=e.options.plugins)?void 0:n.Push)&&(this._push=new e.options.plugins.Push.PushChannel(this)),(null==(i=e.options.plugins)?void 0:i.LiveObjects)&&(this._object=new e.options.plugins.LiveObjects.RealtimeObject(this))}get presence(){return this._presence||eW("RealtimePresence"),this._presence}get annotations(){return this._annotations||eW("Annotations"),this._annotations}get push(){return this._push||eW("Push"),this._push}get object(){return this._object||eW("LiveObjects"),this._object}invalidStateError(){return new Q("Channel operation failed as channel state is "+this.state,90001,400,this.errorReason||void 0)}static processListenerArgs(e){return"function"==typeof(e=Array.prototype.slice.call(e))[0]&&e.unshift(null),e}async setOptions(e){var t;let s=this.channelOptions,r=function(e){if(e&&"params"in e&&!et(e.params))return new Q("options.params must be an object",4e4,400);if(e&&"modes"in e){if(!Array.isArray(e.modes))return new Q("options.modes must be an array",4e4,400);for(let t=0;t<e.modes.length;t++){let s=e.modes[t];if(!s||"string"!=typeof s||!tf.includes(String.prototype.toUpperCase.call(s)))return new Q("Invalid channel mode: "+s,4e4,400)}}}(e);if(r)throw r;if(this.channelOptions=e1(null!=(t=this.client._Crypto)?t:null,this.logger,e),this._decodingContext&&(this._decodingContext.channelOptions=this.channelOptions),this._shouldReattachToSetOptions(e,s))return this.attachImpl(),new Promise((e,t)=>{this._allChannelChanges.once(["attached","update","detached","failed"],function(s){switch(this.event){case"update":case"attached":e();break;default:t(s.reason)}})})}_shouldReattachToSetOptions(e,t){if(!("attached"===this.state||"attaching"===this.state))return!1;if(null==e?void 0:e.params){let s=sR(e.params),r=sR(t.params);if(Object.keys(s).length!==Object.keys(r).length||!eB(r,s))return!0}return null!=e&&!!e.modes&&(!t.modes||!eG(e.modes,t.modes))}async publish(...e){let t,s;let r=e[0],n=e[1];if("string"==typeof r||null==r)t=[t3.fromValues({name:r,data:n})],s=e[2];else if(et(r))t=[t3.fromValues(r)],s=e[1];else if(Array.isArray(r))t=t3.fromValuesArray(r),s=e[1];else throw new Q("The single-argument form of publish() expects a message object or an array of message objects",40013,400);let i=this.client.options.maxMessageSize,o=await t0(t,this.channelOptions),a=t4(o);if(a>i)throw new Q(`Maximum size of messages that can be published at once exceeded (was ${a} bytes; limit is ${i} bytes)`,40009,400);this.throwIfUnpublishableState(),z.logAction(this.logger,z.LOG_MICRO,"RealtimeChannel.publish()","sending message; channel state is "+this.state+", message count = "+o.length);let l=sw({action:tc.MESSAGE,channel:this.name,messages:o,params:s?ev(s):void 0});return await this.sendMessage(l)||{serials:[]}}throwIfUnpublishableState(){if(!this.connectionManager.activeState())throw this.connectionManager.getError();if("failed"===this.state||"suspended"===this.state)throw this.invalidStateError()}onEvent(e){z.logAction(this.logger,z.LOG_MICRO,"RealtimeChannel.onEvent()","received message");let t=this.subscriptions;for(let s=0;s<e.length;s++){let r=e[s];t.emit(r.name,r)}}async attach(){return"attached"===this.state?null:new Promise((e,t)=>{this._attach(!1,null,(s,r)=>s?t(s):e(r))})}_attach(e,t,s){s||(s=e=>{e&&z.logAction(this.logger,z.LOG_ERROR,"RealtimeChannel._attach()","Channel attach failed: "+e.toString())});let r=this.connectionManager;if(!r.activeState()){s(r.getError());return}("attaching"!==this.state||e)&&this.requestState("attaching",t),this.once(function(e){switch(this.event){case"attached":null==s||s(null,e);break;case"detached":case"suspended":case"failed":null==s||s(e.reason||r.getError()||new Q("Unable to attach; reason unknown; state = "+this.event,9e4,500));break;case"detaching":null==s||s(new Q("Attach request superseded by a subsequent detach request",9e4,409))}})}attachImpl(){z.logAction(this.logger,z.LOG_MICRO,"RealtimeChannel.attachImpl()","sending ATTACH message");let e=sw({action:tc.ATTACH,channel:this.name,params:this.channelOptions.params,channelSerial:this.properties.channelSerial});this.channelOptions.modes&&e.encodeModesToFlags(ex(this.channelOptions.modes)),this._attachResume&&e.setFlag("ATTACH_RESUME"),this._lastPayload.decodeFailureRecoveryInProgress&&(e.channelSerial=this._lastPayload.protocolMessageChannelSerial),this.sendMessage(e).catch(sk)}async detach(){let e=this.connectionManager;switch(this.state){case"suspended":this.notifyState("detached");return;case"detached":return;case"failed":throw new Q("Unable to detach; channel state = failed",90001,400);default:if("connected"!==e.state.state){this.notifyState("detached");return}this.requestState("detaching");case"detaching":return new Promise((t,s)=>{this.once(function(r){switch(this.event){case"detached":t();break;case"attached":case"suspended":case"failed":s(r.reason||e.getError()||new Q("Unable to detach; reason unknown; state = "+this.event,9e4,500));break;case"attaching":s(new Q("Detach request superseded by a subsequent attach request",9e4,409))}})})}}detachImpl(){z.logAction(this.logger,z.LOG_MICRO,"RealtimeChannel.detach()","sending DETACH message");let e=sw({action:tc.DETACH,channel:this.name});this.sendMessage(e).catch(sk)}async subscribe(...t){let[s,r]=e.processListenerArgs(t);if("failed"===this.state)throw Q.fromValues(this.invalidStateError());return(s&&"object"==typeof s&&!Array.isArray(s)?this.client._FilteredSubscriptions.subscribeFilter(this,s,r):this.subscriptions.on(s,r),!1!==this.channelOptions.attachOnSubscribe)?this.attach():null}unsubscribe(...t){var s;let[r,n]=e.processListenerArgs(t);if("object"==typeof r&&!n||(null==(s=this.filteredSubscriptions)?void 0:s.has(n))){this.client._FilteredSubscriptions.getAndDeleteFilteredSubscriptions(this,r,n).forEach(e=>this.subscriptions.off(e));return}this.subscriptions.off(r,n)}sync(){switch(this.state){case"initialized":case"detaching":case"detached":throw new X("Unable to sync to channel; not attached",4e4)}let e=this.connectionManager;if(!e.activeState())throw e.getError();let t=sw({action:tc.SYNC,channel:this.name});this.syncChannelSerial&&(t.channelSerial=this.syncChannelSerial),e.send(t)}async sendMessage(e){return new Promise((t,s)=>{this.connectionManager.send(e,this.client.options.queueMessages,(e,r)=>{e?s(e):t(r)})})}async sendPresence(e){let t=sw({action:tc.PRESENCE,channel:this.name,presence:e});await this.sendMessage(t)}async sendState(e){let t=sw({action:tc.OBJECT,channel:this.name,state:e});await this.sendMessage(t)}async processMessage(e){(e.action===tc.ATTACHED||e.action===tc.MESSAGE||e.action===tc.PRESENCE||e.action===tc.OBJECT||e.action===tc.ANNOTATION)&&this.setChannelSerial(e.channelSerial);let t,s=!1;switch(e.action){case tc.ATTACHED:{this.properties.attachSerial=e.channelSerial,this._mode=e.getMode(),this.params=e.params||{};let t=e.decodeModesFromFlags();this.modes=t&&eI(t)||void 0;let s=e.hasFlag("RESUMED"),r=e.hasFlag("HAS_PRESENCE"),n=e.hasFlag("HAS_BACKLOG"),i=e.hasFlag("HAS_OBJECTS");if("attached"===this.state){!s&&(this._presence&&this._presence.onAttached(r),this._object&&this._object.onAttached(i));let t=new sE(this.state,this.state,s,n,e.error);this._allChannelChanges.emit("update",t),(!s||this.channelOptions.updateOnAttached)&&this.emit("update",t)}else"detaching"===this.state?this.checkPendingState():this.notifyState("attached",e.error,s,r,n,i);break}case tc.DETACHED:{let t=e.error?Q.fromValues(e.error):new Q("Channel detached",90001,404);"detaching"===this.state?this.notifyState("detached",t):"attaching"===this.state?this.notifyState("suspended",t):("attached"===this.state||"suspended"===this.state)&&this.requestState("attaching",t);break}case tc.SYNC:if(s=!0,t=this.syncChannelSerial=e.channelSerial,!e.presence)break;case tc.PRESENCE:{if(!e.presence)break;tE(e);let r=this.channelOptions;if(this._presence){let n=await Promise.all(e.presence.map(e=>e.decode(r,this.logger)));this._presence.setPresence(n,s,t)}break}case tc.OBJECT:case tc.OBJECT_SYNC:{if(!this._object||!e.state)return;tE(e);let t=this.client.connection.connectionManager.getActiveTransportFormat(),s=e.state.map(e=>e.decode(this.client,t));e.action===tc.OBJECT?this._object.handleObjectMessages(s):this._object.handleObjectSyncMessages(s,e.channelSerial);break}case tc.MESSAGE:{if("attached"!==this.state){z.logAction(this.logger,z.LOG_MAJOR,"RealtimeChannel.processMessage()",'Message "'+e.id+'" skipped as this channel "'+this.name+'" state is not "attached" (state is "'+this.state+'").');return}tE(e);let t=e.messages,s=t[0],r=t[t.length-1];if(s.extras&&s.extras.delta&&s.extras.delta.from!==this._lastPayload.messageId){let t='Delta message decode failure - previous message not available for message "'+e.id+'" on this channel "'+this.name+'".';z.logAction(this.logger,z.LOG_ERROR,"RealtimeChannel.processMessage()",t),this._startDecodeFailureRecovery(new Q(t,40018,400));break}let n=[];for(let e=0;e<t.length;e++){let{decoded:s,err:r}=await t[e].decodeWithErr(this._decodingContext,this.logger);if(n[e]=s,r)switch(r.code){case 40018:this._startDecodeFailureRecovery(r);return;case 40019:case 40021:this.notifyState("failed",r);return}}this._lastPayload.messageId=r.id,this._lastPayload.protocolMessageChannelSerial=e.channelSerial,this.onEvent(n);break}case tc.ANNOTATION:{tE(e);let t=this.channelOptions;if(this._annotations){let s=await Promise.all((e.annotations||[]).map(e=>e.decode(t,this.logger)));this._annotations._processIncoming(s)}break}case tc.ERROR:{let t=e.error;t&&80016==t.code?this.checkPendingState():this.notifyState("failed",Q.fromValues(t));break}default:z.logAction(this.logger,z.LOG_MAJOR,"RealtimeChannel.processMessage()","Protocol error: unrecognised message action ("+e.action+")")}}_startDecodeFailureRecovery(e){this._lastPayload.decodeFailureRecoveryInProgress||(z.logAction(this.logger,z.LOG_MAJOR,"RealtimeChannel.processMessage()","Starting decode failure recovery process."),this._lastPayload.decodeFailureRecoveryInProgress=!0,this._attach(!0,e,()=>{this._lastPayload.decodeFailureRecoveryInProgress=!1}))}onAttached(){z.logAction(this.logger,z.LOG_MINOR,"RealtimeChannel.onAttached","activating channel; name = "+this.name)}notifyState(e,t,s,r,n,i){if(z.logAction(this.logger,z.LOG_MICRO,"RealtimeChannel.notifyState","name = "+this.name+", current state = "+this.state+", notifying state "+e),this.clearStateTimer(),["detached","suspended","failed"].includes(e)&&(this.properties.channelSerial=null),e===this.state)return;this._presence&&this._presence.actOnChannelState(e,r,t),this._object&&this._object.actOnChannelState(e,i),"suspended"===e&&this.connectionManager.state.sendEvents?this.startRetryTimer():this.cancelRetryTimer(),t&&(this.errorReason=t);let o=new sE(this.state,e,s,n,t),a='Channel state for channel "'+this.name+'"',l=e+(t?"; reason: "+t:"");"failed"===e?z.logAction(this.logger,z.LOG_ERROR,a,l):z.logAction(this.logger,z.LOG_MAJOR,a,l),"attaching"!==e&&"suspended"!==e&&(this.retryCount=0),"attached"===e&&this.onAttached(),"attached"===e?this._attachResume=!0:("detaching"===e||"failed"===e)&&(this._attachResume=!1),this.state=e,this._allChannelChanges.emit(e,o),this.emit(e,o)}requestState(e,t){z.logAction(this.logger,z.LOG_MINOR,"RealtimeChannel.requestState","name = "+this.name+", state = "+e),this.notifyState(e,t),this.checkPendingState()}checkPendingState(){if(!this.connectionManager.state.sendEvents){z.logAction(this.logger,z.LOG_MINOR,"RealtimeChannel.checkPendingState","sendEvents is false; state is "+this.connectionManager.state.state);return}switch(z.logAction(this.logger,z.LOG_MINOR,"RealtimeChannel.checkPendingState","name = "+this.name+", state = "+this.state),this.state){case"attaching":this.startStateTimerIfNotRunning(),this.attachImpl();break;case"detaching":this.startStateTimerIfNotRunning(),this.detachImpl();break;case"attached":this.sync()}}timeoutPendingState(){switch(this.state){case"attaching":{let e=new Q("Channel attach timed out",90007,408);this.notifyState("suspended",e);break}case"detaching":{let e=new Q("Channel detach timed out",90007,408);this.notifyState("attached",e);break}default:this.checkPendingState()}}startStateTimerIfNotRunning(){this.stateTimer||(this.stateTimer=setTimeout(()=>{z.logAction(this.logger,z.LOG_MINOR,"RealtimeChannel.startStateTimerIfNotRunning","timer expired"),this.stateTimer=null,this.timeoutPendingState()},this.client.options.timeouts.realtimeRequestTimeout))}clearStateTimer(){let e=this.stateTimer;e&&(clearTimeout(e),this.stateTimer=null)}startRetryTimer(){if(this.retryTimer)return;this.retryCount++;let e=eU(this.client.options.timeouts.channelRetryTimeout,this.retryCount);this.retryTimer=setTimeout(()=>{"suspended"===this.state&&this.connectionManager.state.sendEvents&&(this.retryTimer=null,z.logAction(this.logger,z.LOG_MINOR,"RealtimeChannel retry timer expired","attempting a new attach"),this.requestState("attaching"))},e)}cancelRetryTimer(){this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)}getReleaseErr(){let e=this.state;return"initialized"===e||"detached"===e||"failed"===e?null:new Q("Can only release a channel in a state where there is no possibility of further updates from the server being received (initialized, detached, or failed); was "+e,90001,400)}setChannelSerial(e){z.logAction(this.logger,z.LOG_MICRO,"RealtimeChannel.setChannelSerial()","Updating channel serial; serial = "+e+"; previous = "+this.properties.channelSerial),e&&(this.properties.channelSerial=e)}async status(){return this.client.rest.channelMixin.status(this)}async getMessage(e){return z.logAction(this.logger,z.LOG_MICRO,"RealtimeChannel.getMessage()","channel = "+this.name),this.client.rest.channelMixin.getMessage(this,e)}async updateMessage(e,t,s){return z.logAction(this.logger,z.LOG_MICRO,"RealtimeChannel.updateMessage()","channel = "+this.name),this.sendUpdate(e,"message.update",t,s)}async deleteMessage(e,t,s){return z.logAction(this.logger,z.LOG_MICRO,"RealtimeChannel.deleteMessage()","channel = "+this.name),this.sendUpdate(e,"message.delete",t,s)}async appendMessage(e,t,s){return z.logAction(this.logger,z.LOG_MICRO,"RealtimeChannel.appendMessage()","channel = "+this.name),this.sendUpdate(e,"message.append",t,s)}async sendUpdate(e,t,s,r){var n,i;if(!e.serial)throw new Q('This message lacks a serial and cannot be updated. Make sure you have enabled "Message annotations, updates, and deletes" in channel settings on your dashboard.',40003,400);this.throwIfUnpublishableState();let o=t3.fromValues(E(O({},e),{action:t,version:s})),a=await o.encode(this.channelOptions),l=sw({action:tc.MESSAGE,channel:this.name,messages:[a],params:r?ev(r):void 0}),c=await this.sendMessage(l);return{versionSerial:null!=(i=null==(n=null==c?void 0:c.serials)?void 0:n[0])?i:null}}async getMessageVersions(e,t){return z.logAction(this.logger,z.LOG_MICRO,"RealtimeChannel.getMessageVersions()","channel = "+this.name),this.client.rest.channelMixin.getMessageVersions(this,e,t)}async ensureAttached(){switch(this.state){case"attached":case"suspended":break;case"initialized":case"detached":case"detaching":case"attaching":await this.attach();break;default:throw Q.fromValues(this.invalidStateError())}}};function sR(e){let t=e||{},{agent:s}=t;return k(t,["agent"])}var sT=class{constructor(e){this.channel=e,this.logger=e.logger,this.subscriptions=new tl(this.logger)}async publish(e,t){let s=this.channel.name,r=sm(e,t),n=await r.encode();this.channel.throwIfUnpublishableState(),z.logAction(this.logger,z.LOG_MICRO,"RealtimeAnnotations.publish()","channelName = "+s+", sending annotation with messageSerial = "+r.messageSerial+", type = "+r.type);let i=sw({action:tc.ANNOTATION,channel:s,annotations:[n]});await this.channel.sendMessage(i)}async delete(e,t){t.action="annotation.delete",await this.publish(e,t)}async subscribe(...e){let t=sC.processListenerArgs(e),s=t[0],r=t[1],n=this.channel;if("failed"===n.state)throw Q.fromValues(n.invalidStateError());if(this.subscriptions.on(s,r),!1!==this.channel.channelOptions.attachOnSubscribe&&await n.attach(),0===("attached"===this.channel.state&&this.channel._mode&tu.ANNOTATION_SUBSCRIBE))throw new Q("You are trying to add an annotation listener, but you haven't requested the annotation_subscribe channel mode in ChannelOptions, so this won't do anything (we only deliver annotations to clients who have explicitly requested them)",93001,400)}unsubscribe(...e){let t=sC.processListenerArgs(e),s=t[0],r=t[1];this.subscriptions.off(s,r)}_processIncoming(e){for(let t of e)this.subscriptions.emit(t.type||"",t)}async get(e,t){return sb.prototype.get.call(this,e,t)}},sA=class e extends ss{constructor(t){var s,r;if(!e._MsgPack)throw Error("Expected DefaultRest._MsgPack to have been set");super(ez.objectifyOptions(t,!0,"Rest",z.defaultLogger,E(O({},sr),{Crypto:null!=(s=e.Crypto)?s:void 0,MsgPack:null!=(r=e._MsgPack)?r:void 0,Annotations:{Annotation:sf,WireAnnotation:sd,RealtimeAnnotations:sT,RestAnnotations:sb}})))}static get Crypto(){if(null===this._Crypto)throw Error("Encryption not enabled; use ably.encryption.js instead");return this._Crypto}static set Crypto(e){this._Crypto=e}};sA._Crypto=null,sA.Message=sn,sA.PresenceMessage=si,sA.Annotation=sp,sA._MsgPack=null,sA._Http=to;var sP=class extends tl{constructor(e){super(e),this.messages=[]}count(){return this.messages.length}push(e){this.messages.push(e)}shift(){return this.messages.shift()}last(){return this.messages[this.messages.length-1]}copyAll(){return this.messages.slice()}append(e){this.messages.push.apply(this.messages,e)}prepend(e){this.messages.unshift.apply(this.messages,e)}completeMessages(e,t,s){z.logAction(this.logger,z.LOG_MICRO,"MessageQueue.completeMessages()","all"==e?"(all)":"serial = "+e.serial+"; count = "+e.count),t=t||null;let r=this.messages;if(0===r.length)throw Error("MessageQueue.completeMessages(): completeMessages called on any empty MessageQueue");let n=[];if("all"===e)n=r.splice(0);else{let t=r[0];if(t){let s=t.message.msgSerial,i=e.serial+e.count;i>s&&(n=r.splice(0,i-s))}}for(let e=0;e<n.length;e++){let r=n[e],i=null==s?void 0:s[e];r.callback(t,i)}0==r.length&&this.emit("idle")}completeAllMessages(e){this.completeMessages("all",e)}resetSendAttempted(){for(let e of this.messages)e.sendAttempted=!1}clear(){z.logAction(this.logger,z.LOG_MICRO,"MessageQueue.clear()","clearing "+this.messages.length+" messages"),this.messages=[],this.emit("idle")}},sM=class{constructor(e,t){this.message=e,this.callback=t,this.merged=!1;let s=e.action;this.sendAttempted=!1,this.ackRequired="number"==typeof s&&[tc.MESSAGE,tc.PRESENCE,tc.ANNOTATION,tc.OBJECT].includes(s)}},sI=class extends tl{constructor(e){super(e.logger),this.transport=e,this.messageQueue=new sP(this.logger),e.on("ack",(e,t,s)=>{this.onAck(e,t,s)}),e.on("nack",(e,t,s)=>{this.onNack(e,t,s)})}onAck(e,t,s){z.logAction(this.logger,z.LOG_MICRO,"Protocol.onAck()","serial = "+e+"; count = "+t),this.messageQueue.completeMessages({serial:e,count:t},null,s)}onNack(e,t,s){z.logAction(this.logger,z.LOG_ERROR,"Protocol.onNack()","serial = "+e+"; count = "+t+"; err = "+eO(s)),s||(s=new Q("Unable to send message; channel not responding",50001,500)),this.messageQueue.completeMessages({serial:e,count:t},s)}onceIdle(e){let t=this.messageQueue;if(0===t.count()){e();return}t.once("idle",e)}send(e){e.ackRequired&&this.messageQueue.push(e),this.logger.shouldLog(z.LOG_MICRO)&&z.logActionNoStrip(this.logger,z.LOG_MICRO,"Protocol.send()","sending msg; "+sS(e.message,this.transport.connectionManager.realtime._RealtimePresence,this.transport.connectionManager.realtime._Annotations,this.transport.connectionManager.realtime._liveObjectsPlugin)),e.sendAttempted=!0,this.transport.send(e.message)}getTransport(){return this.transport}getPendingMessages(){return this.messageQueue.copyAll()}clearPendingMessages(){return this.messageQueue.clear()}finish(){let e=this.transport;this.onceIdle(function(){e.disconnect()})}},sx=class{constructor(e,t,s,r){this.previous=e,this.current=t,s&&(this.retryIn=s),r&&(this.reason=r)}},sL={DISCONNECTED:80003,SUSPENDED:80002,FAILED:8e4,CLOSING:80017,CLOSED:80017,UNKNOWN_CONNECTION_ERR:50002,UNKNOWN_CHANNEL_ERR:50001},sN={disconnected:()=>Q.fromValues({statusCode:400,code:sL.DISCONNECTED,message:"Connection to server temporarily unavailable"}),suspended:()=>Q.fromValues({statusCode:400,code:sL.SUSPENDED,message:"Connection to server unavailable"}),failed:()=>Q.fromValues({statusCode:400,code:sL.FAILED,message:"Connection failed or disconnected by server"}),closing:()=>Q.fromValues({statusCode:400,code:sL.CLOSING,message:"Connection closing"}),closed:()=>Q.fromValues({statusCode:400,code:sL.CLOSED,message:"Connection closed"}),unknownConnectionErr:()=>Q.fromValues({statusCode:500,code:sL.UNKNOWN_CONNECTION_ERR,message:"Internal connection error"}),unknownChannelErr:()=>Q.fromValues({statusCode:500,code:sL.UNKNOWN_CONNECTION_ERR,message:"Internal channel error"})},sU=sw({action:tc.CLOSE}),sj=sw({action:tc.DISCONNECT}),sB=class extends tl{constructor(e,t,s,r){super(e.logger),r&&(s.format=void 0,s.heartbeats=!0),this.connectionManager=e,this.auth=t,this.params=s,this.timeouts=s.options.timeouts,this.format=s.format,this.isConnected=!1,this.isFinished=!1,this.isDisposed=!1,this.maxIdleInterval=null,this.idleTimer=null,this.lastActivity=null}connect(){}close(){this.isConnected&&this.requestClose(),this.finish("closed",sN.closed())}disconnect(e){this.isConnected&&this.requestDisconnect(),this.finish("disconnected",e||sN.disconnected())}fail(e){this.isConnected&&this.requestDisconnect(),this.finish("failed",e||sN.failed())}finish(e,t){var s;this.isFinished||(this.isFinished=!0,this.isConnected=!1,this.maxIdleInterval=null,clearTimeout(null!=(s=this.idleTimer)?s:void 0),this.idleTimer=null,this.emit(e,t),this.dispose())}onProtocolMessage(e){switch(this.logger.shouldLog(z.LOG_MICRO)&&z.logActionNoStrip(this.logger,z.LOG_MICRO,"Transport.onProtocolMessage()","received on "+this.shortName+": "+sS(e,this.connectionManager.realtime._RealtimePresence,this.connectionManager.realtime._Annotations,this.connectionManager.realtime._liveObjectsPlugin)+"; connectionId = "+this.connectionManager.connectionId),this.onActivity(),e.action){case tc.HEARTBEAT:z.logActionNoStrip(this.logger,z.LOG_MICRO,"Transport.onProtocolMessage()",this.shortName+" heartbeat; connectionId = "+this.connectionManager.connectionId),this.emit("heartbeat",e.id);break;case tc.CONNECTED:this.onConnect(e),this.emit("connected",e.error,e.connectionId,e.connectionDetails,e);break;case tc.CLOSED:this.onClose(e);break;case tc.DISCONNECTED:this.onDisconnect(e);break;case tc.ACK:this.emit("ack",e.msgSerial,e.count,e.res);break;case tc.NACK:this.emit("nack",e.msgSerial,e.count,e.error);break;case tc.SYNC:this.connectionManager.onChannelMessage(e,this);break;case tc.ACTIVATE:break;case tc.AUTH:eA(this.auth.authorize(),e=>{e&&z.logAction(this.logger,z.LOG_ERROR,"Transport.onProtocolMessage()","Ably requested re-authentication, but unable to obtain a new token: "+eO(e))});break;case tc.ERROR:if(z.logAction(this.logger,z.LOG_MINOR,"Transport.onProtocolMessage()","received error action; connectionId = "+this.connectionManager.connectionId+"; err = "+H.Config.inspect(e.error)+(e.channel?", channel: "+e.channel:"")),void 0===e.channel){this.onFatalError(e);break}this.connectionManager.onChannelMessage(e,this);break;default:this.connectionManager.onChannelMessage(e,this)}}onConnect(e){if(this.isConnected=!0,!e.connectionDetails)throw Error("Transport.onConnect(): Connect message recieved without connectionDetails");let t=e.connectionDetails.maxIdleInterval;t&&(this.maxIdleInterval=t+this.timeouts.realtimeRequestTimeout,this.onActivity())}onDisconnect(e){let t=e&&e.error;z.logAction(this.logger,z.LOG_MINOR,"Transport.onDisconnect()","err = "+eO(t)),this.finish("disconnected",t)}onFatalError(e){let t=e&&e.error;z.logAction(this.logger,z.LOG_MINOR,"Transport.onFatalError()","err = "+eO(t)),this.finish("failed",t)}onClose(e){let t=e&&e.error;z.logAction(this.logger,z.LOG_MINOR,"Transport.onClose()","err = "+eO(t)),this.finish("closed",t)}requestClose(){z.logAction(this.logger,z.LOG_MINOR,"Transport.requestClose()",""),this.send(sU)}requestDisconnect(){z.logAction(this.logger,z.LOG_MINOR,"Transport.requestDisconnect()",""),this.send(sj)}ping(e){let t={action:tc.HEARTBEAT};e&&(t.id=e),this.send(sw(t))}dispose(){z.logAction(this.logger,z.LOG_MINOR,"Transport.dispose()",""),this.isDisposed=!0,this.off()}onActivity(){this.maxIdleInterval&&(this.lastActivity=this.connectionManager.lastActivity=Date.now(),this.setIdleTimer(this.maxIdleInterval+100))}setIdleTimer(e){this.idleTimer||(this.idleTimer=setTimeout(()=>{this.onIdleTimerExpire()},e))}onIdleTimerExpire(){if(!this.lastActivity||!this.maxIdleInterval)throw Error("Transport.onIdleTimerExpire(): lastActivity/maxIdleInterval not set");this.idleTimer=null;let e=Date.now()-this.lastActivity,t=this.maxIdleInterval-e;if(t<=0){let t="No activity seen from realtime in "+e+"ms; assuming connection has dropped";z.logAction(this.logger,z.LOG_ERROR,"Transport.onIdleTimerExpire()",t),this.disconnect(new Q(t,80003,408))}else this.setIdleTimer(t+100)}static tryConnect(e,t,s,r,n){let i;let o=new e(t,s,r),a=function(e){clearTimeout(i),n({event:this.event,error:e})};return i=setTimeout(()=>{o.off(["preconnect","disconnected","failed"]),o.dispose(),a.call({event:"disconnected"},new Q("Timeout waiting for transport to indicate itself viable",5e4,500))},t.options.timeouts.realtimeRequestTimeout),o.on(["failed","disconnected"],a),o.on("preconnect",function(){z.logAction(t.logger,z.LOG_MINOR,"Transport.tryConnect()","viable transport "+o),clearTimeout(i),o.off(["failed","disconnected"],a),n(null,o)}),o.connect(),o}static isAvailable(){throw new Q("isAvailable not implemented for transport",5e4,500)}};(o=l||(l={})).WebSocket="web_socket",o.Comet="comet",o.XhrPolling="xhr_polling";var sq="undefined"!=typeof global?global:"undefined"!=typeof window?window:self,sD=()=>{var e;return void 0!==H.WebStorage&&(null==(e=H.WebStorage)?void 0:e.localSupported)},sG=()=>{var e;return void 0!==H.WebStorage&&(null==(e=H.WebStorage)?void 0:e.sessionSupported)},sH=function(){},sW="ably-transport-preference";function sF(e){try{return JSON.parse(e)}catch(e){return null}}var sV=class{constructor(e,t,s,r){this.options=e,this.host=t,this.mode=s,this.connectionKey=r,this.format=e.useBinaryProtocol?"msgpack":"json"}getConnectParams(e){let t=e?Z(e):{},s=this.options;switch(this.mode){case"resume":t.resume=this.connectionKey;break;case"recover":{let e=sF(s.recover);e&&(t.recover=e.connectionKey)}}return void 0!==s.clientId&&(t.clientId=s.clientId),!1===s.echoMessages&&(t.echo="false"),void 0!==this.format&&(t.format=this.format),void 0!==this.stream&&(t.stream=this.stream),void 0!==this.heartbeats&&(t.heartbeats=this.heartbeats),t.v=ez.protocolVersion,t.agent=e0(this.options),void 0!==s.transportParams&&Y(t,s.transportParams),t}toString(){let e="[mode="+this.mode;return this.host&&(e+=",host="+this.host),this.connectionKey&&(e+=",connectionKey="+this.connectionKey),this.format&&(e+=",format="+this.format),e+="]"}},s$=class e extends tl{constructor(e,t){super(e.logger),this.supportedTransports={},this.disconnectedRetryCount=0,this.pendingChannelMessagesState={isProcessing:!1,queue:[]},this.realtime=e,this.initTransports(),this.options=t;let s=t.timeouts,r=s.webSocketConnectTimeout+s.realtimeRequestTimeout;if(this.states={initialized:{state:"initialized",terminal:!1,queueEvents:!0,sendEvents:!1,failState:"disconnected"},connecting:{state:"connecting",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:r,failState:"disconnected"},connected:{state:"connected",terminal:!1,queueEvents:!1,sendEvents:!0,failState:"disconnected"},disconnected:{state:"disconnected",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:s.disconnectedRetryTimeout,failState:"disconnected"},suspended:{state:"suspended",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:s.suspendedRetryTimeout,failState:"suspended"},closing:{state:"closing",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:s.realtimeRequestTimeout,failState:"closed"},closed:{state:"closed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"closed"},failed:{state:"failed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"failed"}},this.state=this.states.initialized,this.errorReason=null,this.queuedMessages=new sP(this.logger),this.msgSerial=0,this.connectionDetails=void 0,this.connectionId=void 0,this.connectionKey=void 0,this.connectionStateTtl=s.connectionStateTtl,this.maxIdleInterval=null,this.transports=el(t.transports||ez.defaultTransports,this.supportedTransports),this.transportPreference=null,this.transports.includes(l.WebSocket)&&(this.webSocketTransportAvailable=!0),this.transports.includes(l.XhrPolling)?this.baseTransport=l.XhrPolling:this.transports.includes(l.Comet)&&(this.baseTransport=l.Comet),this.domains=ez.getHosts(t),this.activeProtocol=null,this.host=null,this.lastAutoReconnectAttempt=null,this.lastActivity=null,this.forceFallbackHost=!1,this.connectCounter=0,this.wsCheckResult=null,this.webSocketSlowTimer=null,this.webSocketGiveUpTimer=null,this.abandonedWebSocket=!1,z.logAction(this.logger,z.LOG_MINOR,"Realtime.ConnectionManager()","started"),z.logAction(this.logger,z.LOG_MICRO,"Realtime.ConnectionManager()","requested transports = ["+(t.transports||ez.defaultTransports)+"]"),z.logAction(this.logger,z.LOG_MICRO,"Realtime.ConnectionManager()","available transports = ["+this.transports+"]"),z.logAction(this.logger,z.LOG_MICRO,"Realtime.ConnectionManager()","http domains = ["+this.domains+"]"),!this.transports.length){let e="no requested transports available";throw z.logAction(this.logger,z.LOG_ERROR,"realtime.ConnectionManager()",e),Error(e)}let n=H.Config.addEventListener;n&&(sG()&&"function"==typeof t.recover&&n("beforeunload",this.persistConnection.bind(this)),!0===t.closeOnUnload&&n("beforeunload",()=>{z.logAction(this.logger,z.LOG_MAJOR,"Realtime.ConnectionManager()","beforeunload event has triggered the connection to close as closeOnUnload is true"),this.requestState({state:"closing"})}),n("online",()=>{var e;this.state==this.states.disconnected||this.state==this.states.suspended?(z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager caught browser â€˜onlineâ€™ event","reattempting connection"),this.requestState({state:"connecting"})):this.state==this.states.connecting&&(null==(e=this.pendingTransport)||e.off(),this.disconnectAllTransports(),this.startConnect())}),n("offline",()=>{this.state==this.states.connected&&(z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager caught browser â€˜offlineâ€™ event","disconnecting active transport"),this.disconnectAllTransports())}))}static supportedTransports(e){let t={supportedTransports:{}};return this.initTransports(e,t),t.supportedTransports}static initTransports(e,t){let s=O(O({},H.Transports.bundledImplementations),e);[l.WebSocket,...H.Transports.order].forEach(e=>{let r=s[e];r&&r.isAvailable()&&(t.supportedTransports[e]=r)})}initTransports(){e.initTransports(this.realtime._additionalTransportImplementations,this)}createTransportParams(e,t){return new sV(this.options,e,t,this.connectionKey)}getTransportParams(e){(e=>{if(this.connectionKey){e("resume");return}if("string"==typeof this.options.recover){e("recover");return}let t=this.options.recover,s=this.getSessionRecoverData(),r=this.sessionRecoveryName();if(s&&"function"==typeof t){z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.getTransportParams()","Calling clientOptions-provided recover function with last session data (recovery scope: "+r+")"),t(s,t=>{t?(this.options.recover=s.recoveryKey,e("recover")):e("clean")});return}e("clean")})(t=>{let s=this.createTransportParams(null,t);if("recover"===t){z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport recovery mode = recover; recoveryKey = "+this.options.recover);let e=sF(this.options.recover);e&&(this.msgSerial=e.msgSerial)}else z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport params = "+s.toString());e(s)})}tryATransport(e,t,s){z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.tryATransport()","trying "+t),this.proposedTransport=sB.tryConnect(this.supportedTransports[t],this,this.realtime.auth,e,(r,n)=>{let i=this.state;if(i==this.states.closing||i==this.states.closed||i==this.states.failed){n&&(z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.tryATransport()","connection "+i.state+" while we were attempting the transport; closing "+n),n.close()),s(!0);return}if(r){if(z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.tryATransport()","transport "+t+" "+r.event+", err: "+r.error.toString()),tr.isTokenErr(r.error)&&!(this.errorReason&&tr.isTokenErr(this.errorReason)))this.errorReason=r.error,eA(this.realtime.auth._forceNewToken(null,null),r=>{if(r){this.actOnErrorFromAuthorize(r);return}this.tryATransport(e,t,s)});else if("failed"===r.event)this.notifyState({state:"failed",error:r.error}),s(!0);else if("disconnected"===r.event){var o;!(o=r.error).statusCode||!o.code||o.statusCode>=500||Object.values(sL).includes(o.code)?s(!1):(this.notifyState({state:this.states.connecting.failState,error:r.error}),s(!0))}return}z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.tryATransport()","viable transport "+t+"; setting pending"),this.setTransportPending(n,e),s(null,n)})}setTransportPending(e,t){let s=t.mode;z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.setTransportPending()","transport = "+e+"; mode = "+s),this.pendingTransport=e,this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),e.once("connected",(t,r,n)=>{this.activateTransport(t,e,r,n),"recover"===s&&this.options.recover&&(delete this.options.recover,this.unpersistConnection())});let r=this;e.on(["disconnected","closed","failed"],function(t){r.deactivateTransport(e,this.event,t)}),this.emit("transport.pending",e)}activateTransport(e,t,s,r){z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.activateTransport()","transport = "+t),e&&z.logAction(this.logger,z.LOG_ERROR,"ConnectionManager.activateTransport()","error = "+e),s&&z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.activateTransport()","connectionId =  "+s),r&&z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.activateTransport()","connectionDetails =  "+JSON.stringify(r)),this.persistTransportPreference(t);let n=this.state,i=this.states.connected.state;if(z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.activateTransport()","current state = "+n.state),n.state==this.states.closing.state||n.state==this.states.closed.state||n.state==this.states.failed.state)return z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.activateTransport()","Disconnecting transport and abandoning"),t.disconnect(),!1;if(delete this.pendingTransport,!t.isConnected)return z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.activateTransport()","Declining to activate transport "+t+" since it appears to no longer be connected"),!1;let o=this.activeProtocol;this.activeProtocol=new sI(t),this.host=t.params.host;let a=r.connectionKey;if(a&&this.connectionKey!=a&&this.setConnection(s,r,!!e),this.onConnectionDetailsUpdate(r,t),H.Config.nextTick(()=>{t.on("connected",(e,s,r)=>{this.onConnectionDetailsUpdate(r,t),this.emit("update",new sx(i,i,null,e))})}),n.state===this.states.connected.state?e&&(this.errorReason=this.realtime.connection.errorReason=e,this.emit("update",new sx(i,i,null,e))):(this.notifyState({state:"connected",error:e}),this.errorReason=this.realtime.connection.errorReason=e||null),this.emit("transport.active",t),o){if(o.messageQueue.count()>0&&z.logAction(this.logger,z.LOG_ERROR,"ConnectionManager.activateTransport()","Previous active protocol (for transport "+o.transport.shortName+", new one is "+t.shortName+") finishing with "+o.messageQueue.count()+" messages still pending"),o.transport===t){let e="Assumption violated: activating a transport that was also the transport for the previous active protocol; transport = "+t.shortName+"; stack = "+Error().stack;z.logAction(this.logger,z.LOG_ERROR,"ConnectionManager.activateTransport()",e)}else o.finish()}return!0}deactivateTransport(e,t,s){let r=this.activeProtocol,n=r&&r.getTransport()===e,i=e===this.pendingTransport,o=this.noTransportsScheduledForActivation();if(z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.deactivateTransport()","transport = "+e),z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.deactivateTransport()","state = "+t+(n?"; was active":i?"; was pending":"")+(o?"":"; another transport is scheduled for activation")),s&&s.message&&z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.deactivateTransport()","reason =  "+s.message),n&&(z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.deactivateTransport()","Getting, clearing, and requeuing "+this.activeProtocol.messageQueue.count()+" pending messages"),this.queuePendingMessages(r.getPendingMessages()),r.clearPendingMessages(),this.activeProtocol=this.host=null),this.emit("transport.inactive",e),n&&o||n&&"failed"===t||"closed"===t||null===r&&i){if("disconnected"===t&&s&&s.statusCode>500&&this.domains.length>1){this.unpersistTransportPreference(),this.forceFallbackHost=!0,this.notifyState({state:t,error:s,retryImmediately:!0});return}let e="failed"===t&&tr.isTokenErr(s)?"disconnected":t;this.notifyState({state:e,error:s});return}}noTransportsScheduledForActivation(){return!this.pendingTransport||!this.pendingTransport.isConnected}setConnection(e,t,s){let r=this.connectionId;(r&&r!==e||!r&&s)&&(z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.setConnection()","Resetting msgSerial"),this.msgSerial=0,this.queuedMessages.resetSendAttempted()),this.connectionId!==e&&z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.setConnection()","New connectionId; reattaching any attached channels"),this.realtime.connection.id=this.connectionId=e,this.realtime.connection.key=this.connectionKey=t.connectionKey}clearConnection(){this.realtime.connection.id=this.connectionId=void 0,this.realtime.connection.key=this.connectionKey=void 0,this.msgSerial=0,this.queuedMessages.resetSendAttempted(),this.unpersistConnection()}createRecoveryKey(){return this.connectionKey?JSON.stringify({connectionKey:this.connectionKey,msgSerial:this.msgSerial,channelSerials:this.realtime.channels.channelSerials()}):null}checkConnectionStateFreshness(){if(!this.lastActivity||!this.connectionId)return;let e=Date.now()-this.lastActivity;e>this.connectionStateTtl+this.maxIdleInterval&&(z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.checkConnectionStateFreshness()","Last known activity from realtime was "+e+"ms ago; discarding connection state"),this.clearConnection(),this.states.connecting.failState="suspended")}persistConnection(){if(sG()){let e=this.createRecoveryKey();e&&this.setSessionRecoverData({recoveryKey:e,disconnectedAt:Date.now(),location:sq.location,clientId:this.realtime.auth.clientId})}}unpersistConnection(){this.clearSessionRecoverData()}getActiveTransportFormat(){var e;return null==(e=this.activeProtocol)?void 0:e.getTransport().format}getError(){if(this.errorReason){let e=X.fromValues(this.errorReason);return e.cause=this.errorReason,e}return this.getStateError()}getStateError(){var e;return null==(e=sN[this.state.state])?void 0:e.call(sN)}activeState(){return this.state.queueEvents||this.state.sendEvents}enactStateChange(e){let t="Connection state",s=e.current+(e.reason?"; reason: "+e.reason:"");"failed"===e.current?z.logAction(this.logger,z.LOG_ERROR,t,s):z.logAction(this.logger,z.LOG_MAJOR,t,s),z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.enactStateChange","setting new state: "+e.current+"; reason = "+(e.reason&&e.reason.message));let r=this.state=this.states[e.current];e.reason&&(this.errorReason=e.reason,this.realtime.connection.errorReason=e.reason),(r.terminal||"suspended"===r.state)&&this.clearConnection(),this.emit("connectionstate",e)}startTransitionTimer(e){z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.startTransitionTimer()","transitionState: "+e.state),this.transitionTimer&&(z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.startTransitionTimer()","clearing already-running timer"),clearTimeout(this.transitionTimer)),this.transitionTimer=setTimeout(()=>{this.transitionTimer&&(this.transitionTimer=null,z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager "+e.state+" timer expired","requesting new state: "+e.failState),this.notifyState({state:e.failState}))},e.retryDelay)}cancelTransitionTimer(){z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.cancelTransitionTimer()",""),this.transitionTimer&&(clearTimeout(this.transitionTimer),this.transitionTimer=null)}startSuspendTimer(){this.suspendTimer||(this.suspendTimer=setTimeout(()=>{this.suspendTimer&&(this.suspendTimer=null,z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager suspend timer expired","requesting new state: suspended"),this.states.connecting.failState="suspended",this.notifyState({state:"suspended"}))},this.connectionStateTtl))}checkSuspendTimer(e){"disconnected"!==e&&"suspended"!==e&&"connecting"!==e&&this.cancelSuspendTimer()}cancelSuspendTimer(){this.states.connecting.failState="disconnected",this.suspendTimer&&(clearTimeout(this.suspendTimer),this.suspendTimer=null)}startRetryTimer(e){this.retryTimer=setTimeout(()=>{z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager retry timer expired","retrying"),this.retryTimer=null,this.requestState({state:"connecting"})},e)}cancelRetryTimer(){this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)}startWebSocketSlowTimer(){this.webSocketSlowTimer=setTimeout(()=>{z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager WebSocket slow timer","checking connectivity"),this.checkWsConnectivity().then(()=>{z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager WebSocket slow timer","ws connectivity check succeeded"),this.wsCheckResult=!0}).catch(()=>{z.logAction(this.logger,z.LOG_MAJOR,"ConnectionManager WebSocket slow timer","ws connectivity check failed"),this.wsCheckResult=!1}),this.realtime.http.checkConnectivity&&eA(this.realtime.http.checkConnectivity(),(e,t)=>{e||!t?(z.logAction(this.logger,z.LOG_MAJOR,"ConnectionManager WebSocket slow timer","http connectivity check failed"),this.cancelWebSocketGiveUpTimer(),this.notifyState({state:"disconnected",error:new Q("Unable to connect (network unreachable)",80003,404)})):z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager WebSocket slow timer","http connectivity check succeeded")})},this.options.timeouts.webSocketSlowTimeout)}cancelWebSocketSlowTimer(){this.webSocketSlowTimer&&(clearTimeout(this.webSocketSlowTimer),this.webSocketSlowTimer=null)}startWebSocketGiveUpTimer(e){this.webSocketGiveUpTimer=setTimeout(()=>{var t,s;this.wsCheckResult||(z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager WebSocket give up timer","websocket connection took more than 10s; "+(this.baseTransport?"trying base transport":"")),this.baseTransport?(this.abandonedWebSocket=!0,null==(t=this.proposedTransport)||t.dispose(),null==(s=this.pendingTransport)||s.dispose(),this.connectBase(e,++this.connectCounter)):z.logAction(this.logger,z.LOG_MAJOR,"ConnectionManager WebSocket give up timer","websocket connectivity appears to be unavailable but no other transports to try"))},this.options.timeouts.webSocketConnectTimeout)}cancelWebSocketGiveUpTimer(){this.webSocketGiveUpTimer&&(clearTimeout(this.webSocketGiveUpTimer),this.webSocketGiveUpTimer=null)}notifyState(e){var t;let s=e.state,r="disconnected"===s&&(this.state===this.states.connected||e.retryImmediately||this.state===this.states.connecting&&e.error&&tr.isTokenErr(e.error)&&!(this.errorReason&&tr.isTokenErr(this.errorReason)));if(z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.notifyState()","new state: "+s+(r?"; will retry connection immediately":"")),s==this.state.state||(this.cancelTransitionTimer(),this.cancelRetryTimer(),this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),this.checkSuspendTimer(e.state),("suspended"===s||"connected"===s)&&(this.disconnectedRetryCount=0),this.state.terminal))return;let n=this.states[e.state],i=n.retryDelay;"disconnected"===n.state&&(this.disconnectedRetryCount++,i=eU(n.retryDelay,this.disconnectedRetryCount));let o=new sx(this.state.state,n.state,i,e.error||(null==(t=sN[n.state])?void 0:t.call(sN)));if(r){let e=()=>{this.state===this.states.disconnected&&(this.lastAutoReconnectAttempt=Date.now(),this.requestState({state:"connecting"}))},t=this.lastAutoReconnectAttempt&&Date.now()-this.lastAutoReconnectAttempt+1;t&&t<1e3?(z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.notifyState()","Last reconnect attempt was only "+t+"ms ago, waiting another "+(1e3-t)+"ms before trying again"),setTimeout(e,1e3-t)):H.Config.nextTick(e)}else("disconnected"===s||"suspended"===s)&&this.startRetryTimer(i);("disconnected"===s&&!r||"suspended"===s||n.terminal)&&H.Config.nextTick(()=>{this.disconnectAllTransports()}),"connected"!=s||this.activeProtocol||z.logAction(this.logger,z.LOG_ERROR,"ConnectionManager.notifyState()","Broken invariant: attempted to go into connected state, but there is no active protocol"),this.enactStateChange(o),this.state.sendEvents?this.sendQueuedMessages():this.state.queueEvents||(this.realtime.channels.propogateConnectionInterruption(s,o.reason),this.failQueuedMessages(o.reason))}requestState(e){var t;let s=e.state;if(z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.requestState()","requested state: "+s+"; current state: "+this.state.state),s==this.state.state||(this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),this.cancelTransitionTimer(),this.cancelRetryTimer(),this.checkSuspendTimer(s),"connecting"==s&&"connected"==this.state.state||"closing"==s&&"closed"==this.state.state))return;let r=this.states[s],n=new sx(this.state.state,r.state,null,e.error||(null==(t=sN[r.state])?void 0:t.call(sN)));this.enactStateChange(n),"connecting"==s&&H.Config.nextTick(()=>{this.startConnect()}),"closing"==s&&this.closeImpl()}startConnect(){if(this.state!==this.states.connecting){z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.startConnect()","Must be in connecting state to connect, but was "+this.state.state);return}let e=this.realtime.auth,t=++this.connectCounter,s=()=>{this.checkConnectionStateFreshness(),this.getTransportParams(e=>{if("recover"===e.mode&&e.options.recover){let t=sF(e.options.recover);t&&this.realtime.channels.recoverChannels(t.channelSerials)}t===this.connectCounter&&this.connectImpl(e,t)})};if(z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.startConnect()","starting connection"),this.startSuspendTimer(),this.startTransitionTimer(this.states.connecting),"basic"===e.method)s();else{let r=e=>{t===this.connectCounter&&(e?this.actOnErrorFromAuthorize(e):s())};this.errorReason&&tr.isTokenErr(this.errorReason)?eA(e._forceNewToken(null,null),r):eA(e._ensureValidAuthCredentials(!1),r)}}connectImpl(e,t){let s=this.state.state;if(s!==this.states.connecting.state){z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.connectImpl()","Must be in connecting state to connect, but was "+s);return}let r=this.getTransportPreference();r&&r===this.baseTransport&&this.webSocketTransportAvailable&&this.checkWsConnectivity().then(()=>{this.unpersistTransportPreference(),this.state===this.states.connecting&&(z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.connectImpl():","web socket connectivity available, cancelling connection attempt with "+this.baseTransport),this.disconnectAllTransports(),this.connectWs(e,++this.connectCounter))}).catch(sH),r&&r===this.baseTransport||this.baseTransport&&!this.webSocketTransportAvailable?this.connectBase(e,t):this.connectWs(e,t)}connectWs(e,t){z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.connectWs()"),this.wsCheckResult=null,this.abandonedWebSocket=!1,this.startWebSocketSlowTimer(),this.startWebSocketGiveUpTimer(e),this.tryTransportWithFallbacks("web_socket",e,!0,t,()=>!1!==this.wsCheckResult&&!this.abandonedWebSocket)}connectBase(e,t){z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.connectBase()"),this.baseTransport?this.tryTransportWithFallbacks(this.baseTransport,e,!1,t,()=>!0):this.notifyState({state:"disconnected",error:new Q("No transports left to try",8e4,404)})}tryTransportWithFallbacks(e,t,s,r,n){z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.tryTransportWithFallbacks()",e);let i=e=>{this.notifyState({state:this.states.connecting.failState,error:e})},o=this.domains.slice(),a=(e,t)=>{if(r===this.connectCounter){if(!n()){t&&t.dispose();return}t||e||c()}},l=o.shift();if(!l){i(new Q("Unable to connect (no available host)",80003,404));return}t.host=l;let c=()=>{if(!o.length){i(new Q("Unable to connect (and no more fallback hosts to try)",80003,404));return}if(!this.realtime.http.checkConnectivity){i(new X("Internal error: Http.checkConnectivity not set",null,500));return}eA(this.realtime.http.checkConnectivity(),(s,l)=>{if(r===this.connectCounter&&n()){if(s){i(s);return}if(!l){i(new Q("Unable to connect (network unreachable)",80003,404));return}t.host=eb(o),this.tryATransport(t,e,a)}})};if(this.forceFallbackHost&&o.length){this.forceFallbackHost=!1,c();return}this.tryATransport(t,e,a)}closeImpl(){z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.closeImpl()","closing connection"),this.cancelSuspendTimer(),this.startTransitionTimer(this.states.closing),this.pendingTransport&&(z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.closeImpl()","Closing pending transport: "+this.pendingTransport),this.pendingTransport.close()),this.activeProtocol&&(z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.closeImpl()","Closing active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().close()),this.notifyState({state:"closed"})}onAuthUpdated(e,t){var s;switch(this.state.state){case"connected":{z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Sending AUTH message on active transport");let r=null==(s=this.activeProtocol)?void 0:s.getTransport();r&&r.onAuthUpdated&&r.onAuthUpdated(e);let n=sw({action:tc.AUTH,auth:{accessToken:e.token}});this.send(n);let i=()=>{this.off(o),t(null,e)},o=e=>{"failed"===e.current&&(this.off(i),this.off(o),t(e.reason||this.getStateError()))};this.once("connectiondetails",i),this.on("connectionstate",o);break}case"connecting":z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Aborting current connection attempts in order to start again with the new auth details"),this.disconnectAllTransports();default:{z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Connection state is "+this.state.state+"; waiting until either connected or failed");let s=r=>{switch(r.current){case"connected":this.off(s),t(null,e);break;case"failed":case"closed":case"suspended":this.off(s),t(r.reason||this.getStateError())}};this.on("connectionstate",s),"connecting"===this.state.state?this.startConnect():this.requestState({state:"connecting"})}}}disconnectAllTransports(){z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.disconnectAllTransports()","Disconnecting all transports"),this.connectCounter++,this.pendingTransport&&(z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting pending transport: "+this.pendingTransport),this.pendingTransport.disconnect()),delete this.pendingTransport,this.proposedTransport&&(z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting proposed transport: "+this.pendingTransport),this.proposedTransport.disconnect()),delete this.pendingTransport,this.activeProtocol&&(z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().disconnect())}send(e,t,s){s=s||sH;let r=this.state;if(r.sendEvents){z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.send()","sending event"),this.sendImpl(new sM(e,s));return}if(!(t&&r.queueEvents)){let e="rejecting event, queueEvent was "+t+", state was "+r.state;z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.send()",e),s(this.errorReason||new Q(e,9e4,400));return}this.logger.shouldLog(z.LOG_MICRO)&&z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.send()","queueing msg; "+sS(e,this.realtime._RealtimePresence,this.realtime._Annotations,this.realtime._liveObjectsPlugin)),this.queue(e,s)}sendImpl(e){let t=e.message;e.ackRequired&&!e.sendAttempted&&(t.msgSerial=this.msgSerial++);try{this.activeProtocol.send(e)}catch(e){z.logAction(this.logger,z.LOG_ERROR,"ConnectionManager.sendImpl()","Unexpected exception in transport.send(): "+e.stack)}}queue(e,t){z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.queue()","queueing event"),this.queuedMessages.push(new sM(e,t))}sendQueuedMessages(){let e;for(z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.sendQueuedMessages()","sending "+this.queuedMessages.count()+" queued messages");e=this.queuedMessages.shift();)this.sendImpl(e)}queuePendingMessages(e){e&&e.length&&(z.logAction(this.logger,z.LOG_MICRO,"ConnectionManager.queuePendingMessages()","queueing "+e.length+" pending messages"),this.queuedMessages.prepend(e))}failQueuedMessages(e){let t=this.queuedMessages.count();t>0&&(z.logAction(this.logger,z.LOG_ERROR,"ConnectionManager.failQueuedMessages()","failing "+t+" queued messages, err = "+eO(e)),this.queuedMessages.completeAllMessages(e))}onChannelMessage(e,t){this.pendingChannelMessagesState.queue.push({message:e,transport:t}),this.pendingChannelMessagesState.isProcessing||this.processNextPendingChannelMessage()}processNextPendingChannelMessage(){if(this.pendingChannelMessagesState.queue.length>0){this.pendingChannelMessagesState.isProcessing=!0;let e=this.pendingChannelMessagesState.queue.shift();this.processChannelMessage(e.message).catch(e=>{z.logAction(this.logger,z.LOG_ERROR,"ConnectionManager.processNextPendingChannelMessage() received error ",e)}).finally(()=>{this.pendingChannelMessagesState.isProcessing=!1,this.processNextPendingChannelMessage()})}}async processChannelMessage(e){await this.realtime.channels.processChannelMessage(e)}async ping(){var e;if("connected"!==this.state.state)throw new Q("Unable to ping service; not connected",4e4,400);let t=null==(e=this.activeProtocol)?void 0:e.getTransport();if(!t)throw this.getStateError();z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.ping()","transport = "+t);let s=Date.now(),r=eC();return eF(new Promise(e=>{let n=i=>{i===r&&(t.off("heartbeat",n),e(Date.now()-s))};t.on("heartbeat",n),t.ping(r)}),this.options.timeouts.realtimeRequestTimeout,"Timeout waiting for heartbeat response")}abort(e){this.activeProtocol.getTransport().fail(e)}getTransportPreference(){var e,t;return this.transportPreference||sD()&&(null==(t=null==(e=H.WebStorage)?void 0:e.get)?void 0:t.call(e,sW))}persistTransportPreference(e){var t,s;this.transportPreference=e.shortName,sD()&&(null==(s=null==(t=H.WebStorage)?void 0:t.set)||s.call(t,sW,e.shortName))}unpersistTransportPreference(){var e,t;this.transportPreference=null,sD()&&(null==(t=null==(e=H.WebStorage)?void 0:e.remove)||t.call(e,sW))}actOnErrorFromAuthorize(e){if(40171===e.code)this.notifyState({state:"failed",error:e});else if(40102===e.code)this.notifyState({state:"failed",error:e});else if(e.statusCode===e8.Forbidden){let t="Client configured authentication provider returned 403; failing the connection";z.logAction(this.logger,z.LOG_ERROR,"ConnectionManager.actOnErrorFromAuthorize()",t),this.notifyState({state:"failed",error:new Q(t,80019,403,e)})}else{let t="Client configured authentication provider request failed";z.logAction(this.logger,z.LOG_MINOR,"ConnectionManager.actOnErrorFromAuthorize",t),this.notifyState({state:this.state.failState,error:new Q(t,80019,401,e)})}}onConnectionDetailsUpdate(e,t){if(!e)return;this.connectionDetails=e,e.maxMessageSize&&(this.options.maxMessageSize=e.maxMessageSize);let s=e.clientId;if(s){let e=this.realtime.auth._uncheckedSetClientId(s);if(e){z.logAction(this.logger,z.LOG_ERROR,"ConnectionManager.onConnectionDetailsUpdate()",e.message),t.fail(e);return}}let r=e.connectionStateTtl;r&&(this.connectionStateTtl=r),this.maxIdleInterval=e.maxIdleInterval,this.emit("connectiondetails",e)}checkWsConnectivity(){let e=this.options.wsConnectivityCheckUrl||ez.wsConnectivityCheckUrl,t=new H.Config.WebSocket(e);return new Promise((e,s)=>{let r=!1;t.onopen=()=>{r||(r=!0,e(),t.close())},t.onclose=t.onerror=()=>{r||(r=!0,s())}})}sessionRecoveryName(){return this.options.recoveryKeyStorageName||"ably-connection-recovery"}getSessionRecoverData(){var e,t;return sG()&&(null==(t=null==(e=H.WebStorage)?void 0:e.getSession)?void 0:t.call(e,this.sessionRecoveryName()))}setSessionRecoverData(e){var t,s;return sG()&&(null==(s=null==(t=H.WebStorage)?void 0:t.setSession)?void 0:s.call(t,this.sessionRecoveryName(),e))}clearSessionRecoverData(){var e,t;return sG()&&(null==(t=null==(e=H.WebStorage)?void 0:e.removeSession)?void 0:t.call(e,this.sessionRecoveryName()))}},sz=class extends tl{constructor(e,t){super(e.logger),this.whenState=e=>tl.prototype.whenState.call(this,e,this.state),this.ably=e,this.connectionManager=new s$(e,t),this.state=this.connectionManager.state.state,this.key=void 0,this.id=void 0,this.errorReason=null,this.connectionManager.on("connectionstate",e=>{let t=this.state=e.current;H.Config.nextTick(()=>{this.emit(t,e)})}),this.connectionManager.on("update",e=>{H.Config.nextTick(()=>{this.emit("update",e)})})}connect(){z.logAction(this.logger,z.LOG_MINOR,"Connection.connect()",""),this.connectionManager.requestState({state:"connecting"})}async ping(){return z.logAction(this.logger,z.LOG_MINOR,"Connection.ping()",""),this.connectionManager.ping()}close(){z.logAction(this.logger,z.LOG_MINOR,"Connection.close()","connectionKey = "+this.key),this.connectionManager.requestState({state:"closing"})}get recoveryKey(){return this.logger.deprecationWarning("The `Connection.recoveryKey` attribute has been replaced by the `Connection.createRecoveryKey()` method. Replace your usage of `recoveryKey` with the return value of `createRecoveryKey()`. `recoveryKey` will be removed in a future version."),this.createRecoveryKey()}createRecoveryKey(){return this.connectionManager.createRecoveryKey()}},sJ=class e extends tT{constructor(t){var s,r,n,i;if(super(ez.objectifyOptions(t,!1,"BaseRealtime",z.defaultLogger)),z.logAction(this.logger,z.LOG_MINOR,"Realtime()",""),"string"==typeof EdgeRuntime)throw new Q('Ably.Realtime instance cannot be used in Vercel Edge runtime. If you are running Vercel Edge functions, please replace your "new Ably.Realtime()" with "new Ably.Rest()" and use Ably Rest API instead of the Realtime API. If you are server-rendering your application in the Vercel Edge runtime, please use the condition "if (typeof EdgeRuntime === \'string\')" to prevent instantiating Ably.Realtime instance during SSR in the Vercel Edge runtime.',4e4,400);this._additionalTransportImplementations=e.transportImplementationsFromPlugins(this.options.plugins),this._RealtimePresence=null!=(r=null==(s=this.options.plugins)?void 0:s.RealtimePresence)?r:null,this._liveObjectsPlugin=null!=(i=null==(n=this.options.plugins)?void 0:n.LiveObjects)?i:null,this.connection=new sz(this,this.options),this._channels=new sK(this),!1!==this.options.autoConnect&&this.connect()}static transportImplementationsFromPlugins(e){let t={};return(null==e?void 0:e.WebSocketTransport)&&(t[l.WebSocket]=e.WebSocketTransport),(null==e?void 0:e.XHRPolling)&&(t[l.XhrPolling]=e.XHRPolling),t}get channels(){return this._channels}get clientId(){return this.auth.clientId}connect(){z.logAction(this.logger,z.LOG_MINOR,"Realtime.connect()",""),this.connection.connect()}close(){z.logAction(this.logger,z.LOG_MINOR,"Realtime.close()",""),this.connection.close()}};sJ.EventEmitter=tl;var sK=class extends tl{constructor(e){super(e.logger),this.realtime=e,this.all=Object.create(null),e.connection.connectionManager.on("transport.active",()=>{this.onTransportActive()})}channelSerials(){let e={};for(let t of ef(this.all,!0)){let s=this.all[t];s.properties.channelSerial&&(e[t]=s.properties.channelSerial)}return e}recoverChannels(e){for(let t of ef(e,!0))this.get(t).properties.channelSerial=e[t]}async processChannelMessage(e){let t=e.channel;if(void 0===t){z.logAction(this.logger,z.LOG_ERROR,"Channels.processChannelMessage()","received event unspecified channel, action = "+e.action);return}let s=this.all[t];if(!s){z.logAction(this.logger,z.LOG_ERROR,"Channels.processChannelMessage()","received event for non-existent channel: "+t);return}await s.processMessage(e)}onTransportActive(){for(let e in this.all){let t=this.all[e];"attaching"===t.state||"detaching"===t.state?t.checkPendingState():"suspended"===t.state?t._attach(!1,null):"attached"===t.state&&t.requestState("attaching")}}propogateConnectionInterruption(e,t){let s=["attaching","attached","detaching","suspended"],r={closing:"detached",closed:"detached",failed:"failed",suspended:"suspended"}[e];for(let e in this.all){let n=this.all[e];s.includes(n.state)&&n.notifyState(r,t)}}get(e,t){e=String(e);let s=this.all[e];if(s){if(t){if(s._shouldReattachToSetOptions(t,s.channelOptions))throw new Q("Channels.get() cannot be used to set channel options that would cause the channel to reattach. Please, use RealtimeChannel.setOptions() instead.",4e4,400);s.setOptions(t)}}else s=this.all[e]=new sC(this.realtime,e,t);return s}getDerived(e,t,s){if(t.filter){let s=eD(t.filter),r=eq(e);e=`[filter=${s}${r.qualifierParam}]${r.channelName}`}return this.get(e,s)}release(e){e=String(e);let t=this.all[e];if(!t)return;let s=t.getReleaseErr();if(s)throw s;delete this.all[e]}},sQ=sJ;function sX(e,t){if(e.isSynthesized()||t.isSynthesized())return e.timestamp>=t.timestamp;let s=e.parseId(),r=t.parseId();return s.msgSerial===r.msgSerial?s.index>r.index:s.msgSerial>r.msgSerial}var sY=class extends tl{constructor(e,t,s=sX){super(e.logger),this.presence=e,this.map=Object.create(null),this.syncInProgress=!1,this.residualMembers=null,this.memberKey=t,this.newerThan=s}get(e){return this.map[e]}getClient(e){let t=this.map,s=[];for(let r in t){let n=t[r];n.clientId==e&&"absent"!=n.action&&s.push(n)}return s}list(e){let t=this.map,s=e&&e.clientId,r=e&&e.connectionId,n=[];for(let e in t){let i=t[e];"absent"!==i.action&&(!s||s==i.clientId)&&(r&&r!=i.connectionId||n.push(i))}return n}put(e){("enter"===e.action||"update"===e.action)&&((e=tz.fromValues(e)).action="present");let t=this.map,s=this.memberKey(e);this.residualMembers&&delete this.residualMembers[s];let r=t[s];return(!r||!!this.newerThan(e,r))&&(t[s]=e,!0)}values(){let e=this.map,t=[];for(let s in e){let r=e[s];"absent"!=r.action&&t.push(r)}return t}remove(e){let t=this.map,s=this.memberKey(e),r=t[s];return(!r||!!this.newerThan(e,r))&&(this.syncInProgress?((e=tz.fromValues(e)).action="absent",t[s]=e):delete t[s],!!r)}startSync(){let e=this.map,t=this.syncInProgress;z.logAction(this.logger,z.LOG_MINOR,"PresenceMap.startSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+t),this.syncInProgress||(this.residualMembers=Z(e),this.setInProgress(!0))}endSync(){let e=this.map,t=this.syncInProgress;if(z.logAction(this.logger,z.LOG_MINOR,"PresenceMap.endSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+t),t){for(let t in e)"absent"===e[t].action&&delete e[t];for(let t in this.presence._synthesizeLeaves(ep(this.residualMembers)),this.residualMembers)delete e[t];this.residualMembers=null,this.setInProgress(!1)}this.emit("sync")}async waitSync(){let e=this.syncInProgress;z.logAction(this.logger,z.LOG_MINOR,"PresenceMap.waitSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+e),e&&await this.once("sync")}clear(){this.map={},this.setInProgress(!1),this.residualMembers=null}setInProgress(e){z.logAction(this.logger,z.LOG_MICRO,"PresenceMap.setInProgress()","inProgress = "+e),this.syncInProgress=e,this.presence.syncComplete=!e}};function sZ(e){let t=e.channel.client,s=t.auth.clientId;return(!s||"*"===s)&&"connected"===t.connection.state}var s0=class extends tl{constructor(e){super(e.logger),this.channel=e,this.syncComplete=!1,this.members=new sY(this,e=>e.clientId+":"+e.connectionId),this._myMembers=new sY(this,e=>e.clientId),this.subscriptions=new tl(this.logger),this.pendingPresence=[]}async enter(e){if(sZ(this))throw new Q("clientId must be specified to enter a presence channel",40012,400);return this._enterOrUpdateClient(void 0,void 0,e,"enter")}async update(e){if(sZ(this))throw new Q("clientId must be specified to update presence data",40012,400);return this._enterOrUpdateClient(void 0,void 0,e,"update")}async enterClient(e,t){return this._enterOrUpdateClient(void 0,e,t,"enter")}async updateClient(e,t){return this._enterOrUpdateClient(void 0,e,t,"update")}async _enterOrUpdateClient(e,t,s,r){let n=this.channel;if(!n.connectionManager.activeState())throw n.connectionManager.getError();z.logAction(this.logger,z.LOG_MICRO,"RealtimePresence."+r+"Client()","channel = "+n.name+", id = "+e+", client = "+(t||"(implicit) "+this.channel.client.auth.clientId));let i=tz.fromData(s);i.action=r,e&&(i.id=e),t&&(i.clientId=t);let o=await i.encode(n.channelOptions);switch(n.state){case"attached":return n.sendPresence([o]);case"initialized":case"detached":n.attach();case"attaching":return new Promise((e,t)=>{this.pendingPresence.push({presence:o,callback:s=>s?t(s):e()})});default:{let e=new X("Unable to "+r+" presence channel while in "+n.state+" state",90001);throw e.code=90001,e}}}async leave(e){if(sZ(this))throw new Q("clientId must have been specified to enter or leave a presence channel",40012,400);return this.leaveClient(void 0,e)}async leaveClient(e,t){let s=this.channel;if(!s.connectionManager.activeState())throw s.connectionManager.getError();z.logAction(this.logger,z.LOG_MICRO,"RealtimePresence.leaveClient()","leaving; channel = "+this.channel.name+", client = "+e);let r=tz.fromData(t);r.action="leave",e&&(r.clientId=e);let n=await r.encode(s.channelOptions);switch(s.state){case"attached":return s.sendPresence([n]);case"attaching":return new Promise((e,t)=>{this.pendingPresence.push({presence:n,callback:s=>s?t(s):e()})});case"initialized":case"failed":throw new X("Unable to leave presence channel (incompatible state)",90001);default:throw s.invalidStateError()}}async get(e){let t=!e||!("waitForSync"in e)||e.waitForSync;function s(t){return e?t.list(e):t.values()}if("suspended"===this.channel.state){if(t)throw Q.fromValues({statusCode:400,code:91005,message:"Presence state is out of sync due to channel being in the SUSPENDED state"});return s(this.members)}await this.channel.ensureAttached();let r=this.members;return t&&await r.waitSync(),s(this.members)}async history(e){z.logAction(this.logger,z.LOG_MICRO,"RealtimePresence.history()","channel = "+this.name);let t=this.channel.client.rest.presenceMixin;if(e&&e.untilAttach){if("attached"===this.channel.state)delete e.untilAttach,e.from_serial=this.channel.properties.attachSerial;else throw new Q("option untilAttach requires the channel to be attached, was: "+this.channel.state,4e4,400)}return t.history(this,e)}setPresence(e,t,s){let r,n;z.logAction(this.logger,z.LOG_MICRO,"RealtimePresence.setPresence()","received presence for "+e.length+" participants; syncChannelSerial = "+s);let i=this.members,o=this._myMembers,a=[],l=this.channel.connectionManager.connectionId;for(let c of(t&&(this.members.startSync(),s&&(n=s.match(/^[\w-]+:(.*)$/))&&(r=n[1])),e))switch(c.action){case"leave":i.remove(c)&&a.push(c),c.connectionId!==l||c.isSynthesized()||o.remove(c);break;case"enter":case"present":case"update":i.put(c)&&a.push(c),c.connectionId===l&&o.put(c)}t&&!r&&(i.endSync(),this.channel.syncChannelSerial=null);for(let e=0;e<a.length;e++){let t=a[e];this.subscriptions.emit(t.action,t)}}onAttached(e){z.logAction(this.logger,z.LOG_MINOR,"RealtimePresence.onAttached()","channel = "+this.channel.name+", hasPresence = "+e),e?this.members.startSync():(this._synthesizeLeaves(this.members.values()),this.members.clear()),this._ensureMyMembersPresent();let t=this.pendingPresence,s=t.length;if(s){this.pendingPresence=[];let e=[],r=e6.create(this.logger);z.logAction(this.logger,z.LOG_MICRO,"RealtimePresence.onAttached","sending "+s+" queued presence messages");for(let n=0;n<s;n++){let s=t[n];e.push(s.presence),r.push(s.callback)}this.channel.sendPresence(e).then(()=>r()).catch(e=>r(e))}}actOnChannelState(e,t,s){switch(e){case"attached":this.onAttached(t);break;case"detached":case"failed":this._clearMyMembers(),this.members.clear();case"suspended":this.failPendingPresence(s)}}failPendingPresence(e){if(this.pendingPresence.length){z.logAction(this.logger,z.LOG_MINOR,"RealtimeChannel.failPendingPresence","channel; name = "+this.channel.name+", err = "+eO(e));for(let t=0;t<this.pendingPresence.length;t++)try{this.pendingPresence[t].callback(e)}catch(e){}this.pendingPresence=[]}}_clearMyMembers(){this._myMembers.clear()}_ensureMyMembersPresent(){let e=this._myMembers,t=this.channel.connectionManager.connectionId;for(let s in e.map){let r=e.map[s];z.logAction(this.logger,z.LOG_MICRO,"RealtimePresence._ensureMyMembersPresent()",'Auto-reentering clientId "'+r.clientId+'" into the presence set');let n=r.connectionId===t?r.id:void 0;this._enterOrUpdateClient(n,r.clientId,r.data,"enter").catch(e=>{let t=new Q("Presence auto re-enter failed",91004,400,e);z.logAction(this.logger,z.LOG_ERROR,"RealtimePresence._ensureMyMembersPresent()","Presence auto re-enter failed; reason = "+eO(e));let s=new sE(this.channel.state,this.channel.state,!0,!1,t);this.channel.emit("update",s)})}}_synthesizeLeaves(e){let t=this.subscriptions;e.forEach(function(e){let s=tz.fromValues({action:"leave",connectionId:e.connectionId,clientId:e.clientId,data:e.data,encoding:e.encoding,timestamp:Date.now()});t.emit("leave",s)})}async subscribe(...e){let t=sC.processListenerArgs(e),s=t[0],r=t[1],n=this.channel;if("failed"===n.state)throw Q.fromValues(n.invalidStateError());this.subscriptions.on(s,r),!1!==n.channelOptions.attachOnSubscribe&&await n.attach()}unsubscribe(...e){let t=sC.processListenerArgs(e),s=t[0],r=t[1];this.subscriptions.off(s,r)}},s1=l.WebSocket,s4=class extends sB{constructor(e,t,s){super(e,t,s),this.shortName=s1,s.heartbeats=H.Config.useProtocolHeartbeats,this.wsHost=s.host}static isAvailable(){return!!H.Config.WebSocket}createWebSocket(e,t){return this.uri=e+e_(t),new H.Config.WebSocket(this.uri)}toString(){return"WebSocketTransport; uri="+this.uri}connect(){z.logAction(this.logger,z.LOG_MINOR,"WebSocketTransport.connect()","starting"),sB.prototype.connect.call(this);let e=this,t=this.params,s=t.options,r=(s.tls?"wss://":"ws://")+this.wsHost+":"+ez.getPort(s)+"/";z.logAction(this.logger,z.LOG_MINOR,"WebSocketTransport.connect()","uri: "+r),eA(this.auth.getAuthParams(),function(s,n){if(e.isDisposed)return;let i="";for(let e in n)i+=" "+e+": "+n[e]+";";if(z.logAction(e.logger,z.LOG_MINOR,"WebSocketTransport.connect()","authParams:"+i+" err: "+s),s){e.disconnect(s);return}let o=t.getConnectParams(n);try{let t=e.wsConnection=e.createWebSocket(r,o);t.binaryType=H.Config.binaryType,t.onopen=function(){e.onWsOpen()},t.onclose=function(t){e.onWsClose(t)},t.onmessage=function(t){e.onWsData(t.data)},t.onerror=function(t){e.onWsError(t)},t.on&&t.on("ping",function(){e.onActivity()})}catch(t){z.logAction(e.logger,z.LOG_ERROR,"WebSocketTransport.connect()","Unexpected exception creating websocket: err = "+(t.stack||t.message)),e.disconnect(t)}})}send(e){let t=this.wsConnection;if(!t){z.logAction(this.logger,z.LOG_ERROR,"WebSocketTransport.send()","No socket connection");return}try{t.send(eM(e,this.connectionManager.realtime._MsgPack,this.params.format))}catch(t){let e="Exception from ws connection when trying to send: "+eO(t);z.logAction(this.logger,z.LOG_ERROR,"WebSocketTransport.send()",e),this.finish("disconnected",new Q(e,5e4,500))}}onWsData(e){z.logAction(this.logger,z.LOG_MICRO,"WebSocketTransport.onWsData()","data received; length = "+e.length+"; type = "+typeof e);try{var t,s,r,n,i;this.onProtocolMessage((t=this.connectionManager.realtime._MsgPack,s=this.connectionManager.realtime._RealtimePresence,r=this.connectionManager.realtime._Annotations,n=this.connectionManager.realtime._liveObjectsPlugin,i=this.format,sv(eP(e,t,i),s,r,n)))}catch(e){z.logAction(this.logger,z.LOG_ERROR,"WebSocketTransport.onWsData()","Unexpected exception handing channel message: "+e.stack)}}onWsOpen(){z.logAction(this.logger,z.LOG_MINOR,"WebSocketTransport.onWsOpen()","opened WebSocket"),this.emit("preconnect")}onWsClose(e){let t,s;if("object"==typeof e?(s=e.code,t=e.wasClean||1e3===s):t=1e3==(s=e),delete this.wsConnection,t){z.logAction(this.logger,z.LOG_MINOR,"WebSocketTransport.onWsClose()","Cleanly closed WebSocket");let e=new Q("Websocket closed",80003,400);this.finish("disconnected",e)}else{let e="Unclean disconnection of WebSocket ; code = "+s,t=new Q(e,80003,400);z.logAction(this.logger,z.LOG_MINOR,"WebSocketTransport.onWsClose()",e),this.finish("disconnected",t)}this.emit("disposed")}onWsError(e){z.logAction(this.logger,z.LOG_MINOR,"WebSocketTransport.onError()","Error from WebSocket: "+e.message),H.Config.nextTick(()=>{this.disconnect(Error(e.message))})}dispose(){z.logAction(this.logger,z.LOG_MINOR,"WebSocketTransport.dispose()",""),this.isDisposed=!0;let e=this.wsConnection;e&&(e.onmessage=function(){},delete this.wsConnection,H.Config.nextTick(()=>{if(z.logAction(this.logger,z.LOG_MICRO,"WebSocketTransport.dispose()","closing websocket"),!e)throw Error("WebSocketTransport.dispose(): wsConnection is not defined");e.close()}))}},s2=class{static subscribeFilter(e,t,s){let r=e=>{var r,n,i,o,a,l;let c={name:e.name,refTimeserial:null==(n=null==(r=e.extras)?void 0:r.ref)?void 0:n.timeserial,refType:null==(o=null==(i=e.extras)?void 0:i.ref)?void 0:o.type,isRef:!!(null==(l=null==(a=e.extras)?void 0:a.ref)?void 0:l.timeserial),clientId:e.clientId};Object.entries(t).find(([e,t])=>void 0!==t&&c[e]!==t)||s(e)};this.addFilteredSubscription(e,t,s,r),e.subscriptions.on(r)}static addFilteredSubscription(e,t,s,r){var n;if(e.filteredSubscriptions||(e.filteredSubscriptions=new Map),e.filteredSubscriptions.has(s)){let i=e.filteredSubscriptions.get(s);i.set(t,(null==(n=null==i?void 0:i.get(t))?void 0:n.concat(r))||[r])}else e.filteredSubscriptions.set(s,new Map([[t,[r]]]))}static getAndDeleteFilteredSubscriptions(e,t,s){if(!e.filteredSubscriptions)return[];if(!s&&t)return Array.from(e.filteredSubscriptions.entries()).map(([s,r])=>{var n;let i=r.get(t);return r.delete(t),0===r.size&&(null==(n=e.filteredSubscriptions)||n.delete(s)),i}).reduce((e,t)=>t?e.concat(...t):e,[]);if(!s||!e.filteredSubscriptions.has(s))return[];let r=e.filteredSubscriptions.get(s);if(!t){let t=Array.from(r.values()).reduce((e,t)=>e.concat(...t),[]);return e.filteredSubscriptions.delete(s),t}let n=r.get(t);return r.delete(t),n||[]}},s6=class e extends sQ{constructor(t){var s;let r=e._MsgPack;if(!r)throw Error("Expected DefaultRealtime._MsgPack to have been set");super(ez.objectifyOptions(t,!0,"Realtime",z.defaultLogger,E(O({},sr),{Crypto:null!=(s=e.Crypto)?s:void 0,MsgPack:r,RealtimePresence:{RealtimePresence:s0,PresenceMessage:tz,WirePresenceMessage:t$},Annotations:{Annotation:sf,WireAnnotation:sd,RealtimeAnnotations:sT,RestAnnotations:sb},WebSocketTransport:s4,MessageInteractions:s2})))}static get Crypto(){if(null===this._Crypto)throw Error("Encryption not enabled; use ably.encryption.js instead");return this._Crypto}static set Crypto(e){this._Crypto=e}};s6.Utils=J,s6.ConnectionManager=s$,s6.ProtocolMessage=sO,s6._Crypto=null,s6.Message=sn,s6.PresenceMessage=si,s6.Annotation=sp,s6._MsgPack=null,s6._Http=to,s6._PresenceMap=sY,s6._MessageEncoding=tO;var s3=T(s(84770)),s8=new class{constructor(){this.base64CharSet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",this.hexCharSet="0123456789abcdef"}base64Decode(e){return Buffer.from(e,"base64")}base64Encode(e){return this.toBuffer(e).toString("base64")}base64UrlEncode(e){return this.toBuffer(e).toString("base64url")}areBuffersEqual(e,t){return!!e&&!!t&&0==this.toBuffer(e).compare(this.toBuffer(t))}byteLength(e){return e.byteLength}hexDecode(e){return Buffer.from(e,"hex")}hexEncode(e){return this.toBuffer(e).toString("hex")}isBuffer(e){return Buffer.isBuffer(e)||e instanceof ArrayBuffer||ArrayBuffer.isView(e)}toArrayBuffer(e){let t=this.toBuffer(e);return t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}toBuffer(e){return Buffer.isBuffer(e)?e:e instanceof ArrayBuffer?Buffer.from(e):Buffer.from(e.buffer,e.byteOffset,e.byteLength)}arrayBufferViewToBuffer(e){return this.toBuffer(e)}utf8Decode(e){if(!this.isBuffer(e))throw Error("Expected input of utf8Decode to be a buffer, arraybuffer, or view");return this.toBuffer(e).toString("utf8")}utf8Encode(e){return Buffer.from(e,"utf8")}concat(e){return Buffer.concat(e.map(e=>this.toBuffer(e)))}sha256(e){let t=this.toBuffer(e);return s3.default.createHash("SHA256").update(t).digest()}hmacSha256(e,t){let s=this.toBuffer(e),r=this.toBuffer(t);return s3.default.createHmac("SHA256",r).update(s).digest()}},s5=T(s(84770)),s9=T(s(21764)),s7=T(s(15447)),re=T(s(32615)),rt=T(s(35240)),rs=[],rr=((c=class{constructor(e){this.agent=null,this.supportsAuthHeaders=!0,this.supportsLinkHeaders=!0,this.checkConnectivity=async()=>{var e,t,s,r,n;if(null==(e=this.client)?void 0:e.options.disableConnectivityCheck)return!0;let i=(null==(t=this.client)?void 0:t.options.connectivityCheckUrl)||ez.connectivityCheckUrl,o=null!=(r=null==(s=this.client)?void 0:s.options.connectivityCheckParams)?r:null,a=!(null==(n=this.client)?void 0:n.options.connectivityCheckUrl),{error:l,statusCode:c,body:h}=await this.doUri(e3.Get,i,null,null,o);return l||a?!l&&(null==h?void 0:h.toString().trim())==="yes":c>=200&&c<400},this.client=null!=e?e:null}async doUri(e,t,s,r,n){var i;let o=this.client&&this.client.options.restAgentOptions||ez.restAgentOptions,a={headers:s||void 0,responseType:"buffer"};if(!this.agent){let e=null==(i=rs.find(e=>eB(o,e.options)))?void 0:i.agents;e?this.agent=e:(this.agent={http:new re.default.Agent(o),https:new rt.default.Agent(o)},rs.push({options:o,agents:this.agent}))}r&&(a.body=r),n&&(a.searchParams=n),a.agent=this.agent,a.url=t,a.timeout={request:(this.client&&this.client.options.timeouts||ez.TIMEOUTS).httpRequestTimeout},a.retry={limit:0};try{let t=await s7.default[e](a);return this._handler(null,t,t.body)}catch(e){if(e instanceof s7.default.HTTPError)return this._handler(null,e.response,e.response.body);return this._handler(e)}}shouldFallback(e){let{code:t,statusCode:s}=e;return"ENETUNREACH"===t||"EHOSTUNREACH"===t||"EHOSTDOWN"===t||"ETIMEDOUT"===t||"ESOCKETTIMEDOUT"===t||"ENOTFOUND"===t||"ECONNRESET"===t||"ECONNREFUSED"===t||s>=500&&s<=504}_handler(e,t,s){var r;if(e)return{error:e};let n=t.statusCode,i=t.headers;if(n>=300){switch(i["content-type"]){case"application/json":s=JSON.parse(s);break;case"application/x-msgpack":if(!(null==(r=this.client)?void 0:r._MsgPack))return{error:eH("MsgPack")};s=this.client._MsgPack.decode(s)}return{error:s.error?Q.fromValues(s.error):new Q(i["x-ably-errormessage"]||"Error response received from server: "+n+" body was: "+H.Config.inspect(s),Number(i["x-ably-errorcode"]),n),body:s,headers:i,unpacked:!0,statusCode:n}}return{error:null,body:s,headers:i,unpacked:!1,statusCode:n}}}).methods=[e3.Get,e3.Delete,e3.Post,e3.Put,e3.Patch],c.methodsWithoutBody=[e3.Get,e3.Delete],c.methodsWithBody=[e3.Post,e3.Put,e3.Patch],c),rn=T(s(84770)),ri=T(s(82158)),ro=T(s(21764)),ra={agent:"nodejs/"+process.versions.node,logTimestamps:!0,userAgent:null,binaryType:"nodebuffer",WebSocket:ri.default,useProtocolHeartbeats:!1,supportsBinary:!0,preferBinary:!0,nextTick:process.nextTick,inspect:ro.default.inspect,stringByteSize:Buffer.byteLength,inherits:ro.default.inherits,addEventListener:null,getRandomArrayBuffer:async function(e){return ro.default.promisify(rn.default.randomBytes)(e)}},rl=((a=rl||{})[a.REQ_SEND=0]="REQ_SEND",a[a.REQ_RECV=1]="REQ_RECV",a[a.REQ_RECV_POLL=2]="REQ_RECV_POLL",a[a.REQ_RECV_STREAM=3]="REQ_RECV_STREAM",a);function rc(e){return e.code&&!tr.isTokenErr(e)&&([80015,80017,80030].includes(e.code)||e.code>=4e4&&e.code<5e4)?[sw({action:tc.ERROR,error:e})]:[sw({action:tc.DISCONNECTED,error:e})]}var rh=class extends sB{constructor(e,t,s){super(e,t,s,!0),this.onAuthUpdated=e=>{this.authParams={access_token:e.token}},this.stream=!("stream"in s)||s.stream,this.sendRequest=null,this.recvRequest=null,this.pendingCallback=null,this.pendingItems=null}connect(){z.logAction(this.logger,z.LOG_MINOR,"CometTransport.connect()","starting"),sB.prototype.connect.call(this);let e=this.params,t=e.options,s=e.host||t.primaryDomain,r=ez.getPort(t),n=t.tls?"https://":"http://";this.baseUri=n+s+":"+r+"/comet/";let i=this.baseUri+"connect";z.logAction(this.logger,z.LOG_MINOR,"CometTransport.connect()","uri: "+i),eA(this.auth.getAuthParams(),(e,t)=>{if(e){this.disconnect(e);return}if(this.isDisposed)return;this.authParams=t;let s=this.params.getConnectParams(t);"stream"in s&&(this.stream=s.stream),z.logAction(this.logger,z.LOG_MINOR,"CometTransport.connect()","connectParams:"+e_(s));let r=!1,n=this.recvRequest=this.createRequest(i,null,s,null,this.stream?rl.REQ_RECV_STREAM:rl.REQ_RECV);n.on("data",e=>{this.recvRequest&&(r||(r=!0,this.emit("preconnect")),this.onData(e))}),n.on("complete",e=>{if(this.recvRequest||(e=e||new Q("Request cancelled",80003,400)),this.recvRequest=null,r||e||(r=!0,this.emit("preconnect")),this.onActivity(),e){e.code?this.onData(rc(e)):this.disconnect(e);return}H.Config.nextTick(()=>{this.recv()})}),n.exec()})}requestClose(){z.logAction(this.logger,z.LOG_MINOR,"CometTransport.requestClose()"),this._requestCloseOrDisconnect(!0)}requestDisconnect(){z.logAction(this.logger,z.LOG_MINOR,"CometTransport.requestDisconnect()"),this._requestCloseOrDisconnect(!1)}_requestCloseOrDisconnect(e){let t=e?this.closeUri:this.disconnectUri;if(t){let s=this.createRequest(t,null,this.authParams,null,rl.REQ_SEND);s.on("complete",t=>{t&&(z.logAction(this.logger,z.LOG_ERROR,"CometTransport.request"+(e?"Close()":"Disconnect()"),"request returned err = "+eO(t)),this.finish("disconnected",t))}),s.exec()}}dispose(){z.logAction(this.logger,z.LOG_MINOR,"CometTransport.dispose()",""),this.isDisposed||(this.isDisposed=!0,this.recvRequest&&(z.logAction(this.logger,z.LOG_MINOR,"CometTransport.dispose()","aborting recv request"),this.recvRequest.abort(),this.recvRequest=null),this.finish("disconnected",sN.disconnected()),H.Config.nextTick(()=>{this.emit("disposed")}))}onConnect(e){var t;if(this.isDisposed)return;let s=null==(t=e.connectionDetails)?void 0:t.connectionKey;sB.prototype.onConnect.call(this,e);let r=this.baseUri+s;z.logAction(this.logger,z.LOG_MICRO,"CometTransport.onConnect()","baseUri = "+r),this.sendUri=r+"/send",this.recvUri=r+"/recv",this.closeUri=r+"/close",this.disconnectUri=r+"/disconnect"}send(e){if(this.sendRequest){this.pendingItems=this.pendingItems||[],this.pendingItems.push(e);return}let t=this.pendingItems||[];t.push(e),this.pendingItems=null,this.sendItems(t)}sendAnyPending(){let e=this.pendingItems;e&&(this.pendingItems=null,this.sendItems(e))}sendItems(e){let t=this.sendRequest=this.createRequest(this.sendUri,null,this.authParams,this.encodeRequest(e),rl.REQ_SEND);t.on("complete",(e,t)=>{if(e&&z.logAction(this.logger,z.LOG_ERROR,"CometTransport.sendItems()","on complete: err = "+eO(e)),this.sendRequest=null,e){e.code?this.onData(rc(e)):this.disconnect(e);return}t&&this.onData(t),this.pendingItems&&H.Config.nextTick(()=>{this.sendRequest||this.sendAnyPending()})}),t.exec()}recv(){if(this.recvRequest||!this.isConnected)return;let e=this.recvRequest=this.createRequest(this.recvUri,null,this.authParams,null,this.stream?rl.REQ_RECV_STREAM:rl.REQ_RECV_POLL);e.on("data",e=>{this.onData(e)}),e.on("complete",e=>{if(this.recvRequest=null,this.onActivity(),e){e.code?this.onData(rc(e)):this.disconnect(e);return}H.Config.nextTick(()=>{this.recv()})}),e.exec()}onData(e){try{let t=this.decodeResponse(e);if(t&&t.length)for(let e=0;e<t.length;e++)this.onProtocolMessage(sv(t[e],this.connectionManager.realtime._RealtimePresence,this.connectionManager.realtime._Annotations,this.connectionManager.realtime._liveObjectsPlugin))}catch(e){z.logAction(this.logger,z.LOG_ERROR,"CometTransport.onData()","Unexpected exception handing channel event: "+e.stack)}}encodeRequest(e){return JSON.stringify(e)}decodeResponse(e){return"string"==typeof e?JSON.parse(e):e}},ru=T(s(32615)),rd=T(s(35240)),rf=T(s(17360)),rp=T(s(21764)),rg=function(){},rm=l.Comet,ry=class extends rh{constructor(e,t,s){super(e,t,s),this.httpAgent=null,this.httpsAgent=null,this.pendingRequests=0,this.shortName=rm}static isAvailable(){return!0}toString(){return"NodeCometTransport; uri="+this.baseUri+"; isConnected="+this.isConnected+"; format="+this.format+"; stream="+this.stream}getAgent(e){var t=e?"httpsAgent":"httpAgent",s=this[t];return s||(s=this[t]=new(e?rd.default:ru.default).Agent({keepAlive:!0})),s}dispose(){var e=this;this.onceNoPending(function(){e.httpAgent&&e.httpAgent.destroy(),e.httpsAgent&&e.httpsAgent.destroy()}),rh.prototype.dispose.call(this)}request(e,t,s,r,n){var i=this.createRequest(e,t,s,r);return i.once("complete",n),i.exec(),i}createRequest(e,t,s,r,n){return new rb(e,t,s,r,n,this.format,this.timeouts,this)}addPending(){++this.pendingRequests}removePending(){--this.pendingRequests<=0&&this.emit("nopending")}onceNoPending(e){if(0==this.pendingRequests){e();return}this.once("nopending",e)}},rb=class extends tl{constructor(e,t,s,r,n,i,o,a){super(a.logger),"string"==typeof e&&(e=rf.default.parse(e));var l="https:"==e.protocol;this.client=l?rd.default:ru.default,this.requestMode=n,this.timeouts=o,this.transport=a,this.requestComplete=!1,this.req=this.res=null;var c="GET",h="msgpack"==i?"application/x-msgpack":"application/json";(t=t?Y({},t):{}).accept=h,r&&(c="POST",Buffer.isBuffer(r)||("object"==typeof r&&(r=JSON.stringify(r)),r=Buffer.from(r)),this.body=r,t["Content-Length"]=r.length,t["Content-Type"]=h);var u=this.requestOptions={hostname:e.hostname,port:e.port,path:e.path+e_(s),method:c,headers:t};a&&(u.agent=a.getAgent(l))}exec(){var e=this.requestMode==rl.REQ_SEND?this.timeouts.httpRequestTimeout:this.timeouts.recvTimeout,t=this,s=this.timer=setTimeout(function(){t.abort()},e),r=this.req=this.client.request(this.requestOptions);r.on("error",this.onReqError=function(e){e=new X("Request error: "+e.message,null,400),clearTimeout(s),t.timer=null,t.complete(e)}),r.on("response",function(e){clearTimeout(s),t.timer=null;var r=e.statusCode;if(r==e8.NoContent){e.resume(),t.complete();return}e.on("error",t.onResError=function(e){e=new X("Response error: "+e.message,null,400),t.complete(e)}),t.res=e,t.requestMode==rl.REQ_RECV_STREAM&&r<400?t.readStream():t.readFully()}),this.transport&&this.transport.addPending(),r.end(this.body)}readStream(){var e=this.res,t=this;function s(e){try{e=JSON.parse(e)}catch(e){var s="Malformed response body from server: "+e.message;z.logAction(t.logger,z.LOG_ERROR,"NodeCometTransport.Request.readStream()",s),t.complete(new X(s,null,400));return}t.emit("data",e)}this.chunks=[],this.streamComplete=!1,e.on("data",this.ondata=function(e){var r=String(e).split("\n"),n=t.chunks;r.length>1&&n.length>0&&(n.push(r.shift()),t.chunks=[],s(n.join("")));var i=r.pop();i.length&&t.chunks.push(i),r.map(s)}),e.on("end",function(){t.streamComplete=!0,process.nextTick(function(){t.complete()})})}readFully(){var e=this.res,t=[],s=this;e.on("data",function(e){t.push(e)}),e.on("end",function(){process.nextTick(function(){var r=Buffer.concat(t),n=e.statusCode;try{r=JSON.parse(String(r))}catch(e){var i="Malformed response body from server: "+e.message;z.logAction(s.logger,z.LOG_ERROR,"NodeCometTransport.Request.readFully()",i),s.complete(new X(i,null,400));return}if(n<400||Array.isArray(r)){s.complete(null,r);return}var o=r.error&&Q.fromValues(r.error);o||(o=new X("Error response received from server: "+n+", body was: "+rp.default.inspect(r),null,n)),s.complete(o)})})}complete(e,t){!this.requestComplete&&(this.requestComplete=!0,t&&this.emit("data",t),this.emit("complete",e,t),e&&this.ondata&&!this.streamComplete&&this.ondata&&this.res&&this.res.removeListener("data",this.ondata),this.transport&&this.transport.removePending())}abort(){z.logAction(this.logger,z.LOG_MINOR,"NodeCometTransport.Request.abort()","");var e=this.timer;e&&(clearTimeout(e),this.timer=null);var t=this.req;t&&(z.logAction(this.logger,z.LOG_MINOR,"NodeCometTransport.Request.abort()","aborting request"),t.removeListener("error",this.onReqError),t.on("error",rg),t.abort(),this.req=null),this.complete({statusCode:400,code:80003,message:"Cancelled"})}},r_={order:[l.Comet],bundledImplementations:{[l.WebSocket]:s4,[l.Comet]:ry}},rv={connectivityCheckUrl:"https://internet-up.ably-realtime.com/is-the-internet-up.txt",wsConnectivityCheckUrl:"wss://ws-up.ably-realtime.com",defaultTransports:[l.WebSocket],restAgentOptions:{maxSockets:40,keepAlive:!0}},rw=G(),rS=function(e){async function t(e){return s9.default.promisify(s5.default.randomBytes)(e)}function s(e,t){var s=Buffer.alloc(e);return s.fill(t),s}for(var r=[s(16,16)],n=1;n<=16;n++)r.push(s(n,n));class i{constructor(e,t,s,r){this.algorithm=e,this.keyLength=t,this.mode=s,this.key=r,this.iv=null}}class o{static getDefaultParams(t){if(!t.key)throw Error("Crypto.getDefaultParams: a key is required");s="string"==typeof t.key?e.base64Decode(t.key.replace("_","/").replace("-","+")):t.key instanceof ArrayBuffer?Buffer.from(t.key):t.key;var s,r=new i(t.algorithm||"aes",8*s.length,t.mode||"cbc",s);if(t.keyLength&&t.keyLength!==r.keyLength)throw Error("Crypto.getDefaultParams: a keyLength of "+t.keyLength+" was specified, but the key actually has length "+r.keyLength);return function(e){if("aes"===e.algorithm&&"cbc"===e.mode&&128!==e.keyLength&&256!==e.keyLength)throw Error("Unsupported key length "+e.keyLength+" for aes-cbc encryption. Encryption key must be 128 or 256 bits (16 or 32 ASCII characters)")}(r),r}static async generateRandomKey(e){try{return t((e||256)/8)}catch(e){throw new Q("Failed to generate random key: "+e.message,500,5e4,e)}}static getCipher(e,t){var s,r=e.algorithm&&e.key&&e.keyLength&&e.mode?e:this.getDefaultParams(e);return{cipherParams:r,cipher:new a(r,null!=(s=e.iv)?s:null,t)}}}o.CipherParams=i;class a{constructor(e,t,s){this.logger=s,this.encryptCipher=null,this.algorithm=e.algorithm+"-"+String(e.keyLength)+"-"+e.mode,this.key=e.key,this.iv=t}async encrypt(t){z.logAction(this.logger,z.LOG_MICRO,"CBCCipher.encrypt()","");let s=await this.getIv();this.encryptCipher||(this.encryptCipher=s5.default.createCipheriv(this.algorithm,this.key,s));var n=e.toBuffer(t),i=n.length,o=this.encryptCipher.update(Buffer.concat([n,r[(i+16&-16)-i]]));return Buffer.concat([s,o])}async decrypt(e){var t=s5.default.createDecipheriv(this.algorithm,this.key,e.slice(0,16)),s=t.update(e.slice(16)),r=t.final();return r&&r.length&&(s=Buffer.concat([s,r])),s}async getIv(){if(this.iv){var e=this.iv;return this.iv=null,e}var s=await t(16);return this.encryptCipher?this.encryptCipher.update(s):s}}return o}(s8);for(let e of(H.Crypto=rS,H.BufferUtils=s8,H.Http=rr,H.Config=ra,H.Transports=r_,H.WebStorage=null,[sA,s6]))e.Crypto=rS,e._MsgPack=rw;return z.initLogHandlers(),H.Defaults=Object.assign(ez,rv),H.Config.agent&&(H.Defaults.agent+=" "+H.Config.agent),u.exports={ErrorInfo:Q,Rest:sA,Realtime:s6,msgpack:null,makeProtocolMessageFromDeserialized:function(e){return t=>{var s;return sv(t,{PresenceMessage:tz,WirePresenceMessage:t$},{Annotation:sf,WireAnnotation:sd,RealtimeAnnotations:sT,RestAnnotations:sb},null!=(s=null==e?void 0:e.LiveObjectsPlugin)?s:null)}}},"object"==typeof u.exports&&(u.exports=((e,t,s,r)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let n of Object.getOwnPropertyNames(t))Object.prototype.hasOwnProperty.call(e,n)||n===s||Object.defineProperty(e,n,{get:()=>t[n],enumerable:!(r=Object.getOwnPropertyDescriptor(t,n))||r.enumerable});return e})(u.exports,h)),u.exports},e.exports=r(s(82158),s(15447))},82112:(e,t,s)=>{"use strict";let{V4MAPPED:r,ADDRCONFIG:n,ALL:i,promises:{Resolver:o},lookup:a}=s(80665),{promisify:l}=s(21764),c=s(19801),h=Symbol("cacheableLookupCreateConnection"),u=Symbol("cacheableLookupInstance"),d=Symbol("expires"),f="number"==typeof i,p=e=>{if(!(e&&"function"==typeof e.createConnection))throw Error("Expected an Agent instance as the first argument")},g=e=>{for(let t of e)6!==t.family&&(t.address=`::ffff:${t.address}`,t.family=6)},m=()=>{let e=!1,t=!1;for(let s of Object.values(c.networkInterfaces()))for(let r of s)if(!r.internal&&("IPv6"===r.family?t=!0:e=!0,e&&t))return{has4:e,has6:t};return{has4:e,has6:t}},y=e=>Symbol.iterator in e,b={ttl:!0},_={all:!0};class v{constructor({cache:e=new Map,maxTtl:t=1/0,fallbackDuration:s=3600,errorTtl:r=.15,resolver:n=new o,lookup:i=a}={}){if(this.maxTtl=t,this.errorTtl=r,this._cache=e,this._resolver=n,this._dnsLookup=l(i),this._resolver instanceof o?(this._resolve4=this._resolver.resolve4.bind(this._resolver),this._resolve6=this._resolver.resolve6.bind(this._resolver)):(this._resolve4=l(this._resolver.resolve4.bind(this._resolver)),this._resolve6=l(this._resolver.resolve6.bind(this._resolver))),this._iface=m(),this._pending={},this._nextRemovalTime=!1,this._hostnamesToFallback=new Set,s<1)this._fallback=!1;else{this._fallback=!0;let e=setInterval(()=>{this._hostnamesToFallback.clear()},1e3*s);e.unref&&e.unref()}this.lookup=this.lookup.bind(this),this.lookupAsync=this.lookupAsync.bind(this)}set servers(e){this.clear(),this._resolver.setServers(e)}get servers(){return this._resolver.getServers()}lookup(e,t,s){if("function"==typeof t?(s=t,t={}):"number"==typeof t&&(t={family:t}),!s)throw Error("Callback must be a function.");this.lookupAsync(e,t).then(e=>{t.all?s(null,e):s(null,e.address,e.family,e.expires,e.ttl)},s)}async lookupAsync(e,t={}){"number"==typeof t&&(t={family:t});let s=await this.query(e);if(6===t.family){let e=s.filter(e=>6===e.family);t.hints&r&&(f&&t.hints&i||0===e.length)?g(s):s=e}else 4===t.family&&(s=s.filter(e=>4===e.family));if(t.hints&n){let{_iface:e}=this;s=s.filter(t=>6===t.family?e.has6:e.has4)}if(0===s.length){let t=Error(`cacheableLookup ENOTFOUND ${e}`);throw t.code="ENOTFOUND",t.hostname=e,t}return t.all?s:s[0]}async query(e){let t=await this._cache.get(e);if(!t){let s=this._pending[e];if(s)t=await s;else{let s=this.queryAndCache(e);this._pending[e]=s;try{t=await s}finally{delete this._pending[e]}}}return t.map(e=>({...e}))}async _resolve(e){let t=async e=>{try{return await e}catch(e){if("ENODATA"===e.code||"ENOTFOUND"===e.code)return[];throw e}},[s,r]=await Promise.all([this._resolve4(e,b),this._resolve6(e,b)].map(e=>t(e))),n=0,i=0,o=0,a=Date.now();for(let e of s)e.family=4,e.expires=a+1e3*e.ttl,n=Math.max(n,e.ttl);for(let e of r)e.family=6,e.expires=a+1e3*e.ttl,i=Math.max(i,e.ttl);return o=s.length>0?r.length>0?Math.min(n,i):n:i,{entries:[...s,...r],cacheTtl:o}}async _lookup(e){try{return{entries:await this._dnsLookup(e,{all:!0}),cacheTtl:0}}catch(e){return{entries:[],cacheTtl:0}}}async _set(e,t,s){if(this.maxTtl>0&&s>0){s=1e3*Math.min(s,this.maxTtl),t[d]=Date.now()+s;try{await this._cache.set(e,t,s)}catch(e){this.lookupAsync=async()=>{let t=Error("Cache Error. Please recreate the CacheableLookup instance.");throw t.cause=e,t}}y(this._cache)&&this._tick(s)}}async queryAndCache(e){if(this._hostnamesToFallback.has(e))return this._dnsLookup(e,_);let t=await this._resolve(e);0===t.entries.length&&this._fallback&&0!==(t=await this._lookup(e)).entries.length&&this._hostnamesToFallback.add(e);let s=0===t.entries.length?this.errorTtl:t.cacheTtl;return await this._set(e,t.entries,s),t.entries}_tick(e){let t=this._nextRemovalTime;(!t||e<t)&&(clearTimeout(this._removalTimeout),this._nextRemovalTime=e,this._removalTimeout=setTimeout(()=>{this._nextRemovalTime=!1;let e=1/0,t=Date.now();for(let[s,r]of this._cache){let n=r[d];t>=n?this._cache.delete(s):n<e&&(e=n)}e!==1/0&&this._tick(e-t)},e),this._removalTimeout.unref&&this._removalTimeout.unref())}install(e){if(p(e),h in e)throw Error("CacheableLookup has been already installed");e[h]=e.createConnection,e[u]=this,e.createConnection=(t,s)=>("lookup"in t||(t.lookup=this.lookup),e[h](t,s))}uninstall(e){if(p(e),e[h]){if(e[u]!==this)throw Error("The agent is not owned by this CacheableLookup instance");e.createConnection=e[h],delete e[h],delete e[u]}}updateInterfaceInfo(){let{_iface:e}=this;this._iface=m(),(e.has4&&!this._iface.has4||e.has6&&!this._iface.has6)&&this._cache.clear()}clear(e){if(e){this._cache.delete(e);return}this._cache.clear()}}e.exports=v,e.exports.default=v},21512:(e,t,s)=>{"use strict";let r=s(17702),n=s(17360),i=s(18740),o=s(55815),a=s(20140),l=s(25217),c=s(81332),h=s(48169),u=s(90944);class d{constructor(e,t){if("function"!=typeof e)throw TypeError("Parameter `request` must be a function");return this.cache=new u({uri:"string"==typeof t&&t,store:"string"!=typeof t&&t,namespace:"cacheable-request"}),this.createCacheableRequest(e)}createCacheableRequest(e){return(t,s)=>{let u;if("string"==typeof t)u=f(n.parse(t)),t={};else if(t instanceof n.URL)u=f(n.parse(t.toString())),t={};else{let[e,...s]=(t.path||"").split("?"),r=s.length>0?`?${s.join("?")}`:"";u=f({...t,pathname:e,search:r})}(t={headers:{},method:"GET",cache:!0,strictTtl:!1,automaticFailover:!1,...t,...function(e){let t={...e};return t.path=`${e.pathname||"/"}${e.search||""}`,delete t.pathname,delete t.search,t}(u)}).headers=c(t.headers);let p=new r,g=i(n.format(u),{stripWWW:!1,removeTrailingSlash:!1,stripAuthentication:!1}),m=`${t.method}:${g}`,y=!1,b=!1,_=t=>{let r;b=!0;let n=!1,i=new Promise(e=>{r=()=>{n||(n=!0,e())}});try{let c=e(t,e=>{let r;if(y&&!t.forceRefresh){e.status=e.statusCode;let s=a.fromObject(y.cachePolicy).revalidatedPolicy(t,e);if(!s.modified){let t=s.policy.responseHeaders();(e=new l(y.statusCode,t,y.body,y.url)).cachePolicy=s.policy,e.fromCache=!0}}e.fromCache||(e.cachePolicy=new a(t,e,t),e.fromCache=!1),t.cache&&e.cachePolicy.storable()?(r=h(e),(async()=>{try{let s=o.buffer(e);if(await Promise.race([i,new Promise(t=>e.once("end",t))]),n)return;let r=await s,a={cachePolicy:e.cachePolicy.toObject(),url:e.url,statusCode:e.fromCache?y.statusCode:e.statusCode,body:r},l=t.strictTtl?e.cachePolicy.timeToLive():void 0;t.maxTtl&&(l=l?Math.min(l,t.maxTtl):t.maxTtl),await this.cache.set(m,a,l)}catch(e){p.emit("error",new d.CacheError(e))}})()):t.cache&&y&&(async()=>{try{await this.cache.delete(m)}catch(e){p.emit("error",new d.CacheError(e))}})(),p.emit("response",r||e),"function"==typeof s&&s(r||e)});c.once("error",r),c.once("abort",r),p.emit("request",c)}catch(e){p.emit("error",new d.RequestError(e))}};return(async()=>{let e=async e=>{await Promise.resolve();let t=e.cache?await this.cache.get(m):void 0;if(void 0===t)return _(e);let r=a.fromObject(t.cachePolicy);if(r.satisfiesWithoutRevalidation(e)&&!e.forceRefresh){let e=r.responseHeaders(),n=new l(t.statusCode,e,t.body,t.url);n.cachePolicy=r,n.fromCache=!0,p.emit("response",n),"function"==typeof s&&s(n)}else y=t,e.headers=r.revalidationHeaders(e),_(e)},r=e=>p.emit("error",new d.CacheError(e));this.cache.once("error",r),p.on("response",()=>this.cache.removeListener("error",r));try{await e(t)}catch(e){t.automaticFailover&&!b&&_(t),p.emit("error",new d.CacheError(e))}})(),p}}}function f(e){return{protocol:e.protocol,auth:e.auth,hostname:e.hostname||e.host||"localhost",port:e.port,pathname:e.pathname,search:e.search}}d.RequestError=class extends Error{constructor(e){super(e.message),this.name="RequestError",Object.assign(this,e)}},d.CacheError=class extends Error{constructor(e){super(e.message),this.name="CacheError",Object.assign(this,e)}},e.exports=d},48169:(e,t,s)=>{"use strict";let r=s(76162).PassThrough,n=s(58680);e.exports=e=>{if(!(e&&e.pipe))throw TypeError("Parameter `response` must be a response stream.");let t=new r;return n(e,t),e.pipe(t)}},74174:(e,t,s)=>{"use strict";let{Transform:r,PassThrough:n}=s(76162),i=s(71568),o=s(92880);e.exports=e=>{let t=(e.headers["content-encoding"]||"").toLowerCase();if(!["gzip","deflate","br"].includes(t))return e;let s="br"===t;if(s&&"function"!=typeof i.createBrotliDecompress)return e.destroy(Error("Brotli is not supported on Node.js < 12")),e;let a=!0,l=new r({transform(e,t,s){a=!1,s(null,e)},flush(e){e()}}),c=new n({autoDestroy:!1,destroy(t,s){e.destroy(),s(t)}}),h=s?i.createBrotliDecompress():i.createUnzip();return h.once("error",t=>{if(a&&!e.readable){c.end();return}c.destroy(t)}),o(e,c),e.pipe(l).pipe(h).pipe(c),c}},6152:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});let s=(e,t)=>{let s;let r="function"==typeof(s="function"==typeof t?{connect:t}:t).connect,n="function"==typeof s.secureConnect,i="function"==typeof s.close,o=()=>{r&&s.connect(),e.encrypted&&n&&(e.authorized?s.secureConnect():e.authorizationError||e.once("secureConnect",s.secureConnect)),i&&e.once("close",s.close)};e.writable&&!e.connecting?o():e.connecting?e.once("connect",o):e.destroyed&&i&&s.close(e._hadError)};t.default=s,e.exports=s,e.exports.default=s},52055:(e,t,s)=>{var r=s(48998),n=function(){},i=global.Bare?queueMicrotask:process.nextTick.bind(process),o=function(e,t,s){if("function"==typeof t)return o(e,null,t);t||(t={}),s=r(s||n);var a=e._writableState,l=e._readableState,c=t.readable||!1!==t.readable&&e.readable,h=t.writable||!1!==t.writable&&e.writable,u=!1,d=function(){e.writable||f()},f=function(){h=!1,c||s.call(e)},p=function(){c=!1,h||s.call(e)},g=function(t){s.call(e,t?Error("exited with error code: "+t):null)},m=function(t){s.call(e,t)},y=function(){i(b)},b=function(){if(!u&&(c&&!(l&&l.ended&&!l.destroyed)||h&&!(a&&a.ended&&!a.destroyed)))return s.call(e,Error("premature close"))},_=function(){e.req.on("finish",f)};return e.setHeader&&"function"==typeof e.abort?(e.on("complete",f),e.on("abort",y),e.req?_():e.on("request",_)):h&&!a&&(e.on("end",d),e.on("close",d)),e.stdio&&Array.isArray(e.stdio)&&3===e.stdio.length&&e.on("exit",g),e.on("end",p),e.on("finish",f),!1!==t.error&&e.on("error",m),e.on("close",y),function(){u=!0,e.removeListener("complete",f),e.removeListener("abort",y),e.removeListener("request",_),e.req&&e.req.removeListener("finish",f),e.removeListener("end",d),e.removeListener("close",d),e.removeListener("finish",f),e.removeListener("exit",g),e.removeListener("end",p),e.removeListener("error",m),e.removeListener("close",y)}};e.exports=o},89600:(e,t,s)=>{"use strict";let{PassThrough:r}=s(76162);e.exports=e=>{let{array:t}=e={...e},{encoding:s}=e,n="buffer"===s,i=!1;t?i=!(s||n):s=s||"utf8",n&&(s=null);let o=new r({objectMode:i});s&&o.setEncoding(s);let a=0,l=[];return o.on("data",e=>{l.push(e),i?a=l.length:a+=e.length}),o.getBufferedValue=()=>t?l:n?Buffer.concat(l,a):l.join(""),o.getBufferedLength=()=>a,o}},55815:(e,t,s)=>{"use strict";let{constants:r}=s(78893),n=s(47345),i=s(89600);class o extends Error{constructor(){super("maxBuffer exceeded"),this.name="MaxBufferError"}}async function a(e,t){let s;if(!e)return Promise.reject(Error("Expected a stream"));let{maxBuffer:a}=t={maxBuffer:1/0,...t};return await new Promise((l,c)=>{let h=e=>{e&&s.getBufferedLength()<=r.MAX_LENGTH&&(e.bufferedData=s.getBufferedValue()),c(e)};(s=n(e,i(t),e=>{if(e){h(e);return}l()})).on("data",()=>{s.getBufferedLength()>a&&h(new o)})}),s.getBufferedValue()}e.exports=a,e.exports.default=a,e.exports.buffer=(e,t)=>a(e,{...t,encoding:"buffer"}),e.exports.array=(e,t)=>a(e,{...t,array:!0}),e.exports.MaxBufferError=o},40200:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});let r=s(35595);t.default=function(e,...t){let s=(async()=>{if(e instanceof r.RequestError)try{for(let s of t)if(s)for(let t of s)e=await t(e)}catch(t){e=t}throw e})(),n=()=>s;return s.json=n,s.text=n,s.buffer=n,s.on=n,s}},53129:function(e,t,s){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),n=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||r(t,e,s)};Object.defineProperty(t,"__esModule",{value:!0});let i=s(17702),o=s(88089),a=s(9911),l=s(35595),c=s(6379),h=s(52165),u=s(51174),d=s(53633),f=s(81482),p=["request","response","redirect","uploadProgress","downloadProgress"];t.default=function e(t){let s,r;let n=new i.EventEmitter,g=new a((i,a,m)=>{let y=b=>{let _=new h.default(void 0,t);_.retryCount=b,_._noPipe=!0,m(()=>_.destroy()),m.shouldReject=!1,m(()=>a(new l.CancelError(_))),s=_,_.once("response",async t=>{var s;let n;if(t.retryCount=b,t.request.aborted)return;try{n=await d.default(_),t.rawBody=n}catch(e){return}if(_._isAboutToError)return;let o=["gzip","deflate","br"].includes((null!==(s=t.headers["content-encoding"])&&void 0!==s?s:"").toLowerCase()),{options:a}=_;if(o&&!a.decompress)t.body=n;else try{t.body=c.default(t,a.responseType,a.parseJson,a.encoding)}catch(e){if(t.body=n.toString(),f.isResponseOk(t)){_._beforeError(e);return}}try{for(let[s,r]of a.hooks.afterResponse.entries())t=await r(t,async t=>{let r=h.default.normalizeArguments(void 0,{...t,retry:{calculateDelay:()=>0},throwHttpErrors:!1,resolveBodyOnly:!1},a);for(let e of(r.hooks.afterResponse=r.hooks.afterResponse.slice(0,s),r.hooks.beforeRetry))await e(r);let n=e(r);return m(()=>{n.catch(()=>{}),n.cancel()}),n})}catch(e){_._beforeError(new l.RequestError(e.message,e,_));return}if(r=t,!f.isResponseOk(t)){_._beforeError(new l.HTTPError(t));return}_.destroy(),i(_.options.resolveBodyOnly?t.body:t)});let v=e=>{if(g.isCanceled)return;let{options:t}=_;if(e instanceof l.HTTPError&&!t.throwHttpErrors){let{response:t}=e;i(_.options.resolveBodyOnly?t.body:t);return}a(e)};_.once("error",v);let w=_.options.body;_.once("retry",(e,t)=>{var s,r;if(w===(null===(s=t.request)||void 0===s?void 0:s.options.body)&&o.default.nodeStream(null===(r=t.request)||void 0===r?void 0:r.options.body)){v(t);return}y(e)}),u.default(_,n,p)};y(0)});g.on=(e,t)=>(n.on(e,t),g);let m=e=>{let t=(async()=>{await g;let{options:t}=r.request;return c.default(r,e,t.parseJson,t.encoding)})();return Object.defineProperties(t,Object.getOwnPropertyDescriptors(g)),t};return g.json=()=>{let{headers:e}=s.options;return s.writableFinished||void 0!==e.accept||(e.accept="application/json"),m("json")},g.buffer=()=>m("buffer"),g.text=()=>m("text"),g},n(s(35595),t)},32034:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});let r=s(88089);t.default=(e,t)=>{if(r.default.null_(e.encoding))throw TypeError("To get a Buffer, set `options.responseType` to `buffer` instead");r.assert.any([r.default.string,r.default.undefined],e.encoding),r.assert.any([r.default.boolean,r.default.undefined],e.resolveBodyOnly),r.assert.any([r.default.boolean,r.default.undefined],e.methodRewriting),r.assert.any([r.default.boolean,r.default.undefined],e.isStream),r.assert.any([r.default.string,r.default.undefined],e.responseType),void 0===e.responseType&&(e.responseType="text");let{retry:s}=e;if(t?e.retry={...t.retry}:e.retry={calculateDelay:e=>e.computedValue,limit:0,methods:[],statusCodes:[],errorCodes:[],maxRetryAfter:void 0},r.default.object(s)?(e.retry={...e.retry,...s},e.retry.methods=[...new Set(e.retry.methods.map(e=>e.toUpperCase()))],e.retry.statusCodes=[...new Set(e.retry.statusCodes)],e.retry.errorCodes=[...new Set(e.retry.errorCodes)]):r.default.number(s)&&(e.retry.limit=s),r.default.undefined(e.retry.maxRetryAfter)&&(e.retry.maxRetryAfter=Math.min(...[e.timeout.request,e.timeout.connect].filter(r.default.number))),r.default.object(e.pagination)){t&&(e.pagination={...t.pagination,...e.pagination});let{pagination:s}=e;if(!r.default.function_(s.transform))throw Error("`options.pagination.transform` must be implemented");if(!r.default.function_(s.shouldContinue))throw Error("`options.pagination.shouldContinue` must be implemented");if(!r.default.function_(s.filter))throw TypeError("`options.pagination.filter` must be implemented");if(!r.default.function_(s.paginate))throw Error("`options.pagination.paginate` must be implemented")}return"json"===e.responseType&&void 0===e.headers.accept&&(e.headers.accept="application/json"),e}},6379:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});let r=s(35595);t.default=(e,t,s,n)=>{let{rawBody:i}=e;try{if("text"===t)return i.toString(n);if("json"===t)return 0===i.length?"":s(i.toString());if("buffer"===t)return i;throw new r.ParseError({message:`Unknown body type '${t}'`,name:"Error"},e)}catch(t){throw new r.ParseError(t,e)}}},35595:function(e,t,s){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),n=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||r(t,e,s)};Object.defineProperty(t,"__esModule",{value:!0}),t.CancelError=t.ParseError=void 0;let i=s(52165);class o extends i.RequestError{constructor(e,t){let{options:s}=t.request;super(`${e.message} in "${s.url.toString()}"`,e,t.request),this.name="ParseError",this.code="ERR_GOT_REQUEST_ERROR"===this.code?"ERR_BODY_PARSE_FAILURE":this.code}}t.ParseError=o;class a extends i.RequestError{constructor(e){super("Promise was canceled",{},e),this.name="CancelError",this.code="ERR_CANCELED"}get isCanceled(){return!0}}t.CancelError=a,n(s(52165),t)},12617:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.retryAfterStatusCodes=void 0,t.retryAfterStatusCodes=new Set([413,429,503]),t.default=({attemptCount:e,retryOptions:t,error:s,retryAfter:r})=>{if(e>t.limit)return 0;let n=t.methods.includes(s.options.method),i=t.errorCodes.includes(s.code),o=s.response&&t.statusCodes.includes(s.response.statusCode);if(!n||!i&&!o)return 0;if(s.response){if(r)return void 0===t.maxRetryAfter||r>t.maxRetryAfter?0:r;if(413===s.response.statusCode)return 0}return 2**(e-1)*1e3+100*Math.random()}},52165:(e,t,s)=>{"use strict";let r;Object.defineProperty(t,"__esModule",{value:!0}),t.UnsupportedProtocolError=t.ReadError=t.TimeoutError=t.UploadError=t.CacheError=t.HTTPError=t.MaxRedirectsError=t.RequestError=t.setNonEnumerableProperties=t.knownHookEvents=t.withoutBody=t.kIsNormalizedAlready=void 0;let n=s(21764),i=s(76162),o=s(92048),a=s(17360),l=s(32615),c=s(32615),h=s(35240),u=s(56991),d=s(82112),f=s(21512),p=s(74174),g=s(73145),m=s(81332),y=s(88089),b=s(63318),_=s(89127),v=s(51174),w=s(54986),S=s(32047),O=s(86896),E=s(41960),k=s(53633),C=s(46132),R=s(81482),T=s(99681),A=s(32034),P=s(12617),M=Symbol("request"),I=Symbol("response"),x=Symbol("responseSize"),L=Symbol("downloadedSize"),N=Symbol("bodySize"),U=Symbol("uploadedSize"),j=Symbol("serverResponsesPiped"),B=Symbol("unproxyEvents"),q=Symbol("isFromCache"),D=Symbol("cancelTimeouts"),G=Symbol("startedReading"),H=Symbol("stopReading"),W=Symbol("triggerRead"),F=Symbol("body"),V=Symbol("jobs"),$=Symbol("originalResponse"),z=Symbol("retryTimeout");t.kIsNormalizedAlready=Symbol("isNormalizedAlready");let J=y.default.string(process.versions.brotli);t.withoutBody=new Set(["GET","HEAD"]),t.knownHookEvents=["init","beforeRequest","beforeRedirect","beforeError","beforeRetry","afterResponse"];let K=new E.default,Q=async e=>new Promise((t,s)=>{let r=e=>{s(e)};e.pending||t(),e.once("error",r),e.once("ready",()=>{e.off("error",r),t()})}),X=new Set([300,301,302,303,304,307,308]),Y=["context","body","json","form"];t.setNonEnumerableProperties=(e,t)=>{let s={};for(let t of e)if(t)for(let e of Y)e in t&&(s[e]={writable:!0,configurable:!0,enumerable:!1,value:t[e]});Object.defineProperties(t,s)};class Z extends Error{constructor(e,t,s){var r,n;if(super(e),Error.captureStackTrace(this,this.constructor),this.name="RequestError",this.code=null!==(r=t.code)&&void 0!==r?r:"ERR_GOT_REQUEST_ERROR",s instanceof el?(Object.defineProperty(this,"request",{enumerable:!1,value:s}),Object.defineProperty(this,"response",{enumerable:!1,value:s[I]}),Object.defineProperty(this,"options",{enumerable:!1,value:s.options})):Object.defineProperty(this,"options",{enumerable:!1,value:s}),this.timings=null===(n=this.request)||void 0===n?void 0:n.timings,y.default.string(t.stack)&&y.default.string(this.stack)){let e=this.stack.indexOf(this.message)+this.message.length,s=this.stack.slice(e).split("\n").reverse(),r=t.stack.slice(t.stack.indexOf(t.message)+t.message.length).split("\n").reverse();for(;0!==r.length&&r[0]===s[0];)s.shift();this.stack=`${this.stack.slice(0,e)}${s.reverse().join("\n")}${r.reverse().join("\n")}`}}}t.RequestError=Z;class ee extends Z{constructor(e){super(`Redirected ${e.options.maxRedirects} times. Aborting.`,{},e),this.name="MaxRedirectsError",this.code="ERR_TOO_MANY_REDIRECTS"}}t.MaxRedirectsError=ee;class et extends Z{constructor(e){super(`Response code ${e.statusCode} (${e.statusMessage})`,{},e.request),this.name="HTTPError",this.code="ERR_NON_2XX_3XX_RESPONSE"}}t.HTTPError=et;class es extends Z{constructor(e,t){super(e.message,e,t),this.name="CacheError",this.code="ERR_GOT_REQUEST_ERROR"===this.code?"ERR_CACHE_ACCESS":this.code}}t.CacheError=es;class er extends Z{constructor(e,t){super(e.message,e,t),this.name="UploadError",this.code="ERR_GOT_REQUEST_ERROR"===this.code?"ERR_UPLOAD":this.code}}t.UploadError=er;class en extends Z{constructor(e,t,s){super(e.message,e,s),this.name="TimeoutError",this.event=e.event,this.timings=t}}t.TimeoutError=en;class ei extends Z{constructor(e,t){super(e.message,e,t),this.name="ReadError",this.code="ERR_GOT_REQUEST_ERROR"===this.code?"ERR_READING_RESPONSE_STREAM":this.code}}t.ReadError=ei;class eo extends Z{constructor(e){super(`Unsupported protocol "${e.url.protocol}"`,{},e),this.name="UnsupportedProtocolError",this.code="ERR_UNSUPPORTED_PROTOCOL"}}t.UnsupportedProtocolError=eo;let ea=["socket","connect","continue","information","upgrade","timeout"];class el extends i.Duplex{constructor(e,s={},r){super({autoDestroy:!1,highWaterMark:0}),this[L]=0,this[U]=0,this.requestInitialized=!1,this[j]=new Set,this.redirects=[],this[H]=!1,this[W]=!1,this[V]=[],this.retryCount=0,this._progressCallbacks=[];let n=()=>this._unlockWrite(),i=()=>this._lockWrite();this.on("pipe",e=>{e.prependListener("data",n),e.on("data",i),e.prependListener("end",n),e.on("end",i)}),this.on("unpipe",e=>{e.off("data",n),e.off("data",i),e.off("end",n),e.off("end",i)}),this.on("pipe",e=>{e instanceof c.IncomingMessage&&(this.options.headers={...e.headers,...this.options.headers})});let{json:a,body:l,form:h}=s;if((a||l||h)&&this._lockWrite(),t.kIsNormalizedAlready in s)this.options=s;else try{this.options=this.constructor.normalizeArguments(e,s,r)}catch(e){y.default.nodeStream(s.body)&&s.body.destroy(),this.destroy(e);return}(async()=>{var e;try{this.options.body instanceof o.ReadStream&&await Q(this.options.body);let{url:t}=this.options;if(!t)throw TypeError("Missing `url` property");if(this.requestUrl=t.toString(),decodeURI(this.requestUrl),await this._finalizeBody(),await this._makeRequest(),this.destroyed){null===(e=this[M])||void 0===e||e.destroy();return}for(let e of this[V])e();this[V].length=0,this.requestInitialized=!0}catch(e){if(e instanceof Z){this._beforeError(e);return}this.destroyed||this.destroy(e)}})()}static normalizeArguments(e,s,i){var o,l,c,h,u;let p=s;if(y.default.object(e)&&!y.default.urlInstance(e))s={...i,...e,...s};else{if(e&&s&&void 0!==s.url)throw TypeError("The `url` option is mutually exclusive with the `input` argument");s={...i,...s},void 0!==e&&(s.url=e),y.default.urlInstance(s.url)&&(s.url=new a.URL(s.url.toString()))}if(!1===s.cache&&(s.cache=void 0),!1===s.dnsCache&&(s.dnsCache=void 0),y.assert.any([y.default.string,y.default.undefined],s.method),y.assert.any([y.default.object,y.default.undefined],s.headers),y.assert.any([y.default.string,y.default.urlInstance,y.default.undefined],s.prefixUrl),y.assert.any([y.default.object,y.default.undefined],s.cookieJar),y.assert.any([y.default.object,y.default.string,y.default.undefined],s.searchParams),y.assert.any([y.default.object,y.default.string,y.default.undefined],s.cache),y.assert.any([y.default.object,y.default.number,y.default.undefined],s.timeout),y.assert.any([y.default.object,y.default.undefined],s.context),y.assert.any([y.default.object,y.default.undefined],s.hooks),y.assert.any([y.default.boolean,y.default.undefined],s.decompress),y.assert.any([y.default.boolean,y.default.undefined],s.ignoreInvalidCookies),y.assert.any([y.default.boolean,y.default.undefined],s.followRedirect),y.assert.any([y.default.number,y.default.undefined],s.maxRedirects),y.assert.any([y.default.boolean,y.default.undefined],s.throwHttpErrors),y.assert.any([y.default.boolean,y.default.undefined],s.http2),y.assert.any([y.default.boolean,y.default.undefined],s.allowGetBody),y.assert.any([y.default.string,y.default.undefined],s.localAddress),y.assert.any([C.isDnsLookupIpVersion,y.default.undefined],s.dnsLookupIpVersion),y.assert.any([y.default.object,y.default.undefined],s.https),y.assert.any([y.default.boolean,y.default.undefined],s.rejectUnauthorized),s.https&&(y.assert.any([y.default.boolean,y.default.undefined],s.https.rejectUnauthorized),y.assert.any([y.default.function_,y.default.undefined],s.https.checkServerIdentity),y.assert.any([y.default.string,y.default.object,y.default.array,y.default.undefined],s.https.certificateAuthority),y.assert.any([y.default.string,y.default.object,y.default.array,y.default.undefined],s.https.key),y.assert.any([y.default.string,y.default.object,y.default.array,y.default.undefined],s.https.certificate),y.assert.any([y.default.string,y.default.undefined],s.https.passphrase),y.assert.any([y.default.string,y.default.buffer,y.default.array,y.default.undefined],s.https.pfx)),y.assert.any([y.default.object,y.default.undefined],s.cacheOptions),y.default.string(s.method)?s.method=s.method.toUpperCase():s.method="GET",s.headers===(null==i?void 0:i.headers)?s.headers={...s.headers}:s.headers=m({...null==i?void 0:i.headers,...s.headers}),"slashes"in s)throw TypeError("The legacy `url.Url` has been deprecated. Use `URL` instead.");if("auth"in s)throw TypeError("Parameter `auth` is deprecated. Use `username` / `password` instead.");if("searchParams"in s&&s.searchParams&&s.searchParams!==(null==i?void 0:i.searchParams)){let e;if(y.default.string(s.searchParams)||s.searchParams instanceof a.URLSearchParams)e=new a.URLSearchParams(s.searchParams);else for(let t in function(e){for(let t in e){let s=e[t];if(!y.default.string(s)&&!y.default.number(s)&&!y.default.boolean(s)&&!y.default.null_(s)&&!y.default.undefined(s))throw TypeError(`The \`searchParams\` value '${String(s)}' must be a string, number, boolean or null`)}}(s.searchParams),e=new a.URLSearchParams,s.searchParams){let r=s.searchParams[t];null===r?e.append(t,""):void 0!==r&&e.append(t,r)}null===(o=null==i?void 0:i.searchParams)||void 0===o||o.forEach((t,s)=>{e.has(s)||e.append(s,t)}),s.searchParams=e}if(s.username=null!==(l=s.username)&&void 0!==l?l:"",s.password=null!==(c=s.password)&&void 0!==c?c:"",y.default.undefined(s.prefixUrl)?s.prefixUrl=null!==(h=null==i?void 0:i.prefixUrl)&&void 0!==h?h:"":(s.prefixUrl=s.prefixUrl.toString(),""===s.prefixUrl||s.prefixUrl.endsWith("/")||(s.prefixUrl+="/")),y.default.string(s.url)){if(s.url.startsWith("/"))throw Error("`input` must not start with a slash when using `prefixUrl`");s.url=O.default(s.prefixUrl+s.url,s)}else(y.default.undefined(s.url)&&""!==s.prefixUrl||s.protocol)&&(s.url=O.default(s.prefixUrl,s));if(s.url){"port"in s&&delete s.port;let{prefixUrl:e}=s;Object.defineProperty(s,"prefixUrl",{set:t=>{let r=s.url;if(!r.href.startsWith(t))throw Error(`Cannot change \`prefixUrl\` from ${e} to ${t}: ${r.href}`);s.url=new a.URL(t+r.href.slice(e.length)),e=t},get:()=>e});let{protocol:t}=s.url;if("unix:"===t&&(t="http:",s.url=new a.URL(`http://unix${s.url.pathname}${s.url.search}`)),s.searchParams&&(s.url.search=s.searchParams.toString()),"http:"!==t&&"https:"!==t)throw new eo(s);""===s.username?s.username=s.url.username:s.url.username=s.username,""===s.password?s.password=s.url.password:s.url.password=s.password}let{cookieJar:g}=s;if(g){let{setCookie:e,getCookieString:t}=g;y.assert.function_(e),y.assert.function_(t),4===e.length&&0===t.length&&(e=n.promisify(e.bind(s.cookieJar)),t=n.promisify(t.bind(s.cookieJar)),s.cookieJar={setCookie:e,getCookieString:t})}let{cache:b}=s;if(b&&!K.has(b)&&K.set(b,new f((e,t)=>{let s=e[M](e,t);return y.default.promise(s)&&(s.once=(e,t)=>{if("error"===e)s.catch(t);else if("abort"===e)(async()=>{try{(await s).once("abort",t)}catch(e){}})();else throw Error(`Unknown HTTP2 promise event: ${e}`);return s}),s},b)),s.cacheOptions={...s.cacheOptions},!0===s.dnsCache)r||(r=new d.default),s.dnsCache=r;else if(!y.default.undefined(s.dnsCache)&&!s.dnsCache.lookup)throw TypeError(`Parameter \`dnsCache\` must be a CacheableLookup instance or a boolean, got ${y.default(s.dnsCache)}`);y.default.number(s.timeout)?s.timeout={request:s.timeout}:i&&s.timeout!==i.timeout?s.timeout={...i.timeout,...s.timeout}:s.timeout={...s.timeout},s.context||(s.context={});let _=s.hooks===(null==i?void 0:i.hooks);for(let e of(s.hooks={...s.hooks},t.knownHookEvents))if(e in s.hooks){if(y.default.array(s.hooks[e]))s.hooks[e]=[...s.hooks[e]];else throw TypeError(`Parameter \`${e}\` must be an Array, got ${y.default(s.hooks[e])}`)}else s.hooks[e]=[];if(i&&!_)for(let e of t.knownHookEvents)i.hooks[e].length>0&&(s.hooks[e]=[...i.hooks[e],...s.hooks[e]]);if("family"in s&&T.default('"options.family" was never documented, please use "options.dnsLookupIpVersion"'),(null==i?void 0:i.https)&&(s.https={...i.https,...s.https}),"rejectUnauthorized"in s&&T.default('"options.rejectUnauthorized" is now deprecated, please use "options.https.rejectUnauthorized"'),"checkServerIdentity"in s&&T.default('"options.checkServerIdentity" was never documented, please use "options.https.checkServerIdentity"'),"ca"in s&&T.default('"options.ca" was never documented, please use "options.https.certificateAuthority"'),"key"in s&&T.default('"options.key" was never documented, please use "options.https.key"'),"cert"in s&&T.default('"options.cert" was never documented, please use "options.https.certificate"'),"passphrase"in s&&T.default('"options.passphrase" was never documented, please use "options.https.passphrase"'),"pfx"in s&&T.default('"options.pfx" was never documented, please use "options.https.pfx"'),"followRedirects"in s)throw TypeError("The `followRedirects` option does not exist. Use `followRedirect` instead.");if(s.agent){for(let e in s.agent)if("http"!==e&&"https"!==e&&"http2"!==e)throw TypeError(`Expected the \`options.agent\` properties to be \`http\`, \`https\` or \`http2\`, got \`${e}\``)}return s.maxRedirects=null!==(u=s.maxRedirects)&&void 0!==u?u:0,t.setNonEnumerableProperties([i,p],s),A.default(s,i)}_lockWrite(){let e=()=>{throw TypeError("The payload has been already provided")};this.write=e,this.end=e}_unlockWrite(){this.write=super.write,this.end=super.end}async _finalizeBody(){let{options:e}=this,{headers:s}=e,r=!y.default.undefined(e.form),n=!y.default.undefined(e.json),o=!y.default.undefined(e.body),l=t.withoutBody.has(e.method)&&!("GET"===e.method&&e.allowGetBody);if(this._cannotHaveBody=l,r||n||o){if(l)throw TypeError(`The \`${e.method}\` method cannot be used with a body`);if([o,r,n].filter(e=>e).length>1)throw TypeError("The `body`, `json` and `form` options are mutually exclusive");if(o&&!(e.body instanceof i.Readable)&&!y.default.string(e.body)&&!y.default.buffer(e.body)&&!_.default(e.body))throw TypeError("The `body` option must be a stream.Readable, string or Buffer");if(r&&!y.default.object(e.form))throw TypeError("The `form` option must be an Object");{let t=!y.default.string(s["content-type"]);o?(_.default(e.body)&&t&&(s["content-type"]=`multipart/form-data; boundary=${e.body.getBoundary()}`),this[F]=e.body):r?(t&&(s["content-type"]="application/x-www-form-urlencoded"),this[F]=new a.URLSearchParams(e.form).toString()):(t&&(s["content-type"]="application/json"),this[F]=e.stringifyJson(e.json));let n=await b.default(this[F],e.headers);y.default.undefined(s["content-length"])&&y.default.undefined(s["transfer-encoding"])&&!l&&!y.default.undefined(n)&&(s["content-length"]=String(n))}}else l?this._lockWrite():this._unlockWrite();this[N]=Number(s["content-length"])||void 0}async _onResponseBase(e){let{options:t}=this,{url:s}=t;this[$]=e,t.decompress&&(e=p(e));let r=e.statusCode,n=e;n.statusMessage=n.statusMessage?n.statusMessage:l.STATUS_CODES[r],n.url=t.url.toString(),n.requestUrl=this.requestUrl,n.redirectUrls=this.redirects,n.request=this,n.isFromCache=e.fromCache||!1,n.ip=this.ip,n.retryCount=this.retryCount,this[q]=n.isFromCache,this[x]=Number(e.headers["content-length"])||void 0,this[I]=e,e.once("end",()=>{this[x]=this[L],this.emit("downloadProgress",this.downloadProgress)}),e.once("error",t=>{e.destroy(),this._beforeError(new ei(t,this))}),e.once("aborted",()=>{this._beforeError(new ei({name:"Error",message:"The server aborted pending request",code:"ECONNRESET"},this))}),this.emit("downloadProgress",this.downloadProgress);let i=e.headers["set-cookie"];if(y.default.object(t.cookieJar)&&i){let e=i.map(async e=>t.cookieJar.setCookie(e,s.toString()));t.ignoreInvalidCookies&&(e=e.map(async e=>e.catch(()=>{})));try{await Promise.all(e)}catch(e){this._beforeError(e);return}}if(t.followRedirect&&e.headers.location&&X.has(r)){if(e.resume(),this[M]&&(this[D](),delete this[M],this[B]()),(303!==r||"GET"===t.method||"HEAD"===t.method)&&t.methodRewriting||(t.method="GET","body"in t&&delete t.body,"json"in t&&delete t.json,"form"in t&&delete t.form,this[F]=void 0,delete t.headers["content-length"]),this.redirects.length>=t.maxRedirects){this._beforeError(new ee(this));return}try{let r=Buffer.from(e.headers.location,"binary").toString(),i=new a.URL(r,s),l=i.toString();function o(e){return"unix:"===e.protocol||"unix"===e.hostname}if(decodeURI(l),!o(s)&&o(i)){this._beforeError(new Z("Cannot redirect to UNIX socket",{},this));return}for(let e of(i.hostname!==s.hostname||i.port!==s.port?("host"in t.headers&&delete t.headers.host,"cookie"in t.headers&&delete t.headers.cookie,"authorization"in t.headers&&delete t.headers.authorization,(t.username||t.password)&&(t.username="",t.password="")):(i.username=t.username,i.password=t.password),this.redirects.push(l),t.url=i,t.hooks.beforeRedirect))await e(t,n);this.emit("redirect",n,t),await this._makeRequest()}catch(e){this._beforeError(e)}return}if(t.isStream&&t.throwHttpErrors&&!R.isResponseOk(n)){this._beforeError(new et(n));return}for(let s of(e.on("readable",()=>{this[W]&&this._read()}),this.on("resume",()=>{e.resume()}),this.on("pause",()=>{e.pause()}),e.once("end",()=>{this.push(null)}),this.emit("response",e),this[j]))if(!s.headersSent){for(let r in e.headers){let n=!t.decompress||"content-encoding"!==r,i=e.headers[r];n&&s.setHeader(r,i)}s.statusCode=r}}async _onResponse(e){try{await this._onResponseBase(e)}catch(e){this._beforeError(e)}}_onRequest(e){let{options:t}=this,{timeout:s,url:r}=t;u.default(e),this[D]=w.default(e,s,r);let n=t.cache?"cacheableResponse":"response";e.once(n,e=>{this._onResponse(e)}),e.once("error",t=>{var s;e.destroy(),null===(s=e.res)||void 0===s||s.removeAllListeners("end"),t=t instanceof w.TimeoutError?new en(t,this.timings,this):new Z(t.message,t,this),this._beforeError(t)}),this[B]=v.default(e,this,ea),this[M]=e,this.emit("uploadProgress",this.uploadProgress);let i=this[F],o=0===this.redirects.length?this:e;y.default.nodeStream(i)?(i.pipe(o),i.once("error",e=>{this._beforeError(new er(e,this))})):(this._unlockWrite(),y.default.undefined(i)?(this._cannotHaveBody||this._noPipe)&&(o.end(),this._lockWrite()):(this._writeRequest(i,void 0,()=>{}),o.end(),this._lockWrite())),this.emit("request",e)}async _createCacheableRequest(e,t){return new Promise((s,r)=>{let n;Object.assign(t,S.default(e)),delete t.url;let i=K.get(t.cache)(t,async e=>{e._readableState.autoDestroy=!1,n&&(await n).emit("cacheableResponse",e),s(e)});t.url=e,i.once("error",r),i.once("request",async e=>{s(n=e)})})}async _makeRequest(){var e,t,s,r,n,i;let o;let{options:a}=this,{headers:c}=a;for(let e in c)if(y.default.undefined(c[e]))delete c[e];else if(y.default.null_(c[e]))throw TypeError(`Use \`undefined\` instead of \`null\` to delete the \`${e}\` header`);if(a.decompress&&y.default.undefined(c["accept-encoding"])&&(c["accept-encoding"]=J?"gzip, deflate, br":"gzip, deflate"),a.cookieJar){let e=await a.cookieJar.getCookieString(a.url.toString());y.default.nonEmptyString(e)&&(a.headers.cookie=e)}for(let e of a.hooks.beforeRequest){let t=await e(a);if(!y.default.undefined(t)){a.request=()=>t;break}}a.body&&this[F]!==a.body&&(this[F]=a.body);let{agent:u,request:d,timeout:p,url:m}=a;if(!a.dnsCache||"lookup"in a||(a.lookup=a.dnsCache.lookup),"unix"===m.hostname){let e=/(?<socketPath>.+?):(?<path>.+)/.exec(`${m.pathname}${m.search}`);if(null==e?void 0:e.groups){let{socketPath:t,path:s}=e.groups;Object.assign(a,{socketPath:t,path:s,host:""})}}let b="https:"===m.protocol;o=a.http2?g.auto:b?h.request:l.request;let _=null!==(e=a.request)&&void 0!==e?e:o,v=a.cache?this._createCacheableRequest:_;if(u&&!a.http2&&(a.agent=u[b?"https":"http"]),a[M]=_,delete a.request,delete a.timeout,a.shared=null===(t=a.cacheOptions)||void 0===t?void 0:t.shared,a.cacheHeuristic=null===(s=a.cacheOptions)||void 0===s?void 0:s.cacheHeuristic,a.immutableMinTimeToLive=null===(r=a.cacheOptions)||void 0===r?void 0:r.immutableMinTimeToLive,a.ignoreCargoCult=null===(n=a.cacheOptions)||void 0===n?void 0:n.ignoreCargoCult,void 0!==a.dnsLookupIpVersion)try{a.family=C.dnsLookupIpVersionToFamily(a.dnsLookupIpVersion)}catch(e){throw Error("Invalid `dnsLookupIpVersion` option value")}a.https&&("rejectUnauthorized"in a.https&&(a.rejectUnauthorized=a.https.rejectUnauthorized),a.https.checkServerIdentity&&(a.checkServerIdentity=a.https.checkServerIdentity),a.https.certificateAuthority&&(a.ca=a.https.certificateAuthority),a.https.certificate&&(a.cert=a.https.certificate),a.https.key&&(a.key=a.https.key),a.https.passphrase&&(a.passphrase=a.https.passphrase),a.https.pfx&&(a.pfx=a.https.pfx));try{let e=await v(m,a);(y.default.undefined(e)&&(e=o(m,a)),a.request=d,a.timeout=p,a.agent=u,a.https&&("rejectUnauthorized"in a.https&&delete a.rejectUnauthorized,a.https.checkServerIdentity&&delete a.checkServerIdentity,a.https.certificateAuthority&&delete a.ca,a.https.certificate&&delete a.cert,a.https.key&&delete a.key,a.https.passphrase&&delete a.passphrase,a.https.pfx&&delete a.pfx),i=e,!y.default.object(i)||"statusCode"in i)?this.writable?(this.once("finish",()=>{this._onResponse(e)}),this._unlockWrite(),this.end(),this._lockWrite()):this._onResponse(e):this._onRequest(e)}catch(e){if(e instanceof f.CacheError)throw new es(e,this);throw new Z(e.message,e,this)}}async _error(e){try{for(let t of this.options.hooks.beforeError)e=await t(e)}catch(t){e=new Z(t.message,t,this)}this.destroy(e)}_beforeError(e){if(this[H])return;let{options:t}=this,s=this.retryCount+1;this[H]=!0,e instanceof Z||(e=new Z(e.message,e,this));let r=e,{response:n}=r;(async()=>{if(n&&!n.body){n.setEncoding(this._readableState.encoding);try{n.rawBody=await k.default(n),n.body=n.rawBody.toString()}catch(e){}}if(0!==this.listenerCount("retry")){let i;try{let e;n&&"retry-after"in n.headers&&(e=Number(n.headers["retry-after"]),Number.isNaN(e)?(e=Date.parse(n.headers["retry-after"])-Date.now())<=0&&(e=1):e*=1e3),i=await t.retry.calculateDelay({attemptCount:s,retryOptions:t.retry,error:r,retryAfter:e,computedValue:P.default({attemptCount:s,retryOptions:t.retry,error:r,retryAfter:e,computedValue:0})})}catch(e){this._error(new Z(e.message,e,this));return}if(i){let t=async()=>{try{for(let e of this.options.hooks.beforeRetry)await e(this.options,r,s)}catch(t){this._error(new Z(t.message,e,this));return}this.destroyed||(this.destroy(),this.emit("retry",s,e))};this[z]=setTimeout(t,i);return}}this._error(r)})()}_read(){this[W]=!0;let e=this[I];if(e&&!this[H]){let t;for(e.readableLength&&(this[W]=!1);null!==(t=e.read());){this[L]+=t.length,this[G]=!0;let e=this.downloadProgress;e.percent<1&&this.emit("downloadProgress",e),this.push(t)}}}_write(e,t,s){let r=()=>{this._writeRequest(e,t,s)};this.requestInitialized?r():this[V].push(r)}_writeRequest(e,t,s){this[M].destroyed||(this._progressCallbacks.push(()=>{this[U]+=Buffer.byteLength(e,t);let s=this.uploadProgress;s.percent<1&&this.emit("uploadProgress",s)}),this[M].write(e,t,e=>{!e&&this._progressCallbacks.length>0&&this._progressCallbacks.shift()(),s(e)}))}_final(e){let t=()=>{for(;0!==this._progressCallbacks.length;)this._progressCallbacks.shift()();if(!(M in this)||this[M].destroyed){e();return}this[M].end(t=>{t||(this[N]=this[U],this.emit("uploadProgress",this.uploadProgress),this[M].emit("upload-complete")),e(t)})};this.requestInitialized?t():this[V].push(t)}_destroy(e,t){var s;this[H]=!0,clearTimeout(this[z]),M in this&&(this[D](),(null===(s=this[I])||void 0===s?void 0:s.complete)||this[M].destroy()),null===e||y.default.undefined(e)||e instanceof Z||(e=new Z(e.message,e,this)),t(e)}get _isAboutToError(){return this[H]}get ip(){var e;return null===(e=this.socket)||void 0===e?void 0:e.remoteAddress}get aborted(){var e,t,s;return(null!==(t=null===(e=this[M])||void 0===e?void 0:e.destroyed)&&void 0!==t?t:this.destroyed)&&!(null===(s=this[$])||void 0===s?void 0:s.complete)}get socket(){var e,t;return null!==(t=null===(e=this[M])||void 0===e?void 0:e.socket)&&void 0!==t?t:void 0}get downloadProgress(){return{percent:this[x]?this[L]/this[x]:this[x]===this[L]?1:0,transferred:this[L],total:this[x]}}get uploadProgress(){return{percent:this[N]?this[U]/this[N]:this[N]===this[U]?1:0,transferred:this[U],total:this[N]}}get timings(){var e;return null===(e=this[M])||void 0===e?void 0:e.timings}get isFromCache(){return this[q]}pipe(e,t){if(this[G])throw Error("Failed to pipe. The response has been emitted already.");return e instanceof c.ServerResponse&&this[j].add(e),super.pipe(e,t)}unpipe(e){return e instanceof c.ServerResponse&&this[j].delete(e),super.unpipe(e),this}}t.default=el},46132:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dnsLookupIpVersionToFamily=t.isDnsLookupIpVersion=void 0;let s={auto:0,ipv4:4,ipv6:6};t.isDnsLookupIpVersion=e=>e in s,t.dnsLookupIpVersionToFamily=e=>{if(t.isDnsLookupIpVersion(e))return s[e];throw Error("Invalid DNS lookup IP version")}},63318:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});let r=s(92048),n=s(21764),i=s(88089),o=s(89127),a=n.promisify(r.stat);t.default=async(e,t)=>{if(t&&"content-length"in t)return Number(t["content-length"]);if(!e)return 0;if(i.default.string(e))return Buffer.byteLength(e);if(i.default.buffer(e))return e.length;if(o.default(e))return n.promisify(e.getLength.bind(e))();if(e instanceof r.ReadStream){let{size:t}=await a(e.path);if(0===t)return;return t}}},53633:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});let s=async e=>{let t=[],s=0;for await(let r of e)t.push(r),s+=Buffer.byteLength(r);return Buffer.isBuffer(t[0])?Buffer.concat(t,s):Buffer.from(t.join(""))};t.default=s},89127:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});let r=s(88089);t.default=e=>r.default.nodeStream(e)&&r.default.function_(e.getBoundary)},81482:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isResponseOk=void 0,t.isResponseOk=e=>{let{statusCode:t}=e,s=e.request.options.followRedirect?299:399;return t>=200&&t<=s||304===t}},86896:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});let r=s(17360),n=["protocol","host","hostname","port","pathname","search"];t.default=(e,t)=>{var s,i;if(t.path){if(t.pathname)throw TypeError("Parameters `path` and `pathname` are mutually exclusive.");if(t.search)throw TypeError("Parameters `path` and `search` are mutually exclusive.");if(t.searchParams)throw TypeError("Parameters `path` and `searchParams` are mutually exclusive.")}if(t.search&&t.searchParams)throw TypeError("Parameters `search` and `searchParams` are mutually exclusive.");if(!e){if(!t.protocol)throw TypeError("No URL protocol specified");e=`${t.protocol}//${null!==(i=null!==(s=t.hostname)&&void 0!==s?s:t.host)&&void 0!==i?i:""}`}let o=new r.URL(e);if(t.path){let e=t.path.indexOf("?");-1===e?t.pathname=t.path:(t.pathname=t.path.slice(0,e),t.search=t.path.slice(e+1)),delete t.path}for(let e of n)t[e]&&(o[e]=t[e].toString());return o}},51174:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,s){let r={};for(let n of s)r[n]=(...e)=>{t.emit(n,...e)},e.on(n,r[n]);return()=>{for(let t of s)e.off(t,r[t])}}},54986:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TimeoutError=void 0;let r=s(98216),n=s(83157),i=Symbol("reentry"),o=()=>{};class a extends Error{constructor(e,t){super(`Timeout awaiting '${t}' for ${e}ms`),this.event=t,this.name="TimeoutError",this.code="ETIMEDOUT"}}t.TimeoutError=a,t.default=(e,t,s)=>{if(i in e)return o;e[i]=!0;let l=[],{once:c,unhandleAll:h}=n.default(),u=(e,t,s)=>{var r;let n=setTimeout(t,e,e,s);null===(r=n.unref)||void 0===r||r.call(n);let i=()=>{clearTimeout(n)};return l.push(i),i},{host:d,hostname:f}=s,p=(t,s)=>{e.destroy(new a(t,s))},g=()=>{for(let e of l)e();h()};if(e.once("error",t=>{if(g(),0===e.listenerCount("error"))throw t}),e.once("close",g),c(e,"response",e=>{c(e,"end",g)}),void 0!==t.request&&u(t.request,p,"request"),void 0!==t.socket){let s=()=>{p(t.socket,"socket")};e.setTimeout(t.socket,s),l.push(()=>{e.removeListener("timeout",s)})}return c(e,"socket",n=>{var i;let{socketPath:o}=e;if(n.connecting){let e=!!(null!=o?o:0!==r.isIP(null!==(i=null!=f?f:d)&&void 0!==i?i:""));if(void 0===t.lookup||e||void 0!==n.address().address||c(n,"lookup",u(t.lookup,p,"lookup")),void 0!==t.connect){let s=()=>u(t.connect,p,"connect");e?c(n,"connect",s()):c(n,"lookup",e=>{null===e&&c(n,"connect",s())})}void 0!==t.secureConnect&&"https:"===s.protocol&&c(n,"connect",()=>{c(n,"secureConnect",u(t.secureConnect,p,"secureConnect"))})}if(void 0!==t.send){let s=()=>u(t.send,p,"send");n.connecting?c(n,"connect",()=>{c(e,"upload-complete",s())}):c(e,"upload-complete",s())}}),void 0!==t.response&&c(e,"upload-complete",()=>{c(e,"response",u(t.response,p,"response"))}),g}},83157:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=()=>{let e=[];return{once(t,s,r){t.once(s,r),e.push({origin:t,event:s,fn:r})},unhandleAll(){for(let t of e){let{origin:e,event:s,fn:r}=t;e.removeListener(s,r)}e.length=0}}}},32047:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});let r=s(88089);t.default=e=>{let t={protocol:e.protocol,hostname:r.default.string(e.hostname)&&e.hostname.startsWith("[")?e.hostname.slice(1,-1):e.hostname,host:e.host,hash:e.hash,search:e.search,pathname:e.pathname,href:e.href,path:`${e.pathname||""}${e.search||""}`};return r.default.string(e.port)&&e.port.length>0&&(t.port=Number(e.port)),(e.username||e.password)&&(t.auth=`${e.username||""}:${e.password||""}`),t}},41960:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});class s{constructor(){this.weakMap=new WeakMap,this.map=new Map}set(e,t){"object"==typeof e?this.weakMap.set(e,t):this.map.set(e,t)}get(e){return"object"==typeof e?this.weakMap.get(e):this.map.get(e)}has(e){return"object"==typeof e?this.weakMap.has(e):this.map.has(e)}}t.default=s},45763:function(e,t,s){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),n=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||r(t,e,s)};Object.defineProperty(t,"__esModule",{value:!0}),t.defaultHandler=void 0;let i=s(88089),o=s(53129),a=s(40200),l=s(52165),c=s(79371),h={RequestError:o.RequestError,CacheError:o.CacheError,ReadError:o.ReadError,HTTPError:o.HTTPError,MaxRedirectsError:o.MaxRedirectsError,TimeoutError:o.TimeoutError,ParseError:o.ParseError,CancelError:o.CancelError,UnsupportedProtocolError:o.UnsupportedProtocolError,UploadError:o.UploadError},u=async e=>new Promise(t=>{setTimeout(t,e)}),{normalizeArguments:d}=l.default,f=(...e)=>{let t;for(let s of e)t=d(void 0,s,t);return t},p=e=>e.isStream?new l.default(void 0,e):o.default(e),g=e=>"defaults"in e&&"options"in e.defaults,m=["get","post","put","patch","head","delete"];t.defaultHandler=(e,t)=>t(e);let y=(e,t)=>{if(e)for(let s of e)s(t)},b=e=>{e._rawHandlers=e.handlers,e.handlers=e.handlers.map(e=>(t,s)=>{let r;let n=e(t,e=>r=s(e));if(n!==r&&!t.isStream&&r){let{then:e,catch:t,finally:s}=n;Object.setPrototypeOf(n,Object.getPrototypeOf(r)),Object.defineProperties(n,Object.getOwnPropertyDescriptors(r)),n.then=e,n.catch=t,n.finally=s}return n});let s=(t,s={},r)=>{var n,c;let h=0,u=t=>e.handlers[h++](t,h===e.handlers.length?p:u);if(i.default.plainObject(t)){let e={...t,...s};l.setNonEnumerableProperties([t,s],e),s=e,t=void 0}try{let i;try{y(e.options.hooks.init,s),y(null===(n=s.hooks)||void 0===n?void 0:n.init,s)}catch(e){i=e}let a=d(t,s,null!=r?r:e.options);if(a[l.kIsNormalizedAlready]=!0,i)throw new o.RequestError(i.message,i,a);return u(a)}catch(t){if(!s.isStream)return a.default(t,e.options.hooks.beforeError,null===(c=s.hooks)||void 0===c?void 0:c.beforeError);throw t}};s.extend=(...s)=>{let r;let n=[e.options],i=[...e._rawHandlers];for(let e of s)g(e)?(n.push(e.defaults.options),i.push(...e.defaults._rawHandlers),r=e.defaults.mutableDefaults):(n.push(e),"handlers"in e&&i.push(...e.handlers),r=e.mutableDefaults);return 0===(i=i.filter(e=>e!==t.defaultHandler)).length&&i.push(t.defaultHandler),b({options:f(...n),handlers:i,mutableDefaults:!!r})};let r=async function*(t,r){let n=d(t,r,e.options);n.resolveBodyOnly=!1;let o=n.pagination;if(!i.default.object(o))throw TypeError("`options.pagination` must be implemented");let a=[],{countLimit:l}=o,c=0;for(;c<o.requestLimit;){0!==c&&await u(o.backoff);let e=await s(void 0,void 0,n),t=await o.transform(e),r=[];for(let e of t)if(o.filter(e,a,r)&&(!o.shouldContinue(e,a,r)||(yield e,o.stackAllItems&&a.push(e),r.push(e),--l<=0)))return;let i=o.paginate(e,a,r);if(!1===i)return;i===e.request.options?n=e.request.options:void 0!==i&&(n=d(void 0,i,n)),c++}};for(let e of(s.paginate=r,s.paginate.all=async(e,t)=>{let s=[];for await(let n of r(e,t))s.push(n);return s},s.paginate.each=r,s.stream=(e,t)=>s(e,{...t,isStream:!0}),m))s[e]=(t,r)=>s(t,{...r,method:e}),s.stream[e]=(t,r)=>s(t,{...r,method:e,isStream:!0});return Object.assign(s,h),Object.defineProperty(s,"defaults",{value:e.mutableDefaults?e:c.default(e),writable:e.mutableDefaults,configurable:e.mutableDefaults,enumerable:!0}),s.mergeOptions=f,s};t.default=b,n(s(67967),t)},15447:function(e,t,s){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),n=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||r(t,e,s)};Object.defineProperty(t,"__esModule",{value:!0});let i=s(17360),o=s(45763),a={options:{method:"GET",retry:{limit:2,methods:["GET","PUT","HEAD","DELETE","OPTIONS","TRACE"],statusCodes:[408,413,429,500,502,503,504,521,522,524],errorCodes:["ETIMEDOUT","ECONNRESET","EADDRINUSE","ECONNREFUSED","EPIPE","ENOTFOUND","ENETUNREACH","EAI_AGAIN"],maxRetryAfter:void 0,calculateDelay:({computedValue:e})=>e},timeout:{},headers:{"user-agent":"got (https://github.com/sindresorhus/got)"},hooks:{init:[],beforeRequest:[],beforeRedirect:[],beforeRetry:[],beforeError:[],afterResponse:[]},cache:void 0,dnsCache:void 0,decompress:!0,throwHttpErrors:!0,followRedirect:!0,isStream:!1,responseType:"text",resolveBodyOnly:!1,maxRedirects:10,prefixUrl:"",methodRewriting:!0,ignoreInvalidCookies:!1,context:{},http2:!1,allowGetBody:!1,https:void 0,pagination:{transform:e=>"json"===e.request.options.responseType?e.body:JSON.parse(e.body),paginate:e=>{let t;if(!Reflect.has(e.headers,"link"))return!1;for(let s of e.headers.link.split(",")){let e=s.split(";");if(e[1].includes("next")){t=(t=e[0].trimStart().trim()).slice(1,-1);break}}return!!t&&{url:new i.URL(t)}},filter:()=>!0,shouldContinue:()=>!0,countLimit:1/0,backoff:0,requestLimit:1e4,stackAllItems:!0},parseJson:e=>JSON.parse(e),stringifyJson:e=>JSON.stringify(e),cacheOptions:{}},handlers:[o.defaultHandler],mutableDefaults:!1},l=o.default(a);t.default=l,e.exports=l,e.exports.default=l,e.exports.__esModule=!0,n(s(45763),t),n(s(53129),t)},67967:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},79371:(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});let r=s(88089);t.default=function e(t){for(let s of Object.values(t))(r.default.plainObject(s)||r.default.array(s))&&e(s);return Object.freeze(t)}},99681:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});let s=new Set;t.default=e=>{s.has(e)||(s.add(e),process.emitWarning(`Got: ${e}`,{type:"DeprecationWarning"}))}},20140:e=>{"use strict";let t=new Set([200,203,204,206,300,301,308,404,405,410,414,501]),s=new Set([200,203,204,300,301,302,303,307,308,404,405,410,414,501]),r=new Set([500,502,503,504]),n={date:!0,connection:!0,"keep-alive":!0,"proxy-authenticate":!0,"proxy-authorization":!0,te:!0,trailer:!0,"transfer-encoding":!0,upgrade:!0},i={"content-length":!0,"content-encoding":!0,"transfer-encoding":!0,"content-range":!0};function o(e){let t=parseInt(e,10);return isFinite(t)?t:0}function a(e){let t={};if(!e)return t;for(let s of e.trim().split(/,/)){let[e,r]=s.split(/=/,2);t[e.trim()]=void 0===r||r.trim().replace(/^"|"$/g,"")}return t}e.exports=class{constructor(e,t,{shared:s,cacheHeuristic:r,immutableMinTimeToLive:n,ignoreCargoCult:i,_fromObject:o}={}){if(o){this._fromObject(o);return}if(!t||!t.headers)throw Error("Response headers missing");this._assertRequestHasHeaders(e),this._responseTime=this.now(),this._isShared=!1!==s,this._ignoreCargoCult=!!i,this._cacheHeuristic=void 0!==r?r:.1,this._immutableMinTtl=void 0!==n?n:864e5,this._status="status"in t?t.status:200,this._resHeaders=t.headers,this._rescc=a(t.headers["cache-control"]),this._method="method"in e?e.method:"GET",this._url=e.url,this._host=e.headers.host,this._noAuthorization=!e.headers.authorization,this._reqHeaders=t.headers.vary?e.headers:null,this._reqcc=a(e.headers["cache-control"]),this._ignoreCargoCult&&"pre-check"in this._rescc&&"post-check"in this._rescc&&(delete this._rescc["pre-check"],delete this._rescc["post-check"],delete this._rescc["no-cache"],delete this._rescc["no-store"],delete this._rescc["must-revalidate"],this._resHeaders=Object.assign({},this._resHeaders,{"cache-control":function(e){let t=[];for(let s in e){let r=e[s];t.push(!0===r?s:s+"="+r)}if(t.length)return t.join(", ")}(this._rescc)}),delete this._resHeaders.expires,delete this._resHeaders.pragma),null==t.headers["cache-control"]&&/no-cache/.test(t.headers.pragma)&&(this._rescc["no-cache"]=!0)}now(){return Date.now()}storable(){return!!(!this._reqcc["no-store"]&&("GET"===this._method||"HEAD"===this._method||"POST"===this._method&&this._hasExplicitExpiration())&&s.has(this._status)&&!this._rescc["no-store"]&&(!this._isShared||!this._rescc.private)&&(!this._isShared||this._noAuthorization||this._allowsStoringAuthenticated())&&(this._resHeaders.expires||this._rescc["max-age"]||this._isShared&&this._rescc["s-maxage"]||this._rescc.public||t.has(this._status)))}_hasExplicitExpiration(){return!!(this._isShared&&this._rescc["s-maxage"]||this._rescc["max-age"]||this._resHeaders.expires)}_assertRequestHasHeaders(e){if(!e||!e.headers)throw Error("Request headers missing")}satisfiesWithoutRevalidation(e){return!this.evaluateRequest(e).revalidation}_evaluateRequestHitResult(e){return{response:{headers:this.responseHeaders()},revalidation:e}}_evaluateRequestRevalidation(e,t){return{synchronous:t,headers:this.revalidationHeaders(e)}}_evaluateRequestMissResult(e){return{response:void 0,revalidation:this._evaluateRequestRevalidation(e,!0)}}evaluateRequest(e){if(this._assertRequestHasHeaders(e),this._rescc["must-revalidate"]||!this._requestMatches(e,!1))return this._evaluateRequestMissResult(e);let t=a(e.headers["cache-control"]);return t["no-cache"]||/no-cache/.test(e.headers.pragma)||t["max-age"]&&this.age()>o(t["max-age"])||t["min-fresh"]&&this.maxAge()-this.age()<o(t["min-fresh"])?this._evaluateRequestMissResult(e):this.stale()?"max-stale"in t&&(!0===t["max-stale"]||t["max-stale"]>this.age()-this.maxAge())?this._evaluateRequestHitResult(void 0):this.useStaleWhileRevalidate()?this._evaluateRequestHitResult(this._evaluateRequestRevalidation(e,!1)):this._evaluateRequestMissResult(e):this._evaluateRequestHitResult(void 0)}_requestMatches(e,t){return!!((!this._url||this._url===e.url)&&this._host===e.headers.host&&(!e.method||this._method===e.method||t&&"HEAD"===e.method)&&this._varyMatches(e))}_allowsStoringAuthenticated(){return!!(this._rescc["must-revalidate"]||this._rescc.public||this._rescc["s-maxage"])}_varyMatches(e){if(!this._resHeaders.vary)return!0;if("*"===this._resHeaders.vary)return!1;for(let t of this._resHeaders.vary.trim().toLowerCase().split(/\s*,\s*/))if(e.headers[t]!==this._reqHeaders[t])return!1;return!0}_copyWithoutHopByHopHeaders(e){let t={};for(let s in e)n[s]||(t[s]=e[s]);if(e.connection)for(let s of e.connection.trim().split(/\s*,\s*/))delete t[s];if(t.warning){let e=t.warning.split(/,/).filter(e=>!/^\s*1[0-9][0-9]/.test(e));e.length?t.warning=e.join(",").trim():delete t.warning}return t}responseHeaders(){let e=this._copyWithoutHopByHopHeaders(this._resHeaders),t=this.age();return t>86400&&!this._hasExplicitExpiration()&&this.maxAge()>86400&&(e.warning=(e.warning?`${e.warning}, `:"")+'113 - "rfc7234 5.5.4"'),e.age=`${Math.round(t)}`,e.date=new Date(this.now()).toUTCString(),e}date(){let e=Date.parse(this._resHeaders.date);return isFinite(e)?e:this._responseTime}age(){return this._ageValue()+(this.now()-this._responseTime)/1e3}_ageValue(){return o(this._resHeaders.age)}maxAge(){if(!this.storable()||this._rescc["no-cache"]||this._isShared&&this._resHeaders["set-cookie"]&&!this._rescc.public&&!this._rescc.immutable||"*"===this._resHeaders.vary)return 0;if(this._isShared){if(this._rescc["proxy-revalidate"])return 0;if(this._rescc["s-maxage"])return o(this._rescc["s-maxage"])}if(this._rescc["max-age"])return o(this._rescc["max-age"]);let e=this._rescc.immutable?this._immutableMinTtl:0,t=this.date();if(this._resHeaders.expires){let s=Date.parse(this._resHeaders.expires);return Number.isNaN(s)||s<t?0:Math.max(e,(s-t)/1e3)}if(this._resHeaders["last-modified"]){let s=Date.parse(this._resHeaders["last-modified"]);if(isFinite(s)&&t>s)return Math.max(e,(t-s)/1e3*this._cacheHeuristic)}return e}timeToLive(){let e=this.maxAge()-this.age(),t=e+o(this._rescc["stale-if-error"]),s=e+o(this._rescc["stale-while-revalidate"]);return Math.round(1e3*Math.max(0,e,t,s))}stale(){return this.maxAge()<=this.age()}_useStaleIfError(){return this.maxAge()+o(this._rescc["stale-if-error"])>this.age()}useStaleWhileRevalidate(){let e=o(this._rescc["stale-while-revalidate"]);return e>0&&this.maxAge()+e>this.age()}static fromObject(e){return new this(void 0,void 0,{_fromObject:e})}_fromObject(e){if(this._responseTime)throw Error("Reinitialized");if(!e||1!==e.v)throw Error("Invalid serialization");this._responseTime=e.t,this._isShared=e.sh,this._cacheHeuristic=e.ch,this._immutableMinTtl=void 0!==e.imm?e.imm:864e5,this._ignoreCargoCult=!!e.icc,this._status=e.st,this._resHeaders=e.resh,this._rescc=e.rescc,this._method=e.m,this._url=e.u,this._host=e.h,this._noAuthorization=e.a,this._reqHeaders=e.reqh,this._reqcc=e.reqcc}toObject(){return{v:1,t:this._responseTime,sh:this._isShared,ch:this._cacheHeuristic,imm:this._immutableMinTtl,icc:this._ignoreCargoCult,st:this._status,resh:this._resHeaders,rescc:this._rescc,m:this._method,u:this._url,h:this._host,a:this._noAuthorization,reqh:this._reqHeaders,reqcc:this._reqcc}}revalidationHeaders(e){this._assertRequestHasHeaders(e);let t=this._copyWithoutHopByHopHeaders(e.headers);if(delete t["if-range"],!this._requestMatches(e,!0)||!this.storable())return delete t["if-none-match"],delete t["if-modified-since"],t;if(this._resHeaders.etag&&(t["if-none-match"]=t["if-none-match"]?`${t["if-none-match"]}, ${this._resHeaders.etag}`:this._resHeaders.etag),t["accept-ranges"]||t["if-match"]||t["if-unmodified-since"]||this._method&&"GET"!=this._method){if(delete t["if-modified-since"],t["if-none-match"]){let e=t["if-none-match"].split(/,/).filter(e=>!/^\s*W\//.test(e));e.length?t["if-none-match"]=e.join(",").trim():delete t["if-none-match"]}}else this._resHeaders["last-modified"]&&!t["if-modified-since"]&&(t["if-modified-since"]=this._resHeaders["last-modified"]);return t}revalidatedPolicy(e,t){if(this._assertRequestHasHeaders(e),this._useStaleIfError()&&(!t||r.has(t.status)))return{policy:this,modified:!1,matches:!0};if(!t||!t.headers)throw Error("Response headers missing");let s=!1;void 0!==t.status&&304!=t.status?s=!1:t.headers.etag&&!/^\s*W\//.test(t.headers.etag)?s=this._resHeaders.etag&&this._resHeaders.etag.replace(/^\s*W\//,"")===t.headers.etag:this._resHeaders.etag&&t.headers.etag?s=this._resHeaders.etag.replace(/^\s*W\//,"")===t.headers.etag.replace(/^\s*W\//,""):this._resHeaders["last-modified"]?s=this._resHeaders["last-modified"]===t.headers["last-modified"]:this._resHeaders.etag||this._resHeaders["last-modified"]||t.headers.etag||t.headers["last-modified"]||(s=!0);let n={shared:this._isShared,cacheHeuristic:this._cacheHeuristic,immutableMinTimeToLive:this._immutableMinTtl,ignoreCargoCult:this._ignoreCargoCult};if(!s)return{policy:new this.constructor(e,t,n),modified:304!=t.status,matches:!1};let o={};for(let e in this._resHeaders)o[e]=e in t.headers&&!i[e]?t.headers[e]:this._resHeaders[e];let a=Object.assign({},t,{status:this._status,method:this._method,headers:o});return{policy:new this.constructor(e,a,n),modified:!1,matches:!0}}}},54847:(e,t,s)=>{"use strict";let r=s(17702),n=s(82452),i=s(32694),o=s(95297),a=Symbol("currentStreamsCount"),l=Symbol("request"),c=Symbol("cachedOriginSet"),h=Symbol("gracefullyClosing"),u=["maxDeflateDynamicTableSize","maxSessionMemory","maxHeaderListPairs","maxOutstandingPings","maxReservedRemoteStreams","maxSendHeaderBlockLength","paddingStrategy","localAddress","path","rejectUnauthorized","minDHSize","ca","cert","clientCertEngine","ciphers","key","pfx","servername","minVersion","maxVersion","secureProtocol","crl","honorCipherOrder","ecdhCurve","dhparam","secureOptions","sessionIdContext"],d=(e,t,s)=>{let r=0,n=e.length;for(;r<n;){let i=r+n>>>1;s(e[i],t)?r=i+1:n=i}return r},f=(e,t)=>e.remoteSettings.maxConcurrentStreams>t.remoteSettings.maxConcurrentStreams,p=(e,t)=>{for(let s of e)s[c].length<t[c].length&&s[c].every(e=>t[c].includes(e))&&s[a]+t[a]<=t.remoteSettings.maxConcurrentStreams&&y(s)},g=(e,t)=>{for(let s of e)t[c].length<s[c].length&&t[c].every(e=>s[c].includes(e))&&t[a]+s[a]<=s.remoteSettings.maxConcurrentStreams&&y(t)},m=({agent:e,isFree:t})=>{let s={};for(let r in e.sessions){let n=e.sessions[r].filter(e=>{let s=e[b.kCurrentStreamsCount]<e.remoteSettings.maxConcurrentStreams;return t?s:!s});0!==n.length&&(s[r]=n)}return s},y=e=>{e[h]=!0,0===e[a]&&e.close()};class b extends r{constructor({timeout:e=6e4,maxSessions:t=1/0,maxFreeSessions:s=10,maxCachedTlsSessions:r=100}={}){super(),this.sessions={},this.queue={},this.timeout=e,this.maxSessions=t,this.maxFreeSessions=s,this._freeSessionsCount=0,this._sessionsCount=0,this.settings={enablePush:!1},this.tlsSessionCache=new o({maxSize:r})}static normalizeOrigin(e,t){return"string"==typeof e&&(e=new URL(e)),t&&e.hostname!==t&&(e.hostname=t),e.origin}normalizeOptions(e){let t="";if(e)for(let s of u)e[s]&&(t+=`:${e[s]}`);return t}_tryToCreateNewSession(e,t){if(!(e in this.queue)||!(t in this.queue[e]))return;let s=this.queue[e][t];this._sessionsCount<this.maxSessions&&!s.completed&&(s.completed=!0,s())}getSession(e,t,s){return new Promise((r,n)=>{Array.isArray(s)?(s=[...s],r()):s=[{resolve:r,reject:n}];let o=this.normalizeOptions(t),u=b.normalizeOrigin(e,t&&t.servername);if(void 0===u){for(let{reject:e}of s)e(TypeError("The `origin` argument needs to be a string or an URL object"));return}if(o in this.sessions){let e;let t=this.sessions[o],r=-1,n=-1;for(let s of t){let t=s.remoteSettings.maxConcurrentStreams;if(t<r)break;if(s[c].includes(u)){let i=s[a];if(i>=t||s[h]||s.destroyed)continue;e||(r=t),i>n&&(e=s,n=i)}}if(e){if(1!==s.length){for(let{reject:e}of s)e(Error(`Expected the length of listeners to be 1, got ${s.length}.
Please report this to https://github.com/szmarczak/http2-wrapper/`));return}s[0].resolve(e);return}}if(o in this.queue){if(u in this.queue[o]){this.queue[o][u].listeners.push(...s),this._tryToCreateNewSession(o,u);return}}else this.queue[o]={};let m=()=>{o in this.queue&&this.queue[o][u]===y&&(delete this.queue[o][u],0===Object.keys(this.queue[o]).length&&delete this.queue[o])},y=()=>{let r=`${u}:${o}`,n=!1;try{let b=i.connect(e,{createConnection:this.createConnection,settings:this.settings,session:this.tlsSessionCache.get(r),...t});b[a]=0,b[h]=!1;let _=()=>b[a]<b.remoteSettings.maxConcurrentStreams,v=!0;b.socket.once("session",e=>{this.tlsSessionCache.set(r,e)}),b.once("error",e=>{for(let{reject:t}of s)t(e);this.tlsSessionCache.delete(r)}),b.setTimeout(this.timeout,()=>{b.destroy()}),b.once("close",()=>{if(n){v&&this._freeSessionsCount--,this._sessionsCount--;let e=this.sessions[o];e.splice(e.indexOf(b),1),0===e.length&&delete this.sessions[o]}else{let e=Error("Session closed without receiving a SETTINGS frame");for(let{reject:t}of(e.code="HTTP2WRAPPER_NOSETTINGS",s))t(e);m()}this._tryToCreateNewSession(o,u)});let w=()=>{if(o in this.queue&&_()){for(let e of b[c])if(e in this.queue[o]){let{listeners:t}=this.queue[o][e];for(;0!==t.length&&_();)t.shift().resolve(b);let s=this.queue[o];if(0===s[e].listeners.length&&(delete s[e],0===Object.keys(s).length)){delete this.queue[o];break}if(!_())break}}};b.on("origin",()=>{b[c]=b.originSet,_()&&(w(),p(this.sessions[o],b))}),b.once("remoteSettings",()=>{if(b.ref(),b.unref(),this._sessionsCount++,y.destroyed){let e=Error("Agent has been destroyed");for(let t of s)t.reject(e);b.destroy();return}b[c]=b.originSet;{let e=this.sessions;if(o in e){let t=e[o];t.splice(d(t,b,f),0,b)}else e[o]=[b]}this._freeSessionsCount+=1,n=!0,this.emit("session",b),w(),m(),0===b[a]&&this._freeSessionsCount>this.maxFreeSessions&&b.close(),0!==s.length&&(this.getSession(u,t,s),s.length=0),b.on("remoteSettings",()=>{w(),p(this.sessions[o],b)})}),b[l]=b.request,b.request=(e,t)=>{if(b[h])throw Error("The session is gracefully closing. No new streams are allowed.");let s=b[l](e,t);return b.ref(),++b[a],b[a]===b.remoteSettings.maxConcurrentStreams&&this._freeSessionsCount--,s.once("close",()=>{if(v=_(),--b[a],!b.destroyed&&!b.closed&&(g(this.sessions[o],b),_()&&!b.closed)){v||(this._freeSessionsCount++,v=!0);let e=0===b[a];e&&b.unref(),e&&(this._freeSessionsCount>this.maxFreeSessions||b[h])?b.close():(p(this.sessions[o],b),w())}}),s}}catch(e){for(let t of s)t.reject(e);m()}};y.listeners=s,y.completed=!1,y.destroyed=!1,this.queue[o][u]=y,this._tryToCreateNewSession(o,u)})}request(e,t,s,r){return new Promise((n,i)=>{this.getSession(e,t,[{reject:i,resolve:e=>{try{n(e.request(s,r))}catch(e){i(e)}}}])})}createConnection(e,t){return b.connect(e,t)}static connect(e,t){t.ALPNProtocols=["h2"];let s=e.port||443,r=e.hostname||e.host;return void 0===t.servername&&(t.servername=r),n.connect(s,r,t)}closeFreeSessions(){for(let e of Object.values(this.sessions))for(let t of e)0===t[a]&&t.close()}destroy(e){for(let t of Object.values(this.sessions))for(let s of t)s.destroy(e);for(let e of Object.values(this.queue))for(let t of Object.values(e))t.destroyed=!0;this.queue={}}get freeSessions(){return m({agent:this,isFree:!0})}get busySessions(){return m({agent:this,isFree:!1})}}b.kCurrentStreamsCount=a,b.kGracefullyClosing=h,e.exports={Agent:b,globalAgent:new b}},11781:(e,t,s)=>{"use strict";let r=s(32615),n=s(35240),i=s(58166),o=s(95297),a=s(97605),l=s(82739),c=s(82602),h=new o({maxSize:100}),u=new Map,d=(e,t,s)=>{t._httpMessage={shouldKeepAlive:!0};let r=()=>{e.emit("free",t,s)};t.on("free",r);let n=()=>{e.removeSocket(t,s)};t.on("close",n);let i=()=>{e.removeSocket(t,s),t.off("close",n),t.off("free",r),t.off("agentRemove",i)};t.on("agentRemove",i),e.emit("free",t,s)},f=async e=>{let t=`${e.host}:${e.port}:${e.ALPNProtocols.sort()}`;if(!h.has(t)){if(u.has(t))return(await u.get(t)).alpnProtocol;let{path:s,agent:r}=e;e.path=e.socketPath;let o=i(e);u.set(t,o);try{let{socket:i,alpnProtocol:a}=await o;if(h.set(t,a),e.path=s,"h2"===a)i.destroy();else{let{globalAgent:t}=n,s=n.Agent.prototype.createConnection;r?r.createConnection===s?d(r,i,e):i.destroy():t.createConnection===s?d(t,i,e):i.destroy()}return u.delete(t),a}catch(e){throw u.delete(t),e}}return h.get(t)};e.exports=async(e,t,s)=>{if(("string"==typeof e||e instanceof URL)&&(e=c(new URL(e))),"function"==typeof t&&(s=t,t=void 0),!Array.isArray((t={ALPNProtocols:["h2","http/1.1"],...e,...t,resolveSocket:!0}).ALPNProtocols)||0===t.ALPNProtocols.length)throw Error("The `ALPNProtocols` option must be an Array with at least one entry");t.protocol=t.protocol||"https:";let i="https:"===t.protocol;t.host=t.hostname||t.host||"localhost",t.session=t.tlsSession,t.servername=t.servername||l(t),t.port=t.port||(i?443:80),t._defaultAgent=i?n.globalAgent:r.globalAgent;let o=t.agent;if(o){if(o.addRequest)throw Error("The `options.agent` object can contain only `http`, `https` or `http2` properties");t.agent=o[i?"https":"http"]}return i&&"h2"===await f(t)?(o&&(t.agent=o.http2),new a(t,s)):r.request(t,s)},e.exports.protocolCache=h},97605:(e,t,s)=>{"use strict";let r=s(32694),{Writable:n}=s(76162),{Agent:i,globalAgent:o}=s(54847),a=s(64368),l=s(82602),c=s(32746),h=s(92667),{ERR_INVALID_ARG_TYPE:u,ERR_INVALID_PROTOCOL:d,ERR_HTTP_HEADERS_SENT:f,ERR_INVALID_HTTP_TOKEN:p,ERR_HTTP_INVALID_HEADER_VALUE:g,ERR_INVALID_CHAR:m}=s(86251),{HTTP2_HEADER_STATUS:y,HTTP2_HEADER_METHOD:b,HTTP2_HEADER_PATH:_,HTTP2_METHOD_CONNECT:v}=r.constants,w=Symbol("headers"),S=Symbol("origin"),O=Symbol("session"),E=Symbol("options"),k=Symbol("flushedHeaders"),C=Symbol("jobs"),R=/^[\^`\-\w!#$%&*+.|~]+$/,T=/[^\t\u0020-\u007E\u0080-\u00FF]/;class A extends n{constructor(e,t,s){super({autoDestroy:!1});let r="string"==typeof e||e instanceof URL;if(r&&(e=l(e instanceof URL?e:new URL(e))),"function"==typeof t||void 0===t?(s=t,t=r?e:{...e}):t={...e,...t},t.h2session)this[O]=t.h2session;else if(!1===t.agent)this.agent=new i({maxFreeSessions:0});else if(void 0===t.agent||null===t.agent)"function"==typeof t.createConnection?(this.agent=new i({maxFreeSessions:0}),this.agent.createConnection=t.createConnection):this.agent=o;else if("function"==typeof t.agent.request)this.agent=t.agent;else throw new u("options.agent",["Agent-like Object","undefined","false"],t.agent);if(t.protocol&&"https:"!==t.protocol)throw new d(t.protocol,"https:");let n=t.port||t.defaultPort||this.agent&&this.agent.defaultPort||443,a=t.hostname||t.host||"localhost";delete t.hostname,delete t.host,delete t.port;let{timeout:c}=t;if(t.timeout=void 0,this[w]=Object.create(null),this[C]=[],this.socket=null,this.connection=null,this.method=t.method||"GET",this.path=t.path,this.res=null,this.aborted=!1,this.reusedSocket=!1,t.headers)for(let[e,s]of Object.entries(t.headers))this.setHeader(e,s);!t.auth||"authorization"in this[w]||(this[w].authorization="Basic "+Buffer.from(t.auth).toString("base64")),t.session=t.tlsSession,t.path=t.socketPath,this[E]=t,443===n?(this[S]=`https://${a}`,":authority"in this[w]||(this[w][":authority"]=a)):(this[S]=`https://${a}:${n}`,":authority"in this[w]||(this[w][":authority"]=`${a}:${n}`)),c&&this.setTimeout(c),s&&this.once("response",s),this[k]=!1}get method(){return this[w][b]}set method(e){e&&(this[w][b]=e.toUpperCase())}get path(){return this[w][_]}set path(e){e&&(this[w][_]=e)}get _mustNotHaveABody(){return"GET"===this.method||"HEAD"===this.method||"DELETE"===this.method}_write(e,t,s){if(this._mustNotHaveABody){s(Error("The GET, HEAD and DELETE methods must NOT have a body"));return}this.flushHeaders();let r=()=>this._request.write(e,t,s);this._request?r():this[C].push(r)}_final(e){if(this.destroyed)return;this.flushHeaders();let t=()=>{if(this._mustNotHaveABody){e();return}this._request.end(e)};this._request?t():this[C].push(t)}abort(){this.res&&this.res.complete||(this.aborted||process.nextTick(()=>this.emit("abort")),this.aborted=!0,this.destroy())}_destroy(e,t){this.res&&this.res._dump(),this._request&&this._request.destroy(),t(e)}async flushHeaders(){if(this[k]||this.destroyed)return;this[k]=!0;let e=this.method===v,t=t=>{if(this._request=t,this.destroyed){t.destroy();return}e||c(t,this,["timeout","continue","close","error"]);let s=e=>(...t)=>{this.writable||this.destroyed?this.once("finish",()=>{e(...t)}):e(...t)};t.once("response",s((s,r,n)=>{let i=new a(this.socket,t.readableHighWaterMark);this.res=i,i.req=this,i.statusCode=s[y],i.headers=s,i.rawHeaders=n,i.once("end",()=>{this.aborted?(i.aborted=!0,i.emit("aborted")):(i.complete=!0,i.socket=null,i.connection=null)}),e?(i.upgrade=!0,this.emit("connect",i,t,Buffer.alloc(0))?this.emit("close"):t.destroy()):(t.on("data",e=>{i._dumped||i.push(e)||t.pause()}),t.once("end",()=>{i.push(null)}),this.emit("response",i)||i._dump())})),t.once("headers",s(e=>this.emit("information",{statusCode:e[y]}))),t.once("trailers",s((e,t,s)=>{let{res:r}=this;r.trailers=e,r.rawTrailers=s}));let{socket:r}=t.session;for(let e of(this.socket=r,this.connection=r,this[C]))e();this.emit("socket",this.socket)};if(this[O])try{t(this[O].request(this[w]))}catch(e){this.emit("error",e)}else{this.reusedSocket=!0;try{t(await this.agent.request(this[S],this[E],this[w]))}catch(e){this.emit("error",e)}}}getHeader(e){if("string"!=typeof e)throw new u("name","string",e);return this[w][e.toLowerCase()]}get headersSent(){return this[k]}removeHeader(e){if("string"!=typeof e)throw new u("name","string",e);if(this.headersSent)throw new f("remove");delete this[w][e.toLowerCase()]}setHeader(e,t){if(this.headersSent)throw new f("set");if("string"!=typeof e||!R.test(e)&&!h(e))throw new p("Header name",e);if(void 0===t)throw new g(t,e);if(T.test(t))throw new m("header content",e);this[w][e.toLowerCase()]=t}setNoDelay(){}setSocketKeepAlive(){}setTimeout(e,t){let s=()=>this._request.setTimeout(e,t);return this._request?s():this[C].push(s),this}get maxHeadersCount(){if(!this.destroyed&&this._request)return this._request.session.localSettings.maxHeaderListSize}set maxHeadersCount(e){}}e.exports=A},64368:(e,t,s)=>{"use strict";let{Readable:r}=s(76162);class n extends r{constructor(e,t){super({highWaterMark:t,autoDestroy:!1}),this.statusCode=null,this.statusMessage="",this.httpVersion="2.0",this.httpVersionMajor=2,this.httpVersionMinor=0,this.headers={},this.trailers={},this.req=null,this.aborted=!1,this.complete=!1,this.upgrade=null,this.rawHeaders=[],this.rawTrailers=[],this.socket=e,this.connection=e,this._dumped=!1}_destroy(e){this.req._request.destroy(e)}setTimeout(e,t){return this.req.setTimeout(e,t),this}_dump(){this._dumped||(this._dumped=!0,this.removeAllListeners("data"),this.resume())}_read(){this.req&&this.req._request.resume()}}e.exports=n},73145:(e,t,s)=>{"use strict";let r=s(32694),n=s(54847),i=s(97605),o=s(64368),a=s(11781);e.exports={...r,ClientRequest:i,IncomingMessage:o,...n,request:(e,t,s)=>new i(e,t,s),get:(e,t,s)=>{let r=new i(e,t,s);return r.end(),r},auto:a}},82739:(e,t,s)=>{"use strict";let r=s(98216);e.exports=e=>{let t=e.host,s=e.headers&&e.headers.host;return(s&&(t=s.startsWith("[")?-1===s.indexOf("]")?s:s.slice(1,-1):s.split(":",1)[0]),r.isIP(t))?"":t}},86251:e=>{"use strict";let t=(t,s,r)=>{e.exports[s]=class extends t{constructor(...e){super("string"==typeof r?r:r(e)),this.name=`${super.name} [${s}]`,this.code=s}}};t(TypeError,"ERR_INVALID_ARG_TYPE",e=>{let t=e[0].includes(".")?"property":"argument",s=e[1],r=Array.isArray(s);return r&&(s=`${s.slice(0,-1).join(", ")} or ${s.slice(-1)}`),`The "${e[0]}" ${t} must be ${r?"one of":"of"} type ${s}. Received ${typeof e[2]}`}),t(TypeError,"ERR_INVALID_PROTOCOL",e=>`Protocol "${e[0]}" not supported. Expected "${e[1]}"`),t(Error,"ERR_HTTP_HEADERS_SENT",e=>`Cannot ${e[0]} headers after they are sent to the client`),t(TypeError,"ERR_INVALID_HTTP_TOKEN",e=>`${e[0]} must be a valid HTTP token [${e[1]}]`),t(TypeError,"ERR_HTTP_INVALID_HEADER_VALUE",e=>`Invalid value "${e[0]} for header "${e[1]}"`),t(TypeError,"ERR_INVALID_CHAR",e=>`Invalid character in ${e[0]} [${e[1]}]`)},92667:e=>{"use strict";e.exports=e=>{switch(e){case":method":case":scheme":case":authority":case":path":return!0;default:return!1}}},32746:e=>{"use strict";e.exports=(e,t,s)=>{for(let r of s)e.on(r,(...e)=>t.emit(r,...e))}},82602:e=>{"use strict";e.exports=e=>{let t={protocol:e.protocol,hostname:"string"==typeof e.hostname&&e.hostname.startsWith("[")?e.hostname.slice(1,-1):e.hostname,host:e.host,hash:e.hash,search:e.search,pathname:e.pathname,href:e.href,path:`${e.pathname||""}${e.search||""}`};return"string"==typeof e.port&&0!==e.port.length&&(t.port=Number(e.port)),(e.username||e.password)&&(t.auth=`${e.username||""}:${e.password||""}`),t}},88421:(e,t)=>{t.stringify=function e(t){if(void 0===t)return t;if(t&&Buffer.isBuffer(t))return JSON.stringify(":base64:"+t.toString("base64"));if(t&&t.toJSON&&(t=t.toJSON()),t&&"object"==typeof t){var s="",r=Array.isArray(t);s=r?"[":"{";var n=!0;for(var i in t){var o="function"==typeof t[i]||!r&&void 0===t[i];Object.hasOwnProperty.call(t,i)&&!o&&(n||(s+=","),n=!1,r?void 0==t[i]?s+="null":s+=e(t[i]):void 0!==t[i]&&(s+=e(i)+":"+e(t[i])))}return s+(r?"]":"}")}return"string"==typeof t?JSON.stringify(/^:/.test(t)?":"+t:t):void 0===t?"null":JSON.stringify(t)},t.parse=function(e){return JSON.parse(e,function(e,t){return"string"==typeof t?/^:base64:/.test(t)?Buffer.from(t.substring(8),"base64"):/^:/.test(t)?t.substring(1):t:t})}},90944:(e,t,s)=>{"use strict";let r=s(17702),n=s(88421),i=e=>{if(e.adapter||e.uri){let t=e.adapter||/^[^:+]*/.exec(e.uri)[0];return new(s(33899)({redis:"@keyv/redis",rediss:"@keyv/redis",mongodb:"@keyv/mongo",mongo:"@keyv/mongo",sqlite:"@keyv/sqlite",postgresql:"@keyv/postgres",postgres:"@keyv/postgres",mysql:"@keyv/mysql",etcd:"@keyv/etcd",offline:"@keyv/offline",tiered:"@keyv/tiered"}[t]))(e)}return new Map},o=["sqlite","postgres","mysql","mongo","redis","tiered"];class a extends r{constructor(e,{emitErrors:t=!0,...s}={}){if(super(),this.opts={namespace:"keyv",serialize:n.stringify,deserialize:n.parse,..."string"==typeof e?{uri:e}:e,...s},!this.opts.store){let e={...this.opts};this.opts.store=i(e)}if(this.opts.compression){let e=this.opts.compression;this.opts.serialize=e.serialize.bind(e),this.opts.deserialize=e.deserialize.bind(e)}"function"==typeof this.opts.store.on&&t&&this.opts.store.on("error",e=>this.emit("error",e)),this.opts.store.namespace=this.opts.namespace;let r=e=>async function*(){for await(let[t,s]of"function"==typeof e?e(this.opts.store.namespace):e){let e=await this.opts.deserialize(s);if(!this.opts.store.namespace||t.includes(this.opts.store.namespace)){if("number"==typeof e.expires&&Date.now()>e.expires){this.delete(t);continue}yield[this._getKeyUnprefix(t),e.value]}}};"function"==typeof this.opts.store[Symbol.iterator]&&this.opts.store instanceof Map?this.iterator=r(this.opts.store):"function"==typeof this.opts.store.iterator&&this.opts.store.opts&&this._checkIterableAdaptar()&&(this.iterator=r(this.opts.store.iterator.bind(this.opts.store)))}_checkIterableAdaptar(){return o.includes(this.opts.store.opts.dialect)||o.findIndex(e=>this.opts.store.opts.url.includes(e))>=0}_getKeyPrefix(e){return`${this.opts.namespace}:${e}`}_getKeyPrefixArray(e){return e.map(e=>`${this.opts.namespace}:${e}`)}_getKeyUnprefix(e){return e.split(":").splice(1).join(":")}get(e,t){let{store:s}=this.opts,r=Array.isArray(e),n=r?this._getKeyPrefixArray(e):this._getKeyPrefix(e);if(r&&void 0===s.getMany){let e=[];for(let r of n)e.push(Promise.resolve().then(()=>s.get(r)).then(e=>"string"==typeof e?this.opts.deserialize(e):this.opts.compression?this.opts.deserialize(e):e).then(e=>null==e?void 0:"number"==typeof e.expires&&Date.now()>e.expires?this.delete(r).then(()=>void 0):t&&t.raw?e:e.value));return Promise.allSettled(e).then(e=>{let t=[];for(let s of e)t.push(s.value);return t})}return Promise.resolve().then(()=>r?s.getMany(n):s.get(n)).then(e=>"string"==typeof e?this.opts.deserialize(e):this.opts.compression?this.opts.deserialize(e):e).then(s=>null==s?void 0:r?s.map((s,r)=>{if("string"==typeof s&&(s=this.opts.deserialize(s)),null!=s){if("number"==typeof s.expires&&Date.now()>s.expires){this.delete(e[r]).then(()=>void 0);return}return t&&t.raw?s:s.value}}):"number"==typeof s.expires&&Date.now()>s.expires?this.delete(e).then(()=>void 0):t&&t.raw?s:s.value)}set(e,t,s){let r=this._getKeyPrefix(e);void 0===s&&(s=this.opts.ttl),0===s&&(s=void 0);let{store:n}=this.opts;return Promise.resolve().then(()=>{let e="number"==typeof s?Date.now()+s:null;return"symbol"==typeof t&&this.emit("error","symbol cannot be serialized"),t={value:t,expires:e},this.opts.serialize(t)}).then(e=>n.set(r,e,s)).then(()=>!0)}delete(e){let{store:t}=this.opts;if(Array.isArray(e)){let s=this._getKeyPrefixArray(e);if(void 0===t.deleteMany){let e=[];for(let r of s)e.push(t.delete(r));return Promise.allSettled(e).then(e=>e.every(e=>!0===e.value))}return Promise.resolve().then(()=>t.deleteMany(s))}let s=this._getKeyPrefix(e);return Promise.resolve().then(()=>t.delete(s))}clear(){let{store:e}=this.opts;return Promise.resolve().then(()=>e.clear())}has(e){let t=this._getKeyPrefix(e),{store:s}=this.opts;return Promise.resolve().then(async()=>"function"==typeof s.has?s.has(t):void 0!==await s.get(t))}disconnect(){let{store:e}=this.opts;if("function"==typeof e.disconnect)return e.disconnect()}}e.exports=a},81332:e=>{"use strict";e.exports=e=>{let t={};for(let[s,r]of Object.entries(e))t[s.toLowerCase()]=r;return t}},58680:e=>{"use strict";let t=["destroy","setTimeout","socket","headers","trailers","rawHeaders","statusCode","httpVersion","httpVersionMinor","httpVersionMajor","rawTrailers","statusMessage"];e.exports=(e,s)=>{for(let r of new Set(Object.keys(e).concat(t)))r in s||(s[r]="function"==typeof e[r]?e[r].bind(e):e[r])}},92880:e=>{"use strict";let t=["aborted","complete","headers","httpVersion","httpVersionMinor","httpVersionMajor","method","rawHeaders","rawTrailers","setTimeout","socket","statusCode","statusMessage","trailers","url"];e.exports=(e,s)=>{if(s._readableState.autoDestroy)throw Error("The second stream must have the `autoDestroy` option set to `false`");let r=new Set(Object.keys(e).concat(t)),n={};for(let t of r)t in s||(n[t]={get(){let s=e[t];return"function"==typeof s?s.bind(e):s},set(s){e[t]=s},enumerable:!0,configurable:!1});return Object.defineProperties(s,n),e.once("aborted",()=>{s.destroy(),s.emit("aborted")}),e.once("close",()=>{e.complete&&s.readable?s.once("end",()=>{s.emit("close")}):s.emit("close")}),s}},12085:(e,t,s)=>{"use strict";e.exports=s(30517)},18740:e=>{"use strict";let t=(e,t)=>t.some(t=>t instanceof RegExp?t.test(e):t===e),s=(e,{stripHash:t})=>{let s=/^data:(?<type>[^,]*?),(?<data>[^#]*?)(?:#(?<hash>.*))?$/.exec(e);if(!s)throw Error(`Invalid URL: ${e}`);let{type:r,data:n,hash:i}=s.groups,o=r.split(";");i=t?"":i;let a=!1;"base64"===o[o.length-1]&&(o.pop(),a=!0);let l=(o.shift()||"").toLowerCase(),c=[...o.map(e=>{let[t,s=""]=e.split("=").map(e=>e.trim());return"charset"===t&&"us-ascii"===(s=s.toLowerCase())?"":`${t}${s?`=${s}`:""}`}).filter(Boolean)];return a&&c.push("base64"),(0!==c.length||l&&"text/plain"!==l)&&c.unshift(l),`data:${c.join(";")},${a?n.trim():n}${i?`#${i}`:""}`};e.exports=(e,r)=>{if(r={defaultProtocol:"http:",normalizeProtocol:!0,forceHttp:!1,forceHttps:!1,stripAuthentication:!0,stripHash:!1,stripTextFragment:!0,stripWWW:!0,removeQueryParameters:[/^utm_\w+/i],removeTrailingSlash:!0,removeSingleSlash:!0,removeDirectoryIndex:!1,sortQueryParameters:!0,...r},e=e.trim(),/^data:/i.test(e))return s(e,r);if(/^view-source:/i.test(e))throw Error("`view-source:` is not supported as it is a non-standard protocol");let n=e.startsWith("//");!n&&/^\.*\//.test(e)||(e=e.replace(/^(?!(?:\w+:)?\/\/)|^\/\//,r.defaultProtocol));let i=new URL(e);if(r.forceHttp&&r.forceHttps)throw Error("The `forceHttp` and `forceHttps` options cannot be used together");if(r.forceHttp&&"https:"===i.protocol&&(i.protocol="http:"),r.forceHttps&&"http:"===i.protocol&&(i.protocol="https:"),r.stripAuthentication&&(i.username="",i.password=""),r.stripHash?i.hash="":r.stripTextFragment&&(i.hash=i.hash.replace(/#?:~:text.*?$/i,"")),i.pathname&&(i.pathname=i.pathname.replace(/(?<!\b(?:[a-z][a-z\d+\-.]{1,50}:))\/{2,}/g,"/")),i.pathname)try{i.pathname=decodeURI(i.pathname)}catch(e){}if(!0===r.removeDirectoryIndex&&(r.removeDirectoryIndex=[/^index\.[a-z]+$/]),Array.isArray(r.removeDirectoryIndex)&&r.removeDirectoryIndex.length>0){let e=i.pathname.split("/");t(e[e.length-1],r.removeDirectoryIndex)&&(e=e.slice(0,e.length-1),i.pathname=e.slice(1).join("/")+"/")}if(i.hostname&&(i.hostname=i.hostname.replace(/\.$/,""),r.stripWWW&&/^www\.(?!www\.)(?:[a-z\-\d]{1,63})\.(?:[a-z.\-\d]{2,63})$/.test(i.hostname)&&(i.hostname=i.hostname.replace(/^www\./,""))),Array.isArray(r.removeQueryParameters))for(let e of[...i.searchParams.keys()])t(e,r.removeQueryParameters)&&i.searchParams.delete(e);!0===r.removeQueryParameters&&(i.search=""),r.sortQueryParameters&&i.searchParams.sort(),r.removeTrailingSlash&&(i.pathname=i.pathname.replace(/\/$/,""));let o=e;return e=i.toString(),r.removeSingleSlash||"/"!==i.pathname||o.endsWith("/")||""!==i.hash||(e=e.replace(/\/$/,"")),(r.removeTrailingSlash||"/"===i.pathname)&&""===i.hash&&r.removeSingleSlash&&(e=e.replace(/\/$/,"")),n&&!r.normalizeProtocol&&(e=e.replace(/^http:\/\//,"//")),r.stripProtocol&&(e=e.replace(/^(?:https?:)?\/\//,"")),e}},48998:(e,t,s)=>{var r=s(66082);function n(e){var t=function(){return t.called?t.value:(t.called=!0,t.value=e.apply(this,arguments))};return t.called=!1,t}function i(e){var t=function(){if(t.called)throw Error(t.onceError);return t.called=!0,t.value=e.apply(this,arguments)},s=e.name||"Function wrapped with `once`";return t.onceError=s+" shouldn't be called more than once",t.called=!1,t}e.exports=r(n),e.exports.strict=r(i),n.proto=n(function(){Object.defineProperty(Function.prototype,"once",{value:function(){return n(this)},configurable:!0}),Object.defineProperty(Function.prototype,"onceStrict",{value:function(){return i(this)},configurable:!0})})},9911:e=>{"use strict";class t extends Error{constructor(e){super(e||"Promise was canceled"),this.name="CancelError"}get isCanceled(){return!0}}class s{static fn(e){return(...t)=>new s((s,r,n)=>{t.push(n),e(...t).then(s,r)})}constructor(e){this._cancelHandlers=[],this._isPending=!0,this._isCanceled=!1,this._rejectOnCancel=!0,this._promise=new Promise((t,s)=>{this._reject=s;let r=e=>{if(!this._isPending)throw Error("The `onCancel` handler was attached after the promise settled.");this._cancelHandlers.push(e)};return Object.defineProperties(r,{shouldReject:{get:()=>this._rejectOnCancel,set:e=>{this._rejectOnCancel=e}}}),e(e=>{this._isCanceled&&r.shouldReject||(this._isPending=!1,t(e))},e=>{this._isPending=!1,s(e)},r)})}then(e,t){return this._promise.then(e,t)}catch(e){return this._promise.catch(e)}finally(e){return this._promise.finally(e)}cancel(e){if(this._isPending&&!this._isCanceled){if(this._isCanceled=!0,this._cancelHandlers.length>0)try{for(let e of this._cancelHandlers)e()}catch(e){this._reject(e);return}this._rejectOnCancel&&this._reject(new t(e))}}get isCanceled(){return this._isCanceled}}Object.setPrototypeOf(s.prototype,Promise.prototype),e.exports=s,e.exports.CancelError=t},47345:(e,t,s)=>{var r,n=s(48998),i=s(52055);try{r=s(92048)}catch(e){}var o=function(){},a="undefined"!=typeof process&&/^v?\.0/.test(process.version),l=function(e){return"function"==typeof e},c=function(e,t,s,c){c=n(c);var h=!1;e.on("close",function(){h=!0}),i(e,{readable:t,writable:s},function(e){if(e)return c(e);h=!0,c()});var u=!1;return function(t){if(!h&&!u){if(u=!0,a&&r&&(e instanceof(r.ReadStream||o)||e instanceof(r.WriteStream||o))&&l(e.close))return e.close(o);if(e.setHeader&&l(e.abort))return e.abort();if(l(e.destroy))return e.destroy();c(t||Error("stream was destroyed"))}}},h=function(e){e()},u=function(e,t){return e.pipe(t)};e.exports=function(){var e,t=Array.prototype.slice.call(arguments),s=l(t[t.length-1]||o)&&t.pop()||o;if(Array.isArray(t[0])&&(t=t[0]),t.length<2)throw Error("pump requires two streams per minimum");var r=t.map(function(n,i){var o=i<t.length-1;return c(n,o,i>0,function(t){e||(e=t),t&&r.forEach(h),o||(r.forEach(h),s(e))})});return t.reduce(u)}},95297:e=>{"use strict";class t{constructor(e={}){if(!(e.maxSize&&e.maxSize>0))throw TypeError("`maxSize` must be a number greater than 0");this.maxSize=e.maxSize,this.onEviction=e.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_set(e,t){if(this.cache.set(e,t),this._size++,this._size>=this.maxSize){if(this._size=0,"function"==typeof this.onEviction)for(let[e,t]of this.oldCache.entries())this.onEviction(e,t);this.oldCache=this.cache,this.cache=new Map}}get(e){if(this.cache.has(e))return this.cache.get(e);if(this.oldCache.has(e)){let t=this.oldCache.get(e);return this.oldCache.delete(e),this._set(e,t),t}}set(e,t){return this.cache.has(e)?this.cache.set(e,t):this._set(e,t),this}has(e){return this.cache.has(e)||this.oldCache.has(e)}peek(e){return this.cache.has(e)?this.cache.get(e):this.oldCache.has(e)?this.oldCache.get(e):void 0}delete(e){let t=this.cache.delete(e);return t&&this._size--,this.oldCache.delete(e)||t}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}*keys(){for(let[e]of this)yield e}*values(){for(let[,e]of this)yield e}*[Symbol.iterator](){for(let e of this.cache)yield e;for(let e of this.oldCache){let[t]=e;this.cache.has(t)||(yield e)}}get size(){let e=0;for(let t of this.oldCache.keys())!this.cache.has(t)&&e++;return Math.min(this._size+e,this.maxSize)}}e.exports=t},58166:(e,t,s)=>{"use strict";let r=s(82452);e.exports=(e={},t=r.connect)=>new Promise((s,r)=>{let n,i=!1,o=async()=>{await l,n.off("timeout",a),n.off("error",r),e.resolveSocket?(s({alpnProtocol:n.alpnProtocol,socket:n,timeout:i}),i&&(await Promise.resolve(),n.emit("timeout"))):(n.destroy(),s({alpnProtocol:n.alpnProtocol,timeout:i}))},a=async()=>{i=!0,o()},l=(async()=>{try{(n=await t(e,o)).on("error",r),n.once("timeout",a)}catch(e){r(e)}})()})},25217:(e,t,s)=>{"use strict";let r=s(76162).Readable,n=s(81332);class i extends r{constructor(e,t,s,r){if("number"!=typeof e)throw TypeError("Argument `statusCode` should be a number");if("object"!=typeof t)throw TypeError("Argument `headers` should be an object");if(!(s instanceof Buffer))throw TypeError("Argument `body` should be a buffer");if("string"!=typeof r)throw TypeError("Argument `url` should be a string");super(),this.statusCode=e,this.headers=n(t),this.body=s,this.url=r}_read(){this.push(this.body),this.push(null)}}e.exports=i},66082:e=>{e.exports=function e(t,s){if(t&&s)return e(t)(s);if("function"!=typeof t)throw TypeError("need wrapper function");return Object.keys(t).forEach(function(e){r[e]=t[e]}),r;function r(){for(var e=Array(arguments.length),s=0;s<e.length;s++)e[s]=arguments[s];var r=t.apply(this,e),n=e[e.length-1];return"function"==typeof r&&r!==n&&Object.keys(n).forEach(function(e){r[e]=n[e]}),r}}},82158:(e,t,s)=>{"use strict";let r=s(78631);r.createWebSocketStream=s(94996),r.Server=s(31497),r.Receiver=s(10292),r.Sender=s(13815),r.WebSocket=r,r.WebSocketServer=r.Server,e.exports=r},25521:(e,t,s)=>{"use strict";let{EMPTY_BUFFER:r}=s(40366),n=Buffer[Symbol.species];function i(e,t,s,r,n){for(let i=0;i<n;i++)s[r+i]=e[i]^t[3&i]}function o(e,t){for(let s=0;s<e.length;s++)e[s]^=t[3&s]}if(e.exports={concat:function(e,t){if(0===e.length)return r;if(1===e.length)return e[0];let s=Buffer.allocUnsafe(t),i=0;for(let t=0;t<e.length;t++){let r=e[t];s.set(r,i),i+=r.length}return i<t?new n(s.buffer,s.byteOffset,i):s},mask:i,toArrayBuffer:function(e){return e.length===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.length)},toBuffer:function e(t){let s;return(e.readOnly=!0,Buffer.isBuffer(t))?t:(t instanceof ArrayBuffer?s=new n(t):ArrayBuffer.isView(t)?s=new n(t.buffer,t.byteOffset,t.byteLength):(s=Buffer.from(t),e.readOnly=!1),s)},unmask:o},!process.env.WS_NO_BUFFER_UTIL)try{let t=s(40414);e.exports.mask=function(e,s,r,n,o){o<48?i(e,s,r,n,o):t.mask(e,s,r,n,o)},e.exports.unmask=function(e,s){e.length<32?o(e,s):t.unmask(e,s)}}catch(e){}},40366:e=>{"use strict";let t=["nodebuffer","arraybuffer","fragments"],s="undefined"!=typeof Blob;s&&t.push("blob"),e.exports={BINARY_TYPES:t,CLOSE_TIMEOUT:3e4,EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",hasBlob:s,kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}}},23025:(e,t,s)=>{"use strict";let{kForOnEventAttribute:r,kListener:n}=s(40366),i=Symbol("kCode"),o=Symbol("kData"),a=Symbol("kError"),l=Symbol("kMessage"),c=Symbol("kReason"),h=Symbol("kTarget"),u=Symbol("kType"),d=Symbol("kWasClean");class f{constructor(e){this[h]=null,this[u]=e}get target(){return this[h]}get type(){return this[u]}}Object.defineProperty(f.prototype,"target",{enumerable:!0}),Object.defineProperty(f.prototype,"type",{enumerable:!0});class p extends f{constructor(e,t={}){super(e),this[i]=void 0===t.code?0:t.code,this[c]=void 0===t.reason?"":t.reason,this[d]=void 0!==t.wasClean&&t.wasClean}get code(){return this[i]}get reason(){return this[c]}get wasClean(){return this[d]}}Object.defineProperty(p.prototype,"code",{enumerable:!0}),Object.defineProperty(p.prototype,"reason",{enumerable:!0}),Object.defineProperty(p.prototype,"wasClean",{enumerable:!0});class g extends f{constructor(e,t={}){super(e),this[a]=void 0===t.error?null:t.error,this[l]=void 0===t.message?"":t.message}get error(){return this[a]}get message(){return this[l]}}Object.defineProperty(g.prototype,"error",{enumerable:!0}),Object.defineProperty(g.prototype,"message",{enumerable:!0});class m extends f{constructor(e,t={}){super(e),this[o]=void 0===t.data?null:t.data}get data(){return this[o]}}function y(e,t,s){"object"==typeof e&&e.handleEvent?e.handleEvent.call(e,s):e.call(t,s)}Object.defineProperty(m.prototype,"data",{enumerable:!0}),e.exports={CloseEvent:p,ErrorEvent:g,Event:f,EventTarget:{addEventListener(e,t,s={}){let i;for(let i of this.listeners(e))if(!s[r]&&i[n]===t&&!i[r])return;if("message"===e)i=function(e,s){let r=new m("message",{data:s?e:e.toString()});r[h]=this,y(t,this,r)};else if("close"===e)i=function(e,s){let r=new p("close",{code:e,reason:s.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});r[h]=this,y(t,this,r)};else if("error"===e)i=function(e){let s=new g("error",{error:e,message:e.message});s[h]=this,y(t,this,s)};else{if("open"!==e)return;i=function(){let e=new f("open");e[h]=this,y(t,this,e)}}i[r]=!!s[r],i[n]=t,s.once?this.once(e,i):this.on(e,i)},removeEventListener(e,t){for(let s of this.listeners(e))if(s[n]===t&&!s[r]){this.removeListener(e,s);break}}},MessageEvent:m}},18109:(e,t,s)=>{"use strict";let{tokenChars:r}=s(54093);function n(e,t,s){void 0===e[t]?e[t]=[s]:e[t].push(s)}e.exports={format:function(e){return Object.keys(e).map(t=>{let s=e[t];return Array.isArray(s)||(s=[s]),s.map(e=>[t].concat(Object.keys(e).map(t=>{let s=e[t];return Array.isArray(s)||(s=[s]),s.map(e=>!0===e?t:`${t}=${e}`).join("; ")})).join("; ")).join(", ")}).join(", ")},parse:function(e){let t,s;let i=Object.create(null),o=Object.create(null),a=!1,l=!1,c=!1,h=-1,u=-1,d=-1,f=0;for(;f<e.length;f++)if(u=e.charCodeAt(f),void 0===t){if(-1===d&&1===r[u])-1===h&&(h=f);else if(0!==f&&(32===u||9===u))-1===d&&-1!==h&&(d=f);else if(59===u||44===u){if(-1===h)throw SyntaxError(`Unexpected character at index ${f}`);-1===d&&(d=f);let s=e.slice(h,d);44===u?(n(i,s,o),o=Object.create(null)):t=s,h=d=-1}else throw SyntaxError(`Unexpected character at index ${f}`)}else if(void 0===s){if(-1===d&&1===r[u])-1===h&&(h=f);else if(32===u||9===u)-1===d&&-1!==h&&(d=f);else if(59===u||44===u){if(-1===h)throw SyntaxError(`Unexpected character at index ${f}`);-1===d&&(d=f),n(o,e.slice(h,d),!0),44===u&&(n(i,t,o),o=Object.create(null),t=void 0),h=d=-1}else if(61===u&&-1!==h&&-1===d)s=e.slice(h,f),h=d=-1;else throw SyntaxError(`Unexpected character at index ${f}`)}else if(l){if(1!==r[u])throw SyntaxError(`Unexpected character at index ${f}`);-1===h?h=f:a||(a=!0),l=!1}else if(c){if(1===r[u])-1===h&&(h=f);else if(34===u&&-1!==h)c=!1,d=f;else if(92===u)l=!0;else throw SyntaxError(`Unexpected character at index ${f}`)}else if(34===u&&61===e.charCodeAt(f-1))c=!0;else if(-1===d&&1===r[u])-1===h&&(h=f);else if(-1!==h&&(32===u||9===u))-1===d&&(d=f);else if(59===u||44===u){if(-1===h)throw SyntaxError(`Unexpected character at index ${f}`);-1===d&&(d=f);let r=e.slice(h,d);a&&(r=r.replace(/\\/g,""),a=!1),n(o,s,r),44===u&&(n(i,t,o),o=Object.create(null),t=void 0),s=void 0,h=d=-1}else throw SyntaxError(`Unexpected character at index ${f}`);if(-1===h||c||32===u||9===u)throw SyntaxError("Unexpected end of input");-1===d&&(d=f);let p=e.slice(h,d);return void 0===t?n(i,p,o):(void 0===s?n(o,p,!0):a?n(o,s,p.replace(/\\/g,"")):n(o,s,p),n(i,t,o)),i}}},29025:e=>{"use strict";let t=Symbol("kDone"),s=Symbol("kRun");class r{constructor(e){this[t]=()=>{this.pending--,this[s]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[s]()}[s](){if(this.pending!==this.concurrency&&this.jobs.length){let e=this.jobs.shift();this.pending++,e(this[t])}}}e.exports=r},5580:(e,t,s)=>{"use strict";let r;let n=s(71568),i=s(25521),o=s(29025),{kStatusCode:a}=s(40366),l=Buffer[Symbol.species],c=Buffer.from([0,0,255,255]),h=Symbol("permessage-deflate"),u=Symbol("total-length"),d=Symbol("callback"),f=Symbol("buffers"),p=Symbol("error");class g{constructor(e,t,s){this._maxPayload=0|s,this._options=e||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,r||(r=new o(void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10))}static get extensionName(){return"permessage-deflate"}offer(){let e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){let e=this._deflate[d];this._deflate.close(),this._deflate=null,e&&e(Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){let t=this._options,s=e.find(e=>(!1!==t.serverNoContextTakeover||!e.server_no_context_takeover)&&(!e.server_max_window_bits||!1!==t.serverMaxWindowBits&&("number"!=typeof t.serverMaxWindowBits||!(t.serverMaxWindowBits>e.server_max_window_bits)))&&("number"!=typeof t.clientMaxWindowBits||!!e.client_max_window_bits));if(!s)throw Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(s.server_no_context_takeover=!0),t.clientNoContextTakeover&&(s.client_no_context_takeover=!0),"number"==typeof t.serverMaxWindowBits&&(s.server_max_window_bits=t.serverMaxWindowBits),"number"==typeof t.clientMaxWindowBits?s.client_max_window_bits=t.clientMaxWindowBits:(!0===s.client_max_window_bits||!1===t.clientMaxWindowBits)&&delete s.client_max_window_bits,s}acceptAsClient(e){let t=e[0];if(!1===this._options.clientNoContextTakeover&&t.client_no_context_takeover)throw Error('Unexpected parameter "client_no_context_takeover"');if(t.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(t.client_max_window_bits=this._options.clientMaxWindowBits);return t}normalizeParams(e){return e.forEach(e=>{Object.keys(e).forEach(t=>{let s=e[t];if(s.length>1)throw Error(`Parameter "${t}" must have only a single value`);if(s=s[0],"client_max_window_bits"===t){if(!0!==s){let e=+s;if(!Number.isInteger(e)||e<8||e>15)throw TypeError(`Invalid value for parameter "${t}": ${s}`);s=e}else if(!this._isServer)throw TypeError(`Invalid value for parameter "${t}": ${s}`)}else if("server_max_window_bits"===t){let e=+s;if(!Number.isInteger(e)||e<8||e>15)throw TypeError(`Invalid value for parameter "${t}": ${s}`);s=e}else if("client_no_context_takeover"===t||"server_no_context_takeover"===t){if(!0!==s)throw TypeError(`Invalid value for parameter "${t}": ${s}`)}else throw Error(`Unknown parameter "${t}"`);e[t]=s})}),e}decompress(e,t,s){r.add(r=>{this._decompress(e,t,(e,t)=>{r(),s(e,t)})})}compress(e,t,s){r.add(r=>{this._compress(e,t,(e,t)=>{r(),s(e,t)})})}_decompress(e,t,s){let r=this._isServer?"client":"server";if(!this._inflate){let e=`${r}_max_window_bits`,t="number"!=typeof this.params[e]?n.Z_DEFAULT_WINDOWBITS:this.params[e];this._inflate=n.createInflateRaw({...this._options.zlibInflateOptions,windowBits:t}),this._inflate[h]=this,this._inflate[u]=0,this._inflate[f]=[],this._inflate.on("error",b),this._inflate.on("data",y)}this._inflate[d]=s,this._inflate.write(e),t&&this._inflate.write(c),this._inflate.flush(()=>{let e=this._inflate[p];if(e){this._inflate.close(),this._inflate=null,s(e);return}let n=i.concat(this._inflate[f],this._inflate[u]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[u]=0,this._inflate[f]=[],t&&this.params[`${r}_no_context_takeover`]&&this._inflate.reset()),s(null,n)})}_compress(e,t,s){let r=this._isServer?"server":"client";if(!this._deflate){let e=`${r}_max_window_bits`,t="number"!=typeof this.params[e]?n.Z_DEFAULT_WINDOWBITS:this.params[e];this._deflate=n.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:t}),this._deflate[u]=0,this._deflate[f]=[],this._deflate.on("data",m)}this._deflate[d]=s,this._deflate.write(e),this._deflate.flush(n.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let e=i.concat(this._deflate[f],this._deflate[u]);t&&(e=new l(e.buffer,e.byteOffset,e.length-4)),this._deflate[d]=null,this._deflate[u]=0,this._deflate[f]=[],t&&this.params[`${r}_no_context_takeover`]&&this._deflate.reset(),s(null,e)})}}function m(e){this[f].push(e),this[u]+=e.length}function y(e){if(this[u]+=e.length,this[h]._maxPayload<1||this[u]<=this[h]._maxPayload){this[f].push(e);return}this[p]=RangeError("Max payload size exceeded"),this[p].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[p][a]=1009,this.removeListener("data",y),this.reset()}function b(e){if(this[h]._inflate=null,this[p]){this[d](this[p]);return}e[a]=1007,this[d](e)}e.exports=g},10292:(e,t,s)=>{"use strict";let{Writable:r}=s(76162),n=s(5580),{BINARY_TYPES:i,EMPTY_BUFFER:o,kStatusCode:a,kWebSocket:l}=s(40366),{concat:c,toArrayBuffer:h,unmask:u}=s(25521),{isValidStatusCode:d,isValidUTF8:f}=s(54093),p=Buffer[Symbol.species];class g extends r{constructor(e={}){super(),this._allowSynchronousEvents=void 0===e.allowSynchronousEvents||e.allowSynchronousEvents,this._binaryType=e.binaryType||i[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=0|e.maxPayload,this._skipUTF8Validation=!!e.skipUTF8Validation,this[l]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._errored=!1,this._loop=!1,this._state=0}_write(e,t,s){if(8===this._opcode&&0==this._state)return s();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(s)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){let t=this._buffers[0];return this._buffers[0]=new p(t.buffer,t.byteOffset+e,t.length-e),new p(t.buffer,t.byteOffset,e)}let t=Buffer.allocUnsafe(e);do{let s=this._buffers[0],r=t.length-e;e>=s.length?t.set(this._buffers.shift(),r):(t.set(new Uint8Array(s.buffer,s.byteOffset,e),r),this._buffers[0]=new p(s.buffer,s.byteOffset+e,s.length-e)),e-=s.length}while(e>0);return t}startLoop(e){this._loop=!0;do switch(this._state){case 0:this.getInfo(e);break;case 1:this.getPayloadLength16(e);break;case 2:this.getPayloadLength64(e);break;case 3:this.getMask();break;case 4:this.getData(e);break;case 5:case 6:this._loop=!1;return}while(this._loop);this._errored||e()}getInfo(e){if(this._bufferedBytes<2){this._loop=!1;return}let t=this.consume(2);if((48&t[0])!=0){e(this.createError(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3"));return}let s=(64&t[0])==64;if(s&&!this._extensions[n.extensionName]){e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"));return}if(this._fin=(128&t[0])==128,this._opcode=15&t[0],this._payloadLength=127&t[1],0===this._opcode){if(s){e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"));return}if(!this._fragmented){e(this.createError(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE"));return}this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented){e(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"));return}this._compressed=s}else if(this._opcode>7&&this._opcode<11){if(!this._fin){e(this.createError(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN"));return}if(s){e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"));return}if(this._payloadLength>125||8===this._opcode&&1===this._payloadLength){e(this.createError(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH"));return}}else{e(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"));return}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=(128&t[1])==128,this._isServer){if(!this._masked){e(this.createError(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK"));return}}else if(this._masked){e(this.createError(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK"));return}126===this._payloadLength?this._state=1:127===this._payloadLength?this._state=2:this.haveLength(e)}getPayloadLength16(e){if(this._bufferedBytes<2){this._loop=!1;return}this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength(e)}getPayloadLength64(e){if(this._bufferedBytes<8){this._loop=!1;return}let t=this.consume(8),s=t.readUInt32BE(0);if(s>2097151){e(this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH"));return}this._payloadLength=4294967296*s+t.readUInt32BE(4),this.haveLength(e)}haveLength(e){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0)){e(this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"));return}this._masked?this._state=3:this._state=4}getMask(){if(this._bufferedBytes<4){this._loop=!1;return}this._mask=this.consume(4),this._state=4}getData(e){let t=o;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength){this._loop=!1;return}t=this.consume(this._payloadLength),this._masked&&(this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3])!=0&&u(t,this._mask)}if(this._opcode>7){this.controlMessage(t,e);return}if(this._compressed){this._state=5,this.decompress(t,e);return}t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage(e)}decompress(e,t){this._extensions[n.extensionName].decompress(e,this._fin,(e,s)=>{if(e)return t(e);if(s.length){if(this._messageLength+=s.length,this._messageLength>this._maxPayload&&this._maxPayload>0){t(this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"));return}this._fragments.push(s)}this.dataMessage(t),0===this._state&&this.startLoop(t)})}dataMessage(e){if(!this._fin){this._state=0;return}let t=this._messageLength,s=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let r;r="nodebuffer"===this._binaryType?c(s,t):"arraybuffer"===this._binaryType?h(c(s,t)):"blob"===this._binaryType?new Blob(s):s,this._allowSynchronousEvents?(this.emit("message",r,!0),this._state=0):(this._state=6,setImmediate(()=>{this.emit("message",r,!0),this._state=0,this.startLoop(e)}))}else{let r=c(s,t);if(!this._skipUTF8Validation&&!f(r)){e(this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8"));return}5===this._state||this._allowSynchronousEvents?(this.emit("message",r,!1),this._state=0):(this._state=6,setImmediate(()=>{this.emit("message",r,!1),this._state=0,this.startLoop(e)}))}}controlMessage(e,t){if(8===this._opcode){if(0===e.length)this._loop=!1,this.emit("conclude",1005,o),this.end();else{let s=e.readUInt16BE(0);if(!d(s)){t(this.createError(RangeError,`invalid status code ${s}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE"));return}let r=new p(e.buffer,e.byteOffset+2,e.length-2);if(!this._skipUTF8Validation&&!f(r)){t(this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8"));return}this._loop=!1,this.emit("conclude",s,r),this.end()}this._state=0;return}this._allowSynchronousEvents?(this.emit(9===this._opcode?"ping":"pong",e),this._state=0):(this._state=6,setImmediate(()=>{this.emit(9===this._opcode?"ping":"pong",e),this._state=0,this.startLoop(t)}))}createError(e,t,s,r,n){this._loop=!1,this._errored=!0;let i=new e(s?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(i,this.createError),i.code=n,i[a]=r,i}}e.exports=g},13815:(e,t,s)=>{"use strict";let r;let{Duplex:n}=s(76162),{randomFillSync:i}=s(84770),o=s(5580),{EMPTY_BUFFER:a,kWebSocket:l,NOOP:c}=s(40366),{isBlob:h,isValidStatusCode:u}=s(54093),{mask:d,toBuffer:f}=s(25521),p=Symbol("kByteLength"),g=Buffer.alloc(4),m=8192;class y{constructor(e,t,s){this._extensions=t||{},s&&(this._generateMask=s,this._maskBuffer=Buffer.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._queue=[],this._state=0,this.onerror=c,this[l]=void 0}static frame(e,t){let s,n;let o=!1,a=2,l=!1;t.mask&&(s=t.maskBuffer||g,t.generateMask?t.generateMask(s):(8192===m&&(void 0===r&&(r=Buffer.alloc(8192)),i(r,0,8192),m=0),s[0]=r[m++],s[1]=r[m++],s[2]=r[m++],s[3]=r[m++]),l=(s[0]|s[1]|s[2]|s[3])==0,a=6),"string"==typeof e?n=(!t.mask||l)&&void 0!==t[p]?t[p]:(e=Buffer.from(e)).length:(n=e.length,o=t.mask&&t.readOnly&&!l);let c=n;n>=65536?(a+=8,c=127):n>125&&(a+=2,c=126);let h=Buffer.allocUnsafe(o?n+a:a);return(h[0]=t.fin?128|t.opcode:t.opcode,t.rsv1&&(h[0]|=64),h[1]=c,126===c?h.writeUInt16BE(n,2):127===c&&(h[2]=h[3]=0,h.writeUIntBE(n,4,6)),t.mask)?(h[1]|=128,h[a-4]=s[0],h[a-3]=s[1],h[a-2]=s[2],h[a-1]=s[3],l)?[h,e]:o?(d(e,s,h,a,n),[h]):(d(e,s,e,0,n),[h,e]):[h,e]}close(e,t,s,r){let n;if(void 0===e)n=a;else if("number"==typeof e&&u(e)){if(void 0!==t&&t.length){let s=Buffer.byteLength(t);if(s>123)throw RangeError("The message must not be greater than 123 bytes");(n=Buffer.allocUnsafe(2+s)).writeUInt16BE(e,0),"string"==typeof t?n.write(t,2):n.set(t,2)}else(n=Buffer.allocUnsafe(2)).writeUInt16BE(e,0)}else throw TypeError("First argument must be a valid error code number");let i={[p]:n.length,fin:!0,generateMask:this._generateMask,mask:s,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};0!==this._state?this.enqueue([this.dispatch,n,!1,i,r]):this.sendFrame(y.frame(n,i),r)}ping(e,t,s){let r,n;if("string"==typeof e?(r=Buffer.byteLength(e),n=!1):h(e)?(r=e.size,n=!1):(r=(e=f(e)).length,n=f.readOnly),r>125)throw RangeError("The data size must not be greater than 125 bytes");let i={[p]:r,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:9,readOnly:n,rsv1:!1};h(e)?0!==this._state?this.enqueue([this.getBlobData,e,!1,i,s]):this.getBlobData(e,!1,i,s):0!==this._state?this.enqueue([this.dispatch,e,!1,i,s]):this.sendFrame(y.frame(e,i),s)}pong(e,t,s){let r,n;if("string"==typeof e?(r=Buffer.byteLength(e),n=!1):h(e)?(r=e.size,n=!1):(r=(e=f(e)).length,n=f.readOnly),r>125)throw RangeError("The data size must not be greater than 125 bytes");let i={[p]:r,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:10,readOnly:n,rsv1:!1};h(e)?0!==this._state?this.enqueue([this.getBlobData,e,!1,i,s]):this.getBlobData(e,!1,i,s):0!==this._state?this.enqueue([this.dispatch,e,!1,i,s]):this.sendFrame(y.frame(e,i),s)}send(e,t,s){let r,n;let i=this._extensions[o.extensionName],a=t.binary?2:1,l=t.compress;"string"==typeof e?(r=Buffer.byteLength(e),n=!1):h(e)?(r=e.size,n=!1):(r=(e=f(e)).length,n=f.readOnly),this._firstFragment?(this._firstFragment=!1,l&&i&&i.params[i._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(l=r>=i._threshold),this._compress=l):(l=!1,a=0),t.fin&&(this._firstFragment=!0);let c={[p]:r,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:a,readOnly:n,rsv1:l};h(e)?0!==this._state?this.enqueue([this.getBlobData,e,this._compress,c,s]):this.getBlobData(e,this._compress,c,s):0!==this._state?this.enqueue([this.dispatch,e,this._compress,c,s]):this.dispatch(e,this._compress,c,s)}getBlobData(e,t,s,r){this._bufferedBytes+=s[p],this._state=2,e.arrayBuffer().then(e=>{if(this._socket.destroyed){let e=Error("The socket was closed while the blob was being read");process.nextTick(b,this,e,r);return}this._bufferedBytes-=s[p];let n=f(e);t?this.dispatch(n,t,s,r):(this._state=0,this.sendFrame(y.frame(n,s),r),this.dequeue())}).catch(e=>{process.nextTick(_,this,e,r)})}dispatch(e,t,s,r){if(!t){this.sendFrame(y.frame(e,s),r);return}let n=this._extensions[o.extensionName];this._bufferedBytes+=s[p],this._state=1,n.compress(e,s.fin,(e,t)=>{if(this._socket.destroyed){b(this,Error("The socket was closed while data was being compressed"),r);return}this._bufferedBytes-=s[p],this._state=0,s.readOnly=!1,this.sendFrame(y.frame(t,s),r),this.dequeue()})}dequeue(){for(;0===this._state&&this._queue.length;){let e=this._queue.shift();this._bufferedBytes-=e[3][p],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][p],this._queue.push(e)}sendFrame(e,t){2===e.length?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}}function b(e,t,s){"function"==typeof s&&s(t);for(let s=0;s<e._queue.length;s++){let r=e._queue[s],n=r[r.length-1];"function"==typeof n&&n(t)}}function _(e,t,s){b(e,t,s),e.onerror(t)}e.exports=y},94996:(e,t,s)=>{"use strict";s(78631);let{Duplex:r}=s(76162);function n(e){e.emit("close")}function i(){!this.destroyed&&this._writableState.finished&&this.destroy()}function o(e){this.removeListener("error",o),this.destroy(),0===this.listenerCount("error")&&this.emit("error",e)}e.exports=function(e,t){let s=!0,a=new r({...t,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return e.on("message",function(t,s){let r=!s&&a._readableState.objectMode?t.toString():t;a.push(r)||e.pause()}),e.once("error",function(e){a.destroyed||(s=!1,a.destroy(e))}),e.once("close",function(){a.destroyed||a.push(null)}),a._destroy=function(t,r){if(e.readyState===e.CLOSED){r(t),process.nextTick(n,a);return}let i=!1;e.once("error",function(e){i=!0,r(e)}),e.once("close",function(){i||r(t),process.nextTick(n,a)}),s&&e.terminate()},a._final=function(t){if(e.readyState===e.CONNECTING){e.once("open",function(){a._final(t)});return}null!==e._socket&&(e._socket._writableState.finished?(t(),a._readableState.endEmitted&&a.destroy()):(e._socket.once("finish",function(){t()}),e.close()))},a._read=function(){e.isPaused&&e.resume()},a._write=function(t,s,r){if(e.readyState===e.CONNECTING){e.once("open",function(){a._write(t,s,r)});return}e.send(t,r)},a.on("end",i),a.on("error",o),a}},89716:(e,t,s)=>{"use strict";let{tokenChars:r}=s(54093);e.exports={parse:function(e){let t=new Set,s=-1,n=-1,i=0;for(;i<e.length;i++){let o=e.charCodeAt(i);if(-1===n&&1===r[o])-1===s&&(s=i);else if(0!==i&&(32===o||9===o))-1===n&&-1!==s&&(n=i);else if(44===o){if(-1===s)throw SyntaxError(`Unexpected character at index ${i}`);-1===n&&(n=i);let r=e.slice(s,n);if(t.has(r))throw SyntaxError(`The "${r}" subprotocol is duplicated`);t.add(r),s=n=-1}else throw SyntaxError(`Unexpected character at index ${i}`)}if(-1===s||-1!==n)throw SyntaxError("Unexpected end of input");let o=e.slice(s,i);if(t.has(o))throw SyntaxError(`The "${o}" subprotocol is duplicated`);return t.add(o),t}}},54093:(e,t,s)=>{"use strict";let{isUtf8:r}=s(78893),{hasBlob:n}=s(40366);function i(e){let t=e.length,s=0;for(;s<t;)if((128&e[s])==0)s++;else if((224&e[s])==192){if(s+1===t||(192&e[s+1])!=128||(254&e[s])==192)return!1;s+=2}else if((240&e[s])==224){if(s+2>=t||(192&e[s+1])!=128||(192&e[s+2])!=128||224===e[s]&&(224&e[s+1])==128||237===e[s]&&(224&e[s+1])==160)return!1;s+=3}else{if((248&e[s])!=240||s+3>=t||(192&e[s+1])!=128||(192&e[s+2])!=128||(192&e[s+3])!=128||240===e[s]&&(240&e[s+1])==128||244===e[s]&&e[s+1]>143||e[s]>244)return!1;s+=4}return!0}if(e.exports={isBlob:function(e){return n&&"object"==typeof e&&"function"==typeof e.arrayBuffer&&"string"==typeof e.type&&"function"==typeof e.stream&&("Blob"===e[Symbol.toStringTag]||"File"===e[Symbol.toStringTag])},isValidStatusCode:function(e){return e>=1e3&&e<=1014&&1004!==e&&1005!==e&&1006!==e||e>=3e3&&e<=4999},isValidUTF8:i,tokenChars:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0]},r)e.exports.isValidUTF8=function(e){return e.length<24?i(e):r(e)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{let t=s(35531);e.exports.isValidUTF8=function(e){return e.length<32?i(e):t(e)}}catch(e){}},31497:(e,t,s)=>{"use strict";let r=s(17702),n=s(32615),{Duplex:i}=s(76162),{createHash:o}=s(84770),a=s(18109),l=s(5580),c=s(89716),h=s(78631),{CLOSE_TIMEOUT:u,GUID:d,kWebSocket:f}=s(40366),p=/^[+/0-9A-Za-z]{22}==$/;class g extends r{constructor(e,t){if(super(),null==(e={allowSynchronousEvents:!0,autoPong:!0,maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,closeTimeout:u,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:h,...e}).port&&!e.server&&!e.noServer||null!=e.port&&(e.server||e.noServer)||e.server&&e.noServer)throw TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(null!=e.port?(this._server=n.createServer((e,t)=>{let s=n.STATUS_CODES[426];t.writeHead(426,{"Content-Length":s.length,"Content-Type":"text/plain"}),t.end(s)}),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){let e=this.emit.bind(this,"connection");this._removeListeners=function(e,t){for(let s of Object.keys(t))e.on(s,t[s]);return function(){for(let s of Object.keys(t))e.removeListener(s,t[s])}}(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(t,s,r)=>{this.handleUpgrade(t,s,r,e)}})}!0===e.perMessageDeflate&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=e,this._state=0}address(){if(this.options.noServer)throw Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(2===this._state){e&&this.once("close",()=>{e(Error("The server is not running"))}),process.nextTick(m,this);return}if(e&&this.once("close",e),1!==this._state){if(this._state=1,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients&&this.clients.size?this._shouldEmitClose=!0:process.nextTick(m,this);else{let e=this._server;this._removeListeners(),this._removeListeners=this._server=null,e.close(()=>{m(this)})}}}shouldHandle(e){if(this.options.path){let t=e.url.indexOf("?");if((-1!==t?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,s,r){t.on("error",y);let n=e.headers["sec-websocket-key"],i=e.headers.upgrade,o=+e.headers["sec-websocket-version"];if("GET"!==e.method){_(this,e,t,405,"Invalid HTTP method");return}if(void 0===i||"websocket"!==i.toLowerCase()){_(this,e,t,400,"Invalid Upgrade header");return}if(void 0===n||!p.test(n)){_(this,e,t,400,"Missing or invalid Sec-WebSocket-Key header");return}if(13!==o&&8!==o){_(this,e,t,400,"Missing or invalid Sec-WebSocket-Version header",{"Sec-WebSocket-Version":"13, 8"});return}if(!this.shouldHandle(e)){b(t,400);return}let h=e.headers["sec-websocket-protocol"],u=new Set;if(void 0!==h)try{u=c.parse(h)}catch(s){_(this,e,t,400,"Invalid Sec-WebSocket-Protocol header");return}let d=e.headers["sec-websocket-extensions"],f={};if(this.options.perMessageDeflate&&void 0!==d){let s=new l(this.options.perMessageDeflate,!0,this.options.maxPayload);try{let e=a.parse(d);e[l.extensionName]&&(s.accept(e[l.extensionName]),f[l.extensionName]=s)}catch(s){_(this,e,t,400,"Invalid or unacceptable Sec-WebSocket-Extensions header");return}}if(this.options.verifyClient){let i={origin:e.headers[`${8===o?"sec-websocket-origin":"origin"}`],secure:!!(e.socket.authorized||e.socket.encrypted),req:e};if(2===this.options.verifyClient.length){this.options.verifyClient(i,(i,o,a,l)=>{if(!i)return b(t,o||401,a,l);this.completeUpgrade(f,n,u,e,t,s,r)});return}if(!this.options.verifyClient(i))return b(t,401)}this.completeUpgrade(f,n,u,e,t,s,r)}completeUpgrade(e,t,s,r,n,i,c){if(!n.readable||!n.writable)return n.destroy();if(n[f])throw Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>0)return b(n,503);let h=o("sha1").update(t+d).digest("base64"),u=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${h}`],p=new this.options.WebSocket(null,void 0,this.options);if(s.size){let e=this.options.handleProtocols?this.options.handleProtocols(s,r):s.values().next().value;e&&(u.push(`Sec-WebSocket-Protocol: ${e}`),p._protocol=e)}if(e[l.extensionName]){let t=e[l.extensionName].params,s=a.format({[l.extensionName]:[t]});u.push(`Sec-WebSocket-Extensions: ${s}`),p._extensions=e}this.emit("headers",u,r),n.write(u.concat("\r\n").join("\r\n")),n.removeListener("error",y),p.setSocket(n,i,{allowSynchronousEvents:this.options.allowSynchronousEvents,maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(p),p.on("close",()=>{this.clients.delete(p),this._shouldEmitClose&&!this.clients.size&&process.nextTick(m,this)})),c(p,r)}}function m(e){e._state=2,e.emit("close")}function y(){this.destroy()}function b(e,t,s,r){s=s||n.STATUS_CODES[t],r={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(s),...r},e.once("finish",e.destroy),e.end(`HTTP/1.1 ${t} ${n.STATUS_CODES[t]}\r
`+Object.keys(r).map(e=>`${e}: ${r[e]}`).join("\r\n")+"\r\n\r\n"+s)}function _(e,t,s,r,n,i){if(e.listenerCount("wsClientError")){let r=Error(n);Error.captureStackTrace(r,_),e.emit("wsClientError",r,s,t)}else b(s,r,n,i)}e.exports=g},78631:(e,t,s)=>{"use strict";let r=s(17702),n=s(35240),i=s(32615),o=s(98216),a=s(82452),{randomBytes:l,createHash:c}=s(84770),{Duplex:h,Readable:u}=s(76162),{URL:d}=s(17360),f=s(5580),p=s(10292),g=s(13815),{isBlob:m}=s(54093),{BINARY_TYPES:y,CLOSE_TIMEOUT:b,EMPTY_BUFFER:_,GUID:v,kForOnEventAttribute:w,kListener:S,kStatusCode:O,kWebSocket:E,NOOP:k}=s(40366),{EventTarget:{addEventListener:C,removeEventListener:R}}=s(23025),{format:T,parse:A}=s(18109),{toBuffer:P}=s(25521),M=Symbol("kAborted"),I=[8,13],x=["CONNECTING","OPEN","CLOSING","CLOSED"],L=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/;class N extends r{constructor(e,t,s){super(),this._binaryType=y[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=_,this._closeTimer=null,this._errorEmitted=!1,this._extensions={},this._paused=!1,this._protocol="",this._readyState=N.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,null!==e?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,void 0===t?t=[]:Array.isArray(t)||("object"==typeof t&&null!==t?(s=t,t=[]):t=[t]),function e(t,s,r,o){let a,h,u,p;let g={allowSynchronousEvents:!0,autoPong:!0,closeTimeout:b,protocolVersion:I[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...o,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(t._autoPong=g.autoPong,t._closeTimeout=g.closeTimeout,!I.includes(g.protocolVersion))throw RangeError(`Unsupported protocol version: ${g.protocolVersion} (supported versions: ${I.join(", ")})`);if(s instanceof d)a=s;else try{a=new d(s)}catch(e){throw SyntaxError(`Invalid URL: ${s}`)}"http:"===a.protocol?a.protocol="ws:":"https:"===a.protocol&&(a.protocol="wss:"),t._url=a.href;let m="wss:"===a.protocol,y="ws+unix:"===a.protocol;if("ws:"===a.protocol||m||y?y&&!a.pathname?h="The URL's pathname is empty":a.hash&&(h="The URL contains a fragment identifier"):h='The URL\'s protocol must be one of "ws:", "wss:", "http:", "https:", or "ws+unix:"',h){let e=SyntaxError(h);if(0===t._redirects)throw e;U(t,e);return}let _=m?443:80,w=l(16).toString("base64"),S=m?n.request:i.request,O=new Set;if(g.createConnection=g.createConnection||(m?B:j),g.defaultPort=g.defaultPort||_,g.port=a.port||_,g.host=a.hostname.startsWith("[")?a.hostname.slice(1,-1):a.hostname,g.headers={...g.headers,"Sec-WebSocket-Version":g.protocolVersion,"Sec-WebSocket-Key":w,Connection:"Upgrade",Upgrade:"websocket"},g.path=a.pathname+a.search,g.timeout=g.handshakeTimeout,g.perMessageDeflate&&(u=new f(!0!==g.perMessageDeflate?g.perMessageDeflate:{},!1,g.maxPayload),g.headers["Sec-WebSocket-Extensions"]=T({[f.extensionName]:u.offer()})),r.length){for(let e of r){if("string"!=typeof e||!L.test(e)||O.has(e))throw SyntaxError("An invalid or duplicated subprotocol was specified");O.add(e)}g.headers["Sec-WebSocket-Protocol"]=r.join(",")}if(g.origin&&(g.protocolVersion<13?g.headers["Sec-WebSocket-Origin"]=g.origin:g.headers.Origin=g.origin),(a.username||a.password)&&(g.auth=`${a.username}:${a.password}`),y){let e=g.path.split(":");g.socketPath=e[0],g.path=e[1]}if(g.followRedirects){if(0===t._redirects){t._originalIpc=y,t._originalSecure=m,t._originalHostOrSocketPath=y?g.socketPath:a.host;let e=o&&o.headers;if(o={...o,headers:{}},e)for(let[t,s]of Object.entries(e))o.headers[t.toLowerCase()]=s}else if(0===t.listenerCount("redirect")){let e=y?!!t._originalIpc&&g.socketPath===t._originalHostOrSocketPath:!t._originalIpc&&a.host===t._originalHostOrSocketPath;e&&(!t._originalSecure||m)||(delete g.headers.authorization,delete g.headers.cookie,e||delete g.headers.host,g.auth=void 0)}g.auth&&!o.headers.authorization&&(o.headers.authorization="Basic "+Buffer.from(g.auth).toString("base64")),p=t._req=S(g),t._redirects&&t.emit("redirect",t.url,p)}else p=t._req=S(g);g.timeout&&p.on("timeout",()=>{q(t,p,"Opening handshake has timed out")}),p.on("error",e=>{null===p||p[M]||(p=t._req=null,U(t,e))}),p.on("response",n=>{let i=n.headers.location,a=n.statusCode;if(i&&g.followRedirects&&a>=300&&a<400){let n;if(++t._redirects>g.maxRedirects){q(t,p,"Maximum redirects exceeded");return}p.abort();try{n=new d(i,s)}catch(e){U(t,SyntaxError(`Invalid URL: ${i}`));return}e(t,n,r,o)}else t.emit("unexpected-response",p,n)||q(t,p,`Unexpected server response: ${n.statusCode}`)}),p.on("upgrade",(e,s,r)=>{let n;if(t.emit("upgrade",e),t.readyState!==N.CONNECTING)return;p=t._req=null;let i=e.headers.upgrade;if(void 0===i||"websocket"!==i.toLowerCase()){q(t,s,"Invalid Upgrade header");return}let o=c("sha1").update(w+v).digest("base64");if(e.headers["sec-websocket-accept"]!==o){q(t,s,"Invalid Sec-WebSocket-Accept header");return}let a=e.headers["sec-websocket-protocol"];if(void 0!==a?O.size?O.has(a)||(n="Server sent an invalid subprotocol"):n="Server sent a subprotocol but none was requested":O.size&&(n="Server sent no subprotocol"),n){q(t,s,n);return}a&&(t._protocol=a);let l=e.headers["sec-websocket-extensions"];if(void 0!==l){let e;if(!u){q(t,s,"Server sent a Sec-WebSocket-Extensions header but no extension was requested");return}try{e=A(l)}catch(e){q(t,s,"Invalid Sec-WebSocket-Extensions header");return}let r=Object.keys(e);if(1!==r.length||r[0]!==f.extensionName){q(t,s,"Server indicated an extension that was not requested");return}try{u.accept(e[f.extensionName])}catch(e){q(t,s,"Invalid Sec-WebSocket-Extensions header");return}t._extensions[f.extensionName]=u}t.setSocket(s,r,{allowSynchronousEvents:g.allowSynchronousEvents,generateMask:g.generateMask,maxPayload:g.maxPayload,skipUTF8Validation:g.skipUTF8Validation})}),g.finishRequest?g.finishRequest(p,t):p.end()}(this,e,t,s)):(this._autoPong=s.autoPong,this._closeTimeout=s.closeTimeout,this._isServer=!0)}get binaryType(){return this._binaryType}set binaryType(e){y.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,s){let r=new p({allowSynchronousEvents:s.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:s.maxPayload,skipUTF8Validation:s.skipUTF8Validation}),n=new g(e,this._extensions,s.generateMask);this._receiver=r,this._sender=n,this._socket=e,r[E]=this,n[E]=this,e[E]=this,r.on("conclude",G),r.on("drain",H),r.on("error",W),r.on("message",V),r.on("ping",$),r.on("pong",z),n.onerror=K,e.setTimeout&&e.setTimeout(0),e.setNoDelay&&e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",X),e.on("data",Y),e.on("end",Z),e.on("error",ee),this._readyState=N.OPEN,this.emit("open")}emitClose(){if(!this._socket){this._readyState=N.CLOSED,this.emit("close",this._closeCode,this._closeMessage);return}this._extensions[f.extensionName]&&this._extensions[f.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=N.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==N.CLOSED){if(this.readyState===N.CONNECTING){q(this,this._req,"WebSocket was closed before the connection was established");return}if(this.readyState===N.CLOSING){this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end();return}this._readyState=N.CLOSING,this._sender.close(e,t,!this._isServer,e=>{!e&&(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())}),Q(this)}}pause(){this.readyState!==N.CONNECTING&&this.readyState!==N.CLOSED&&(this._paused=!0,this._socket.pause())}ping(e,t,s){if(this.readyState===N.CONNECTING)throw Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof e?(s=e,e=t=void 0):"function"==typeof t&&(s=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState!==N.OPEN){D(this,e,s);return}void 0===t&&(t=!this._isServer),this._sender.ping(e||_,t,s)}pong(e,t,s){if(this.readyState===N.CONNECTING)throw Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof e?(s=e,e=t=void 0):"function"==typeof t&&(s=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState!==N.OPEN){D(this,e,s);return}void 0===t&&(t=!this._isServer),this._sender.pong(e||_,t,s)}resume(){this.readyState!==N.CONNECTING&&this.readyState!==N.CLOSED&&(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(e,t,s){if(this.readyState===N.CONNECTING)throw Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof t&&(s=t,t={}),"number"==typeof e&&(e=e.toString()),this.readyState!==N.OPEN){D(this,e,s);return}let r={binary:"string"!=typeof e,mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[f.extensionName]||(r.compress=!1),this._sender.send(e||_,r,s)}terminate(){if(this.readyState!==N.CLOSED){if(this.readyState===N.CONNECTING){q(this,this._req,"WebSocket was closed before the connection was established");return}this._socket&&(this._readyState=N.CLOSING,this._socket.destroy())}}}function U(e,t){e._readyState=N.CLOSING,e._errorEmitted=!0,e.emit("error",t),e.emitClose()}function j(e){return e.path=e.socketPath,o.connect(e)}function B(e){return e.path=void 0,e.servername||""===e.servername||(e.servername=o.isIP(e.host)?"":e.host),a.connect(e)}function q(e,t,s){e._readyState=N.CLOSING;let r=Error(s);Error.captureStackTrace(r,q),t.setHeader?(t[M]=!0,t.abort(),t.socket&&!t.socket.destroyed&&t.socket.destroy(),process.nextTick(U,e,r)):(t.destroy(r),t.once("error",e.emit.bind(e,"error")),t.once("close",e.emitClose.bind(e)))}function D(e,t,s){if(t){let s=m(t)?t.size:P(t).length;e._socket?e._sender._bufferedBytes+=s:e._bufferedAmount+=s}if(s){let t=Error(`WebSocket is not open: readyState ${e.readyState} (${x[e.readyState]})`);process.nextTick(s,t)}}function G(e,t){let s=this[E];s._closeFrameReceived=!0,s._closeMessage=t,s._closeCode=e,void 0!==s._socket[E]&&(s._socket.removeListener("data",Y),process.nextTick(J,s._socket),1005===e?s.close():s.close(e,t))}function H(){let e=this[E];e.isPaused||e._socket.resume()}function W(e){let t=this[E];void 0!==t._socket[E]&&(t._socket.removeListener("data",Y),process.nextTick(J,t._socket),t.close(e[O])),t._errorEmitted||(t._errorEmitted=!0,t.emit("error",e))}function F(){this[E].emitClose()}function V(e,t){this[E].emit("message",e,t)}function $(e){let t=this[E];t._autoPong&&t.pong(e,!this._isServer,k),t.emit("ping",e)}function z(e){this[E].emit("pong",e)}function J(e){e.resume()}function K(e){let t=this[E];t.readyState===N.CLOSED||(t.readyState===N.OPEN&&(t._readyState=N.CLOSING,Q(t)),this._socket.end(),t._errorEmitted||(t._errorEmitted=!0,t.emit("error",e)))}function Q(e){e._closeTimer=setTimeout(e._socket.destroy.bind(e._socket),e._closeTimeout)}function X(){let e=this[E];if(this.removeListener("close",X),this.removeListener("data",Y),this.removeListener("end",Z),e._readyState=N.CLOSING,!this._readableState.endEmitted&&!e._closeFrameReceived&&!e._receiver._writableState.errorEmitted&&0!==this._readableState.length){let t=this.read(this._readableState.length);e._receiver.write(t)}e._receiver.end(),this[E]=void 0,clearTimeout(e._closeTimer),e._receiver._writableState.finished||e._receiver._writableState.errorEmitted?e.emitClose():(e._receiver.on("error",F),e._receiver.on("finish",F))}function Y(e){this[E]._receiver.write(e)||this.pause()}function Z(){let e=this[E];e._readyState=N.CLOSING,e._receiver.end(),this.end()}function ee(){let e=this[E];this.removeListener("error",ee),this.on("error",k),e&&(e._readyState=N.CLOSING,this.destroy())}Object.defineProperty(N,"CONNECTING",{enumerable:!0,value:x.indexOf("CONNECTING")}),Object.defineProperty(N.prototype,"CONNECTING",{enumerable:!0,value:x.indexOf("CONNECTING")}),Object.defineProperty(N,"OPEN",{enumerable:!0,value:x.indexOf("OPEN")}),Object.defineProperty(N.prototype,"OPEN",{enumerable:!0,value:x.indexOf("OPEN")}),Object.defineProperty(N,"CLOSING",{enumerable:!0,value:x.indexOf("CLOSING")}),Object.defineProperty(N.prototype,"CLOSING",{enumerable:!0,value:x.indexOf("CLOSING")}),Object.defineProperty(N,"CLOSED",{enumerable:!0,value:x.indexOf("CLOSED")}),Object.defineProperty(N.prototype,"CLOSED",{enumerable:!0,value:x.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach(e=>{Object.defineProperty(N.prototype,e,{enumerable:!0})}),["open","error","close","message"].forEach(e=>{Object.defineProperty(N.prototype,`on${e}`,{enumerable:!0,get(){for(let t of this.listeners(e))if(t[w])return t[S];return null},set(t){for(let t of this.listeners(e))if(t[w]){this.removeListener(e,t);break}"function"==typeof t&&this.addEventListener(e,t,{[w]:!0})}})}),N.prototype.addEventListener=C,N.prototype.removeEventListener=R,e.exports=N}};