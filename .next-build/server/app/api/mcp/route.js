(()=>{var e={};e.id=694,e.ids=[694],e.modules={33899:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=33899,e.exports=t},53524:e=>{"use strict";e.exports=require("@prisma/client")},72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{"use strict";e.exports=require("assert")},78893:e=>{"use strict";e.exports=require("buffer")},61282:e=>{"use strict";e.exports=require("child_process")},84770:e=>{"use strict";e.exports=require("crypto")},80665:e=>{"use strict";e.exports=require("dns")},17702:e=>{"use strict";e.exports=require("events")},92048:e=>{"use strict";e.exports=require("fs")},32615:e=>{"use strict";e.exports=require("http")},32694:e=>{"use strict";e.exports=require("http2")},35240:e=>{"use strict";e.exports=require("https")},98216:e=>{"use strict";e.exports=require("net")},19801:e=>{"use strict";e.exports=require("os")},55315:e=>{"use strict";e.exports=require("path")},86624:e=>{"use strict";e.exports=require("querystring")},76162:e=>{"use strict";e.exports=require("stream")},82452:e=>{"use strict";e.exports=require("tls")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},40414:()=>{},35531:()=>{},64160:(e,t,r)=>{"use strict";r.r(t),r.d(t,{originalPathname:()=>G,patchFetch:()=>U,requestAsyncStorage:()=>P,routeModule:()=>O,serverHooks:()=>C,staticGenerationAsyncStorage:()=>M});var a={};r.r(a),r.d(a,{GET:()=>k,POST:()=>R});var i=r(12085),s=r(31650),n=r(85980),o=r(42073),m=r(53524),u=r(57752),c=r(6415),d=r(76148),l=r(7750);let p={p:"♟",r:"♜",n:"♞",b:"♝",q:"♛",k:"♚",P:"♙",R:"♖",N:"♘",B:"♗",Q:"♕",K:"♔"};var g=r(37141);function h(e){if(!e)throw Error("Authentication required");return e}let y=c.Ry({query:c.Z_().trim().optional(),email:c.Z_().trim().optional(),name:c.Z_().trim().optional(),limit:c.Rx().int().min(1).max(50).default(20)}).transform(e=>({term:(e.query??e.email??e.name??"").trim(),limit:e.limit})),f=c.Ry({opponentEmail:c.Z_().email().transform(e=>e.trim().toLowerCase()),playAs:c.Km(["white","black"]).default("white")}),w=c.Ry({gameId:c.Z_().min(1),from:c.Z_().regex(/^[a-h][1-8]$/),to:c.Z_().regex(/^[a-h][1-8]$/),promotion:c.Km(["q","r","b","n"]).optional()}),b=c.Ry({gameId:c.Z_().min(1)}),I=c.Ry({gameId:c.Z_().min(1),size:c.Rx().int().min(200).max(1200).default(560)}),v=c.Ry({gameId:c.Z_().min(1),limit:c.Rx().int().min(1).max(300).default(200)}),x=c.Ry({scope:c.Km(["my","others","all"]).default("all"),limit:c.Rx().int().min(1).max(100).default(30)}),q=c.Ry({gameId:c.Z_().min(1),body:c.Z_().trim().min(1).max(500)}),S=c.Ry({gameId:c.Z_().min(1),limit:c.Rx().int().min(1).max(200).default(50)}),E=[{name:"query_users_by_email",description:"Search users by email and/or name.",inputSchema:{type:"object",properties:{query:{type:"string"},email:{type:"string"},name:{type:"string"},limit:{type:"number"}}},execute:async e=>{let t=y.parse(e??{}),r=t.term?{AND:[{email:{not:null}},{OR:[{email:{contains:t.term}},{name:{contains:t.term}}]}]}:{email:{not:null}};return{users:await l.db.user.findMany({where:r,select:{id:!0,name:!0,email:!0,image:!0},orderBy:[{email:"asc"},{createdAt:"desc"}],take:t.limit})}}},{name:"new_game",description:"Create a new game against an email and send invitation email.",inputSchema:{type:"object",properties:{opponentEmail:{type:"string",format:"email"},playAs:{type:"string",enum:["white","black"]}},required:["opponentEmail"]},execute:async(e,t)=>{let r=h(t.userId),a=f.parse(e??{}),i=await l.db.user.findUnique({where:{id:r},select:{id:!0,email:!0,name:!0}});if(!i)throw Error("Authenticated user not found");if(i.email?.toLowerCase()===a.opponentEmail)throw Error("Cannot create a game against yourself");let s=await l.db.user.findUnique({where:{email:a.opponentEmail},select:{id:!0,email:!0,name:!0}}),n=!0;s||(n=!1,s=await l.db.user.create({data:{email:a.opponentEmail},select:{id:!0,email:!0,name:!0}}));let o=new u.qQ,m="white"===a.playAs?r:s.id,c="black"===a.playAs?r:s.id,p=await l.db.game.create({data:{whiteId:m,blackId:c,createdById:r,fen:o.fen(),pgn:o.pgn(),isPublic:!0},include:{white:{select:{id:!0,email:!0,name:!0}},black:{select:{id:!0,email:!0,name:!0}}}}),y=await (0,g.X)({toEmail:a.opponentEmail,invitedByEmail:i.email,invitedByName:i.name,gameId:p.id,opponentExists:n});return await (0,d.FZ)(p.id,"game.created",{whiteId:p.white.id,blackId:p.black.id}),await (0,d.OZ)("game.created",{gameId:p.id}),{game:{id:p.id,white:p.white,black:p.black,status:p.status,fen:p.fen,createdAt:p.createdAt},invitation:y}}},{name:"move_piece",description:"Move a piece in a game (authenticated game players only).",inputSchema:{type:"object",properties:{gameId:{type:"string"},from:{type:"string"},to:{type:"string"},promotion:{type:"string",enum:["q","r","b","n"]}},required:["gameId","from","to"]},execute:async(e,t)=>{let r=h(t.userId),a=w.parse(e??{}),i=await l.db.$transaction(async e=>{let t=await e.game.findUnique({where:{id:a.gameId}});if(!t)throw Error("Game not found");if(t.status!==m.GameStatus.ACTIVE)throw Error("Game is not active");let i=r===t.whiteId?"w":r===t.blackId?"b":null;if(!i)throw Error("Only game players can move pieces");let s=new u.qQ(t.fen);if(s.turn()!==i)throw Error("It is not your turn");let n=s.fen(),o=s.move({from:a.from,to:a.to,promotion:a.promotion});if(!o)throw Error("Illegal move");let c=s.fen(),d=await e.move.count({where:{gameId:t.id}}),l=s.isGameOver()?m.GameStatus.FINISHED:m.GameStatus.ACTIVE;await e.game.update({where:{id:t.id},data:{fen:c,pgn:s.pgn(),status:l}});let p=await e.move.create({data:{gameId:t.id,byUserId:r,from:a.from,to:a.to,promotion:a.promotion,san:o.san,fenBefore:n,fenAfter:c,ply:d+1}});return{move:{id:p.id,san:p.san,from:p.from,to:p.to,ply:p.ply,createdAt:p.createdAt},fen:c,gameStatus:l,isCheckmate:s.isCheckmate(),isDraw:s.isDraw(),winnerUserId:s.isCheckmate()?r:null}});return await (0,d.FZ)(a.gameId,"move.created",{moveId:i.move.id,byUserId:r,san:i.move.san,from:i.move.from,to:i.move.to,gameStatus:i.gameStatus}),await (0,d.OZ)("game.updated",{gameId:a.gameId}),i.gameStatus===m.GameStatus.FINISHED&&await (0,d.FZ)(a.gameId,"game.finished",{winnerUserId:i.winnerUserId,isCheckmate:i.isCheckmate,isDraw:i.isDraw}),i}},{name:"snapshot",description:"Generate a board snapshot image for a game.",inputSchema:{type:"object",properties:{gameId:{type:"string"},size:{type:"number"}},required:["gameId"]},execute:async e=>{let t=I.parse(e??{}),r=await l.db.game.findUnique({where:{id:t.gameId}});if(!r||!r.isPublic)throw Error("Game not found");let a=function(e,t=560){let r=new u.qQ(e).board(),a=t/8,i=["a","b","c","d","e","f","g","h"],s="";for(let e=0;e<8;e+=1){let t=8-e;for(let n=0;n<8;n+=1){let o=n*a,m=e*a,u=(e+n)%2==0?"#f0d9b5":"#b58863";s+=`<rect x='${o}' y='${m}' width='${a}' height='${a}' fill='${u}' />`;let c=r[e]?.[n];if(!c)continue;let d=p["w"===c.color?c.type.toUpperCase():c.type],l=`${i[n]}${t}`;s+=`<text x='${o+a/2}' y='${m+.66*a}' text-anchor='middle' font-size='${.72*a}' font-family='"Times New Roman", serif'>${d}</text><title>${l}</title>`}}return`<svg xmlns='http://www.w3.org/2000/svg' width='${t}' height='${t}' viewBox='0 0 ${t} ${t}'>${s}</svg>`}(r.fen,t.size),i=Buffer.from(a).toString("base64");return{gameId:r.id,mimeType:"image/svg+xml",dataUrl:`data:image/svg+xml;base64,${i}`}}},{name:"status",description:"Get the game status and piece positions.",inputSchema:{type:"object",properties:{gameId:{type:"string"}},required:["gameId"]},execute:async e=>{let t=b.parse(e??{}),r=await l.db.game.findUnique({where:{id:t.gameId}});if(!r||!r.isPublic)throw Error("Game not found");let a=new u.qQ(r.fen);return{gameId:r.id,fen:r.fen,turn:a.turn(),isCheck:a.isCheck(),isCheckmate:a.isCheckmate(),isStalemate:a.isStalemate(),isDraw:a.isDraw(),gameStatus:r.status,pieces:function(e){let t=new u.qQ(e).board(),r=["a","b","c","d","e","f","g","h"],a=[];for(let e=0;e<8;e+=1){let i=8-e;for(let s=0;s<8;s+=1){let n=t[e]?.[s];n&&a.push({square:`${r[s]}${i}`,type:n.type,color:n.color})}}return a}(r.fen)}}},{name:"history",description:"Get chronological move history.",inputSchema:{type:"object",properties:{gameId:{type:"string"},limit:{type:"number"}},required:["gameId"]},execute:async e=>{let t=v.parse(e??{}),r=await l.db.game.findUnique({where:{id:t.gameId}});if(!r||!r.isPublic)throw Error("Game not found");let a=await l.db.move.findMany({where:{gameId:t.gameId},orderBy:{ply:"asc"},include:{byUser:{select:{id:!0,email:!0}}},take:t.limit});return{gameId:t.gameId,moves:a.map(e=>({id:e.id,ply:e.ply,san:e.san,from:e.from,to:e.to,byUser:e.byUser,createdAt:e.createdAt}))}}},{name:"list_games",description:"List public games, with my/others scopes for authenticated users.",inputSchema:{type:"object",properties:{scope:{type:"string",enum:["my","others","all"]},limit:{type:"number"}}},execute:async(e,t)=>{let r=x.parse(e??{}),a={isPublic:!0};if("my"===r.scope){let e=h(t.userId);a={isPublic:!0,OR:[{whiteId:e},{blackId:e}]}}return"others"===r.scope&&t.userId&&(a={isPublic:!0,AND:[{NOT:{OR:[{whiteId:t.userId},{blackId:t.userId}]}}]}),{games:(await l.db.game.findMany({where:a,include:{white:{select:{id:!0,email:!0}},black:{select:{id:!0,email:!0}},_count:{select:{moves:!0}}},orderBy:{updatedAt:"desc"},take:r.limit})).map(e=>({id:e.id,white:e.white,black:e.black,status:e.status,moveCount:e._count.moves,updatedAt:e.updatedAt,createdAt:e.createdAt}))}}},{name:"get_game",description:"Get one game's metadata.",inputSchema:{type:"object",properties:{gameId:{type:"string"}},required:["gameId"]},execute:async(e,t)=>{let r=b.parse(e??{}),a=await l.db.game.findUnique({where:{id:r.gameId},include:{white:{select:{id:!0,email:!0}},black:{select:{id:!0,email:!0}},_count:{select:{moves:!0,chatMessages:!0}}}});if(!a||!a.isPublic)throw Error("Game not found");return{game:{id:a.id,white:a.white,black:a.black,status:a.status,moveCount:a._count.moves,chatCount:a._count.chatMessages,createdAt:a.createdAt,updatedAt:a.updatedAt,canMove:a.status===m.GameStatus.ACTIVE&&(t.userId===a.whiteId||t.userId===a.blackId)}}}},{name:"get_chat_messages",description:"Get per-game chat messages.",inputSchema:{type:"object",properties:{gameId:{type:"string"},limit:{type:"number"}},required:["gameId"]},execute:async e=>{let t=S.parse(e??{}),r=await l.db.game.findUnique({where:{id:t.gameId}});if(!r||!r.isPublic)throw Error("Game not found");let a=await l.db.chatMessage.findMany({where:{gameId:t.gameId},include:{user:{select:{id:!0,email:!0}}},orderBy:{createdAt:"asc"},take:t.limit});return{gameId:t.gameId,messages:a.map(e=>({id:e.id,body:e.body,createdAt:e.createdAt,user:e.user}))}}},{name:"post_chat_message",description:"Post a message to a game's chat (players only).",inputSchema:{type:"object",properties:{gameId:{type:"string"},body:{type:"string"}},required:["gameId","body"]},execute:async(e,t)=>{let r=h(t.userId),a=q.parse(e??{}),i=await l.db.game.findUnique({where:{id:a.gameId}});if(!i||!i.isPublic)throw Error("Game not found");if(i.whiteId!==r&&i.blackId!==r)throw Error("Only game players can post chat messages");let s=await l.db.chatMessage.create({data:{gameId:a.gameId,userId:r,body:a.body},include:{user:{select:{id:!0,email:!0}}}});return await (0,d.FZ)(a.gameId,"chat.created",{messageId:s.id,userId:r}),{message:{id:s.id,body:s.body,createdAt:s.createdAt,user:s.user}}}}];async function A(e,t,r){let a=E.find(t=>t.name===e);if(!a)throw Error(`Unknown tool: ${e}`);return a.execute(t,r)}function _(e,t){return Response.json({jsonrpc:"2.0",id:e??null,result:t})}function $(e,t,r){return Response.json({jsonrpc:"2.0",id:e??null,error:{code:t,message:r}},{status:400})}async function k(){return Response.json({name:"mcp-chess",protocol:"JSON-RPC 2.0",endpoint:"/api/mcp"})}async function R(e){let t;try{t=await e.json()}catch{return $(null,-32700,"Invalid JSON")}let{id:r,method:a,params:i}=t;try{if("initialize"===a)return _(r,{protocolVersion:"2024-11-05",serverInfo:{name:"mcp-chess",version:"0.1.0"},capabilities:{tools:{}}});if("tools/list"===a)return _(r,{tools:E.map(e=>({name:e.name,description:e.description,inputSchema:e.inputSchema}))});if("tools/call"===a){let e=await (0,o.I)(),t=i?.name,a=i?.arguments??{};if("string"!=typeof t||!t)return $(r,-32602,"Invalid params: tool name is required");let s=await A(t,a,{userId:e?.user?.id??null});return _(r,{content:[{type:"text",text:JSON.stringify(s)}],structuredContent:s})}return $(r,-32601,`Method not found: ${a??"<missing>"}`)}catch(e){return $(r,-32e3,e instanceof Error?e.message:"Internal error")}}let O=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/mcp/route",pathname:"/api/mcp",filename:"route",bundlePath:"app/api/mcp/route"},resolvedPagePath:"/Users/samuelbourque/codex/mcp-chess/app/api/mcp/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:P,staticGenerationAsyncStorage:M,serverHooks:C}=O,G="/api/mcp/route";function U(){return(0,n.patchFetch)({serverHooks:C,staticGenerationAsyncStorage:M})}},76148:(e,t,r)=>{"use strict";r.d(t,{FZ:()=>o,OZ:()=>m,Zg:()=>n});var a=r(2589);let i=null;function s(){if(i)return i;let e=process.env.ABLY_API_KEY;return e?i=new a.Rest({key:e}):null}async function n(e){let t=s();if(!t)throw Error("ABLY_API_KEY is not configured");return t.auth.createTokenRequest({clientId:e,capability:JSON.stringify({"game:*":["subscribe"],games:["subscribe"]}),ttl:36e5})}async function o(e,t,r){let a=s();if(!a)return{sent:!1,skippedReason:"ABLY_API_KEY is not configured"};try{return await a.channels.get(`game:${e}`).publish(t,{...r,gameId:e,emittedAt:new Date().toISOString()}),{sent:!0}}catch(e){return console.error("Failed to publish Ably game event",e),{sent:!1,error:e instanceof Error?e.message:"Ably publish failed"}}}async function m(e,t){let r=s();if(!r)return{sent:!1,skippedReason:"ABLY_API_KEY is not configured"};try{return await r.channels.get("games").publish(e,{...t,emittedAt:new Date().toISOString()}),{sent:!0}}catch(e){return console.error("Failed to publish Ably games event",e),{sent:!1,error:e instanceof Error?e.message:"Ably publish failed"}}}},42073:(e,t,r)=>{"use strict";r.d(t,{I:()=>u,L:()=>m});var a=r(96403),i=r(20600),s=r(34512),n=r(7750);let o=[];process.env.GOOGLE_ID&&process.env.GOOGLE_SECRET&&o.push((0,s.Z)({clientId:process.env.GOOGLE_ID,clientSecret:process.env.GOOGLE_SECRET}));let m={adapter:(0,a.N)(n.db),session:{strategy:"database"},providers:o,callbacks:{session:({session:e,user:t})=>(e.user&&(e.user.id=t.id),e)}};function u(){return(0,i.getServerSession)(m)}},7750:(e,t,r)=>{"use strict";r.d(t,{db:()=>n});var a=r(53524);let i=require("node:path");var s=r.n(i);let n=global.prisma||new a.PrismaClient({datasources:{db:{url:function(e){if(!e||!e.startsWith("file:"))return e;let t=e.slice(5);if(t.startsWith("/")||t.startsWith("//"))return e;let r=s().resolve(process.cwd(),t);return`file:${r}`}(process.env.DATABASE_URL)}},log:["error"]})},37141:(e,t,r)=>{"use strict";r.d(t,{H:()=>m,X:()=>o});var a=r(85973);let i=null;function s(){return(process.env.NEXTAUTH_URL||"http://localhost:3000").replace(/\/$/,"")}async function n(e){let t=function(){if(i)return i;let e=process.env.SMTP_HOST,t=process.env.SMTP_PORT,r=process.env.SMTP_USER,s=process.env.SMTP_PASS;if(!e||!t||!r||!s)return null;let n=Number.parseInt(t,10);if(!Number.isFinite(n))return null;let o=process.env.SMTP_SECURE?"true"===process.env.SMTP_SECURE:465===n;return i=a.createTransport({host:e,port:n,secure:o,auth:{user:r,pass:s}})}();if(!t)return{sent:!1,skippedReason:"SMTP not configured"};try{let r=await t.sendMail({from:process.env.SMTP_FROM||"no-reply@localhost",to:e.to,subject:e.subject,text:e.text,html:e.html});return{sent:!0,messageId:r.messageId}}catch(e){return{sent:!1,error:e instanceof Error?e.message:"SMTP send failed"}}}async function o(e){let t=`${s()}/games/${e.gameId}`,r=e.invitedByName||e.invitedByEmail||"A player",a=e.opponentExists?"Your opponent started a game with you.":"Your opponent started a game with you. This email is not registered yet, but you can sign in with Google using this email to play.";return n({to:e.toEmail,subject:"You were invited to a chess game",text:`${r} invited you to a chess game.

${a}

Open game: ${t}`,html:`<p><strong>${u(r)}</strong> invited you to a chess game.</p><p>${u(a)}</p><p><a href="${u(t)}">Open game</a></p>`})}async function m(e){let t=`${s()}/games/${e.gameId}`;return n({to:e.toEmail,subject:"Chess reminder: it's your move",text:`It's your turn to move in game ${e.gameId}.

Last move was ${Math.floor(e.minutesSinceLastMove)} minute(s) ago (threshold: ${e.minMinutesSinceLastMove} minute(s)).

Open game: ${t}`,html:`<p>It's your turn to move in game <code>${u(e.gameId)}</code>.</p><p>Last move was ${Math.floor(e.minutesSinceLastMove)} minute(s) ago (threshold: ${e.minMinutesSinceLastMove} minute(s)).</p><p><a href="${u(t)}">Open game</a></p>`})}function u(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#039;")}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[719,976,35,765],()=>r(64160));module.exports=a})();