"use strict";(()=>{var e={};e.id=985,e.ids=[985],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},11965:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>x,requestAsyncStorage:()=>h,routeModule:()=>d,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f});var s={};r.r(s),r.d(s,{POST:()=>c});var n=r(12085),o=r(31650),a=r(85980),i=r(57752),u=r(6415),p=r(7750),l=r(37141);let m=u.Ry({gameId:u.Z_().min(1),minMinutesSinceLastMove:u.Rx().int().min(1).max(43200).default(60),dryRun:u.O7().default(!1)});async function c(e){let t;let r=process.env.REMINDER_API_KEY;if(r&&function(e){let t=e.headers.get("x-reminder-key");if(t)return t;let r=e.headers.get("authorization");return r?.toLowerCase().startsWith("bearer ")?r.slice(7).trim():null}(e)!==r)return Response.json({error:"Unauthorized"},{status:401});try{t=await e.json()}catch{return Response.json({error:"Invalid JSON"},{status:400})}let s=m.safeParse(t);if(!s.success)return Response.json({error:"Invalid payload",details:s.error.flatten()},{status:400});let{gameId:n,minMinutesSinceLastMove:o,dryRun:a}=s.data,u=await p.db.game.findUnique({where:{id:n},include:{white:{select:{id:!0,email:!0,name:!0}},black:{select:{id:!0,email:!0,name:!0}}}});if(!u)return Response.json({error:"Game not found"},{status:404});if("ACTIVE"!==u.status)return Response.json({gameId:n,sent:!1,skippedReason:"Game is not active"});let c=new i.qQ(u.fen).turn(),d="w"===c?u.white:u.black;if(!d.email)return Response.json({gameId:n,sent:!1,skippedReason:"Current player has no email"});let h=await p.db.move.findFirst({where:{gameId:n},select:{createdAt:!0},orderBy:{createdAt:"desc"}}),f=h?.createdAt??u.createdAt,g=(Date.now()-new Date(f).getTime())/1e3/60;if(g<o)return Response.json({gameId:n,sent:!1,skippedReason:`Threshold not met (${Math.floor(g)} < ${o} minutes)`,toEmail:d.email});if(a)return Response.json({gameId:n,sent:!1,dryRun:!0,wouldSendTo:d.email,minutesSinceLastMove:Math.floor(g)});let v=await (0,l.H)({toEmail:d.email,gameId:n,minutesSinceLastMove:g,minMinutesSinceLastMove:o});return Response.json({gameId:n,toEmail:d.email,turn:c,minutesSinceLastMove:Math.floor(g),...v})}let d=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/reminders/turn/route",pathname:"/api/reminders/turn",filename:"route",bundlePath:"app/api/reminders/turn/route"},resolvedPagePath:"/Users/samuelbourque/codex/mcp-chess/app/api/reminders/turn/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:h,staticGenerationAsyncStorage:f,serverHooks:g}=d,v="/api/reminders/turn/route";function x(){return(0,a.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:f})}},7750:(e,t,r)=>{r.d(t,{db:()=>a});var s=r(53524);let n=require("node:path");var o=r.n(n);let a=global.prisma||new s.PrismaClient({datasources:{db:{url:function(e){if(!e||!e.startsWith("file:"))return e;let t=e.slice(5);if(t.startsWith("/")||t.startsWith("//"))return e;let r=o().resolve(process.cwd(),t);return`file:${r}`}(process.env.DATABASE_URL)}},log:["error"]})},37141:(e,t,r)=>{r.d(t,{H:()=>u,X:()=>i});var s=r(85973);let n=null;function o(){return(process.env.NEXTAUTH_URL||"http://localhost:3000").replace(/\/$/,"")}async function a(e){let t=function(){if(n)return n;let e=process.env.SMTP_HOST,t=process.env.SMTP_PORT,r=process.env.SMTP_USER,o=process.env.SMTP_PASS;if(!e||!t||!r||!o)return null;let a=Number.parseInt(t,10);if(!Number.isFinite(a))return null;let i=process.env.SMTP_SECURE?"true"===process.env.SMTP_SECURE:465===a;return n=s.createTransport({host:e,port:a,secure:i,auth:{user:r,pass:o}})}();if(!t)return{sent:!1,skippedReason:"SMTP not configured"};try{let r=await t.sendMail({from:process.env.SMTP_FROM||"no-reply@localhost",to:e.to,subject:e.subject,text:e.text,html:e.html});return{sent:!0,messageId:r.messageId}}catch(e){return{sent:!1,error:e instanceof Error?e.message:"SMTP send failed"}}}async function i(e){let t=`${o()}/games/${e.gameId}`,r=e.invitedByName||e.invitedByEmail||"A player",s=e.opponentExists?"Your opponent started a game with you.":"Your opponent started a game with you. This email is not registered yet, but you can sign in with Google using this email to play.";return a({to:e.toEmail,subject:"You were invited to a chess game",text:`${r} invited you to a chess game.

${s}

Open game: ${t}`,html:`<p><strong>${p(r)}</strong> invited you to a chess game.</p><p>${p(s)}</p><p><a href="${p(t)}">Open game</a></p>`})}async function u(e){let t=`${o()}/games/${e.gameId}`;return a({to:e.toEmail,subject:"Chess reminder: it's your move",text:`It's your turn to move in game ${e.gameId}.

Last move was ${Math.floor(e.minutesSinceLastMove)} minute(s) ago (threshold: ${e.minMinutesSinceLastMove} minute(s)).

Open game: ${t}`,html:`<p>It's your turn to move in game <code>${p(e.gameId)}</code>.</p><p>Last move was ${Math.floor(e.minutesSinceLastMove)} minute(s) ago (threshold: ${e.minMinutesSinceLastMove} minute(s)).</p><p><a href="${p(t)}">Open game</a></p>`})}function p(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#039;")}},12085:(e,t,r)=>{e.exports=r(30517)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[719,765],()=>r(11965));module.exports=s})();